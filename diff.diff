diff --git a/application/config/config.php b/application/config/config.php
index 714dc87..3efe2c6 100644
--- a/application/config/config.php
+++ b/application/config/config.php
@@ -380,7 +380,7 @@ $config['encryption_key'] = '';
 $config['sess_driver'] = 'files';
 $config['sess_cookie_name'] = 'ci_session';
 $config['sess_expiration'] = 0;
-$config['sess_save_path'] = NULL;
+$config['sess_save_path'] = FCPATH.'/application/session_file';
 $config['sess_match_ip'] = FALSE;
 $config['sess_time_to_update'] = 300;
 $config['sess_regenerate_destroy'] = FALSE;
diff --git a/application/config/constants.php b/application/config/constants.php
index 4386acb..18d3b4b 100644
--- a/application/config/constants.php
+++ b/application/config/constants.php
@@ -83,11 +83,3 @@ defined('EXIT_USER_INPUT')     OR define('EXIT_USER_INPUT', 7); // invalid user
 defined('EXIT_DATABASE')       OR define('EXIT_DATABASE', 8); // database error
 defined('EXIT__AUTO_MIN')      OR define('EXIT__AUTO_MIN', 9); // lowest automatically-assigned error code
 defined('EXIT__AUTO_MAX')      OR define('EXIT__AUTO_MAX', 125); // highest automatically-assigned error code
-
-/*
-|--------------------------------------------------------------------------
-| Custom Config
-|--------------------------------------------------------------------------
-*/
-defined('API_AUTHEN_CODE')      OR define('API_AUTHEN_CODE', 'Y5RL9BABAQj4qBdEXBs84eu8QK7PGXrk');
-defined('WEB_BASE_URL')      OR define('WEB_BASE_URL', 'https://www.policehospital-coop.com');
\ No newline at end of file
diff --git a/application/config/database.php b/application/config/database.php
index 0b7a47c..74222c5 100644
--- a/application/config/database.php
+++ b/application/config/database.php
@@ -76,12 +76,9 @@ $query_builder = TRUE;
 $db['default'] = array(
 	'dsn'	=> '',
 	'hostname' => 'localhost',
-	//'hostname' => 'fsccoop.upbean.co.th',
-	//'username' => 'upfsccoop_sys',
-	//'password' => 'xohnUgsZe',
-	'username' => 'root',
-	'password' => '',
-	'database' => 'upfscoop_sys',
+	'username' => 'bbcooporth_sys',
+	'password' => 'aUqNI14j',
+	'database' => 'bbcooporth_sys',
 	'dbdriver' => 'mysqli',
 	'dbprefix' => '',
 	'pconnect' => FALSE,
@@ -98,12 +95,12 @@ $db['default'] = array(
 	'save_queries' => TRUE
 );
 
-/*$db['backup'] = array(
+$db['backup'] = array(
 	'dsn'	=> '',
 	'hostname' => 'localhost',
-	'username' => 'spktsys_backup',
-	'password' => '8n7AUO4e',
-	'database' => 'spktsys_backup',
+	'username' => $db['default']['username'],
+	'password' => $db['default']['password'],
+	'database' => 'bbcooporth_backup',
 	'dbdriver' => 'mysqli',
 	'dbprefix' => '',
 	'pconnect' => FALSE,
@@ -118,5 +115,5 @@ $db['default'] = array(
 	'stricton' => FALSE,
 	'failover' => array(),
 	'save_queries' => TRUE,
-	'backuppath' => '/home/spktsys/coop_backup'
-);*/
\ No newline at end of file
+	'backuppath' => '/home/bbcooporth/coop_backup'
+);
\ No newline at end of file
diff --git a/application/controllers/Coop_setting.php b/application/controllers/Coop_setting.php
new file mode 100644
index 0000000..d6d2e52
--- /dev/null
+++ b/application/controllers/Coop_setting.php
@@ -0,0 +1,27 @@
+<?php
+defined('BASEPATH') OR exit('No direct script access allowed');
+
+class Coop_setting extends CI_Controller {
+    
+    function __construct()
+	{
+		parent::__construct();
+    }
+
+    public function get_setting(){
+        $setting = $this->uri->segment(3);
+        $res = array();
+        $res['status'] = 200;
+        if(!empty($setting)){
+            $this->db->where("setting_name", $setting);
+        }
+        $this->db->select(array("setting_name", "setting_value"));
+        $rs = $this->db->get("coop_setting")->result_array();
+        $res['setting'] = array();
+        foreach($rs as $key=>$value) {
+            $res['setting'][$value['setting_name']] = $value["setting_value"];
+        }
+        header("content-type: application/json; charset=utf-8;");
+        echo json_encode($res);
+    }
+}
\ No newline at end of file
diff --git a/application/controllers/Loan_contract.php b/application/controllers/Loan_contract.php
index 088cb13..c16f2a5 100644
--- a/application/controllers/Loan_contract.php
+++ b/application/controllers/Loan_contract.php
@@ -93,6 +93,12 @@ class Loan_contract extends  CI_Controller
             $arr_data['sum_balance'] = $guaruntee->getBalance();
             $arr_data['count_contract'] = $guaruntee->itemCount();
 
+            //payment
+            $arr_data['rs_bank'] = $this->db->get("coop_bank")->result_array();
+            $arr_data['content_bank'] = $this->db->get_where("coop_mem_bank_account", array(
+                "member_id" => $member_id
+            ))->row_array();
+
             //keeping
             $payment_other = $payment_deposit = $payment_share = $payment_loan = 0;                 //initial
 
@@ -103,6 +109,7 @@ class Loan_contract extends  CI_Controller
                     if ($item['deduct_code'] == "DEPOSIT") {
                         $payment_deposit += $item['sum_amount'];
                         $arr_data['payment_deposit'] += $item['sum_amount'];
+                        continue;
                     }
                     if ($item['deduct_code'] == "LOAN") {
 
@@ -113,16 +120,18 @@ class Loan_contract extends  CI_Controller
                         }
                         $payment_loan += $item['sum_amount'];
                         $arr_data['payment_loan'] = $item['sum_amount'];
+                        continue;
                     }
                     if ($item['deduct_code'] == "SHARE") {
                         $payment_share = $item['sum_amount'];
                         $arr_data['payment_share'] = $item['sum_amount'];
-                    } else {
-                        $payment_other += $item['sum_amount'];
-                        $arr_data['payment_other'] += $item['sum_amount'];
+                        continue;
                     }
+                    $payment_other += $item['sum_amount'];
+                    $arr_data['payment_other'] += $item['sum_amount'];
                 }
             }
+            
             $arr_data['net_balance'] = $arr_data['income_per_month'] - ($payment_loan + $payment_deposit + $payment_share+$payment_other);
 
         }
@@ -149,8 +158,6 @@ class Loan_contract extends  CI_Controller
         $setting['cut_off'] = 5;
         $arr_data['first_receive_date'] = date('j') > $setting['cut_off'] ?  date('Y-m-t', strtotime('+1 MONTH')) : date('Y-m-t');
 
-//        echo '<pre>';print_r($arr_data);exit;
-
         $this->libraries->template('loan_contract/index', $arr_data);
     }
 
diff --git a/application/controllers/Migrate.php b/application/controllers/Migrate.php
new file mode 100644
index 0000000..27b54a5
--- /dev/null
+++ b/application/controllers/Migrate.php
@@ -0,0 +1,179 @@
+<?php
+class Migrate extends CI_Controller{
+
+    public function __construct()
+    {
+        parent::__construct();
+    }
+
+
+    /**
+     * เปลี่ยนแปลง Text Case ให้ตรงกับชื่อตาราง
+     * @param String $str `รับค่า string ที่ต้องการ`
+     * @param string $textCase `รับค่า TextCase ที่ต้องการเปลี่ยนแปลง lowercase, uppercase`
+     * @return string
+     */
+    private function modTextCase($str, $textCase = "lowercase"){
+        if(strtolower($textCase) == "uppercase") {
+            return strtoupper($str);
+        }else{
+            return strtolower($str);
+        }
+    }
+
+    /**
+     * Migrate ข้อมูลที่อยู่
+     */
+    public function district(){
+
+        /** @var String $database */
+        $database = "police"; // กำหนดชื่อฐานข้อมูล
+        /** @var String $textCase */
+        $textCase = "lowercase";        //กำหนด text case
+
+        $src = $this->db->get_where($database.".".self::modTextCase("sc_mem_m_member_address", $textCase), array("address_type" => 0 ))->result_array();
+        $data = array();
+        $num = 0;
+        foreach ($src as $key => $area){
+
+            $provinceName = $this->db->select("PROVINCE_NAME")->from($database.".".self::modTextCase("SC_MEM_M_UCF_PROVINCE", $textCase))->where(array('PROVINCE_CODE' => $area['PROVINCE_CODE']))->get()->row_array();
+            $amphurName = $this->db->select("DISTRICT_NAME")->from($database.".".self::modTextCase("SC_MEM_M_UCF_DISTRICT", $textCase))->where(array('PROVINCE_CODE' => $area['PROVINCE_CODE'], 'DISTRICT_CODE' => $area['DISTRICT_CODE']))->get()->row_array();
+
+            $provinceId =  $this->db->select("province_id")->from("coop_province")->where("province_name like '%". $provinceName['PROVINCE_NAME']."%' ")->get()->row_array();
+            $amphurId = $this->db->select("amphur_id")->from("coop_amphur")->where("amphur_name Like '%".$amphurName['DISTRICT_NAME']."%' AND province_id ={$provinceId['province_id']}")->get()->row_array();
+
+            if(empty($area['TAMBOL'])) {
+                $districtId = array();
+            }else{
+                $districtId = $this->db->select("district_id")->from("coop_district")->where("district_name like '%" . preg_replace('/[^ก-๛]+/', '',$area['TAMBOL']) . "%' AND amphur_id = '" . $amphurId['amphur_id'] . "' AND province_id='" . $provinceId['province_id'] . "' AND district_name not like '%*%'  ")->get()->row_array();
+            }
+            $data[$num]['member_id'] =  $area['MEMBERSHIP_NO'];
+            $data[$num]['province_id'] = $provinceId['province_id'];
+            $data[$num]['amphur_id'] = $amphurId['amphur_id'];
+            $data[$num]['district_id'] = $districtId['district_id'];
+
+            $num++;
+        }
+
+        $this->db->update_batch("coop_mem_apply", $data, 'member_id');
+
+    }
+
+    /**
+     * Migrate ข้อมูลเบอร์โทรศัพ
+     */
+    public function mobile(){
+
+        $src = $this->db->select("member_id, note as mem_tel")
+            ->from("coop_mem_apply")
+            ->where('mobile is null')
+            ->get()->result_array();
+        //$src = $this->db->select("mem_no as member_id, mem_tel")->from("tmp_mem_tel")->get()->result_array();
+
+        $data = array();
+        $num = 0;
+        foreach ($src as $key => $val ){
+
+            if(!empty($val['mem_tel'])) {
+
+                //$tel = preg_replace('/([ก-๛]|\/+|(\s)+|\s\s+|\s{2,}|,)+/', ' ', $val['mem_tel']);
+                //$mem_tel_arr = explode(',', $tel);
+
+                $mem_tel_arr = preg_split('/([ก-๛]|\/+|(\s)+|\s\s+|\s{2,}|,|\.)+/', $val['mem_tel']);
+
+                $mobile = "";
+                foreach ($mem_tel_arr as $index => $value){
+                    $value = preg_replace('/([ก-๛]|\/+|(\s)+|\s\s+|\s{2,}|-)/', '', $value);
+                    if(strlen($value) < 10){
+                        $value = str_pad($value, 10, 0, STR_PAD_LEFT);
+                    }
+                    if(in_array(substr($value, 0, 2), array('06', '08', '09')) && strlen($value) == 10){
+                        $mobile = $value;
+                    }
+                }
+
+                if($mobile){
+                    $data[$num]['member_id'] = $val['member_id'];
+                    $data[$num]['mobile'] = $mobile;
+                    $num++;
+                }
+            }
+        }
+
+        if($_GET['run'] == 'execute') {
+            $this->db->update_batch('coop_mem_apply', $data, 'member_id');
+            //$this->db->update_batch("tmp_mem_tel", $data, 'mem_no');
+            echo "successful.";
+        }else{
+
+            echo "rows: ".sizeof($data); echo "<hr>";
+            echo "<pre>"; print_r($data); exit;
+        }
+    }
+
+    public function member_group(){
+        $group = $this->db->get('coop_mem_group')->result_array();
+        $data = array();
+        $num = 0;
+        foreach ($group as $key => $value){
+
+            $num++;
+            $parent = 1;
+
+            $data[$num]['mem_group_id'] = $value['mem_group_id'];
+            $data[$num]['mem_group_full_name'] = 'ไม่ระบุ';
+            $data[$num]['mem_group_name'] = 'ไม่ระบุ';
+            $data[$num]['mem_group_type'] = $parent;
+
+            for($i=0; $i < 2; $i++){
+                $data[$num]['mem_group_id'] = '';
+                $data[$num]['mem_group_full_name'] = 'ไม่ระบุ';
+                $data[$num]['mem_group_name'] = 'ไม่ระบุ';
+                $data[$num]['mem_group_type'] = $parent;
+                $num++;
+                $parent++;
+            }
+        }
+    }
+
+    public function set_interest(){
+
+        ini_set('precision', 16);
+        $data = array();
+        $num = 0;
+        foreach (self::lon_step_rate() as $number => $step){
+
+            if(self::getCounter($step['LOAN_TYPE'], $step['EFFECTIVE_DATE']) == 0) {
+                $condition = self::get_term_of_loan($step['LOAN_TYPE']);
+                unset($condition['id']);
+                $condition['interest_rate'] = round($step['LOAN_INTEREST_RATE']*100, 2);
+                $condition['start_date'] = $step['EFFECTIVE_DATE'];
+                $data[$num] = $condition;
+                $num++;
+            }
+        }
+
+//        header('content-type: application/json; charset: utf8;');
+//        echo json_encode($data);
+//        exit;
+        if(sizeof($data)) {
+            $this->db->insert_batch('coop_term_of_loan', $data);
+        }
+
+    }
+
+    public function getCounter($loanType = "", $effective = ""){
+        return $this->db->select('*')->from('coop_term_of_loan')->where(array('prefix_code' => $loanType, 'start_date' => $effective))->count_all_results();
+    }
+
+    public function get_term_of_loan($loanType = ""){
+        return $this->db->select('*')->from('coop_term_of_loan')->where(array('prefix_code' => $loanType))
+            ->order_by('start_date', 'desc')->limit(1)->get()->row_array();
+    }
+
+    public function lon_step_rate(){
+        return $this->db->get_where('police.sc_lon_m_int_step_rate', "EFFECTIVE_DATE > '2020-01-01'")->result_array();
+    }
+
+
+}
\ No newline at end of file
diff --git a/application/controllers/Report_loan_data.php b/application/controllers/Report_loan_data.php
index a9ac86a..04c69d5 100644
--- a/application/controllers/Report_loan_data.php
+++ b/application/controllers/Report_loan_data.php
@@ -5,6 +5,7 @@ class Report_loan_data extends CI_Controller {
 	function __construct()
 	{
 		parent::__construct();
+		$this->load->model('report_loan_data_model');
 	}
 	
 	public function coop_report_loan(){
@@ -251,1040 +252,19 @@ class Report_loan_data extends CI_Controller {
 	
 	function coop_report_loan_detail_preview(){
 		$arr_data = array();
-		$member_id = @$_GET['member_id'];
-		$loan_id = @$_GET['loan_id'];
-		if($member_id != '') {
-			//@start ดึงข้อมูลในตารางเก็บข้อมูลรายละเอียดการขอกู้เงิน เพื่อใช้ดูข้อมูลย้อนหลัง
-			$this->db->select('*');
-			$this->db->from('coop_loan_report_detail');
-			$this->db->where("loan_id = '".$loan_id."'");
-			$rs_report_detail = $this->db->get()->result_array();
-			$row_report_detail = $rs_report_detail[0];
-			$arr_data['row_report_detail'] = $row_report_detail;			
-			//@end ดึงข้อมูลในตารางเก็บข้อมูลรายละเอียดการขอกู้เงิน เพื่อใช้ดูข้อมูลย้อนหลัง
-			
-			$this->db->select('coop_mem_apply.*,
-							coop_mem_type.mem_type_name,
-							department.mem_group_full_name AS department_name,
-							faction.mem_group_full_name AS faction_name,
-							level.mem_group_full_name AS level_name',
-							'prename.prename_full'
-							);
-			$this->db->from('coop_mem_apply');
-			$this->db->join("coop_mem_type","coop_mem_apply.mem_type_id = coop_mem_type.mem_type_id","left");
-			$this->db->join("coop_mem_group as department","coop_mem_apply.department = department.id","left");
-			$this->db->join("coop_mem_group as faction","coop_mem_apply.faction = faction.id","left");
-			$this->db->join("coop_mem_group as level","coop_mem_apply.level = level.id ","left");
-			$this->db->join("coop_prename as prename","coop_mem_apply.prename_id = prename.prename_id ","left");
-			$this->db->where("coop_mem_apply.member_id = '".$member_id."'");
-			$rs_member = $this->db->get()->result_array();
-			$row_member = $rs_member[0];
-			$arr_data['row_member'] = $row_member;
-			
-			$this->db->select(array(
-				't1.*',
-				't3.loan_name as loan_type_detail',
-				't3.loan_type_id',
-				't4.id',
-				't5.bank_name',
-				't6.account_name',
-				't7.user_name AS admin_name'
-			));
-			$this->db->from('coop_loan as t1');			
-			$this->db->join('coop_loan_name as t3','t1.loan_type = t3.loan_name_id','inner');
-			$this->db->join("coop_loan_type as t4",'t3.loan_type_id = t4.id','inner');
-			$this->db->join("coop_bank as t5",'t1.transfer_bank_id = t5.bank_id','left');
-			$this->db->join("coop_maco_account as t6",'t1.transfer_account_id = t6.account_id','left');
-			$this->db->join("coop_user AS t7",'t1.admin_id = t7.user_id','left');
-			$this->db->where("t1.member_id = '".$member_id."' AND t1.id='".$loan_id."'");
-			$this->db->order_by("t1.id DESC");
-			$rs_loan = $this->db->get()->result_array();
-			$row_loan =  @$rs_loan[0];
-			$arr_data['row_loan'] = @$row_loan;
-			$createdate_loan = date("Y-m-d", strtotime($row_loan['createdatetime']));
-			if(@$_GET['dev'] == 'dev'){
-				echo $this->db->last_query(); 
-				echo '<hr>';
-			}
-			$this->db->select(array(
-				//' MAX(total_paid_per_month) AS total_paid_per_month'
-				'principal_payment',
-				'total_paid_per_month'
-			));
-			$this->db->from('coop_loan_period');
-			$this->db->where("loan_id='".$loan_id."' AND date_count = '31'");
-			$this->db->limit(1);
-			$per_month = $this->db->get()->result_array();
-			//echo $this->db->last_query(); 
-			if(@$row_loan['pay_type'] == '1'){
-				$total_paid_per_month = @round(@$per_month[0]['principal_payment'],2);
-				$pay_type_name = "แบบคงต้น";
-				
-				//ดอกเบี้ย 30 วัน ของจากยอดกู้เต็ม
-				$date_count = 31;
-				$interest_30_day = (((@$row_loan['loan_amount']*@$row_loan['interest_per_year'])/100)/365)*@$date_count;
-				if(@$_GET['dev'] == 'dev'){
-					echo '((('.@$row_loan['loan_amount'].'*'.@$row_loan['interest_per_year'].')/100)/365)*'.@$date_count.'<br>';
-				}	
-				$interest_30_day = round(@$interest_30_day, 2);
-			}else{
-				$total_paid_per_month = @round(@$per_month[0]['total_paid_per_month'],2);
-				$pay_type_name = "แบบคงยอด";
-				$interest_30_day  = 0;
-			}
-			//$total_paid_per_month = round(@$per_month[0]['total_paid_per_month'],-2);
-			$arr_data['total_paid_per_month'] = @$total_paid_per_month;
-			$arr_data['pay_type'] = @$pay_type_name;			
-			$arr_data['interest_30_day'] = @$interest_30_day;
-			$arr_data['pay_type_id'] = @$row_loan['pay_type'];
-			
-			$this->db->select('*');
-			$this->db->from('coop_mem_share');
-			$this->db->where("member_id = '".$member_id."' AND share_status IN('1','2')");
-			$this->db->order_by('share_date DESC');
-			$this->db->limit(1);
-			$row_prev_share = $this->db->get()->result_array();
-			$row_prev_share = @$row_prev_share[0];
-			
-			$arr_data['count_share'] = $row_prev_share['share_collect'];
-			$arr_data['cal_share'] = $row_prev_share['share_collect_value']; //หุ้นที่มี่
-			$arr_data['share_period'] = $row_prev_share['share_period'];
-			$arr_data['rules_share'] = $row_loan['loan_amount']*20/100; //หุ้นตามหลักเกณฑ์
-			$arr_data['old_share'] = 0; //เดิม
-			$arr_data['deposit_account_in'] = 0; //เข้าบัญชีเงินฝาก
-			
-			//เช็คสมุดเงินฝากสีน้ำเงิน
-			$this->db->select(array('coop_maco_account.account_id'));
-			$this->db->from('coop_maco_account');
-			$this->db->join("coop_deposit_type_setting","coop_maco_account.type_id = coop_deposit_type_setting.type_id","inner");
-			$this->db->where("
-				coop_maco_account.mem_id = '".$member_id."' 
-				 AND coop_maco_account.account_status = '0'
-				AND coop_deposit_type_setting.deduct_loan = '1'
-			");
-			$this->db->limit(1);
-			$rs_account_blue = $this->db->get()->result_array();
-			$account_id_blue =  @$rs_account_blue[0]['account_id'];
-			if($account_id_blue != ''){
-				$this->db->select(array('transaction_balance'));
-				$this->db->from('coop_account_transaction');
-				$this->db->where("account_id = '".$account_id_blue."'");
-				$this->db->order_by('transaction_id DESC');
-				$this->db->limit(1);
-				$rs_account_blue_balance = $this->db->get()->result_array();
-				$account_blue_balance = @$rs_account_blue_balance[0]['transaction_balance'];
-				
-			}
-			$arr_data['account_blue_deposit'] = @$account_blue_balance; //เงินฝากสีน้ำเงิน
-			
-			//////////////////////////////////////
-			//รายการผ่อนชำระสหกรณ์ปัจจุบัน/เดือน
-			//$month_now = date('n');
-			//$year_now = date('Y')+543;
-			$month_now = date('n',strtotime(@$row_loan['createdatetime']));
-			$year_now = date('Y',strtotime(@$row_loan['createdatetime']))+543;
-			$date_month_end = date('Y-m-t',strtotime((@$year_now-543).'-'.sprintf("%02d",@$month_now).'-01'));
-			
-			$this->db->select(array('coop_finance_month_detail.*','coop_finance_month_profile.*','coop_loan_name.loan_type_id'));
-			$this->db->from('coop_finance_month_detail');
-			$this->db->join('coop_finance_month_profile', 'coop_finance_month_detail.profile_id = coop_finance_month_profile.profile_id', 'left');
-			$this->db->join('coop_loan', 'coop_finance_month_detail.loan_id = coop_loan.id', 'left');
-			$this->db->join('coop_loan_name', 'coop_loan.loan_type = coop_loan_name.loan_name_id', 'left');
-			$this->db->where("
-						coop_finance_month_detail.member_id = '".@$member_id."'
-						AND coop_finance_month_profile.profile_month = '".$month_now."'
-						AND coop_finance_month_profile.profile_year = '".$year_now."'
-					");
-			$row_finance_month = $this->db->get()->result_array();
-//			echo $this->db->last_query()."<br>";
-//			echo $row_finance_month.'<br>';
-			//
-			if(!empty($row_finance_month)){
-				//ออกรายการเรียกเก็บประจำเดือนแล้ว
-				//echo '<pre>'; print_r($row_finance_month); echo '</pre>';
-				$arr_list_loan = array();
-				foreach($row_finance_month AS $key_month=>$value_month){
-					//echo @$value_month['deduct_code'].'<br>';
-					if(@$value_month['deduct_code'] == 'SHARE'){
-						//หุ้นหักรายเดือน
-						$share_month = @$value_month['pay_amount'];
-						$share_month_interest = 0;
-						$arr_data['share_month'] = @$share_month; //หุ้นหักรายเดือน(เงินต้น)
-						$arr_data['share_month_interest'] = @$share_month_interest; //หุ้นหักรายเดือน(ดอกเบี้ย)
-						
-					}						
-					
-					if(@$value_month['deduct_code'] == 'DEPOSIT'){
-						//เงินฝากหักรายเดือน
-						$deposit_month =  @$value_month['pay_amount'];
-						$deposit_month_interest = 0;	
-						$arr_data['deposit_month'] = @$deposit_month; //เงินฝากหักรายเดือน(เงินต้น)
-						$arr_data['deposit_month_interest'] = @$deposit_month_interest; //เงินฝากหักรายเดือน(ดอกเบี้ย)	
-											
-					}
-					
-					if(@$value_month['deduct_code'] == 'LOAN'){
-						//echo '<pre>'; print_r($value_month); echo '</pre>';
-						if(@$value_month['pay_type'] == 'principal'){
-							$arr_list_loan[@$value_month['loan_type_id']]['loan_principle'] = @$value_month['pay_amount'];//ยอดที่ชำระต่อเดือน เงินต้น
-						}
-						
-						if(@$value_month['pay_type'] == 'interest'){
-							$arr_list_loan[@$value_month['loan_type_id']]['loan_interest'] = @$value_month['pay_amount'];//(ดอกเบี้ย)
-						}
-						$arr_list_loan[@$value_month['loan_type_id']]['loan_id'] = @$value_month['loan_id'];//loan_id
-						
-					}
-					
-					if(@$value_month['deduct_code'] == 'ATM'){
-						if(@$value_month['pay_type'] == 'principal'){
-							@$arr_list_loan[7]['loan_principle'] += @$value_month['pay_amount'];//ยอดที่ชำระต่อเดือน เงินต้น
-						}
-						
-						if(@$value_month['pay_type'] == 'interest'){
-							@$arr_list_loan[7]['loan_interest'] += @$value_month['pay_amount'];//(ดอกเบี้ย)
-						}
-						$arr_list_loan[7]['loan_id'] = @$value_month['loan_atm_id'];//loan_id
-					}
-					
-					
-				}			
-				
-				$this->db->select(array('*'));
-				$this->db->from('coop_loan_type');
-				$loan_type = $this->db->get()->result_array();
-				$list_loan = array();
-				$loan_principle_total = 0;
-				$loan_interest_total = 0;
-				if(!empty($loan_type)){
-					foreach($loan_type AS $key=>$value){						
-						$list_loan[$value['id']]['loan_name']= $value['loan_type'];//ชื่อเงินกู้หลัก
-						$list_loan[$value['id']]['loan_principle']= @$arr_list_loan[$value['id']]['loan_principle'];//ยอดที่ชำระต่อเดือน
-						$list_loan[$value['id']]['loan_interest'] = @$arr_list_loan[$value['id']]['loan_interest'];//(ดอกเบี้ย)
-						$loan_principle_total += @$arr_list_loan[$value['id']]['loan_principle'];
-						$loan_interest_total += @$arr_list_loan[$value['id']]['loan_interest'];
-					}
-				}
-				$arr_data['list_loan'] = @$list_loan;	
-				
-			}else{
-				
-				//ยังไม่ได้ออกรายการเรียกเก็บประจำเดือน
-				$arr_list_loan = array();
-				$this->db->select('setting_value');
-				$this->db->from('coop_share_setting');
-				$this->db->where("setting_id = '1'");
-				$row = $this->db->get()->result_array();
-				$row_share_value = $row[0];
-				$share_value = $row_share_value['setting_value'];
-			
-				$this->db->select(array('deduct_id','deduct_code','deduct_detail','deduct_type','deduct_format','deposit_type_id','deposit_amount'));
-				$this->db->from('coop_deduct');
-				$this->db->order_by('deduct_seq ASC');
-				$deduct_list = $this->db->get()->result_array();
-				//echo '<pre>'; print_r($deduct_list); echo '</pre>';	
-				foreach($deduct_list as $key2 => $value2){
-					
-					//หุ้นหักรายเดือน
-					if($value2['deduct_code']=='SHARE'){
-						//งดหุ้นชั่วคราว
-						$check_refrain_share = 0;
-						$this->db->select('*');
-						$this->db->from('coop_refrain_share');
-						$this->db->where("member_id = '".$row_member['member_id']."' AND type_refrain = '2' AND month_refrain = '".@$month_now."' AND year_refrain = '".@$year_now."'");
-						$this->db->order_by('refrain_id DESC');			
-						$rs_refrain_temporary = $this->db->get()->result_array();
-						if(!empty($rs_refrain_temporary)){
-							foreach($rs_refrain_temporary AS $key=>$value){
-								$check_refrain_share = 1;
-							}
-						}
-						
-						//งดหุ้นถาวร
-						$this->db->select('*');
-						$this->db->from('coop_refrain_share');
-						$this->db->where("member_id = '".$row_member['member_id']."' AND type_refrain = '1'");
-						$this->db->order_by('refrain_id DESC');			
-						$rs_refrain_permanent = $this->db->get()->result_array();
-						if(!empty($rs_refrain_permanent)){
-							foreach($rs_refrain_permanent AS $key=>$value){
-								$check_refrain_share = 1;
-							}
-						}				
-						
-						//ทุนเรือนหุ้น
-						if(@$row_member['apply_type_id'] == '1' && $check_refrain_share == 0){															
-							$share = @$row_member['share_month'];
-							$share_month = @$share;
-							$share_month_interest = 0;
-							$arr_data['share_month'] = @$share_month; //หุ้นหักรายเดือน(เงินต้น)
-							$arr_data['share_month_interest'] = @$share_month_interest; //หุ้นหักรายเดือน(ดอกเบี้ย)
-						}
-						//echo $row_member['apply_type_id'].'<br>';
-						/*if(@$row_member['apply_type_id'] == '1'){	
-							$this->db->select(array('change_value'));
-							$this->db->from('coop_change_share');
-							$this->db->where("member_id = '".$row_member['member_id']."' AND change_share_status IN ('1','2')");
-							$this->db->order_by("change_share_id DESC");
-							$this->db->limit(1);
-							$row_change_share = $this->db->get()->result_array();
-							$row_change_share = @$row_change_share[0];
-							$sum = 0;
-							if(@$row_change_share['change_value'] != ''){
-								$num_share = @$row_change_share['change_value'];
-							}else{
-								$this->db->select(array('share_salary'));
-								$this->db->from('coop_share_rule');
-								$this->db->where("salary_rule <= '".$row_member['salary']."'");
-								$this->db->order_by("salary_rule DESC");
-								$this->db->limit(1);
-								$row_share_rule = $this->db->get()->result_array();
-								$row_share_rule = @$row_share_rule[0];
-								
-								$num_share = @$row_share_rule['share_salary'];
-							}
-							$share = @$num_share*@$share_value;
-
-							$share_month = @$share;
-							$share_month_interest = 0;
-							$arr_data['share_month'] = @$share_month; //หุ้นหักรายเดือน(เงินต้น)
-							$arr_data['share_month_interest'] = @$share_month_interest; //หุ้นหักรายเดือน(ดอกเบี้ย)
-						}
-						*/
-					}
-					
-					//เงินฝากหักรายเดือน
-					if($value2['deduct_code']=='DEPOSIT'){							
-						//เงินฝาก	
-						$sum_deposit = 0;
-						$DEPOSIT = 0;						
-						$deposit_type_id = @$value2['deposit_type_id'];
-						$DEPOSIT = @$value2['deposit_amount'];
-						//echo $deposit_type_id.'<hr>';
-						$deposit_period_count = 1;
-						$deposit_balance = $DEPOSIT;
-						
-						$this->db->select('*');
-						$this->db->from('coop_maco_account');
-						$this->db->where("mem_id = '".@$row_member['member_id']."' AND type_id = '".@$deposit_type_id."'");
-						$this->db->limit(1);
-						$rs_account = $this->db->get()->result_array();
-						$account_id = @$rs_account[0]['account_id'];
-						if(!empty($account_id)){												
-							if($DEPOSIT > 0){						
-								$sum_deposit += @$DEPOSIT;
-							}
-						}
-
-						$deposit_month =  @$sum_deposit;
-						$deposit_month_interest = 0;	
-						$arr_data['deposit_month'] = @$deposit_month; //เงินฝากหักรายเดือน(เงินต้น)
-						$arr_data['deposit_month_interest'] = @$deposit_month_interest; //เงินฝากหักรายเดือน(ดอกเบี้ย)							
-					}
-				
-					
-					if(@$value2['deduct_code'] == 'LOAN'){										
-						$LOAN = array();
-						$where = '';
-						$where .= " AND (coop_loan.guarantee_for_id = '' OR coop_loan.guarantee_for_id IS NULL) ";
-		
-						$this->db->select(
-							array(
-								'coop_loan.id',
-								'coop_loan.loan_type',
-								'coop_loan.contract_number',
-								'coop_loan.loan_amount_balance',
-								'coop_loan.interest_per_year',
-								'coop_loan_transfer.date_transfer',
-								'coop_loan_name.loan_name',
-								'coop_loan.pay_type',
-								'coop_loan.money_period_1',
-								'coop_loan.createdatetime',
-								'coop_loan.guarantee_for_id',
-								'coop_loan_name.loan_type_id'
-							)
-						);
-						$this->db->from('coop_loan');
-						$this->db->join('coop_loan_transfer', 'coop_loan_transfer.loan_id = coop_loan.id', 'left');
-						$this->db->join('coop_loan_name', 'coop_loan_name.loan_name_id = coop_loan.loan_type', 'inner');
-						$this->db->where("
-							coop_loan.loan_amount_balance > 0
-							AND coop_loan.member_id = '".$row_member['member_id']."'
-							AND coop_loan.loan_status = '1'
-							AND coop_loan_transfer.transfer_status = '0'
-							AND coop_loan.date_start_period <= '".($year_now-543)."-".sprintf("%02d",$month_now)."-".date('t',strtotime(($year_now-543)."-".$month_now."-01"))."' 
-						".$where);
-						$row_loan_month = $this->db->get()->result_array();
-						//echo $this->db->last_query()."<br>";
-						$j=0;
-						
-						foreach($row_loan_month as $key => $row_normal_loan){
-							$this->db->select(array('deduct_id','ref_id'));
-							$this->db->from('coop_deduct_detail');
-							$this->db->where("deduct_id = '{$value2['deduct_id']}' AND ref_id = '{$row_normal_loan['loan_type']}'");
-							$rs_deduct_detail = $this->db->get()->result_array();
-							$ref_id = @$rs_deduct_detail[0]['ref_id'];
-							if(!empty($ref_id)){
-								$deduct_format = @$value2['deduct_format'];
-								
-								if($row_normal_loan['guarantee_for_id']!=''){
-									$for_loan_id = $row_normal_loan['guarantee_for_id'];
-								}else{
-									$for_loan_id = $row_normal_loan['id'];
-								}
-								
-								$this->db->select(
-									array(
-										'outstanding_balance',
-										'principal_payment',
-										'total_paid_per_month'
-									)
-								);
-								$this->db->from('coop_loan_period');
-								$this->db->where("loan_id = '".$for_loan_id."'");
-								$this->db->limit(1);
-								$row_loan_period = $this->db->get()->result_array();
-								$row_principal_payment = $row_loan_period[0];
-								
-								$date_interesting = $date_month_end;
-								$cal_loan_interest = array();
-								$cal_loan_interest['loan_id'] = $row_normal_loan['id'];
-								$cal_loan_interest['date_interesting'] = $date_interesting;
-								$interest = $this->loan_libraries->cal_loan_interest($cal_loan_interest);
-								
-								if($row_principal_payment['principal_payment'] > $row_normal_loan['loan_amount_balance']){
-									$principal_payment = @$row_normal_loan['loan_amount_balance'];
-									$balance = 0;
-								}else{
-									$principal_payment = @$row_principal_payment['principal_payment'];
-									$balance = @$row_normal_loan['loan_amount_balance']-@$row_principal_payment['principal_payment'];
-								}
-								
-								$LOAN[$j]['loan_id'] = $row_normal_loan['id'];
-								$LOAN[$j]['loan_type'] = $row_normal_loan['loan_name'];
-								//$LOAN[$j]['loan_type_id'] = $row_normal_loan['loan_type'];
-								$LOAN[$j]['loan_type_id'] = $row_normal_loan['loan_type_id'];
-								$LOAN[$j]['contract_number'] = $row_normal_loan['contract_number'];
-								$LOAN[$j]['money_period_1'] = $row_normal_loan['money_period_1'];
-								$LOAN[$j]['pay_loan_type'] = $row_normal_loan['pay_type'];
-								if($deduct_format == '2'){
-									$LOAN[$j]['text_title'] = 'ต้นเงินกู้เลขที่สัญญา';
-									$LOAN[$j]['principal_payment'] = $principal_payment;
-									$LOAN[$j]['interest'] = 0;
-									$LOAN[$j]['total'] = $principal_payment;
-									$LOAN[$j]['pay_type'] = 'principal';
-								}else if($deduct_format == '1'){
-									$LOAN[$j]['text_title'] = 'ดอกเบี้ยเงินกู้เลขที่สัญญา';
-									$LOAN[$j]['principal_payment'] = 0;
-									$LOAN[$j]['interest'] = $interest;
-									$LOAN[$j]['total'] = $interest;
-									$LOAN[$j]['pay_type'] = 'interest';
-									$interest_arr[$row_normal_loan['id']] = $interest;
-								}	
-								$balance = @$row_normal_loan['loan_amount_balance']-$principal_payment-$interest;
-								$LOAN[$j]['balance'] = $balance;
-								
-							}
-							$j++;
-						}
-						//echo"<pre>";print_r($LOAN);echo"</pre>";
-						if(!empty($LOAN)){
-							foreach($LOAN as $key3 => $value3){
-								$arr_list_loan[@$value3['loan_type_id']]['loan_principle'] = @$value3['principal_payment'];//ยอดที่ชำระต่อเดือน เงินต้น							
-								$arr_list_loan[@$value3['loan_type_id']]['loan_interest'] = @$value3['interest'];//(ดอกเบี้ย)
-								$arr_list_loan[@$value3['loan_type_id']]['loan_id'] = @$value3['loan_id'];//loan_id
-							}
-						}
-						
-						//echo '<pre>'; print_r($arr_list_loan); echo '</pre>';
-					}
-					
-					if(@$value2['deduct_code'] == 'ATM'){					
-						$ATM = 0;
-						$this->db->select(array(
-							't1.loan_amount_balance',
-							't1.principal_per_month',
-							't2.contract_number',
-							't2.loan_atm_id',
-							't1.date_last_pay',
-							't1.loan_date'
-						));
-						$this->db->from('coop_loan_atm_detail as t1');
-						$this->db->join('coop_loan_atm as t2', 't1.loan_atm_id = t2.loan_atm_id', 'inner');
-						$this->db->where("
-							t2.member_id = '".$row_member['member_id']."'
-							AND t2.loan_atm_status = '1'
-							AND t1.date_start_period <= '".$date_month_end."'
-							AND t1.loan_status = '0'
-						");
-						$row_atm = $this->db->get()->result_array();
-						$principal_per_month = 0;
-						$loan_amount_balance = 0;
-						if(!empty($row_atm)){
-							foreach($row_atm as $key_atm => $value_atm){
-								$loan_atm_id = @$value_atm['loan_atm_id'];
-								$principal_per_month += @$value_atm['principal_per_month'];
-								$loan_amount_balance += @$value_atm['loan_amount_balance'];
-							}
-							if(@$principal_per_month < @$loan_atm_setting['min_principal_pay_per_month']){
-								$principal_per_month = @$loan_atm_setting['min_principal_pay_per_month'];
-							}
-							if(@$principal_per_month > @$loan_amount_balance){
-								$principal_per_month = @$loan_amount_balance;
-							}
-							
-							$cal_loan_interest = array();
-							$cal_loan_interest['loan_atm_id'] = @$loan_atm_id;
-							$cal_loan_interest['date_interesting'] = @$date_month_end;
-							$interest = $this->loan_libraries->cal_atm_interest(@$cal_loan_interest);
-							
-							
-							$deduct_format = @$value2['deduct_format'];
-							if($deduct_format == '2'){
-								@$arr_list_loan[7]['loan_principle'] += @$principal_per_month;//ยอดที่ชำระต่อเดือน เงินต้น
-							}else{
-								@$arr_list_loan[7]['loan_interest'] += @$interest;//(ดอกเบี้ย)
-							}
-							$arr_list_loan[7]['loan_id'] = @$loan_atm_id;//loan_id
-						}
-					}
-				}
-				
-					
-				$this->db->select(array('*'));
-				$this->db->from('coop_loan_type');
-				$loan_type = $this->db->get()->result_array();
-				$list_loan = array();
-				$loan_principle_total = 0;
-				$loan_interest_total = 0;
-				if(!empty($loan_type)){
-					foreach($loan_type AS $key=>$value){						
-						$list_loan[$value['id']]['loan_name']= $value['loan_type'];//ชื่อเงินกู้หลัก
-						$list_loan[$value['id']]['loan_principle']= @$arr_list_loan[$value['id']]['loan_principle'];//ยอดที่ชำระต่อเดือน
-						$list_loan[$value['id']]['loan_interest'] = @$arr_list_loan[$value['id']]['loan_interest'];//(ดอกเบี้ย)
-						$loan_principle_total += @$arr_list_loan[$value['id']]['loan_principle'];
-						$loan_interest_total += @$arr_list_loan[$value['id']]['loan_interest'];
-					}
-				}
-				$arr_data['list_loan'] = @$list_loan;	
-			}
-			$arr_data['arr_list_loan'] = @$arr_list_loan;	
-			///////////////////////////////////////////////
-			
-			//เงินฝาก
-			$this->db->select(array('coop_maco_account.account_id','coop_maco_account.mem_id','coop_maco_account.account_name','coop_deposit_type_setting.type_name'));
-			$this->db->from('coop_maco_account');
-			$this->db->join("coop_deposit_type_setting","coop_maco_account.type_id = coop_deposit_type_setting.type_id AND deduct_loan = '1'","inner");
-			$this->db->where("coop_maco_account.mem_id = '".@$member_id."'");
-			$row_account= $this->db->get()->result_array();
-			$account_list = array();
-			if(!empty($row_account)){
-				foreach($row_account AS $key=>$value){
-					$this->db->select(array('transaction_balance','transaction_deposit'));
-					$this->db->from('coop_account_transaction');
-					$this->db->where("account_id = '".$value['account_id']."'");
-					$this->db->order_by('transaction_id DESC');
-					$this->db->limit(1);
-					$row_balance = $this->db->get()->result_array();
-					//$account_balance  = @$row_balance[0]['transaction_balance'];
-					$account_balance  = @$row_balance[0]['transaction_deposit'];
-					
-					$account_list[$value['account_id']]['account_id'] =  @$value['account_id'];
-					$account_list[$value['account_id']]['account_name'] =  @$value['account_name'];
-					$account_list[$value['account_id']]['account_balance'] =  @$account_balance;
-					//print_r($this->db->last_query());
-				}
-			}
-			$arr_data['account_list'] = @$account_list;			
-			
-			//ปิดสัญญาเดิม
-			//
-			/*
-			$this->db->select(array('t1.*','t3.loan_type_code'));
-			$this->db->from("coop_loan as t1");
-			$this->db->join("coop_loan_name as t2",'t1.loan_type = t2.loan_name_id','inner');
-			$this->db->join("coop_loan_type as t3",'t2.loan_type_id = t3.id','inner');
-			$this->db->where("t1.id = '".@$loan_id."'");
-			$rs_loan = $this->db->get()->result_array();
-			$rs_loan = $rs_loan[0];	
-			*/			
-			
-			$date_interesting = date('Y-m-d');
-			$list_old_loan = array();
-			
-			$this->db->select(array('t1.*',
-									't2.contract_number',
-									't2.loan_amount_balance',
-									't2.id'
-									));
-			$this->db->from("coop_loan_prev_deduct t1");
-			$this->db->join("coop_loan t2",'t1.ref_id = t2.id','inner');
-			$this->db->where("t1.loan_id = '".@$loan_id."' AND t1.data_type = 'loan'");
-			$row = $this->db->get()->result_array();
-			$index = 0;
-			if(@$_GET['dev'] == 'dev'){
-				echo 'coop_loan_prev_deduct<br>';
-				print_r($this->db->last_query()); //exit;
-			}
-			$extra_debt = array();
-			foreach($row as $key => $value){
-				$list_old_loan[$index]['contract_number'] = @$value['contract_number'];
-				
-				$extra_debt_amount	= 0;//หนี้ห้อย
-				/*if(date("Y-m", strtotime($rs_loan[0]['createdatetime']) ) != date("Y-m") ){
-					$month = date("m", strtotime("+1 months", strtotime($rs_loan[0]['createdatetime'])) );
-					if($month=="01"){
-						$year = date("Y", strtotime($rs_loan[0]['createdatetime']) ) + 543 + 1;
-					}else{
-						$year = date("Y", strtotime($rs_loan[0]['createdatetime']) ) + 543;
-					}
-					
-					$this->db->select('profile_id');
-					$this->db->from('coop_finance_month_profile');
-					$this->db->where("profile_month = '".(int)$month."' AND profile_year = '".$year."' ");
-					$profile_id = $this->db->get()->result_array()[0]['profile_id'];
-					if(@$_GET['dev'] == 'dev'){
-						echo '<hr>';
-						print_r($this->db->last_query());
-					}
-					$this->db->select("sum(pay_amount) as sum_of_pay_amount");
-					$finance_month_detail = $this->db->get_where("coop_finance_month_detail", array(
-						"profile_id" => $profile_id,
-						"member_id" => $rs_loan[0]['member_id'],
-						"loan_id" => $value['id'],
-						"pay_type" => "principal",
-						"run_status" => 0
-					))->result_array()[0];
-					if(@$_GET['dev'] == 'dev'){
-						echo '<hr>';
-						print_r($this->db->last_query());
-						echo '<hr>'.date("Y-m", strtotime($rs_loan[0]['createdatetime']) ).' !='. date("Y-m").'<br>';
-					}
-					if($finance_month_detail && $rs_loan[0]['loan_status']==0){
-						$extra_debt['total_princical'] += $finance_month_detail['sum_of_pay_amount'];
-						$extra_debt_amount	= $finance_month_detail['sum_of_pay_amount'];
-					}
-						
-				}
-				*/
-
-				if($value['pay_type'] == 'principal'){	
-					if(@$_GET['dev'] == 'dev'){
-						echo 'pay_amount='.@$value['pay_amount'].'<br>';
-						echo 'extra_debt_amount='.@$extra_debt_amount.'<br>';
-					}				
-					$list_old_loan[$index]['loan_id'] = @$value['id'];
-					$list_old_loan[$index]['loan_amount_balance'] = @$value['pay_amount'] - $extra_debt_amount;
-					$list_old_loan[$index]['loan_interest_amount'] = 0;
-				}else{
-					$list_old_loan[$index]['loan_id'] = @$value['id'];
-					$list_old_loan[$index]['loan_amount_balance'] = @$value['pay_amount'] - $extra_debt_amount - @$value['interest_amount'];
-					$list_old_loan[$index]['loan_interest_amount'] = @$value['interest_amount'];
-					/*$list_old_loan[$index]['loan_amount_balance'] = @$value['loan_amount_balance'];
-					$cal_loan_interest = array();
-					$cal_loan_interest['loan_id'] = @$value['ref_id'];
-					$cal_loan_interest['date_interesting'] = $this->center_function->ConvertToSQLDate(@$date_interesting);
-					$interest_data = $this->loan_libraries->cal_loan_interest($cal_loan_interest);
-					$list_old_loan[$index]['loan_interest_amount'] = @$interest_data;
-					*/
-				}
-				$index++;
-			}
-			
-			//ปิดปัญชีกู้ฉุกเฉิน ATM
-			$this->db->select(array('t1.*',
-									't2.contract_number',
-									't2.total_amount_approve',
-									't2.total_amount_balance',
-									't2.loan_atm_id'
-									));
-			$this->db->from("coop_loan_prev_deduct t1");
-			$this->db->join("coop_loan_atm t2",'t1.ref_id = t2.loan_atm_id','inner');
-			$this->db->where("t1.loan_id = '".@$loan_id."' AND t1.data_type = 'atm'");
-			$row = $this->db->get()->result_array();
-			if(@$_GET['dev'] == 'dev'){
-				print_r($this->db->last_query()); //exit;
-				echo '<pre>'; print_r(@$row); echo '</pre>';
-			}
-			
-			foreach($row as $key => $value){
-				$list_old_loan[$index]['contract_number'] = @$value['contract_number'];
-				if($value['pay_type'] == 'principal'){					
-					$list_old_loan[$index]['loan_id'] = @$value['loan_atm_id'];
-					//$list_old_loan[$index]['loan_amount_balance'] = @$value['total_amount_approve'] - @$value['total_amount_balance'];
-					$list_old_loan[$index]['loan_amount_balance'] = @$value['pay_amount'] - @$value['interest_amount'];
-					$list_old_loan[$index]['loan_interest_amount'] = 0;
-				}else{
-					$list_old_loan[$index]['loan_id'] = @$value['loan_atm_id'];
-					//$list_old_loan[$index]['loan_amount_balance'] = @$value['total_amount_approve'] - @$value['total_amount_balance'];
-					$list_old_loan[$index]['loan_amount_balance'] = @$value['pay_amount'] - @$value['interest_amount'];
-					/*$cal_loan_interest = array();
-					//$cal_loan_interest['loan_id'] = @$value['ref_id'];
-					$cal_loan_interest['loan_atm_id'] = @$value['ref_id'];
-					$cal_loan_interest['date_interesting'] = $this->center_function->ConvertToSQLDate(@$date_interesting);
-					$interest_atm = $this->loan_libraries->cal_atm_interest_deduct($cal_loan_interest);
-					$list_old_loan[$index]['loan_interest_amount'] = @$interest_atm;
-					*/
-					$list_old_loan[$index]['loan_interest_amount'] = @$value['interest_amount'];
-				}
-				$index++;
-			}	
-			
-			if(@$_GET['dev'] == 'dev'){
-					echo '<pre>'; print_r(@$list_old_loan); echo '</pre>';
-			}
-			
-			$arr_data['list_old_loan'] = @$list_old_loan;
-			$total_principal = 0;
-			$total_interest = 0;
-			$total_loan_balance = 0;
-			if(!empty($list_old_loan)){
-				foreach($list_old_loan AS $key => $value){
-					$total_principal += @$value['loan_amount_balance'];
-					$total_interest += @$value['loan_interest_amount'];
-					$total_loan_balance += @$value['loan_amount_balance']+@$value['loan_interest_amount'];
-				}
-			}
-			
-			$arr_data['existing_loan'] = @$total_loan_balance; //หักเงินกู้เดิม
-			$arr_data['principal_load'] = @$total_principal;//ภาระเงินต้น
-			$arr_data['interest_burden'] = @$total_interest;//ภาระดอกเบี้ย
-			$arr_data['extra_debt'] = @$extra_debt;//หนี้ห้อย
-			
-			$loan_amount = @$row_loan['loan_amount']; //วงเงินที่ขออนุมัติ		
-			
-			$month_receipt = date("m", strtotime($row_loan['createdatetime']));
-			$year_receipt = date("Y", strtotime($row_loan['createdatetime']));
-			
-			$this->db->select(array('deduct_id','deduct_code','deduct_detail','deduct_type','deduct_format','deposit_type_id','deposit_amount'));
-			$this->db->from('coop_deduct');
-			$this->db->order_by('deduct_seq ASC');
-			$deduct_list = $this->db->get()->result_array();
-			$data_arr['deduct_list'] = @$deduct_list;
-			//
-			
-			$deductible =  0 ;			
-			//ค่าธรรมเนียม 
-			$this->db->select(array('*'));
-			$this->db->from('coop_loan_deduct');
-			$this->db->where("loan_id = '{$loan_id}'");
-			$rs_deduct = $this->db->get()->result_array();
-			//echo $loan_id.'<hr>';
-			//echo '<pre>'; print_r($rs_deduct); echo '</pre>';
-			if(!empty($rs_deduct)){
-				foreach($rs_deduct AS $key=>$row_deduct){
-					if(!in_array($row_deduct['loan_deduct_list_code'], array( 'deduct_pay_prev_loan', 'deduct_cheque'))){
-						$deductible += @$row_deduct['loan_deduct_amount'];
-					}
-					
-					if($row_deduct['loan_deduct_list_code'] == 'deduct_loan_fee'){
-						$arr_data['deduct_loan_fee'] = @$row_deduct['loan_deduct_amount'];
-					}
-					
-					if($row_deduct['loan_deduct_list_code'] == 'deduct_person_guarantee'){
-						//มีการกำหนดกรณีไม่ผ่านเกณฑ์
-						$arr_data['deduct_person_guarantee'] = @$row_deduct['loan_deduct_amount'];
-					}
-
-					if($row_deduct['loan_deduct_list_code'] == 'deduct_insurance'){
-						//เบี้ยประกัน
-						$arr_data['deduct_insurance'] = @$row_deduct['loan_deduct_amount'];
-					}
-
-					if($row_deduct['loan_deduct_list_code'] == 'deduct_cheque'){
-                        $arr_data['deduct_cheque'] = @$row_deduct['loan_deduct_amount'];
-                    }
-				}
-			}
-			//exit;			
-			
-			$arr_data['deductible'] =  @$deductible; //รายการหัก
-			$total_amount = @$loan_amount - @$total_loan_balance - @$deductible - @$arr_data['deduct_cheque'];
-			$arr_data['total_amount'] = @$total_amount;
-			
-			$arr_data['total_paid_per_month'] =  @$total_paid_per_month; //รวมชำระต่องวด
-			
-			//รายการรับเงิน	
-			$arr_receiving_money = array();
-			//ชำระหนี้สถาบันการเงิน
-			$this->db->select(array('*'));
-			$this->db->from('coop_loan_financial_institutions');
-			$this->db->where("loan_id = '".@$loan_id."'");
-			$this->db->order_by("order_by ASC");
-			$rs_financial_institutions = $this->db->get()->result_array();
-			
-			$i=0;
-			$financial_amount = 0;
-			foreach($rs_financial_institutions AS $key=>$row_financial_institutions){
-				$arr_receiving_money[$i]['transfer_type'] = 'จ่ายธนาคาร'.@$row_financial_institutions['financial_institutions_name'];
-				$arr_receiving_money[$i]['total_received'] = @$row_financial_institutions['financial_institutions_amount'];
-				$financial_amount += @$row_financial_institutions['financial_institutions_amount'];
-				$i++;
-			}
-			
-			//การจ่ายเงินกู้
-			$transfer_type = array('0'=>'เงินสด','1'=>'โอนเงินบัญชีสหกรณ์','2'=>'โอนเงินบัญชี','3' => 'พร้อมเพย์', '4' => 'เช็คเงินสด');
-			if(@$row_loan['transfer_type'] == '2'){
-				$transfer_type_description = '';
-				$transfer_type_description .= @$row_loan['bank_name'];
-				$transfer_type_description .= '<br> เลขที่บัญชี '.@$row_loan['transfer_bank_account_id'];
-			}else if(@$row_loan['transfer_type'] == '1'){
-				$transfer_type_description = ' '.@$row_loan['transfer_account_id'].':'.@$row_loan['account_name'];
-			}else{
-				$transfer_type_description = '';
-			}
-			$text_transfer_type = @$transfer_type[@$row_loan['transfer_type']].@$transfer_type_description;
-			
-			//ยอดเงินที่จะได้รับโดยประมาณ
-			$this->db->select(array('estimate_receive_money'));
-			$this->db->from('coop_loan_deduct_profile');
-			$this->db->where("loan_id = '".@$loan_id."'");
-			$loan_deduct_profile = $this->db->get()->result_array();
-			$estimate_receive_money = @$loan_deduct_profile[0]['estimate_receive_money'];			
-			
-			$arr_receiving_money[$i]['transfer_type'] = @$text_transfer_type;
-			$arr_receiving_money[$i]['total_received'] = @$estimate_receive_money-@$financial_amount;
-			
-			$arr_data['receiving_money'] = $arr_receiving_money;		
-					
-			$arr_data['total_month'] = @$share_month+@$deposit_month+@$loan_principle_total;//รวมทั้งสิ้น รายการผ่อนชำระสหกรณ์ปัจจุบัน/เดือน
-			$arr_data['total_month_interest'] = @$share_month_interest+@$deposit_month_interest+@$loan_interest_total;//รวมทั้งสิ้น รายการผ่อนชำระสหกรณ์ปัจจุบัน/เดือน(ดอกเบี้ย)
-			
-			//บุคคลค้ำประกัน
-			$this->db->select(array(
-				't1.*',
-				't3.member_id',
-				't3.firstname_th',
-				't3.lastname_th',
-				't3.mem_group_id',
-				't3.salary',
-				't3.birthday',
-				't3.member_date',
-				't3.share_month',
-				't4.mem_group_name',
-				't5.prename_full'
-			));
-			$this->db->from('coop_loan_guarantee_person as t1');
-			$this->db->join('coop_mem_apply as t3','t1.guarantee_person_id = t3.member_id','inner');
-			$this->db->join("coop_mem_group as t4", "t3.level = t4.id", "left");
-			$this->db->join("coop_prename as t5", "t3.prename_id = t5.prename_id", "left");
-			$this->db->where("t1.loan_id = '{$loan_id}' AND t3.member_status <> '3'");
-			$this->db->order_by("t1.id ASC");
-			$rs_guarantee = $this->db->get()->result_array();
-			foreach($rs_guarantee AS $key=>$row_guarantee){
-				$this->db->from('coop_loan_guarantee_person as t1');
-				$this->db->join('coop_loan as t2','t1.loan_id = t2.id ','inner');
-				$this->db->where("
-					t1.guarantee_person_id = '".@$row_guarantee['guarantee_person_id']."' 
-					AND t2.loan_status IN('1','2')
-				");
-				$rs_count_guarantee = $this->db->get()->result_array();
-				$n=0;
-				foreach($rs_count_guarantee as $key_count => $row_count_guarantee){
-					$n++;
-				}
-				@$rs_guarantee[$key]['count_guarantee'] = @$n;
-
-				$share = $this->db->select("share_period, share_collect_value")->from("coop_mem_share")->where("share_date <= '".$row_loan["createdatetime"]."' AND member_id = '".$row_guarantee['guarantee_person_id']."' AND share_status IN (1,5,6)")->order_by("share_date DESC")->get()->row();
-				$rs_guarantee[$key]['share_balance'] = $share->share_collect_value;
-				$rs_guarantee[$key]['share_period'] = $share->share_period;
-
-				//ข้อมูลค้ำประกันเงินกู้
-				$guarantors_raw = $this->db->select("t3.member_id, t2.contract_number, t3.firstname_th, t3.lastname_th, t4.prename_full, t1.loan_id")
-							->from("coop_loan_guarantee_person as t1")
-							->join("coop_loan as t2", "t1.loan_id = t2.id", "INNER")
-							->join("coop_mem_apply as t3", "t2.member_id = t3.member_id", "LEFT")
-							->join("coop_prename as t4", "t3.prename_id = t4.prename_id", "LEFT")
-							->where("t1.guarantee_person_id = '".$row_guarantee['guarantee_person_id']."'")
-							->get()->result_array();
-				$guarantors = array();
-				foreach($guarantors_raw as $data) {
-					$transaction = $this->db->select("*")->from("coop_loan_transaction")->where("loan_id = '".$data["loan_id"]."' AND transaction_datetime <= '".$row_loan["createdatetime"]."'")->order_by("transaction_datetime DESC")->get()->row();
-					if($transaction->loan_amount_balance > 0) {
-						$guarantors[] = $data;
-					}
-				}
-
-				$rs_guarantee[$key]["guarantors"] = $guarantors;
-
-                //หุ้นค้ำประกัน
-                $res_guarantee =  $this->db->get_where('coop_loan_guarantee', array('loan_id' => $loan_id))->row_array();
-                $arr_data['g_share_amt'] = $res_guarantee['amount'];
-
-
-                $loans = array();
-				$loan_raw = $this->db->select("t1.id as loan_id, t1.approve_date, t1.contract_number, t1.date_last_interest, t1.loan_amount, t1.money_per_period, t1.period_amount, t1.period_now")
-							->from("coop_loan as t1")
-							->where("t1.member_id = '".$row_guarantee['guarantee_person_id']."' AND t1.loan_status IN (1,4,6,7,8) AND t1.id != '".$_GET["loan_id"]."'")
-							->get()->result_array();
-				foreach($loan_raw as $loan) {
-					$transaction = $this->db->select("*")->from("coop_loan_transaction")->where("loan_id = '".$loan["loan_id"]."' AND transaction_datetime <= '".$row_loan["createdatetime"]."'")->order_by("transaction_datetime DESC")->get()->row();
-					if($transaction->loan_amount_balance > 0) {
-						$loan["balance"] = $transaction->loan_amount_balance;
-						$loans[] = $loan;
-					}
-				}
-				$rs_guarantee[$key]["loans"] = $loans;
-
-			}	
-			$arr_data['row_guarantee'] = @$rs_guarantee;	
-			
-			//รายการซื้อ	
-			$this->db->select(array('*'));
-			$this->db->from('coop_loan_deduct_list');
-			$this->db->where("loan_deduct_list_code != 'deduct_pay_prev_loan' AND loan_deduct_status = 1");
-			$this->db->order_by('run_id ASC');
-			$row = $this->db->get()->result_array();
-			$arr_data['loan_deduct_list'] = $row;	
-			
-			$this->db->select(array(
-				'loan_deduct_list_code',
-				'loan_deduct_amount'
-			));
-			$this->db->from('coop_loan_deduct');
-			$this->db->where("loan_id = '".$loan_id."'");
-			$row = $this->db->get()->result_array();
-			$loan_deduct = array();
-			foreach($row as $key => $value){
-				$loan_deduct[$value['loan_deduct_list_code']] = $value['loan_deduct_amount'];
-			}
-			$arr_data['loan_deduct'] = $loan_deduct;
-			
-			//ค่าใช้จ่าย
-//			$this->db->from('coop_loan_cost');
-//			$this->db->where("loan_id = '".$loan_id."' AND member_id = '".$member_id."'");
-//			$this->db->limit(1);
-//			$rs_cost = $this->db->get()->result_array();
-//			$row_cost = @$rs_cost[0];
-//			$arr_data['school_benefits'] = $row_cost['school_benefits'];
-//			$arr_data['saving'] = @$row_cost['saving'];
-//			$arr_data['ch_p_k'] = @$row_cost['ch_p_k'];
-//			$arr_data['pension'] = @$row_cost['pension'];
-//			$arr_data['k_b_k'] = @$row_cost['k_b_k'];
-//			$arr_data['other'] = @$row_cost['other'];
-
-            //รายได้
-            $sql = "SELECT
-				*, 
-				IFNULL((select coop_income_loan_detail.income_value from coop_income_loan_detail where coop_income_loan_detail.loan_id = '".$loan_id."' and coop_income_loan_detail.income_id = coop_income.id), 0) as income_value
-			FROM
-				`coop_income`
-			ORDER BY
-				`seq` ASC";
-
-            if($_GET['sql'] == 'show'){
-                echo $sql; exit;
-            }
-            $arr_data['income'] = $this->db->query($sql)->result_array();
-
-            //ค่าใช้จ่าย
-            $arr_data['loan_cost_code'] = array();
-            $this->db->select('outgoing_code, outgoing_name, loan_cost_amount');
-            $this->db->from("coop_outgoing");
-            $this->db->join("coop_loan_cost_mod", "coop_outgoing.outgoing_code=coop_loan_cost_mod.loan_cost_code", "inner");
-            $this->db->where("loan_id = '".$loan_id."' AND member_id = '".$member_id."'");
-            $rs_cost = $this->db->get()->result_array();
-            $arr_data['loan_cost_code'] = $rs_cost;
-//            foreach ($rs_cost as $key => $val){
-//                $arr_data['loan_cost_code'] = $val['loan_cost_amount'];
-//            }
-
-			//อสังหาทรัพย์ค้ำประกัน
-			$this->db->select(array('t1.*',
-									't2.province_name',
-									't3.amphur_name',
-									't4.district_name'
-								));
-			$this->db->from("coop_loan_guarantee_real_estate t1");
-			$this->db->join("coop_province t2","t1.province_id = t2.province_id","left");
-			$this->db->join("coop_amphur t3","t1.amphur_id = t3.amphur_id","left");
-			$this->db->join("coop_district t4","t1.district_id = t4.district_id","left");
-			$this->db->where("t1.loan_id = '".$loan_id."'");
-			$rs_real_estate = $this->db->get()->result_array();
-			$arr_data['row_real_estate'] = @$rs_real_estate[0];
-			
-			//$member_id = @$_GET['member_id'];
-			//$loan_id = @$_GET['loan_id'];
-			//@start ข้อมูลประกันชีวิต
-			$rs_cremation_type = $this->db->select('import_cremation_type,import_amount_balance')
-			->from('coop_life_insurance_cremation')
-			->where("member_id = '".$member_id."' AND loan_id = '".$loan_id."'")
-			->get()->result_array();
-			$cremation_type_1 = 0;
-			$cremation_type_2 = 0;
-			foreach($rs_cremation_type AS $key=>$row_cremation_type){
-				//ชสอ
-				if($row_cremation_type['import_cremation_type'] == '1'){
-					$cremation_type_1 = @$row_cremation_type['import_amount_balance'];
-				}
-				
-				//สสอค
-				if($row_cremation_type['import_cremation_type'] == '2'){
-					$cremation_type_2 = @$row_cremation_type['import_amount_balance'];
-				}
-			}
-			$arr_data['cremation_type_1'] = @$cremation_type_1;
-			$arr_data['cremation_type_2'] = @$cremation_type_2;			
-				
-			$row_life_insurance = $this->db->select('insurance_year,insurance_date,insurance_amount,insurance_premium,insurance_new,insurance_old')
-			->from('coop_life_insurance')
-			->where("member_id = '".$member_id."' AND loan_id = '".$loan_id."'")
-			->limit(1)
-			->get()->result_array();
-			
-			$arr_data['life_insurance_4'] = @$row_life_insurance[0]['insurance_old'];
-			$arr_data['life_insurance_5'] = @$row_life_insurance[0]['insurance_new'];	
-			$arr_data['life_insurance_6'] = @$row_life_insurance[0]['insurance_amount'];	
-			//@end ข้อมูลประกันชีวิต
-
-			//ข้อมูลค้ำประกันเงินกู้
-			$guarantors_raw = $this->db->select("t3.member_id, t2.contract_number, t3.firstname_th, t3.lastname_th, t4.prename_full, t1.loan_id")
-									->from("coop_loan_guarantee_person as t1")
-									->join("coop_loan as t2", "t1.loan_id = t2.id", "INNER")
-									->join("coop_mem_apply as t3", "t2.member_id = t3.member_id", "LEFT")
-									->join("coop_prename as t4", "t3.prename_id = t4.prename_id", "LEFT")
-									->where("t1.guarantee_person_id = '".$member_id."'")
-									->get()->result_array();
-			$guarantors = array();
-			foreach($guarantors_raw as $data) {
-				$transaction = $this->db->select("*")->from("coop_loan_transaction")->where("loan_id = '".$data["loan_id"]."' AND transaction_datetime <= '".$row_loan["createdatetime"]."'")->order_by("transaction_datetime DESC")->get()->row();
-				if($transaction->loan_amount_balance > 0) {
-					$guarantors[] = $data;
-				}
-			}
-
-			$arr_data["guarantors"] = $guarantors;
-
-			$loans = array();
-			$loan_raw = $this->db->select("t1.id as loan_id, t1.approve_date, t1.contract_number, t1.date_last_interest, t1.loan_amount, t1.money_per_period, t1.period_amount, t1.period_now")
-									->from("coop_loan as t1")
-									->where("t1.member_id = '".$member_id."' AND t1.loan_status IN (1,4,6,7,8) AND t1.id != '".$_GET["loan_id"]."'")
-									->get()->result_array();
-			foreach($loan_raw as $loan) {
-				// 2019-12-31 00:00:00
-				$transaction = $this->db->select("*")->from("coop_loan_transaction")->where("loan_id = '".$loan["loan_id"]."' AND transaction_datetime <= '".$row_loan["createdatetime"]."'")->order_by("transaction_datetime DESC")->get()->row();
-				if($transaction->loan_amount_balance > 0) {
-					$loan["balance"] = $transaction->loan_amount_balance;
-					$loans[] = $loan;
-				}
-			}
-			$arr_data["loans"] = $loans;
-
-			$board_raw = $this->db->select("*")->from("coop_loan_board")->get()->result_array();
-			$boards = array();
-			foreach($board_raw as $board) {
-				if($board["level"] != "board") {
-					$boards[$board["level"]] = $board;
-				} else {
-					$boards["boards"][] = $board;
-				}
-			}
-			$arr_data["boards"] = $boards;
+        $code_name = 'report_loan_data_model';
+        $this->db->select('*');
+        $this->db->from('format_setting_report');
+        $this->db->where('code_name', $code_name);
+        $switch_report = $this->db->get()->row_array();
+        if($switch_report['switch_code'] == '1'){
+			$arr_data = $this->report_loan_data_model->get_report_loan_data();
+			$this->preview_libraries->template_preview('report_loan_data/coop_report_loan_detail_preview', $arr_data);
+        }else if($switch_report['switch_code'] == '2'){
+			$arr_data = $this->report_loan_data_model->get_report_loan_data_1();
+			$this->preview_libraries->template_preview('report_loan_data/coop_report_loan_detail_preview_1', $arr_data);
 		}
 
-		$arr_data['person_guarantee'] = $this->db->select('person_guarantee')->from('coop_term_of_loan')->where('type_id', $row_loan['loan_type'])->order_by('start_date', 'desc')->limit(1)->get()->row_array()['person_guarantee'];
-
-		$this->preview_libraries->template_preview('report_loan_data/coop_report_loan_detail_preview',$arr_data);
 	}
 	function coop_report_loan_deduct($loan_id=''){
 		$arr_data = array();
diff --git a/application/models/Contract_modal.php b/application/models/Contract_modal.php
index 7d1db75..8cbc6a7 100644
--- a/application/models/Contract_modal.php
+++ b/application/models/Contract_modal.php
@@ -135,6 +135,10 @@ class Contract_modal extends CI_Model
                     $principal_month += $value2['pay_amount'];
                 }
                 $principal = $value['loan_amount_balance'] - $principal_month;
+                if($this->Setting_model->get("calc_interest_on_getPrevLoan_have_finance_month_detail")==1){
+                    $interest_loan = $this->loan_libraries->calc_interest_loan_multi_rate($loan_amount, $loan_type, $date1, $date2);
+                    $interest_loan = ROUND($interest_loan, 2);
+                }
             }else{
                 $interest_loan = $this->loan_libraries->calc_interest_loan_multi_rate($loan_amount, $loan_type, $date1, $date2);
                 $interest_loan = ROUND($interest_loan, 2);
@@ -216,7 +220,8 @@ class Contract_modal extends CI_Model
         //$year  = (double)$data_post["year"];
         $year = (double)date('Y', strtotime($contract['createdatetime']));
         $_period_amt = self::parseFloat($contract['period_amount']);
-
+        $rounding_calc_period_interest = $this->Setting_model->get("rounding_calc_period_interest");
+        $round_interest = $this->Setting_model->get("round_interest");
         //หาดอกเบี้ยหัก ณ ที่จ่าย
         $payment_interest_current = 0;
 
@@ -237,11 +242,11 @@ class Contract_modal extends CI_Model
         } else {
             $day_of_month = date('t', strtotime($date_interest));
         }
-        if ($day >= 6) {
+        if ($day >= 1) {
             //$day = date('t', strtotime($day_of_month));
-            $month += 1;
+            // $month += 1;
         }
-
+        
         if ($month > 12) {
             $month = 1;
             $year += 1;
@@ -298,7 +303,7 @@ class Contract_modal extends CI_Model
                         $year += 1;
                     }
 
-                    $loan_pri = ceil($a / 10) * 10;
+                    $loan_pri = ceil($a / $rounding_calc_period_interest) * $rounding_calc_period_interest;
                     $nummonth = cal_days_in_month(CAL_GREGORIAN, $month, ($year));
                     $summonth = $nummonth;
                     $daydiff = 31 - $day;
@@ -317,21 +322,22 @@ class Contract_modal extends CI_Model
 
                     $summonth = self::force_summonth($summonth, $i);
                     //echo "1 :: ".$daydiff." :: ".$summonth." :: ".$date_start; exit;
-                    $loan_int = round($loan_remain * ($interest / (self::cal_days_in_year(($year)) / $summonth)) / 100, 2);
+                    $loan_int = round($loan_remain * ($interest / (self::cal_days_in_year(($year)) / $summonth)) / 100, $round_interest);
                     if ($loan_pri < 0) {
                         $loan_pri = 0;
                     }
                     $loan_pay = $loan_pri + $loan_int;
-                    $loan_remain -= ceil($loan_pri / 10) * 10;
+                    $loan_remain -= ceil($loan_pri / $rounding_calc_period_interest) * $rounding_calc_period_interest;
                 } else if ($period_type == 2) {
                     if ($month > 12) {
                         $month = 1;
                         $year += 1;
                     }
-                    $nummonth = cal_days_in_month(CAL_GREGORIAN, $month, ($year));
-                    $summonth = $nummonth;
-                    $daydiff = 31 - $day;
+                    
                     if ($i == 1) {
+                        $nummonth = cal_days_in_month(CAL_GREGORIAN, $month, ($year));
+                        $daydiff = $nummonth - $day;
+                        $summonth = $daydiff;
                         if ($daydiff >= 0) {
                             $month += 1;
                             if ($month > 12) {
@@ -339,15 +345,17 @@ class Contract_modal extends CI_Model
                                 $year += 1;
                             }
                             $nummonth = cal_days_in_month(CAL_GREGORIAN, $month, ($year));
-                            $summonth = $nummonth;
-                            $summonth = $daydiff + 31;
+                            $summonth += $nummonth;
                         }
+                    }else{
+                        $nummonth = cal_days_in_month(CAL_GREGORIAN, $month, ($year));
+                        $summonth = $nummonth;
                     }
 
                     $summonth = self::force_summonth($summonth, $i);
                     //echo "2 :: ".$daydiff." :: ".$summonth; exit;
-                    $loan_pri = ceil($period / 100) * 100;
-                    $loan_int = round($loan_remain * ($interest / (self::cal_days_in_year(($year)) / $summonth)) / 100, 2);
+                    $loan_pri = ceil($period / $rounding_calc_period_interest) * $rounding_calc_period_interest;
+                    $loan_int = round($loan_remain * ($interest / (self::cal_days_in_year(($year)) / $summonth)) / 100, $round_interest);
                     if ($loan_pri < 0) {
                         $loan_pri = 0;
                     }
@@ -361,7 +369,7 @@ class Contract_modal extends CI_Model
                         $year += 1;
                     }
 
-                    $loan_pri = ceil($a / 100) * 100;
+                    $loan_pri = ceil($a / $rounding_calc_period_interest) * $rounding_calc_period_interest;
                     $nummonth = cal_days_in_month(CAL_GREGORIAN, $month, ($year));
                     $summonth = $nummonth;
                     $daydiff = date('t', strtotime(($year) . '-' . sprintf('%02d', $month) . '-' . $day)) - $day;
@@ -379,14 +387,14 @@ class Contract_modal extends CI_Model
                     }
                     $summonth = self::force_summonth($summonth, $i);
                     //echo "3 :: ".$daydiff." :: ".$summonth; exit;
-                    $loan_int = round($loan_remain * ($interest / (self::cal_days_in_year(($year)) / $summonth)) / 100, 2);
+                    $loan_int = round($loan_remain * ($interest / (self::cal_days_in_year(($year)) / $summonth)) / 100, $round_interest);
                     $loan_pri = $loan_pri - $loan_int;
                     if ($loan_pri < 0) {
                         $loan_pri = 0;
                     }
                     $loan_pay = $loan_pri + $loan_int;
 
-                    $loan_remain -= ceil($loan_pri / 10) * 10;
+                    $loan_remain -= ceil($loan_pri / $rounding_calc_period_interest) * $rounding_calc_period_interest;
                 } else if ($period_type == 2) {
                     if ($month > 12) {
                         $month = 1;
diff --git a/application/models/Report_loan_data_model.php b/application/models/Report_loan_data_model.php
new file mode 100644
index 0000000..b3914a5
--- /dev/null
+++ b/application/models/Report_loan_data_model.php
@@ -0,0 +1,2255 @@
+<?php if( ! defined('BASEPATH')) exit('No direct script access allowed');
+
+
+class Report_loan_data_model extends CI_Model
+{
+
+    public function __construct()
+    {
+        parent::__construct();
+    }
+
+    public function get_report_loan_data(){
+        $member_id = @$_GET['member_id'];
+		$loan_id = @$_GET['loan_id'];
+		if($member_id != '') {
+			//@start ดึงข้อมูลในตารางเก็บข้อมูลรายละเอียดการขอกู้เงิน เพื่อใช้ดูข้อมูลย้อนหลัง
+			$this->db->select('*');
+			$this->db->from('coop_loan_report_detail');
+			$this->db->where("loan_id = '".$loan_id."'");
+			$rs_report_detail = $this->db->get()->result_array();
+			$row_report_detail = $rs_report_detail[0];
+			$arr_data['row_report_detail'] = $row_report_detail;			
+			//@end ดึงข้อมูลในตารางเก็บข้อมูลรายละเอียดการขอกู้เงิน เพื่อใช้ดูข้อมูลย้อนหลัง
+			
+			$this->db->select('coop_mem_apply.*,
+							coop_mem_type.mem_type_name,
+							department.mem_group_full_name AS department_name,
+							faction.mem_group_full_name AS faction_name,
+							level.mem_group_full_name AS level_name',
+							'prename.prename_full'
+							);
+			$this->db->from('coop_mem_apply');
+			$this->db->join("coop_mem_type","coop_mem_apply.mem_type_id = coop_mem_type.mem_type_id","left");
+			$this->db->join("coop_mem_group as department","coop_mem_apply.department = department.id","left");
+			$this->db->join("coop_mem_group as faction","coop_mem_apply.faction = faction.id","left");
+			$this->db->join("coop_mem_group as level","coop_mem_apply.level = level.id ","left");
+			$this->db->join("coop_prename as prename","coop_mem_apply.prename_id = prename.prename_id ","left");
+			$this->db->where("coop_mem_apply.member_id = '".$member_id."'");
+			$rs_member = $this->db->get()->result_array();
+			$row_member = $rs_member[0];
+			$arr_data['row_member'] = $row_member;
+			
+			$this->db->select(array(
+				't1.*',
+				't3.loan_name as loan_type_detail',
+				't3.loan_type_id',
+				't4.id',
+				't5.bank_name',
+				't6.account_name',
+				't7.user_name AS admin_name'
+			));
+			$this->db->from('coop_loan as t1');			
+			$this->db->join('coop_loan_name as t3','t1.loan_type = t3.loan_name_id','inner');
+			$this->db->join("coop_loan_type as t4",'t3.loan_type_id = t4.id','inner');
+			$this->db->join("coop_bank as t5",'t1.transfer_bank_id = t5.bank_id','left');
+			$this->db->join("coop_maco_account as t6",'t1.transfer_account_id = t6.account_id','left');
+			$this->db->join("coop_user AS t7",'t1.admin_id = t7.user_id','left');
+			$this->db->where("t1.member_id = '".$member_id."' AND t1.id='".$loan_id."'");
+			$this->db->order_by("t1.id DESC");
+			$rs_loan = $this->db->get()->result_array();
+			$row_loan =  @$rs_loan[0];
+			$arr_data['row_loan'] = @$row_loan;
+			$createdate_loan = date("Y-m-d", strtotime($row_loan['createdatetime']));
+			if(@$_GET['dev'] == 'dev'){
+				echo $this->db->last_query(); 
+				echo '<hr>';
+			}
+			$this->db->select(array(
+				//' MAX(total_paid_per_month) AS total_paid_per_month'
+				'principal_payment',
+				'total_paid_per_month'
+			));
+			$this->db->from('coop_loan_period');
+			$this->db->where("loan_id='".$loan_id."' AND date_count = '31'");
+			$this->db->limit(1);
+			$per_month = $this->db->get()->result_array();
+			//echo $this->db->last_query(); 
+			if(@$row_loan['pay_type'] == '1'){
+				$total_paid_per_month = @round(@$per_month[0]['principal_payment'],2);
+				$pay_type_name = "แบบคงต้น";
+				
+				//ดอกเบี้ย 30 วัน ของจากยอดกู้เต็ม
+				$date_count = 31;
+				$interest_30_day = (((@$row_loan['loan_amount']*@$row_loan['interest_per_year'])/100)/365)*@$date_count;
+				if(@$_GET['dev'] == 'dev'){
+					echo '((('.@$row_loan['loan_amount'].'*'.@$row_loan['interest_per_year'].')/100)/365)*'.@$date_count.'<br>';
+				}	
+				$interest_30_day = round(@$interest_30_day, 2);
+			}else{
+				$total_paid_per_month = @round(@$per_month[0]['total_paid_per_month'],2);
+				$pay_type_name = "แบบคงยอด";
+				$interest_30_day  = 0;
+			}
+			//$total_paid_per_month = round(@$per_month[0]['total_paid_per_month'],-2);
+			$arr_data['total_paid_per_month'] = @$total_paid_per_month;
+			$arr_data['pay_type'] = @$pay_type_name;			
+			$arr_data['interest_30_day'] = @$interest_30_day;
+			$arr_data['pay_type_id'] = @$row_loan['pay_type'];
+			
+			$this->db->select('*');
+			$this->db->from('coop_mem_share');
+			$this->db->where("member_id = '".$member_id."' AND share_status IN('1','2')");
+			$this->db->order_by('share_date DESC');
+			$this->db->limit(1);
+			$row_prev_share = $this->db->get()->result_array();
+			$row_prev_share = @$row_prev_share[0];
+			
+			$arr_data['count_share'] = $row_prev_share['share_collect'];
+			$arr_data['cal_share'] = $row_prev_share['share_collect_value']; //หุ้นที่มี่
+			$arr_data['share_period'] = $row_prev_share['share_period'];
+			$arr_data['rules_share'] = $row_loan['loan_amount']*20/100; //หุ้นตามหลักเกณฑ์
+			$arr_data['old_share'] = 0; //เดิม
+			$arr_data['deposit_account_in'] = 0; //เข้าบัญชีเงินฝาก
+			
+			//เช็คสมุดเงินฝากสีน้ำเงิน
+			$this->db->select(array('coop_maco_account.account_id'));
+			$this->db->from('coop_maco_account');
+			$this->db->join("coop_deposit_type_setting","coop_maco_account.type_id = coop_deposit_type_setting.type_id","inner");
+			$this->db->where("
+				coop_maco_account.mem_id = '".$member_id."' 
+				 AND coop_maco_account.account_status = '0'
+				AND coop_deposit_type_setting.deduct_loan = '1'
+			");
+			$this->db->limit(1);
+			$rs_account_blue = $this->db->get()->result_array();
+			$account_id_blue =  @$rs_account_blue[0]['account_id'];
+			if($account_id_blue != ''){
+				$this->db->select(array('transaction_balance'));
+				$this->db->from('coop_account_transaction');
+				$this->db->where("account_id = '".$account_id_blue."'");
+				$this->db->order_by('transaction_id DESC');
+				$this->db->limit(1);
+				$rs_account_blue_balance = $this->db->get()->result_array();
+				$account_blue_balance = @$rs_account_blue_balance[0]['transaction_balance'];
+				
+			}
+			$arr_data['account_blue_deposit'] = @$account_blue_balance; //เงินฝากสีน้ำเงิน
+			
+			//////////////////////////////////////
+			//รายการผ่อนชำระสหกรณ์ปัจจุบัน/เดือน
+			//$month_now = date('n');
+			//$year_now = date('Y')+543;
+			$month_now = date('n',strtotime(@$row_loan['createdatetime']));
+			$year_now = date('Y',strtotime(@$row_loan['createdatetime']))+543;
+			$date_month_end = date('Y-m-t',strtotime((@$year_now-543).'-'.sprintf("%02d",@$month_now).'-01'));
+			
+			$this->db->select(array('coop_finance_month_detail.*','coop_finance_month_profile.*','coop_loan_name.loan_type_id'));
+			$this->db->from('coop_finance_month_detail');
+			$this->db->join('coop_finance_month_profile', 'coop_finance_month_detail.profile_id = coop_finance_month_profile.profile_id', 'left');
+			$this->db->join('coop_loan', 'coop_finance_month_detail.loan_id = coop_loan.id', 'left');
+			$this->db->join('coop_loan_name', 'coop_loan.loan_type = coop_loan_name.loan_name_id', 'left');
+			$this->db->where("
+						coop_finance_month_detail.member_id = '".@$member_id."'
+						AND coop_finance_month_profile.profile_month = '".$month_now."'
+						AND coop_finance_month_profile.profile_year = '".$year_now."'
+					");
+			$row_finance_month = $this->db->get()->result_array();
+            //			echo $this->db->last_query()."<br>";
+            //			echo $row_finance_month.'<br>';
+			//
+			if(!empty($row_finance_month)){
+				//ออกรายการเรียกเก็บประจำเดือนแล้ว
+				//echo '<pre>'; print_r($row_finance_month); echo '</pre>';
+				$arr_list_loan = array();
+				foreach($row_finance_month AS $key_month=>$value_month){
+					//echo @$value_month['deduct_code'].'<br>';
+					if(@$value_month['deduct_code'] == 'SHARE'){
+						//หุ้นหักรายเดือน
+						$share_month = @$value_month['pay_amount'];
+						$share_month_interest = 0;
+						$arr_data['share_month'] = @$share_month; //หุ้นหักรายเดือน(เงินต้น)
+						$arr_data['share_month_interest'] = @$share_month_interest; //หุ้นหักรายเดือน(ดอกเบี้ย)
+						
+					}						
+					
+					if(@$value_month['deduct_code'] == 'DEPOSIT'){
+						//เงินฝากหักรายเดือน
+						$deposit_month =  @$value_month['pay_amount'];
+						$deposit_month_interest = 0;	
+						$arr_data['deposit_month'] = @$deposit_month; //เงินฝากหักรายเดือน(เงินต้น)
+						$arr_data['deposit_month_interest'] = @$deposit_month_interest; //เงินฝากหักรายเดือน(ดอกเบี้ย)	
+											
+					}
+					
+					if(@$value_month['deduct_code'] == 'LOAN'){
+						//echo '<pre>'; print_r($value_month); echo '</pre>';
+						if(@$value_month['pay_type'] == 'principal'){
+							$arr_list_loan[@$value_month['loan_type_id']]['loan_principle'] = @$value_month['pay_amount'];//ยอดที่ชำระต่อเดือน เงินต้น
+						}
+						
+						if(@$value_month['pay_type'] == 'interest'){
+							$arr_list_loan[@$value_month['loan_type_id']]['loan_interest'] = @$value_month['pay_amount'];//(ดอกเบี้ย)
+						}
+						$arr_list_loan[@$value_month['loan_type_id']]['loan_id'] = @$value_month['loan_id'];//loan_id
+						
+					}
+					
+					if(@$value_month['deduct_code'] == 'ATM'){
+						if(@$value_month['pay_type'] == 'principal'){
+							@$arr_list_loan[7]['loan_principle'] += @$value_month['pay_amount'];//ยอดที่ชำระต่อเดือน เงินต้น
+						}
+						
+						if(@$value_month['pay_type'] == 'interest'){
+							@$arr_list_loan[7]['loan_interest'] += @$value_month['pay_amount'];//(ดอกเบี้ย)
+						}
+						$arr_list_loan[7]['loan_id'] = @$value_month['loan_atm_id'];//loan_id
+					}
+					
+					
+				}			
+				
+				$this->db->select(array('*'));
+				$this->db->from('coop_loan_type');
+				$loan_type = $this->db->get()->result_array();
+				$list_loan = array();
+				$loan_principle_total = 0;
+				$loan_interest_total = 0;
+				if(!empty($loan_type)){
+					foreach($loan_type AS $key=>$value){						
+						$list_loan[$value['id']]['loan_name']= $value['loan_type'];//ชื่อเงินกู้หลัก
+						$list_loan[$value['id']]['loan_principle']= @$arr_list_loan[$value['id']]['loan_principle'];//ยอดที่ชำระต่อเดือน
+						$list_loan[$value['id']]['loan_interest'] = @$arr_list_loan[$value['id']]['loan_interest'];//(ดอกเบี้ย)
+						$loan_principle_total += @$arr_list_loan[$value['id']]['loan_principle'];
+						$loan_interest_total += @$arr_list_loan[$value['id']]['loan_interest'];
+					}
+				}
+				$arr_data['list_loan'] = @$list_loan;	
+				
+			}else{
+				
+				//ยังไม่ได้ออกรายการเรียกเก็บประจำเดือน
+				$arr_list_loan = array();
+				$this->db->select('setting_value');
+				$this->db->from('coop_share_setting');
+				$this->db->where("setting_id = '1'");
+				$row = $this->db->get()->result_array();
+				$row_share_value = $row[0];
+				$share_value = $row_share_value['setting_value'];
+			
+				$this->db->select(array('deduct_id','deduct_code','deduct_detail','deduct_type','deduct_format','deposit_type_id','deposit_amount'));
+				$this->db->from('coop_deduct');
+				$this->db->order_by('deduct_seq ASC');
+				$deduct_list = $this->db->get()->result_array();
+				//echo '<pre>'; print_r($deduct_list); echo '</pre>';	
+				foreach($deduct_list as $key2 => $value2){
+					
+					//หุ้นหักรายเดือน
+					if($value2['deduct_code']=='SHARE'){
+						//งดหุ้นชั่วคราว
+						$check_refrain_share = 0;
+						$this->db->select('*');
+						$this->db->from('coop_refrain_share');
+						$this->db->where("member_id = '".$row_member['member_id']."' AND type_refrain = '2' AND month_refrain = '".@$month_now."' AND year_refrain = '".@$year_now."'");
+						$this->db->order_by('refrain_id DESC');			
+						$rs_refrain_temporary = $this->db->get()->result_array();
+						if(!empty($rs_refrain_temporary)){
+							foreach($rs_refrain_temporary AS $key=>$value){
+								$check_refrain_share = 1;
+							}
+						}
+						
+						//งดหุ้นถาวร
+						$this->db->select('*');
+						$this->db->from('coop_refrain_share');
+						$this->db->where("member_id = '".$row_member['member_id']."' AND type_refrain = '1'");
+						$this->db->order_by('refrain_id DESC');			
+						$rs_refrain_permanent = $this->db->get()->result_array();
+						if(!empty($rs_refrain_permanent)){
+							foreach($rs_refrain_permanent AS $key=>$value){
+								$check_refrain_share = 1;
+							}
+						}				
+						
+						//ทุนเรือนหุ้น
+						if(@$row_member['apply_type_id'] == '1' && $check_refrain_share == 0){															
+							$share = @$row_member['share_month'];
+							$share_month = @$share;
+							$share_month_interest = 0;
+							$arr_data['share_month'] = @$share_month; //หุ้นหักรายเดือน(เงินต้น)
+							$arr_data['share_month_interest'] = @$share_month_interest; //หุ้นหักรายเดือน(ดอกเบี้ย)
+						}
+						//echo $row_member['apply_type_id'].'<br>';
+						/*if(@$row_member['apply_type_id'] == '1'){	
+							$this->db->select(array('change_value'));
+							$this->db->from('coop_change_share');
+							$this->db->where("member_id = '".$row_member['member_id']."' AND change_share_status IN ('1','2')");
+							$this->db->order_by("change_share_id DESC");
+							$this->db->limit(1);
+							$row_change_share = $this->db->get()->result_array();
+							$row_change_share = @$row_change_share[0];
+							$sum = 0;
+							if(@$row_change_share['change_value'] != ''){
+								$num_share = @$row_change_share['change_value'];
+							}else{
+								$this->db->select(array('share_salary'));
+								$this->db->from('coop_share_rule');
+								$this->db->where("salary_rule <= '".$row_member['salary']."'");
+								$this->db->order_by("salary_rule DESC");
+								$this->db->limit(1);
+								$row_share_rule = $this->db->get()->result_array();
+								$row_share_rule = @$row_share_rule[0];
+								
+								$num_share = @$row_share_rule['share_salary'];
+							}
+							$share = @$num_share*@$share_value;
+
+							$share_month = @$share;
+							$share_month_interest = 0;
+							$arr_data['share_month'] = @$share_month; //หุ้นหักรายเดือน(เงินต้น)
+							$arr_data['share_month_interest'] = @$share_month_interest; //หุ้นหักรายเดือน(ดอกเบี้ย)
+						}
+						*/
+					}
+					
+					//เงินฝากหักรายเดือน
+					if($value2['deduct_code']=='DEPOSIT'){							
+						//เงินฝาก	
+						$sum_deposit = 0;
+						$DEPOSIT = 0;						
+						$deposit_type_id = @$value2['deposit_type_id'];
+						$DEPOSIT = @$value2['deposit_amount'];
+						//echo $deposit_type_id.'<hr>';
+						$deposit_period_count = 1;
+						$deposit_balance = $DEPOSIT;
+						
+						$this->db->select('*');
+						$this->db->from('coop_maco_account');
+						$this->db->where("mem_id = '".@$row_member['member_id']."' AND type_id = '".@$deposit_type_id."'");
+						$this->db->limit(1);
+						$rs_account = $this->db->get()->result_array();
+						$account_id = @$rs_account[0]['account_id'];
+						if(!empty($account_id)){												
+							if($DEPOSIT > 0){						
+								$sum_deposit += @$DEPOSIT;
+							}
+						}
+
+						$deposit_month =  @$sum_deposit;
+						$deposit_month_interest = 0;	
+						$arr_data['deposit_month'] = @$deposit_month; //เงินฝากหักรายเดือน(เงินต้น)
+						$arr_data['deposit_month_interest'] = @$deposit_month_interest; //เงินฝากหักรายเดือน(ดอกเบี้ย)							
+					}
+				
+					
+					if(@$value2['deduct_code'] == 'LOAN'){										
+						$LOAN = array();
+						$where = '';
+						$where .= " AND (coop_loan.guarantee_for_id = '' OR coop_loan.guarantee_for_id IS NULL) ";
+		
+						$this->db->select(
+							array(
+								'coop_loan.id',
+								'coop_loan.loan_type',
+								'coop_loan.contract_number',
+								'coop_loan.loan_amount_balance',
+								'coop_loan.interest_per_year',
+								'coop_loan_transfer.date_transfer',
+								'coop_loan_name.loan_name',
+								'coop_loan.pay_type',
+								'coop_loan.money_period_1',
+								'coop_loan.createdatetime',
+								'coop_loan.guarantee_for_id',
+								'coop_loan_name.loan_type_id'
+							)
+						);
+						$this->db->from('coop_loan');
+						$this->db->join('coop_loan_transfer', 'coop_loan_transfer.loan_id = coop_loan.id', 'left');
+						$this->db->join('coop_loan_name', 'coop_loan_name.loan_name_id = coop_loan.loan_type', 'inner');
+						$this->db->where("
+							coop_loan.loan_amount_balance > 0
+							AND coop_loan.member_id = '".$row_member['member_id']."'
+							AND coop_loan.loan_status = '1'
+							AND coop_loan_transfer.transfer_status = '0'
+							AND coop_loan.date_start_period <= '".($year_now-543)."-".sprintf("%02d",$month_now)."-".date('t',strtotime(($year_now-543)."-".$month_now."-01"))."' 
+						".$where);
+						$row_loan_month = $this->db->get()->result_array();
+						//echo $this->db->last_query()."<br>";
+						$j=0;
+						
+						foreach($row_loan_month as $key => $row_normal_loan){
+							$this->db->select(array('deduct_id','ref_id'));
+							$this->db->from('coop_deduct_detail');
+							$this->db->where("deduct_id = '{$value2['deduct_id']}' AND ref_id = '{$row_normal_loan['loan_type']}'");
+							$rs_deduct_detail = $this->db->get()->result_array();
+							$ref_id = @$rs_deduct_detail[0]['ref_id'];
+							if(!empty($ref_id)){
+								$deduct_format = @$value2['deduct_format'];
+								
+								if($row_normal_loan['guarantee_for_id']!=''){
+									$for_loan_id = $row_normal_loan['guarantee_for_id'];
+								}else{
+									$for_loan_id = $row_normal_loan['id'];
+								}
+								
+								$this->db->select(
+									array(
+										'outstanding_balance',
+										'principal_payment',
+										'total_paid_per_month'
+									)
+								);
+								$this->db->from('coop_loan_period');
+								$this->db->where("loan_id = '".$for_loan_id."'");
+								$this->db->limit(1);
+								$row_loan_period = $this->db->get()->result_array();
+								$row_principal_payment = $row_loan_period[0];
+								
+								$date_interesting = $date_month_end;
+								$cal_loan_interest = array();
+								$cal_loan_interest['loan_id'] = $row_normal_loan['id'];
+								$cal_loan_interest['date_interesting'] = $date_interesting;
+								$interest = $this->loan_libraries->cal_loan_interest($cal_loan_interest);
+								
+								if($row_principal_payment['principal_payment'] > $row_normal_loan['loan_amount_balance']){
+									$principal_payment = @$row_normal_loan['loan_amount_balance'];
+									$balance = 0;
+								}else{
+									$principal_payment = @$row_principal_payment['principal_payment'];
+									$balance = @$row_normal_loan['loan_amount_balance']-@$row_principal_payment['principal_payment'];
+								}
+								
+								$LOAN[$j]['loan_id'] = $row_normal_loan['id'];
+								$LOAN[$j]['loan_type'] = $row_normal_loan['loan_name'];
+								//$LOAN[$j]['loan_type_id'] = $row_normal_loan['loan_type'];
+								$LOAN[$j]['loan_type_id'] = $row_normal_loan['loan_type_id'];
+								$LOAN[$j]['contract_number'] = $row_normal_loan['contract_number'];
+								$LOAN[$j]['money_period_1'] = $row_normal_loan['money_period_1'];
+								$LOAN[$j]['pay_loan_type'] = $row_normal_loan['pay_type'];
+								if($deduct_format == '2'){
+									$LOAN[$j]['text_title'] = 'ต้นเงินกู้เลขที่สัญญา';
+									$LOAN[$j]['principal_payment'] = $principal_payment;
+									$LOAN[$j]['interest'] = 0;
+									$LOAN[$j]['total'] = $principal_payment;
+									$LOAN[$j]['pay_type'] = 'principal';
+								}else if($deduct_format == '1'){
+									$LOAN[$j]['text_title'] = 'ดอกเบี้ยเงินกู้เลขที่สัญญา';
+									$LOAN[$j]['principal_payment'] = 0;
+									$LOAN[$j]['interest'] = $interest;
+									$LOAN[$j]['total'] = $interest;
+									$LOAN[$j]['pay_type'] = 'interest';
+									$interest_arr[$row_normal_loan['id']] = $interest;
+								}	
+								$balance = @$row_normal_loan['loan_amount_balance']-$principal_payment-$interest;
+								$LOAN[$j]['balance'] = $balance;
+								
+							}
+							$j++;
+						}
+						//echo"<pre>";print_r($LOAN);echo"</pre>";
+						if(!empty($LOAN)){
+							foreach($LOAN as $key3 => $value3){
+								$arr_list_loan[@$value3['loan_type_id']]['loan_principle'] = @$value3['principal_payment'];//ยอดที่ชำระต่อเดือน เงินต้น							
+								$arr_list_loan[@$value3['loan_type_id']]['loan_interest'] = @$value3['interest'];//(ดอกเบี้ย)
+								$arr_list_loan[@$value3['loan_type_id']]['loan_id'] = @$value3['loan_id'];//loan_id
+							}
+						}
+						
+						//echo '<pre>'; print_r($arr_list_loan); echo '</pre>';
+					}
+					
+					if(@$value2['deduct_code'] == 'ATM'){					
+						$ATM = 0;
+						$this->db->select(array(
+							't1.loan_amount_balance',
+							't1.principal_per_month',
+							't2.contract_number',
+							't2.loan_atm_id',
+							't1.date_last_pay',
+							't1.loan_date'
+						));
+						$this->db->from('coop_loan_atm_detail as t1');
+						$this->db->join('coop_loan_atm as t2', 't1.loan_atm_id = t2.loan_atm_id', 'inner');
+						$this->db->where("
+							t2.member_id = '".$row_member['member_id']."'
+							AND t2.loan_atm_status = '1'
+							AND t1.date_start_period <= '".$date_month_end."'
+							AND t1.loan_status = '0'
+						");
+						$row_atm = $this->db->get()->result_array();
+						$principal_per_month = 0;
+						$loan_amount_balance = 0;
+						if(!empty($row_atm)){
+							foreach($row_atm as $key_atm => $value_atm){
+								$loan_atm_id = @$value_atm['loan_atm_id'];
+								$principal_per_month += @$value_atm['principal_per_month'];
+								$loan_amount_balance += @$value_atm['loan_amount_balance'];
+							}
+							if(@$principal_per_month < @$loan_atm_setting['min_principal_pay_per_month']){
+								$principal_per_month = @$loan_atm_setting['min_principal_pay_per_month'];
+							}
+							if(@$principal_per_month > @$loan_amount_balance){
+								$principal_per_month = @$loan_amount_balance;
+							}
+							
+							$cal_loan_interest = array();
+							$cal_loan_interest['loan_atm_id'] = @$loan_atm_id;
+							$cal_loan_interest['date_interesting'] = @$date_month_end;
+							$interest = $this->loan_libraries->cal_atm_interest(@$cal_loan_interest);
+							
+							
+							$deduct_format = @$value2['deduct_format'];
+							if($deduct_format == '2'){
+								@$arr_list_loan[7]['loan_principle'] += @$principal_per_month;//ยอดที่ชำระต่อเดือน เงินต้น
+							}else{
+								@$arr_list_loan[7]['loan_interest'] += @$interest;//(ดอกเบี้ย)
+							}
+							$arr_list_loan[7]['loan_id'] = @$loan_atm_id;//loan_id
+						}
+					}
+				}
+				
+					
+				$this->db->select(array('*'));
+				$this->db->from('coop_loan_type');
+				$loan_type = $this->db->get()->result_array();
+				$list_loan = array();
+				$loan_principle_total = 0;
+				$loan_interest_total = 0;
+				if(!empty($loan_type)){
+					foreach($loan_type AS $key=>$value){						
+						$list_loan[$value['id']]['loan_name']= $value['loan_type'];//ชื่อเงินกู้หลัก
+						$list_loan[$value['id']]['loan_principle']= @$arr_list_loan[$value['id']]['loan_principle'];//ยอดที่ชำระต่อเดือน
+						$list_loan[$value['id']]['loan_interest'] = @$arr_list_loan[$value['id']]['loan_interest'];//(ดอกเบี้ย)
+						$loan_principle_total += @$arr_list_loan[$value['id']]['loan_principle'];
+						$loan_interest_total += @$arr_list_loan[$value['id']]['loan_interest'];
+					}
+				}
+				$arr_data['list_loan'] = @$list_loan;	
+			}
+			$arr_data['arr_list_loan'] = @$arr_list_loan;	
+			///////////////////////////////////////////////
+			
+			//เงินฝาก
+			$this->db->select(array('coop_maco_account.account_id','coop_maco_account.mem_id','coop_maco_account.account_name','coop_deposit_type_setting.type_name'));
+			$this->db->from('coop_maco_account');
+			$this->db->join("coop_deposit_type_setting","coop_maco_account.type_id = coop_deposit_type_setting.type_id AND deduct_loan = '1'","inner");
+			$this->db->where("coop_maco_account.mem_id = '".@$member_id."'");
+			$row_account= $this->db->get()->result_array();
+			$account_list = array();
+			if(!empty($row_account)){
+				foreach($row_account AS $key=>$value){
+					$this->db->select(array('transaction_balance','transaction_deposit'));
+					$this->db->from('coop_account_transaction');
+					$this->db->where("account_id = '".$value['account_id']."'");
+					$this->db->order_by('transaction_id DESC');
+					$this->db->limit(1);
+					$row_balance = $this->db->get()->result_array();
+					//$account_balance  = @$row_balance[0]['transaction_balance'];
+					$account_balance  = @$row_balance[0]['transaction_deposit'];
+					
+					$account_list[$value['account_id']]['account_id'] =  @$value['account_id'];
+					$account_list[$value['account_id']]['account_name'] =  @$value['account_name'];
+					$account_list[$value['account_id']]['account_balance'] =  @$account_balance;
+					//print_r($this->db->last_query());
+				}
+			}
+			$arr_data['account_list'] = @$account_list;			
+			
+			//ปิดสัญญาเดิม
+			//
+			/*
+			$this->db->select(array('t1.*','t3.loan_type_code'));
+			$this->db->from("coop_loan as t1");
+			$this->db->join("coop_loan_name as t2",'t1.loan_type = t2.loan_name_id','inner');
+			$this->db->join("coop_loan_type as t3",'t2.loan_type_id = t3.id','inner');
+			$this->db->where("t1.id = '".@$loan_id."'");
+			$rs_loan = $this->db->get()->result_array();
+			$rs_loan = $rs_loan[0];	
+			*/			
+			
+			$date_interesting = date('Y-m-d');
+			$list_old_loan = array();
+			
+			$this->db->select(array('t1.*',
+									't2.contract_number',
+									't2.loan_amount_balance',
+									't2.id'
+									));
+			$this->db->from("coop_loan_prev_deduct t1");
+			$this->db->join("coop_loan t2",'t1.ref_id = t2.id','inner');
+			$this->db->where("t1.loan_id = '".@$loan_id."' AND t1.data_type = 'loan'");
+			$row = $this->db->get()->result_array();
+			$index = 0;
+			if(@$_GET['dev'] == 'dev'){
+				echo 'coop_loan_prev_deduct<br>';
+				print_r($this->db->last_query()); //exit;
+			}
+			$extra_debt = array();
+			foreach($row as $key => $value){
+				$list_old_loan[$index]['contract_number'] = @$value['contract_number'];
+				
+				$extra_debt_amount	= 0;//หนี้ห้อย
+				/*if(date("Y-m", strtotime($rs_loan[0]['createdatetime']) ) != date("Y-m") ){
+					$month = date("m", strtotime("+1 months", strtotime($rs_loan[0]['createdatetime'])) );
+					if($month=="01"){
+						$year = date("Y", strtotime($rs_loan[0]['createdatetime']) ) + 543 + 1;
+					}else{
+						$year = date("Y", strtotime($rs_loan[0]['createdatetime']) ) + 543;
+					}
+					
+					$this->db->select('profile_id');
+					$this->db->from('coop_finance_month_profile');
+					$this->db->where("profile_month = '".(int)$month."' AND profile_year = '".$year."' ");
+					$profile_id = $this->db->get()->result_array()[0]['profile_id'];
+					if(@$_GET['dev'] == 'dev'){
+						echo '<hr>';
+						print_r($this->db->last_query());
+					}
+					$this->db->select("sum(pay_amount) as sum_of_pay_amount");
+					$finance_month_detail = $this->db->get_where("coop_finance_month_detail", array(
+						"profile_id" => $profile_id,
+						"member_id" => $rs_loan[0]['member_id'],
+						"loan_id" => $value['id'],
+						"pay_type" => "principal",
+						"run_status" => 0
+					))->result_array()[0];
+					if(@$_GET['dev'] == 'dev'){
+						echo '<hr>';
+						print_r($this->db->last_query());
+						echo '<hr>'.date("Y-m", strtotime($rs_loan[0]['createdatetime']) ).' !='. date("Y-m").'<br>';
+					}
+					if($finance_month_detail && $rs_loan[0]['loan_status']==0){
+						$extra_debt['total_princical'] += $finance_month_detail['sum_of_pay_amount'];
+						$extra_debt_amount	= $finance_month_detail['sum_of_pay_amount'];
+					}
+						
+				}
+				*/
+
+				if($value['pay_type'] == 'principal'){	
+					if(@$_GET['dev'] == 'dev'){
+						echo 'pay_amount='.@$value['pay_amount'].'<br>';
+						echo 'extra_debt_amount='.@$extra_debt_amount.'<br>';
+					}				
+					$list_old_loan[$index]['loan_id'] = @$value['id'];
+					$list_old_loan[$index]['loan_amount_balance'] = @$value['pay_amount'] - $extra_debt_amount;
+					$list_old_loan[$index]['loan_interest_amount'] = 0;
+				}else{
+					$list_old_loan[$index]['loan_id'] = @$value['id'];
+					$list_old_loan[$index]['loan_amount_balance'] = @$value['pay_amount'] - $extra_debt_amount - @$value['interest_amount'];
+					$list_old_loan[$index]['loan_interest_amount'] = @$value['interest_amount'];
+					/*$list_old_loan[$index]['loan_amount_balance'] = @$value['loan_amount_balance'];
+					$cal_loan_interest = array();
+					$cal_loan_interest['loan_id'] = @$value['ref_id'];
+					$cal_loan_interest['date_interesting'] = $this->center_function->ConvertToSQLDate(@$date_interesting);
+					$interest_data = $this->loan_libraries->cal_loan_interest($cal_loan_interest);
+					$list_old_loan[$index]['loan_interest_amount'] = @$interest_data;
+					*/
+				}
+				$index++;
+			}
+			
+			//ปิดปัญชีกู้ฉุกเฉิน ATM
+			$this->db->select(array('t1.*',
+									't2.contract_number',
+									't2.total_amount_approve',
+									't2.total_amount_balance',
+									't2.loan_atm_id'
+									));
+			$this->db->from("coop_loan_prev_deduct t1");
+			$this->db->join("coop_loan_atm t2",'t1.ref_id = t2.loan_atm_id','inner');
+			$this->db->where("t1.loan_id = '".@$loan_id."' AND t1.data_type = 'atm'");
+			$row = $this->db->get()->result_array();
+			if(@$_GET['dev'] == 'dev'){
+				print_r($this->db->last_query()); //exit;
+				echo '<pre>'; print_r(@$row); echo '</pre>';
+			}
+			
+			foreach($row as $key => $value){
+				$list_old_loan[$index]['contract_number'] = @$value['contract_number'];
+				if($value['pay_type'] == 'principal'){					
+					$list_old_loan[$index]['loan_id'] = @$value['loan_atm_id'];
+					//$list_old_loan[$index]['loan_amount_balance'] = @$value['total_amount_approve'] - @$value['total_amount_balance'];
+					$list_old_loan[$index]['loan_amount_balance'] = @$value['pay_amount'] - @$value['interest_amount'];
+					$list_old_loan[$index]['loan_interest_amount'] = 0;
+				}else{
+					$list_old_loan[$index]['loan_id'] = @$value['loan_atm_id'];
+					//$list_old_loan[$index]['loan_amount_balance'] = @$value['total_amount_approve'] - @$value['total_amount_balance'];
+					$list_old_loan[$index]['loan_amount_balance'] = @$value['pay_amount'] - @$value['interest_amount'];
+					/*$cal_loan_interest = array();
+					//$cal_loan_interest['loan_id'] = @$value['ref_id'];
+					$cal_loan_interest['loan_atm_id'] = @$value['ref_id'];
+					$cal_loan_interest['date_interesting'] = $this->center_function->ConvertToSQLDate(@$date_interesting);
+					$interest_atm = $this->loan_libraries->cal_atm_interest_deduct($cal_loan_interest);
+					$list_old_loan[$index]['loan_interest_amount'] = @$interest_atm;
+					*/
+					$list_old_loan[$index]['loan_interest_amount'] = @$value['interest_amount'];
+				}
+				$index++;
+			}	
+			
+			if(@$_GET['dev'] == 'dev'){
+					echo '<pre>'; print_r(@$list_old_loan); echo '</pre>';
+			}
+			
+			$arr_data['list_old_loan'] = @$list_old_loan;
+			$total_principal = 0;
+			$total_interest = 0;
+			$total_loan_balance = 0;
+			if(!empty($list_old_loan)){
+				foreach($list_old_loan AS $key => $value){
+					$total_principal += @$value['loan_amount_balance'];
+					$total_interest += @$value['loan_interest_amount'];
+					$total_loan_balance += @$value['loan_amount_balance']+@$value['loan_interest_amount'];
+				}
+			}
+			
+			$arr_data['existing_loan'] = @$total_loan_balance; //หักเงินกู้เดิม
+			$arr_data['principal_load'] = @$total_principal;//ภาระเงินต้น
+			$arr_data['interest_burden'] = @$total_interest;//ภาระดอกเบี้ย
+			$arr_data['extra_debt'] = @$extra_debt;//หนี้ห้อย
+			
+			$loan_amount = @$row_loan['loan_amount']; //วงเงินที่ขออนุมัติ		
+			
+			$month_receipt = date("m", strtotime($row_loan['createdatetime']));
+			$year_receipt = date("Y", strtotime($row_loan['createdatetime']));
+			
+			$this->db->select(array('deduct_id','deduct_code','deduct_detail','deduct_type','deduct_format','deposit_type_id','deposit_amount'));
+			$this->db->from('coop_deduct');
+			$this->db->order_by('deduct_seq ASC');
+			$deduct_list = $this->db->get()->result_array();
+			$data_arr['deduct_list'] = @$deduct_list;
+			//
+			
+			$deductible =  0 ;			
+			//ค่าธรรมเนียม 
+			$this->db->select(array('*'));
+			$this->db->from('coop_loan_deduct');
+			$this->db->where("loan_id = '{$loan_id}'");
+			$rs_deduct = $this->db->get()->result_array();
+			//echo $loan_id.'<hr>';
+			//echo '<pre>'; print_r($rs_deduct); echo '</pre>';
+			if(!empty($rs_deduct)){
+				foreach($rs_deduct AS $key=>$row_deduct){
+					if(!in_array($row_deduct['loan_deduct_list_code'], array( 'deduct_pay_prev_loan', 'deduct_cheque'))){
+						$deductible += @$row_deduct['loan_deduct_amount'];
+					}
+					
+					if($row_deduct['loan_deduct_list_code'] == 'deduct_loan_fee'){
+						$arr_data['deduct_loan_fee'] = @$row_deduct['loan_deduct_amount'];
+					}
+					
+					if($row_deduct['loan_deduct_list_code'] == 'deduct_person_guarantee'){
+						//มีการกำหนดกรณีไม่ผ่านเกณฑ์
+						$arr_data['deduct_person_guarantee'] = @$row_deduct['loan_deduct_amount'];
+					}
+
+					if($row_deduct['loan_deduct_list_code'] == 'deduct_insurance'){
+						//เบี้ยประกัน
+						$arr_data['deduct_insurance'] = @$row_deduct['loan_deduct_amount'];
+					}
+
+					if($row_deduct['loan_deduct_list_code'] == 'deduct_cheque'){
+                        $arr_data['deduct_cheque'] = @$row_deduct['loan_deduct_amount'];
+                    }
+				}
+			}
+			//exit;			
+			
+			$arr_data['deductible'] =  @$deductible; //รายการหัก
+			$total_amount = @$loan_amount - @$total_loan_balance - @$deductible - @$arr_data['deduct_cheque'];
+			$arr_data['total_amount'] = @$total_amount;
+			
+			$arr_data['total_paid_per_month'] =  @$total_paid_per_month; //รวมชำระต่องวด
+			
+			//รายการรับเงิน	
+			$arr_receiving_money = array();
+			//ชำระหนี้สถาบันการเงิน
+			$this->db->select(array('*'));
+			$this->db->from('coop_loan_financial_institutions');
+			$this->db->where("loan_id = '".@$loan_id."'");
+			$this->db->order_by("order_by ASC");
+			$rs_financial_institutions = $this->db->get()->result_array();
+			
+			$i=0;
+			$financial_amount = 0;
+			foreach($rs_financial_institutions AS $key=>$row_financial_institutions){
+				$arr_receiving_money[$i]['transfer_type'] = 'จ่ายธนาคาร'.@$row_financial_institutions['financial_institutions_name'];
+				$arr_receiving_money[$i]['total_received'] = @$row_financial_institutions['financial_institutions_amount'];
+				$financial_amount += @$row_financial_institutions['financial_institutions_amount'];
+				$i++;
+			}
+			
+			//การจ่ายเงินกู้
+			$transfer_type = array('0'=>'เงินสด','1'=>'โอนเงินบัญชีสหกรณ์','2'=>'โอนเงินบัญชี','3' => 'พร้อมเพย์', '4' => 'เช็คเงินสด');
+			if(@$row_loan['transfer_type'] == '2'){
+				$transfer_type_description = '';
+				$transfer_type_description .= @$row_loan['bank_name'];
+				$transfer_type_description .= '<br> เลขที่บัญชี '.@$row_loan['transfer_bank_account_id'];
+			}else if(@$row_loan['transfer_type'] == '1'){
+				$transfer_type_description = ' '.@$row_loan['transfer_account_id'].':'.@$row_loan['account_name'];
+			}else{
+				$transfer_type_description = '';
+			}
+			$text_transfer_type = @$transfer_type[@$row_loan['transfer_type']].@$transfer_type_description;
+			
+			//ยอดเงินที่จะได้รับโดยประมาณ
+			$this->db->select(array('estimate_receive_money'));
+			$this->db->from('coop_loan_deduct_profile');
+			$this->db->where("loan_id = '".@$loan_id."'");
+			$loan_deduct_profile = $this->db->get()->result_array();
+			$estimate_receive_money = @$loan_deduct_profile[0]['estimate_receive_money'];			
+			
+			$arr_receiving_money[$i]['transfer_type'] = @$text_transfer_type;
+			$arr_receiving_money[$i]['total_received'] = @$estimate_receive_money-@$financial_amount;
+			
+			$arr_data['receiving_money'] = $arr_receiving_money;		
+					
+			$arr_data['total_month'] = @$share_month+@$deposit_month+@$loan_principle_total;//รวมทั้งสิ้น รายการผ่อนชำระสหกรณ์ปัจจุบัน/เดือน
+			$arr_data['total_month_interest'] = @$share_month_interest+@$deposit_month_interest+@$loan_interest_total;//รวมทั้งสิ้น รายการผ่อนชำระสหกรณ์ปัจจุบัน/เดือน(ดอกเบี้ย)
+			
+			//บุคคลค้ำประกัน
+			$this->db->select(array(
+				't1.*',
+				't3.member_id',
+				't3.firstname_th',
+				't3.lastname_th',
+				't3.mem_group_id',
+				't3.salary',
+				't3.birthday',
+				't3.member_date',
+				't3.share_month',
+				't4.mem_group_name',
+				't5.prename_full'
+			));
+			$this->db->from('coop_loan_guarantee_person as t1');
+			$this->db->join('coop_mem_apply as t3','t1.guarantee_person_id = t3.member_id','inner');
+			$this->db->join("coop_mem_group as t4", "t3.level = t4.id", "left");
+			$this->db->join("coop_prename as t5", "t3.prename_id = t5.prename_id", "left");
+			$this->db->where("t1.loan_id = '{$loan_id}' AND t3.member_status <> '3'");
+			$this->db->order_by("t1.id ASC");
+			$rs_guarantee = $this->db->get()->result_array();
+			foreach($rs_guarantee AS $key=>$row_guarantee){
+				$this->db->from('coop_loan_guarantee_person as t1');
+				$this->db->join('coop_loan as t2','t1.loan_id = t2.id ','inner');
+				$this->db->where("
+					t1.guarantee_person_id = '".@$row_guarantee['guarantee_person_id']."' 
+					AND t2.loan_status IN('1','2')
+				");
+				$rs_count_guarantee = $this->db->get()->result_array();
+				$n=0;
+				foreach($rs_count_guarantee as $key_count => $row_count_guarantee){
+					$n++;
+				}
+				@$rs_guarantee[$key]['count_guarantee'] = @$n;
+
+				$share = $this->db->select("share_period, share_collect_value")->from("coop_mem_share")->where("share_date <= '".$row_loan["createdatetime"]."' AND member_id = '".$row_guarantee['guarantee_person_id']."' AND share_status IN (1,5,6)")->order_by("share_date DESC")->get()->row();
+				$rs_guarantee[$key]['share_balance'] = $share->share_collect_value;
+				$rs_guarantee[$key]['share_period'] = $share->share_period;
+
+				//ข้อมูลค้ำประกันเงินกู้
+				$guarantors_raw = $this->db->select("t3.member_id, t2.contract_number, t3.firstname_th, t3.lastname_th, t4.prename_full, t1.loan_id")
+							->from("coop_loan_guarantee_person as t1")
+							->join("coop_loan as t2", "t1.loan_id = t2.id", "INNER")
+							->join("coop_mem_apply as t3", "t2.member_id = t3.member_id", "LEFT")
+							->join("coop_prename as t4", "t3.prename_id = t4.prename_id", "LEFT")
+							->where("t1.guarantee_person_id = '".$row_guarantee['guarantee_person_id']."'")
+							->get()->result_array();
+				$guarantors = array();
+				foreach($guarantors_raw as $data) {
+					$transaction = $this->db->select("*")->from("coop_loan_transaction")->where("loan_id = '".$data["loan_id"]."' AND transaction_datetime <= '".$row_loan["createdatetime"]."'")->order_by("transaction_datetime DESC")->get()->row();
+					if($transaction->loan_amount_balance > 0) {
+						$guarantors[] = $data;
+					}
+				}
+
+				$rs_guarantee[$key]["guarantors"] = $guarantors;
+
+                //หุ้นค้ำประกัน
+                $res_guarantee =  $this->db->get_where('coop_loan_guarantee', array('loan_id' => $loan_id))->row_array();
+                $arr_data['g_share_amt'] = $res_guarantee['amount'];
+
+
+                $loans = array();
+				$loan_raw = $this->db->select("t1.id as loan_id, t1.approve_date, t1.contract_number, t1.date_last_interest, t1.loan_amount, t1.money_per_period, t1.period_amount, t1.period_now")
+							->from("coop_loan as t1")
+							->where("t1.member_id = '".$row_guarantee['guarantee_person_id']."' AND t1.loan_status IN (1,4,6,7,8) AND t1.id != '".$_GET["loan_id"]."'")
+							->get()->result_array();
+				foreach($loan_raw as $loan) {
+					$transaction = $this->db->select("*")->from("coop_loan_transaction")->where("loan_id = '".$loan["loan_id"]."' AND transaction_datetime <= '".$row_loan["createdatetime"]."'")->order_by("transaction_datetime DESC")->get()->row();
+					if($transaction->loan_amount_balance > 0) {
+						$loan["balance"] = $transaction->loan_amount_balance;
+						$loans[] = $loan;
+					}
+				}
+				$rs_guarantee[$key]["loans"] = $loans;
+
+			}	
+			$arr_data['row_guarantee'] = @$rs_guarantee;	
+			
+			//รายการซื้อ	
+			$this->db->select(array('*'));
+			$this->db->from('coop_loan_deduct_list');
+			$this->db->where("loan_deduct_list_code != 'deduct_pay_prev_loan' AND loan_deduct_status = 1");
+			$this->db->order_by('run_id ASC');
+			$row = $this->db->get()->result_array();
+			$arr_data['loan_deduct_list'] = $row;	
+			
+			$this->db->select(array(
+				'loan_deduct_list_code',
+				'loan_deduct_amount'
+			));
+			$this->db->from('coop_loan_deduct');
+			$this->db->where("loan_id = '".$loan_id."'");
+			$row = $this->db->get()->result_array();
+			$loan_deduct = array();
+			foreach($row as $key => $value){
+				$loan_deduct[$value['loan_deduct_list_code']] = $value['loan_deduct_amount'];
+			}
+			$arr_data['loan_deduct'] = $loan_deduct;
+			
+			//ค่าใช้จ่าย
+            //			$this->db->from('coop_loan_cost');
+            //			$this->db->where("loan_id = '".$loan_id."' AND member_id = '".$member_id."'");
+            //			$this->db->limit(1);
+            //			$rs_cost = $this->db->get()->result_array();
+            //			$row_cost = @$rs_cost[0];
+            //			$arr_data['school_benefits'] = $row_cost['school_benefits'];
+            //			$arr_data['saving'] = @$row_cost['saving'];
+            //			$arr_data['ch_p_k'] = @$row_cost['ch_p_k'];
+            //			$arr_data['pension'] = @$row_cost['pension'];
+            //			$arr_data['k_b_k'] = @$row_cost['k_b_k'];
+            //			$arr_data['other'] = @$row_cost['other'];
+
+            //รายได้
+            $sql = "SELECT
+				*, 
+				IFNULL((select coop_income_loan_detail.income_value from coop_income_loan_detail where coop_income_loan_detail.loan_id = '".$loan_id."' and coop_income_loan_detail.income_id = coop_income.id), 0) as income_value
+			FROM
+				`coop_income`
+			ORDER BY
+				`seq` ASC";
+
+            if($_GET['sql'] == 'show'){
+                echo $sql; exit;
+            }
+            $arr_data['income'] = $this->db->query($sql)->result_array();
+
+            //ค่าใช้จ่าย
+            $arr_data['loan_cost_code'] = array();
+            $this->db->select('outgoing_code, outgoing_name, loan_cost_amount');
+            $this->db->from("coop_outgoing");
+            $this->db->join("coop_loan_cost_mod", "coop_outgoing.outgoing_code=coop_loan_cost_mod.loan_cost_code", "inner");
+            $this->db->where("loan_id = '".$loan_id."' AND member_id = '".$member_id."'");
+            $rs_cost = $this->db->get()->result_array();
+            $arr_data['loan_cost_code'] = $rs_cost;
+            //            foreach ($rs_cost as $key => $val){
+            //                $arr_data['loan_cost_code'] = $val['loan_cost_amount'];
+            //            }
+
+			//อสังหาทรัพย์ค้ำประกัน
+			$this->db->select(array('t1.*',
+									't2.province_name',
+									't3.amphur_name',
+									't4.district_name'
+								));
+			$this->db->from("coop_loan_guarantee_real_estate t1");
+			$this->db->join("coop_province t2","t1.province_id = t2.province_id","left");
+			$this->db->join("coop_amphur t3","t1.amphur_id = t3.amphur_id","left");
+			$this->db->join("coop_district t4","t1.district_id = t4.district_id","left");
+			$this->db->where("t1.loan_id = '".$loan_id."'");
+			$rs_real_estate = $this->db->get()->result_array();
+			$arr_data['row_real_estate'] = @$rs_real_estate[0];
+			
+			//$member_id = @$_GET['member_id'];
+			//$loan_id = @$_GET['loan_id'];
+			//@start ข้อมูลประกันชีวิต
+			$rs_cremation_type = $this->db->select('import_cremation_type,import_amount_balance')
+			->from('coop_life_insurance_cremation')
+			->where("member_id = '".$member_id."' AND loan_id = '".$loan_id."'")
+			->get()->result_array();
+			$cremation_type_1 = 0;
+			$cremation_type_2 = 0;
+			foreach($rs_cremation_type AS $key=>$row_cremation_type){
+				//ชสอ
+				if($row_cremation_type['import_cremation_type'] == '1'){
+					$cremation_type_1 = @$row_cremation_type['import_amount_balance'];
+				}
+				
+				//สสอค
+				if($row_cremation_type['import_cremation_type'] == '2'){
+					$cremation_type_2 = @$row_cremation_type['import_amount_balance'];
+				}
+			}
+			$arr_data['cremation_type_1'] = @$cremation_type_1;
+			$arr_data['cremation_type_2'] = @$cremation_type_2;			
+				
+			$row_life_insurance = $this->db->select('insurance_year,insurance_date,insurance_amount,insurance_premium,insurance_new,insurance_old')
+			->from('coop_life_insurance')
+			->where("member_id = '".$member_id."' AND loan_id = '".$loan_id."'")
+			->limit(1)
+			->get()->result_array();
+			
+			$arr_data['life_insurance_4'] = @$row_life_insurance[0]['insurance_old'];
+			$arr_data['life_insurance_5'] = @$row_life_insurance[0]['insurance_new'];	
+			$arr_data['life_insurance_6'] = @$row_life_insurance[0]['insurance_amount'];	
+			//@end ข้อมูลประกันชีวิต
+
+			//ข้อมูลค้ำประกันเงินกู้
+			$guarantors_raw = $this->db->select("t3.member_id, t2.contract_number, t3.firstname_th, t3.lastname_th, t4.prename_full, t1.loan_id")
+									->from("coop_loan_guarantee_person as t1")
+									->join("coop_loan as t2", "t1.loan_id = t2.id", "INNER")
+									->join("coop_mem_apply as t3", "t2.member_id = t3.member_id", "LEFT")
+									->join("coop_prename as t4", "t3.prename_id = t4.prename_id", "LEFT")
+									->where("t1.guarantee_person_id = '".$member_id."'")
+									->get()->result_array();
+			$guarantors = array();
+			foreach($guarantors_raw as $data) {
+				$transaction = $this->db->select("*")->from("coop_loan_transaction")->where("loan_id = '".$data["loan_id"]."' AND transaction_datetime <= '".$row_loan["createdatetime"]."'")->order_by("transaction_datetime DESC")->get()->row();
+				if($transaction->loan_amount_balance > 0) {
+					$guarantors[] = $data;
+				}
+			}
+
+			$arr_data["guarantors"] = $guarantors;
+
+			$loans = array();
+			$loan_raw = $this->db->select("t1.id as loan_id, t1.approve_date, t1.contract_number, t1.date_last_interest, t1.loan_amount, t1.money_per_period, t1.period_amount, t1.period_now")
+									->from("coop_loan as t1")
+									->where("t1.member_id = '".$member_id."' AND t1.loan_status IN (1,4,6,7,8) AND t1.id != '".$_GET["loan_id"]."'")
+									->get()->result_array();
+			foreach($loan_raw as $loan) {
+				// 2019-12-31 00:00:00
+				$transaction = $this->db->select("*")->from("coop_loan_transaction")->where("loan_id = '".$loan["loan_id"]."' AND transaction_datetime <= '".$row_loan["createdatetime"]."'")->order_by("transaction_datetime DESC")->get()->row();
+				if($transaction->loan_amount_balance > 0) {
+					$loan["balance"] = $transaction->loan_amount_balance;
+					$loans[] = $loan;
+				}
+			}
+			$arr_data["loans"] = $loans;
+
+			$board_raw = $this->db->select("*")->from("coop_loan_board")->get()->result_array();
+			$boards = array();
+			foreach($board_raw as $board) {
+				if($board["level"] != "board") {
+					$boards[$board["level"]] = $board;
+				} else {
+					$boards["boards"][] = $board;
+				}
+			}
+			$arr_data["boards"] = $boards;
+		}
+
+		$arr_data['person_guarantee'] = $this->db->select('person_guarantee')->from('coop_term_of_loan')->where('type_id', $row_loan['loan_type'])->order_by('start_date', 'desc')->limit(1)->get()->row_array()['person_guarantee'];
+        return $arr_data;
+    }
+
+    public function get_report_loan_data_1(){
+        $member_id = @$_GET['member_id'];
+		$loan_id = @$_GET['loan_id'];
+		if($member_id != '') {
+			//@start ดึงข้อมูลในตารางเก็บข้อมูลรายละเอียดการขอกู้เงิน เพื่อใช้ดูข้อมูลย้อนหลัง
+			$this->db->select('*');
+			$this->db->from('coop_loan_report_detail');
+			$this->db->where("loan_id = '".$loan_id."'");
+			$rs_report_detail = $this->db->get()->result_array();
+			$row_report_detail = $rs_report_detail[0];
+			$arr_data['row_report_detail'] = $row_report_detail;			
+			//@end ดึงข้อมูลในตารางเก็บข้อมูลรายละเอียดการขอกู้เงิน เพื่อใช้ดูข้อมูลย้อนหลัง
+			
+			$this->db->select('coop_mem_apply.*,
+							coop_mem_type.mem_type_name,
+							department.mem_group_full_name AS department_name,
+							faction.mem_group_full_name AS faction_name,
+							level.mem_group_full_name AS level_name',
+							'prename.prename_full'
+							);
+			$this->db->from('coop_mem_apply');
+			$this->db->join("coop_mem_type","coop_mem_apply.mem_type_id = coop_mem_type.mem_type_id","left");
+			$this->db->join("coop_mem_group as department","coop_mem_apply.department = department.id","left");
+			$this->db->join("coop_mem_group as faction","coop_mem_apply.faction = faction.id","left");
+			$this->db->join("coop_mem_group as level","coop_mem_apply.level = level.id ","left");
+			$this->db->join("coop_prename as prename","coop_mem_apply.prename_id = prename.prename_id ","left");
+			$this->db->where("coop_mem_apply.member_id = '".$member_id."'");
+			$rs_member = $this->db->get()->result_array();
+			$row_member = $rs_member[0];
+			$arr_data['row_member'] = $row_member;
+			
+			$this->db->select(array(
+				't1.*',
+				't3.loan_name as loan_type_detail',
+				't3.loan_type_id',
+				't4.id',
+				't5.bank_name',
+				't6.account_name',
+				't7.user_name AS admin_name'
+			));
+			$this->db->from('coop_loan as t1');			
+			$this->db->join('coop_loan_name as t3','t1.loan_type = t3.loan_name_id','inner');
+			$this->db->join("coop_loan_type as t4",'t3.loan_type_id = t4.id','inner');
+			$this->db->join("coop_bank as t5",'t1.transfer_bank_id = t5.bank_id','left');
+			$this->db->join("coop_maco_account as t6",'t1.transfer_account_id = t6.account_id','left');
+			$this->db->join("coop_user AS t7",'t1.admin_id = t7.user_id','left');
+			$this->db->where("t1.member_id = '".$member_id."' AND t1.id='".$loan_id."'");
+			$this->db->order_by("t1.id DESC");
+			$rs_loan = $this->db->get()->result_array();
+			$row_loan =  @$rs_loan[0];
+			$arr_data['row_loan'] = @$row_loan;
+			$createdate_loan = date("Y-m-d", strtotime($row_loan['createdatetime']));
+			if(@$_GET['dev'] == 'dev'){
+				echo $this->db->last_query(); 
+				echo '<hr>';
+			}
+			$this->db->select(array(
+				//' MAX(total_paid_per_month) AS total_paid_per_month'
+				'principal_payment',
+				'total_paid_per_month'
+			));
+			$this->db->from('coop_loan_period');
+			$this->db->where("loan_id='".$loan_id."' AND date_count = '31'");
+			$this->db->limit(1);
+			$per_month = $this->db->get()->result_array();
+			//echo $this->db->last_query(); 
+			if(@$row_loan['pay_type'] == '1'){
+				$total_paid_per_month = @round(@$per_month[0]['principal_payment'],2);
+				$pay_type_name = "แบบคงต้น";
+				
+				//ดอกเบี้ย 30 วัน ของจากยอดกู้เต็ม
+				$date_count = date_diff(date_create($row_loan['createdatetime']),date_create($row_loan['date_start_period']))->format("%a");
+				$interest_30_day = (((@$row_loan['loan_amount']*@$row_loan['interest_per_year'])/100)/365)*@$date_count;
+				if(@$_GET['dev'] == 'dev'){
+					echo '((('.@$row_loan['loan_amount'].'*'.@$row_loan['interest_per_year'].')/100)/365)*'.@$date_count.'<br>';
+				}	
+				$interest_30_day = round(@$interest_30_day, 2);
+			}else{
+				$total_paid_per_month = @round(@$per_month[0]['total_paid_per_month'],2);
+				$pay_type_name = "แบบคงยอด";
+				$interest_30_day  = 0;
+			}
+			//$total_paid_per_month = round(@$per_month[0]['total_paid_per_month'],-2);
+			$arr_data['total_paid_per_month'] = @$total_paid_per_month;
+			$arr_data['pay_type'] = @$pay_type_name;			
+			$arr_data['interest_30_day'] = @$interest_30_day;
+			$arr_data['pay_type_id'] = @$row_loan['pay_type'];
+			
+			$this->db->select('*');
+			$this->db->from('coop_mem_share');
+			$this->db->where("member_id = '".$member_id."' AND share_status IN('1','2')");
+			$this->db->order_by('share_date DESC');
+			$this->db->limit(1);
+			$row_prev_share = $this->db->get()->result_array();
+			$row_prev_share = @$row_prev_share[0];
+			
+			$arr_data['count_share'] = $row_prev_share['share_collect'];
+			$arr_data['cal_share'] = $row_prev_share['share_collect_value']; //หุ้นที่มี่
+			$arr_data['share_period'] = $row_prev_share['share_period'];
+			$arr_data['rules_share'] = $row_loan['loan_amount']*20/100; //หุ้นตามหลักเกณฑ์
+			$arr_data['old_share'] = 0; //เดิม
+			$arr_data['deposit_account_in'] = 0; //เข้าบัญชีเงินฝาก
+			
+			//เช็คสมุดเงินฝากสีน้ำเงิน
+			$this->db->select(array('coop_maco_account.account_id'));
+			$this->db->from('coop_maco_account');
+			$this->db->join("coop_deposit_type_setting","coop_maco_account.type_id = coop_deposit_type_setting.type_id","inner");
+			$this->db->where("
+				coop_maco_account.mem_id = '".$member_id."' 
+				 AND coop_maco_account.account_status = '0'
+				AND coop_deposit_type_setting.deduct_loan = '1'
+			");
+			$this->db->limit(1);
+			$rs_account_blue = $this->db->get()->result_array();
+			$account_id_blue =  @$rs_account_blue[0]['account_id'];
+			if($account_id_blue != ''){
+				$this->db->select(array('transaction_balance'));
+				$this->db->from('coop_account_transaction');
+				$this->db->where("account_id = '".$account_id_blue."'");
+				$this->db->order_by('transaction_id DESC');
+				$this->db->limit(1);
+				$rs_account_blue_balance = $this->db->get()->result_array();
+				$account_blue_balance = @$rs_account_blue_balance[0]['transaction_balance'];
+				
+			}
+			$arr_data['account_blue_deposit'] = @$account_blue_balance; //เงินฝากสีน้ำเงิน
+			
+			//////////////////////////////////////
+			//รายการผ่อนชำระสหกรณ์ปัจจุบัน/เดือน
+			//$month_now = date('n');
+			//$year_now = date('Y')+543;
+			$month_now = date('n',strtotime(@$row_loan['createdatetime']));
+			$year_now = date('Y',strtotime(@$row_loan['createdatetime']))+543;
+			$date_month_end = date('Y-m-t',strtotime((@$year_now-543).'-'.sprintf("%02d",@$month_now).'-01'));
+			
+			$this->db->select(array('coop_finance_month_detail.*','coop_finance_month_profile.*','coop_loan_name.loan_type_id'));
+			$this->db->from('coop_finance_month_detail');
+			$this->db->join('coop_finance_month_profile', 'coop_finance_month_detail.profile_id = coop_finance_month_profile.profile_id', 'left');
+			$this->db->join('coop_loan', 'coop_finance_month_detail.loan_id = coop_loan.id', 'left');
+			$this->db->join('coop_loan_name', 'coop_loan.loan_type = coop_loan_name.loan_name_id', 'left');
+			$this->db->where("
+						coop_finance_month_detail.member_id = '".@$member_id."'
+						AND coop_finance_month_profile.profile_month = '".$month_now."'
+						AND coop_finance_month_profile.profile_year = '".$year_now."'
+					");
+			$row_finance_month = $this->db->get()->result_array();
+			//			echo $this->db->last_query()."<br>";
+			//			echo $row_finance_month.'<br>';
+			//
+			if($this->Setting_model->get("display_deduct_in_coop_report_loan_detail_preview")==1){
+				//share
+				$share_month 						= @$arr_data['row_member']['share_month'];
+				$share_month_interest 				= 0;
+				$arr_data['share_month'] 			= @$share_month; //หุ้นหักรายเดือน(เงินต้น)
+				$arr_data['share_month_interest'] 	= @$share_month_interest; //หุ้นหักรายเดือน(ดอกเบี้ย)
+				$this->db->order_by("share_date", "DESC");
+				$this->db->limit(1);
+				$arr_data['share_month_balance']	= $this->db->get_where("coop_mem_share", array("member_id" => $row_member['member_id'], "share_date <= " => $row_loan['createdatetime']))->result_array()[0]['share_collect_value'];
+
+				//เงินฝากหักรายเดือน
+				$sum_deposit = 0;
+				$deposit_month =  0;
+				$deposit_month_interest = 0;
+				$maco_account = $this->db->get_where("coop_maco_account", array(
+					"mem_id" => $row_member['member_id']
+				));
+				foreach ($maco_account->result_array() as $key => $value) {
+					$this->db->select("SUM(pay_amount) as deposit_month");
+					$this->db->join("coop_finance_month_profile", "coop_finance_month_detail.profile_id = coop_finance_month_profile.profile_id", "inner");
+					$deposit_month_transaction = $this->db->get_where("coop_finance_month_detail", array(
+						"member_id" 												=> $row_member['member_id'],
+						"deduct_code"												=> "DEPOSIT",
+						"deposit_account_id"										=> $value['account_id'],
+						"coop_finance_month_profile.profile_year" 					=> (date("Y", strtotime($row_loan['createdatetime'])) + 543),
+						"coop_finance_month_profile.profile_month" 					=> (date("n", strtotime($row_loan['createdatetime'])))
+					))->row_array()['deposit_month'];
+					if(empty($deposit_month_transaction)){
+						$this->db->order_by("deduction_year desc, deduction_month desc");
+						$deposit_month_transaction = $this->db->get_where("coop_deposit_month_transaction", array(
+							"account_id" => $value['account_id']
+						))->row_array()['total_amount'];
+					}
+					if(empty($deposit_month_transaction)){
+						$this->db->select("SUM(pay_amount) as deposit_month");
+						$this->db->join("coop_finance_month_profile", "coop_finance_month_detail.profile_id = coop_finance_month_profile.profile_id", "inner");
+						$deposit_month_transaction = $this->db->get_where("coop_finance_month_detail", array(
+							"member_id" 												=> $row_member['member_id'],
+							"deduct_code"												=> "DEPOSIT",
+							"deposit_account_id"										=> $value['account_id'],
+							"coop_finance_month_profile.profile_year" 					=> (date("Y", strtotime("-1 month", strtotime($row_loan['createdatetime']))) + 543),
+							"coop_finance_month_profile.profile_month" 					=> (date("n", strtotime("-1 month", strtotime($row_loan['createdatetime']))))
+						))->row_array()['deposit_month'];
+					}
+
+					if($deposit_month_transaction>0){
+						$deposit_month += $deposit_month_transaction;
+					}
+
+					$this->db->order_by("transaction_time desc, transaction_id desc");
+					$this->db->limit(1);
+					$transaction_balance = $this->db->get_where("coop_account_transaction", array(
+						"account_id" => $value['account_id'],
+						"transaction_time" => $row_loan['createdatetime']
+					))->row_array()['transaction_balance'];
+					$sum_deposit += $transaction_balance;
+				}
+				$arr_data['deposit_month'] = @$deposit_month; //เงินฝากหักรายเดือน(เงินต้น)
+				$arr_data['deposit_month_interest'] = @$deposit_month_interest; //เงินฝากหักรายเดือน(ดอกเบี้ย)
+				$arr_data['deposit_balance'] = $sum_deposit;
+
+				//loan
+				$loan_principle_total = 0;
+				$loan_interest_total = 0;
+				$this->db->join("coop_loan_name", "coop_loan_name.loan_name_id = coop_loan.loan_type", "inner");
+				$loans = $this->db->get_where("coop_loan", array(
+					"member_id" => $row_member['member_id'],
+					"id <> " => $loan_id,
+					"loan_status <> " => "3"
+				))->result_array();
+				foreach ($loans as $key => $value) {
+
+					$loan_prev_deduct = $this->db->get_where("coop_loan_prev_deduct", array(
+						"loan_id" => $loan_id,
+						"ref_id" => $value['id']
+					))->row_array();
+					$is_loan_dedct = (!empty($loan_prev_deduct)) ? true : false;
+					if($is_loan_dedct){
+						continue;
+					}
+					//update money_per_period
+					// $sql_update = "update coop_loan set money_per_period = (select principal_payment from coop_loan_period where loan_id = coop_loan.id limit 1) where loan_status = 1 and id = ".$value['id'];
+					// $this->db->query($sql_update);
+					$value['money_per_period'] = $this->db->get_where("coop_loan", array("id"=>$value['id']))->row_array()['money_per_period'];
+					if($value['pay_type']==2){
+						$finance_month_detail = $this->db->get_where("coop_finance_month_detail", array("loan_id"=>$value['id'], "pay_type" => "principal"))->row_array()['pay_amount'];
+					}
+					//
+					$this->db->order_by("transaction_datetime desc, loan_transaction_id desc");
+					$this->db->limit(1);
+					$loan_transaction = $this->db->get_where("coop_loan_transaction", array(
+						"loan_id" => $value['id'],
+						"transaction_datetime <= " => $row_loan['createdatetime'],
+						"loan_amount_balance >= " => 0
+					))->row_array();
+
+					if(($loan_transaction['loan_amount_balance']-($value['pay_type']==2 ? $finance_month_detail : $value['money_per_period'])) <= 0){
+						continue;
+					}
+
+					if($loan_transaction['loan_amount_balance'] > 0){
+						$interest_per_year = $this->db->get_where("coop_term_of_loan", array(
+							"type_id" 				=> $value['loan_type'],
+							"start_date <=" 		=> $row_loan['date_start_period']
+						))->row_array()['interest_rate'];
+						$count_day = date('t', strtotime($row_loan['date_start_period']));
+						$temp_interest_31_day = ((((@$loan_transaction['loan_amount_balance']-($value['pay_type']==2 ? $finance_month_detail : $value['money_per_period'])) * $interest_per_year) / 100) / 365) * $count_day;
+						$temp_interest_31_day = round($temp_interest_31_day, 2);
+						$arr_list_loan[@$value['id']]['loan_principle'] = ($value['pay_type']==2) ? $value['money_per_period']-$temp_interest_31_day : $value['money_per_period']; //ยอดที่ชำระต่อเดือน เงินต้น
+						$arr_list_loan[@$value['id']]['loan_interest'] = @$temp_interest_31_day; //(ดอกเบี้ย)
+						$arr_list_loan[@$value['id']]['loan_amount_balance'] = $loan_transaction['loan_amount_balance']-$value['money_per_period']; //(balance)
+						$arr_list_loan[@$value['id']]['loan_id'] = @$value['id']; //loan_id
+						$arr_list_loan[@$value['id']]['contract_number'] = @$value['contract_number']; //contract_number
+						$loan_principle_total += $arr_list_loan[@$value['id']]['loan_principle'];
+						$loan_interest_total += $arr_list_loan[@$value['id']]['loan_interest'];
+						if(@$_GET['debug']){
+							echo "loan_id ". $value['id']." : (".$loan_transaction['loan_amount_balance']."-".($value['pay_type']==2 ? $finance_month_detail : $value['money_per_period']).") * ".$interest_per_year." / 100 / 365 * ".$count_day." = ".$temp_interest_31_day."<br>";
+							echo $value['money_per_period']." - ".$temp_interest_31_day." = ".($arr_list_loan[@$value['id']]['loan_principle'])."<br>";
+						}
+					}else{
+
+						if($value['loan_status']!="0"){
+							if($loan_transaction['loan_transaction_id']!=""){
+								$this->db->order_by("transaction_datetime desc, loan_transaction_id desc");
+								$this->db->limit(1);
+								$tmp_loan_transaction = $this->db->get_where("coop_loan_transaction", array(
+									"loan_id" => $value['id'],
+									"transaction_datetime <= " => $row_loan['createdatetime'],
+									"loan_amount_balance >= " => 0,
+									"loan_transaction_id < " => $loan_transaction['loan_transaction_id']
+								))->row_array();
+								if($value['loan_status']!=4){
+									$loan_transaction = $tmp_loan_transaction;
+									$arr_list_loan[@$value['id']]['loan_principle'] = $value['money_per_period']; //ยอดที่ชำระต่อเดือน เงินต้น
+									$temp_interest_31_day = (((@$loan_transaction['loan_amount_balance'] * @$value['interest_per_year']) / 100) / 365) * 31;
+									$temp_interest_31_day = @$temp_interest_31_day;
+									$arr_list_loan[@$value['id']]['loan_interest'] = @$temp_interest_31_day; //(ดอกเบี้ย)
+									$arr_list_loan[@$value['id']]['loan_amount_balance'] = $loan_transaction['loan_amount_balance']; //(balance)
+									$arr_list_loan[@$value['id']]['loan_id'] = @$value['id']; //loan_id
+									$arr_list_loan[@$value['id']]['contract_number'] = @$value['contract_number']; //contract_number
+									$loan_principle_total += $value['money_per_period'];
+									$loan_interest_total += $temp_interest_31_day;
+								}
+							}else{
+								$loan_transaction = $value['loan_amount_balance'];
+								$arr_list_loan[@$value['id']]['loan_principle'] = $value['money_per_period']; //ยอดที่ชำระต่อเดือน เงินต้น
+								$temp_interest_31_day = (((@$loan_transaction * @$value['interest_per_year']) / 100) / 365) * 31;
+								$temp_interest_31_day = @$temp_interest_31_day;
+								$arr_list_loan[@$value['id']]['loan_interest'] = @$temp_interest_31_day; //(ดอกเบี้ย)
+								$arr_list_loan[@$value['id']]['loan_amount_balance'] = $loan_transaction; //(balance)
+								$arr_list_loan[@$value['id']]['loan_id'] = @$value['id']; //loan_id
+								$arr_list_loan[@$value['id']]['contract_number'] = @$value['contract_number']; //contract_number
+								$loan_principle_total += $value['money_per_period'];
+								$loan_interest_total += $temp_interest_31_day;
+							}
+
+						}
+					}
+				}
+
+				$this->db->select(array('*'));
+				$this->db->from('coop_loan_type');
+				$loan_type = $this->db->get()->result_array();
+				$list_loan = array();
+				$arr_data['list_loan'] = @$list_loan;
+
+				$loan_principle_total += $total_paid_per_month;
+				$loan_interest_total += $interest_30_day;
+			}else{
+				if(!empty($row_finance_month)){
+					//ออกรายการเรียกเก็บประจำเดือนแล้ว
+					//echo '<pre>'; print_r($row_finance_month); echo '</pre>';
+					$arr_list_loan = array();
+					foreach($row_finance_month AS $key_month=>$value_month){
+						//echo @$value_month['deduct_code'].'<br>';
+						if(@$value_month['deduct_code'] == 'SHARE'){
+							//หุ้นหักรายเดือน
+							$share_month = @$value_month['pay_amount'];
+							$share_month_interest = 0;
+							$arr_data['share_month'] = @$share_month; //หุ้นหักรายเดือน(เงินต้น)
+							$arr_data['share_month_interest'] = @$share_month_interest; //หุ้นหักรายเดือน(ดอกเบี้ย)
+							
+						}						
+						
+						if(@$value_month['deduct_code'] == 'DEPOSIT'){
+							//เงินฝากหักรายเดือน
+							$deposit_month =  @$value_month['pay_amount'];
+							$deposit_month_interest = 0;	
+							$arr_data['deposit_month'] = @$deposit_month; //เงินฝากหักรายเดือน(เงินต้น)
+							$arr_data['deposit_month_interest'] = @$deposit_month_interest; //เงินฝากหักรายเดือน(ดอกเบี้ย)	
+												
+						}
+						
+						if(@$value_month['deduct_code'] == 'LOAN'){
+							//echo '<pre>'; print_r($value_month); echo '</pre>';
+							if(@$value_month['pay_type'] == 'principal'){
+								$arr_list_loan[@$value_month['loan_type_id']]['loan_principle'] = @$value_month['pay_amount'];//ยอดที่ชำระต่อเดือน เงินต้น
+							}
+							
+							if(@$value_month['pay_type'] == 'interest'){
+								$arr_list_loan[@$value_month['loan_type_id']]['loan_interest'] = @$value_month['pay_amount'];//(ดอกเบี้ย)
+							}
+							$arr_list_loan[@$value_month['loan_type_id']]['loan_id'] = @$value_month['loan_id'];//loan_id
+							
+						}
+						
+						if(@$value_month['deduct_code'] == 'ATM'){
+							if(@$value_month['pay_type'] == 'principal'){
+								@$arr_list_loan[7]['loan_principle'] += @$value_month['pay_amount'];//ยอดที่ชำระต่อเดือน เงินต้น
+							}
+							
+							if(@$value_month['pay_type'] == 'interest'){
+								@$arr_list_loan[7]['loan_interest'] += @$value_month['pay_amount'];//(ดอกเบี้ย)
+							}
+							$arr_list_loan[7]['loan_id'] = @$value_month['loan_atm_id'];//loan_id
+						}
+						
+						
+					}			
+					
+					$this->db->select(array('*'));
+					$this->db->from('coop_loan_type');
+					$loan_type = $this->db->get()->result_array();
+					$list_loan = array();
+					$loan_principle_total = 0;
+					$loan_interest_total = 0;
+					if(!empty($loan_type)){
+						foreach($loan_type AS $key=>$value){						
+							$list_loan[$value['id']]['loan_name']= $value['loan_type'];//ชื่อเงินกู้หลัก
+							$list_loan[$value['id']]['loan_principle']= @$arr_list_loan[$value['id']]['loan_principle'];//ยอดที่ชำระต่อเดือน
+							$list_loan[$value['id']]['loan_interest'] = @$arr_list_loan[$value['id']]['loan_interest'];//(ดอกเบี้ย)
+							$loan_principle_total += @$arr_list_loan[$value['id']]['loan_principle'];
+							$loan_interest_total += @$arr_list_loan[$value['id']]['loan_interest'];
+						}
+					}
+					$arr_data['list_loan'] = @$list_loan;	
+					
+				}else{
+					
+					//ยังไม่ได้ออกรายการเรียกเก็บประจำเดือน
+					$arr_list_loan = array();
+					$this->db->select('setting_value');
+					$this->db->from('coop_share_setting');
+					$this->db->where("setting_id = '1'");
+					$row = $this->db->get()->result_array();
+					$row_share_value = $row[0];
+					$share_value = $row_share_value['setting_value'];
+				
+					$this->db->select(array('deduct_id','deduct_code','deduct_detail','deduct_type','deduct_format','deposit_type_id','deposit_amount'));
+					$this->db->from('coop_deduct');
+					$this->db->order_by('deduct_seq ASC');
+					$deduct_list = $this->db->get()->result_array();
+					//echo '<pre>'; print_r($deduct_list); echo '</pre>';	
+					foreach($deduct_list as $key2 => $value2){
+						
+						//หุ้นหักรายเดือน
+						if($value2['deduct_code']=='SHARE'){
+							//งดหุ้นชั่วคราว
+							$check_refrain_share = 0;
+							$this->db->select('*');
+							$this->db->from('coop_refrain_share');
+							$this->db->where("member_id = '".$row_member['member_id']."' AND type_refrain = '2' AND month_refrain = '".@$month_now."' AND year_refrain = '".@$year_now."'");
+							$this->db->order_by('refrain_id DESC');			
+							$rs_refrain_temporary = $this->db->get()->result_array();
+							if(!empty($rs_refrain_temporary)){
+								foreach($rs_refrain_temporary AS $key=>$value){
+									$check_refrain_share = 1;
+								}
+							}
+							
+							//งดหุ้นถาวร
+							$this->db->select('*');
+							$this->db->from('coop_refrain_share');
+							$this->db->where("member_id = '".$row_member['member_id']."' AND type_refrain = '1'");
+							$this->db->order_by('refrain_id DESC');			
+							$rs_refrain_permanent = $this->db->get()->result_array();
+							if(!empty($rs_refrain_permanent)){
+								foreach($rs_refrain_permanent AS $key=>$value){
+									$check_refrain_share = 1;
+								}
+							}				
+							
+							//ทุนเรือนหุ้น
+							if(@$row_member['apply_type_id'] == '1' && $check_refrain_share == 0){															
+								$share = @$row_member['share_month'];
+								$share_month = @$share;
+								$share_month_interest = 0;
+								$arr_data['share_month'] = @$share_month; //หุ้นหักรายเดือน(เงินต้น)
+								$arr_data['share_month_interest'] = @$share_month_interest; //หุ้นหักรายเดือน(ดอกเบี้ย)
+							}
+							//echo $row_member['apply_type_id'].'<br>';
+							/*if(@$row_member['apply_type_id'] == '1'){	
+								$this->db->select(array('change_value'));
+								$this->db->from('coop_change_share');
+								$this->db->where("member_id = '".$row_member['member_id']."' AND change_share_status IN ('1','2')");
+								$this->db->order_by("change_share_id DESC");
+								$this->db->limit(1);
+								$row_change_share = $this->db->get()->result_array();
+								$row_change_share = @$row_change_share[0];
+								$sum = 0;
+								if(@$row_change_share['change_value'] != ''){
+									$num_share = @$row_change_share['change_value'];
+								}else{
+									$this->db->select(array('share_salary'));
+									$this->db->from('coop_share_rule');
+									$this->db->where("salary_rule <= '".$row_member['salary']."'");
+									$this->db->order_by("salary_rule DESC");
+									$this->db->limit(1);
+									$row_share_rule = $this->db->get()->result_array();
+									$row_share_rule = @$row_share_rule[0];
+									
+									$num_share = @$row_share_rule['share_salary'];
+								}
+								$share = @$num_share*@$share_value;
+	
+								$share_month = @$share;
+								$share_month_interest = 0;
+								$arr_data['share_month'] = @$share_month; //หุ้นหักรายเดือน(เงินต้น)
+								$arr_data['share_month_interest'] = @$share_month_interest; //หุ้นหักรายเดือน(ดอกเบี้ย)
+							}
+							*/
+						}
+						
+						//เงินฝากหักรายเดือน
+						if($value2['deduct_code']=='DEPOSIT'){							
+							//เงินฝาก	
+							$sum_deposit = 0;
+							$DEPOSIT = 0;						
+							$deposit_type_id = @$value2['deposit_type_id'];
+							$DEPOSIT = @$value2['deposit_amount'];
+							//echo $deposit_type_id.'<hr>';
+							$deposit_period_count = 1;
+							$deposit_balance = $DEPOSIT;
+							
+							$this->db->select('*');
+							$this->db->from('coop_maco_account');
+							$this->db->where("mem_id = '".@$row_member['member_id']."' AND type_id = '".@$deposit_type_id."'");
+							$this->db->limit(1);
+							$rs_account = $this->db->get()->result_array();
+							$account_id = @$rs_account[0]['account_id'];
+							if(!empty($account_id)){												
+								if($DEPOSIT > 0){						
+									$sum_deposit += @$DEPOSIT;
+								}
+							}
+	
+							$deposit_month =  @$sum_deposit;
+							$deposit_month_interest = 0;	
+							$arr_data['deposit_month'] = @$deposit_month; //เงินฝากหักรายเดือน(เงินต้น)
+							$arr_data['deposit_month_interest'] = @$deposit_month_interest; //เงินฝากหักรายเดือน(ดอกเบี้ย)							
+						}
+					
+						
+						if(@$value2['deduct_code'] == 'LOAN'){										
+							$LOAN = array();
+							$where = '';
+							$where .= " AND (coop_loan.guarantee_for_id = '' OR coop_loan.guarantee_for_id IS NULL) ";
+			
+							$this->db->select(
+								array(
+									'coop_loan.id',
+									'coop_loan.loan_type',
+									'coop_loan.contract_number',
+									'coop_loan.loan_amount_balance',
+									'coop_loan.interest_per_year',
+									'coop_loan_transfer.date_transfer',
+									'coop_loan_name.loan_name',
+									'coop_loan.pay_type',
+									'coop_loan.money_period_1',
+									'coop_loan.createdatetime',
+									'coop_loan.guarantee_for_id',
+									'coop_loan_name.loan_type_id'
+								)
+							);
+							$this->db->from('coop_loan');
+							$this->db->join('coop_loan_transfer', 'coop_loan_transfer.loan_id = coop_loan.id', 'left');
+							$this->db->join('coop_loan_name', 'coop_loan_name.loan_name_id = coop_loan.loan_type', 'inner');
+							$this->db->where("
+								coop_loan.loan_amount_balance > 0
+								AND coop_loan.member_id = '".$row_member['member_id']."'
+								AND coop_loan.loan_status = '1'
+								AND coop_loan_transfer.transfer_status = '0'
+								AND coop_loan.date_start_period <= '".($year_now-543)."-".sprintf("%02d",$month_now)."-".date('t',strtotime(($year_now-543)."-".$month_now."-01"))."' 
+							".$where);
+							$row_loan_month = $this->db->get()->result_array();
+							//echo $this->db->last_query()."<br>";
+							$j=0;
+							
+							foreach($row_loan_month as $key => $row_normal_loan){
+								$this->db->select(array('deduct_id','ref_id'));
+								$this->db->from('coop_deduct_detail');
+								$this->db->where("deduct_id = '{$value2['deduct_id']}' AND ref_id = '{$row_normal_loan['loan_type']}'");
+								$rs_deduct_detail = $this->db->get()->result_array();
+								$ref_id = @$rs_deduct_detail[0]['ref_id'];
+								if(!empty($ref_id)){
+									$deduct_format = @$value2['deduct_format'];
+									
+									if($row_normal_loan['guarantee_for_id']!=''){
+										$for_loan_id = $row_normal_loan['guarantee_for_id'];
+									}else{
+										$for_loan_id = $row_normal_loan['id'];
+									}
+									
+									$this->db->select(
+										array(
+											'outstanding_balance',
+											'principal_payment',
+											'total_paid_per_month'
+										)
+									);
+									$this->db->from('coop_loan_period');
+									$this->db->where("loan_id = '".$for_loan_id."'");
+									$this->db->limit(1);
+									$row_loan_period = $this->db->get()->result_array();
+									$row_principal_payment = $row_loan_period[0];
+									
+									$date_interesting = $date_month_end;
+									$cal_loan_interest = array();
+									$cal_loan_interest['loan_id'] = $row_normal_loan['id'];
+									$cal_loan_interest['date_interesting'] = $date_interesting;
+									$interest = $this->loan_libraries->cal_loan_interest($cal_loan_interest);
+									
+									if($row_principal_payment['principal_payment'] > $row_normal_loan['loan_amount_balance']){
+										$principal_payment = @$row_normal_loan['loan_amount_balance'];
+										$balance = 0;
+									}else{
+										$principal_payment = @$row_principal_payment['principal_payment'];
+										$balance = @$row_normal_loan['loan_amount_balance']-@$row_principal_payment['principal_payment'];
+									}
+									
+									$LOAN[$j]['loan_id'] = $row_normal_loan['id'];
+									$LOAN[$j]['loan_type'] = $row_normal_loan['loan_name'];
+									//$LOAN[$j]['loan_type_id'] = $row_normal_loan['loan_type'];
+									$LOAN[$j]['loan_type_id'] = $row_normal_loan['loan_type_id'];
+									$LOAN[$j]['contract_number'] = $row_normal_loan['contract_number'];
+									$LOAN[$j]['money_period_1'] = $row_normal_loan['money_period_1'];
+									$LOAN[$j]['pay_loan_type'] = $row_normal_loan['pay_type'];
+									if($deduct_format == '2'){
+										$LOAN[$j]['text_title'] = 'ต้นเงินกู้เลขที่สัญญา';
+										$LOAN[$j]['principal_payment'] = $principal_payment;
+										$LOAN[$j]['interest'] = 0;
+										$LOAN[$j]['total'] = $principal_payment;
+										$LOAN[$j]['pay_type'] = 'principal';
+									}else if($deduct_format == '1'){
+										$LOAN[$j]['text_title'] = 'ดอกเบี้ยเงินกู้เลขที่สัญญา';
+										$LOAN[$j]['principal_payment'] = 0;
+										$LOAN[$j]['interest'] = $interest;
+										$LOAN[$j]['total'] = $interest;
+										$LOAN[$j]['pay_type'] = 'interest';
+										$interest_arr[$row_normal_loan['id']] = $interest;
+									}	
+									$balance = @$row_normal_loan['loan_amount_balance']-$principal_payment-$interest;
+									$LOAN[$j]['balance'] = $balance;
+									
+								}
+								$j++;
+							}
+							//echo"<pre>";print_r($LOAN);echo"</pre>";
+							if(!empty($LOAN)){
+								foreach($LOAN as $key3 => $value3){
+									$arr_list_loan[@$value3['loan_type_id']]['loan_principle'] = @$value3['principal_payment'];//ยอดที่ชำระต่อเดือน เงินต้น							
+									$arr_list_loan[@$value3['loan_type_id']]['loan_interest'] = @$value3['interest'];//(ดอกเบี้ย)
+									$arr_list_loan[@$value3['loan_type_id']]['loan_id'] = @$value3['loan_id'];//loan_id
+								}
+							}
+							
+							//echo '<pre>'; print_r($arr_list_loan); echo '</pre>';
+						}
+						
+						if(@$value2['deduct_code'] == 'ATM'){					
+							$ATM = 0;
+							$this->db->select(array(
+								't1.loan_amount_balance',
+								't1.principal_per_month',
+								't2.contract_number',
+								't2.loan_atm_id',
+								't1.date_last_pay',
+								't1.loan_date'
+							));
+							$this->db->from('coop_loan_atm_detail as t1');
+							$this->db->join('coop_loan_atm as t2', 't1.loan_atm_id = t2.loan_atm_id', 'inner');
+							$this->db->where("
+								t2.member_id = '".$row_member['member_id']."'
+								AND t2.loan_atm_status = '1'
+								AND t1.date_start_period <= '".$date_month_end."'
+								AND t1.loan_status = '0'
+							");
+							$row_atm = $this->db->get()->result_array();
+							$principal_per_month = 0;
+							$loan_amount_balance = 0;
+							if(!empty($row_atm)){
+								foreach($row_atm as $key_atm => $value_atm){
+									$loan_atm_id = @$value_atm['loan_atm_id'];
+									$principal_per_month += @$value_atm['principal_per_month'];
+									$loan_amount_balance += @$value_atm['loan_amount_balance'];
+								}
+								if(@$principal_per_month < @$loan_atm_setting['min_principal_pay_per_month']){
+									$principal_per_month = @$loan_atm_setting['min_principal_pay_per_month'];
+								}
+								if(@$principal_per_month > @$loan_amount_balance){
+									$principal_per_month = @$loan_amount_balance;
+								}
+								
+								$cal_loan_interest = array();
+								$cal_loan_interest['loan_atm_id'] = @$loan_atm_id;
+								$cal_loan_interest['date_interesting'] = @$date_month_end;
+								$interest = $this->loan_libraries->cal_atm_interest(@$cal_loan_interest);
+								
+								
+								$deduct_format = @$value2['deduct_format'];
+								if($deduct_format == '2'){
+									@$arr_list_loan[7]['loan_principle'] += @$principal_per_month;//ยอดที่ชำระต่อเดือน เงินต้น
+								}else{
+									@$arr_list_loan[7]['loan_interest'] += @$interest;//(ดอกเบี้ย)
+								}
+								$arr_list_loan[7]['loan_id'] = @$loan_atm_id;//loan_id
+							}
+						}
+					}
+					
+						
+					$this->db->select(array('*'));
+					$this->db->from('coop_loan_type');
+					$loan_type = $this->db->get()->result_array();
+					$list_loan = array();
+					$loan_principle_total = 0;
+					$loan_interest_total = 0;
+					if(!empty($loan_type)){
+						foreach($loan_type AS $key=>$value){						
+							$list_loan[$value['id']]['loan_name']= $value['loan_type'];//ชื่อเงินกู้หลัก
+							$list_loan[$value['id']]['loan_principle']= @$arr_list_loan[$value['id']]['loan_principle'];//ยอดที่ชำระต่อเดือน
+							$list_loan[$value['id']]['loan_interest'] = @$arr_list_loan[$value['id']]['loan_interest'];//(ดอกเบี้ย)
+							$loan_principle_total += @$arr_list_loan[$value['id']]['loan_principle'];
+							$loan_interest_total += @$arr_list_loan[$value['id']]['loan_interest'];
+						}
+					}
+					$arr_data['list_loan'] = @$list_loan;	
+				}
+			}
+			// var_dump($arr_list_loan);exit;
+			$arr_data['arr_list_loan'] = @$arr_list_loan;
+			///////////////////////////////////////////////
+			
+			//เงินฝาก
+			$this->db->select(array('coop_maco_account.account_id','coop_maco_account.mem_id','coop_maco_account.account_name','coop_deposit_type_setting.type_name'));
+			$this->db->from('coop_maco_account');
+			$this->db->join("coop_deposit_type_setting","coop_maco_account.type_id = coop_deposit_type_setting.type_id AND deduct_loan = '1'","inner");
+			$this->db->where("coop_maco_account.mem_id = '".@$member_id."'");
+			$row_account= $this->db->get()->result_array();
+			$account_list = array();
+			if(!empty($row_account)){
+				foreach($row_account AS $key=>$value){
+					$this->db->select(array('transaction_balance','transaction_deposit'));
+					$this->db->from('coop_account_transaction');
+					$this->db->where("account_id = '".$value['account_id']."'");
+					$this->db->order_by('transaction_id DESC');
+					$this->db->limit(1);
+					$row_balance = $this->db->get()->result_array();
+					//$account_balance  = @$row_balance[0]['transaction_balance'];
+					$account_balance  = @$row_balance[0]['transaction_deposit'];
+					
+					$account_list[$value['account_id']]['account_id'] =  @$value['account_id'];
+					$account_list[$value['account_id']]['account_name'] =  @$value['account_name'];
+					$account_list[$value['account_id']]['account_balance'] =  @$account_balance;
+					//print_r($this->db->last_query());
+				}
+			}
+			$arr_data['account_list'] = @$account_list;			
+			
+			//ปิดสัญญาเดิม
+			//
+			/*
+			$this->db->select(array('t1.*','t3.loan_type_code'));
+			$this->db->from("coop_loan as t1");
+			$this->db->join("coop_loan_name as t2",'t1.loan_type = t2.loan_name_id','inner');
+			$this->db->join("coop_loan_type as t3",'t2.loan_type_id = t3.id','inner');
+			$this->db->where("t1.id = '".@$loan_id."'");
+			$rs_loan = $this->db->get()->result_array();
+			$rs_loan = $rs_loan[0];	
+			*/			
+			
+			$date_interesting = date('Y-m-d');
+			$list_old_loan = array();
+			
+			$this->db->select(array('t1.*',
+									't2.contract_number',
+									't2.loan_amount_balance',
+									't2.id'
+									));
+			$this->db->from("coop_loan_prev_deduct t1");
+			$this->db->join("coop_loan t2",'t1.ref_id = t2.id','inner');
+			$this->db->where("t1.loan_id = '".@$loan_id."' AND t1.data_type = 'loan'");
+			$row = $this->db->get()->result_array();
+			$index = 0;
+			if(@$_GET['dev'] == 'dev'){
+				echo 'coop_loan_prev_deduct<br>';
+				print_r($this->db->last_query()); //exit;
+			}
+			$extra_debt = array();
+			foreach($row as $key => $value){
+				$list_old_loan[$index]['contract_number'] = @$value['contract_number'];
+				
+				$extra_debt_amount	= 0;//หนี้ห้อย
+				/*if(date("Y-m", strtotime($rs_loan[0]['createdatetime']) ) != date("Y-m") ){
+					$month = date("m", strtotime("+1 months", strtotime($rs_loan[0]['createdatetime'])) );
+					if($month=="01"){
+						$year = date("Y", strtotime($rs_loan[0]['createdatetime']) ) + 543 + 1;
+					}else{
+						$year = date("Y", strtotime($rs_loan[0]['createdatetime']) ) + 543;
+					}
+					
+					$this->db->select('profile_id');
+					$this->db->from('coop_finance_month_profile');
+					$this->db->where("profile_month = '".(int)$month."' AND profile_year = '".$year."' ");
+					$profile_id = $this->db->get()->result_array()[0]['profile_id'];
+					if(@$_GET['dev'] == 'dev'){
+						echo '<hr>';
+						print_r($this->db->last_query());
+					}
+					$this->db->select("sum(pay_amount) as sum_of_pay_amount");
+					$finance_month_detail = $this->db->get_where("coop_finance_month_detail", array(
+						"profile_id" => $profile_id,
+						"member_id" => $rs_loan[0]['member_id'],
+						"loan_id" => $value['id'],
+						"pay_type" => "principal",
+						"run_status" => 0
+					))->result_array()[0];
+					if(@$_GET['dev'] == 'dev'){
+						echo '<hr>';
+						print_r($this->db->last_query());
+						echo '<hr>'.date("Y-m", strtotime($rs_loan[0]['createdatetime']) ).' !='. date("Y-m").'<br>';
+					}
+					if($finance_month_detail && $rs_loan[0]['loan_status']==0){
+						$extra_debt['total_princical'] += $finance_month_detail['sum_of_pay_amount'];
+						$extra_debt_amount	= $finance_month_detail['sum_of_pay_amount'];
+					}
+						
+				}
+				*/
+
+				if($value['pay_type'] == 'principal'){	
+					if(@$_GET['dev'] == 'dev'){
+						echo 'pay_amount='.@$value['pay_amount'].'<br>';
+						echo 'extra_debt_amount='.@$extra_debt_amount.'<br>';
+					}				
+					$list_old_loan[$index]['loan_id'] = @$value['id'];
+					$list_old_loan[$index]['loan_amount_balance'] = @$value['pay_amount'] - $extra_debt_amount;
+					$list_old_loan[$index]['loan_interest_amount'] = 0;
+				}else{
+					$list_old_loan[$index]['loan_id'] = @$value['id'];
+					$list_old_loan[$index]['loan_amount_balance'] = @$value['pay_amount'] - $extra_debt_amount - @$value['interest_amount'];
+					$list_old_loan[$index]['loan_interest_amount'] = @$value['interest_amount'];
+					/*$list_old_loan[$index]['loan_amount_balance'] = @$value['loan_amount_balance'];
+					$cal_loan_interest = array();
+					$cal_loan_interest['loan_id'] = @$value['ref_id'];
+					$cal_loan_interest['date_interesting'] = $this->center_function->ConvertToSQLDate(@$date_interesting);
+					$interest_data = $this->loan_libraries->cal_loan_interest($cal_loan_interest);
+					$list_old_loan[$index]['loan_interest_amount'] = @$interest_data;
+					*/
+				}
+				$index++;
+			}
+			
+			//ปิดปัญชีกู้ฉุกเฉิน ATM
+			$this->db->select(array('t1.*',
+									't2.contract_number',
+									't2.total_amount_approve',
+									't2.total_amount_balance',
+									't2.loan_atm_id'
+									));
+			$this->db->from("coop_loan_prev_deduct t1");
+			$this->db->join("coop_loan_atm t2",'t1.ref_id = t2.loan_atm_id','inner');
+			$this->db->where("t1.loan_id = '".@$loan_id."' AND t1.data_type = 'atm'");
+			$row = $this->db->get()->result_array();
+			if(@$_GET['dev'] == 'dev'){
+				print_r($this->db->last_query()); //exit;
+				echo '<pre>'; print_r(@$row); echo '</pre>';
+			}
+			
+			foreach($row as $key => $value){
+				$list_old_loan[$index]['contract_number'] = @$value['contract_number'];
+				if($value['pay_type'] == 'principal'){					
+					$list_old_loan[$index]['loan_id'] = @$value['loan_atm_id'];
+					//$list_old_loan[$index]['loan_amount_balance'] = @$value['total_amount_approve'] - @$value['total_amount_balance'];
+					$list_old_loan[$index]['loan_amount_balance'] = @$value['pay_amount'] - @$value['interest_amount'];
+					$list_old_loan[$index]['loan_interest_amount'] = 0;
+				}else{
+					$list_old_loan[$index]['loan_id'] = @$value['loan_atm_id'];
+					//$list_old_loan[$index]['loan_amount_balance'] = @$value['total_amount_approve'] - @$value['total_amount_balance'];
+					$list_old_loan[$index]['loan_amount_balance'] = @$value['pay_amount'] - @$value['interest_amount'];
+					/*$cal_loan_interest = array();
+					//$cal_loan_interest['loan_id'] = @$value['ref_id'];
+					$cal_loan_interest['loan_atm_id'] = @$value['ref_id'];
+					$cal_loan_interest['date_interesting'] = $this->center_function->ConvertToSQLDate(@$date_interesting);
+					$interest_atm = $this->loan_libraries->cal_atm_interest_deduct($cal_loan_interest);
+					$list_old_loan[$index]['loan_interest_amount'] = @$interest_atm;
+					*/
+					$list_old_loan[$index]['loan_interest_amount'] = @$value['interest_amount'];
+				}
+				$index++;
+			}	
+			
+			if(@$_GET['dev'] == 'dev'){
+					echo '<pre>'; print_r(@$list_old_loan); echo '</pre>';
+			}
+			
+			$arr_data['list_old_loan'] = @$list_old_loan;
+			$total_principal = 0;
+			$total_interest = 0;
+			$total_loan_balance = 0;
+			if(!empty($list_old_loan)){
+				foreach($list_old_loan AS $key => $value){
+					$total_principal += @$value['loan_amount_balance'];
+					$total_interest += @$value['loan_interest_amount'];
+					$total_loan_balance += @$value['loan_amount_balance']+@$value['loan_interest_amount'];
+				}
+			}
+			
+			$arr_data['existing_loan'] = @$total_loan_balance; //หักเงินกู้เดิม
+			$arr_data['principal_load'] = @$total_principal;//ภาระเงินต้น
+			$arr_data['interest_burden'] = @$total_interest;//ภาระดอกเบี้ย
+			$arr_data['extra_debt'] = @$extra_debt;//หนี้ห้อย
+			
+			$loan_amount = @$row_loan['loan_amount']; //วงเงินที่ขออนุมัติ		
+			
+			$month_receipt = date("m", strtotime($row_loan['createdatetime']));
+			$year_receipt = date("Y", strtotime($row_loan['createdatetime']));
+			
+			$this->db->select(array('deduct_id','deduct_code','deduct_detail','deduct_type','deduct_format','deposit_type_id','deposit_amount'));
+			$this->db->from('coop_deduct');
+			$this->db->order_by('deduct_seq ASC');
+			$deduct_list = $this->db->get()->result_array();
+			$data_arr['deduct_list'] = @$deduct_list;
+			//
+			
+			$deductible =  0 ;			
+			//ค่าธรรมเนียม 
+			$this->db->select(array('*'));
+			$this->db->from('coop_loan_deduct');
+			$this->db->where("loan_id = '{$loan_id}'");
+			$rs_deduct = $this->db->get()->result_array();
+			//echo $loan_id.'<hr>';
+			//echo '<pre>'; print_r($rs_deduct); echo '</pre>';
+			if(!empty($rs_deduct)){
+				foreach($rs_deduct AS $key=>$row_deduct){
+					if(!in_array($row_deduct['loan_deduct_list_code'], array( 'deduct_pay_prev_loan', 'deduct_cheque'))){
+						$deductible += @$row_deduct['loan_deduct_amount'];
+					}
+					
+					if($row_deduct['loan_deduct_list_code'] == 'deduct_loan_fee'){
+						$arr_data['deduct_loan_fee'] = @$row_deduct['loan_deduct_amount'];
+					}
+					
+					if($row_deduct['loan_deduct_list_code'] == 'deduct_person_guarantee'){
+						//มีการกำหนดกรณีไม่ผ่านเกณฑ์
+						$arr_data['deduct_person_guarantee'] = @$row_deduct['loan_deduct_amount'];
+					}
+
+					if($row_deduct['loan_deduct_list_code'] == 'deduct_insurance'){
+						//เบี้ยประกัน
+						$arr_data['deduct_insurance'] = @$row_deduct['loan_deduct_amount'];
+					}
+
+					if($row_deduct['loan_deduct_list_code'] == 'deduct_cheque'){
+                        $arr_data['deduct_cheque'] = @$row_deduct['loan_deduct_amount'];
+                    }
+				}
+			}
+			//exit;			
+			
+			$arr_data['deductible'] =  @$deductible; //รายการหัก
+			$total_amount = @$loan_amount - @$total_loan_balance - @$deductible - @$arr_data['deduct_cheque'];
+			$arr_data['total_amount'] = @$total_amount;
+			
+			$arr_data['total_paid_per_month'] =  @$total_paid_per_month; //รวมชำระต่องวด
+			
+			//รายการรับเงิน	
+			$arr_receiving_money = array();
+			//ชำระหนี้สถาบันการเงิน
+			$this->db->select(array('*'));
+			$this->db->from('coop_loan_financial_institutions');
+			$this->db->where("loan_id = '".@$loan_id."'");
+			$this->db->order_by("order_by ASC");
+			$rs_financial_institutions = $this->db->get()->result_array();
+			
+			$i=0;
+			$financial_amount = 0;
+			foreach($rs_financial_institutions AS $key=>$row_financial_institutions){
+				$arr_receiving_money[$i]['transfer_type'] = 'จ่ายธนาคาร'.@$row_financial_institutions['financial_institutions_name'];
+				$arr_receiving_money[$i]['total_received'] = @$row_financial_institutions['financial_institutions_amount'];
+				$financial_amount += @$row_financial_institutions['financial_institutions_amount'];
+				$i++;
+			}
+			
+			//การจ่ายเงินกู้
+			$transfer_type = array('0'=>'เงินสด','1'=>'โอนเงินบัญชีสหกรณ์','2'=>'โอนเงินบัญชี','3' => 'พร้อมเพย์', '4' => 'เช็คเงินสด');
+			if(@$row_loan['transfer_type'] == '2'){
+				$transfer_type_description = '';
+				$transfer_type_description .= @$row_loan['bank_name'];
+				$transfer_type_description .= '<br> เลขที่บัญชี '.@$row_loan['transfer_bank_account_id'];
+			}else if(@$row_loan['transfer_type'] == '1'){
+				$transfer_type_description = ' '.@$row_loan['transfer_account_id'].':'.@$row_loan['account_name'];
+			}else{
+				$transfer_type_description = '';
+			}
+			$text_transfer_type = @$transfer_type[@$row_loan['transfer_type']].@$transfer_type_description;
+			
+			//ยอดเงินที่จะได้รับโดยประมาณ
+			$this->db->select(array('estimate_receive_money'));
+			$this->db->from('coop_loan_deduct_profile');
+			$this->db->where("loan_id = '".@$loan_id."'");
+			$loan_deduct_profile = $this->db->get()->result_array();
+			$estimate_receive_money = @$loan_deduct_profile[0]['estimate_receive_money'];			
+			
+			$arr_receiving_money[$i]['transfer_type'] = @$text_transfer_type;
+			$arr_receiving_money[$i]['total_received'] = @$estimate_receive_money-@$financial_amount;
+			
+			$arr_data['receiving_money'] = $arr_receiving_money;		
+					
+			$arr_data['total_month'] = @$share_month+@$deposit_month+@$loan_principle_total;//รวมทั้งสิ้น รายการผ่อนชำระสหกรณ์ปัจจุบัน/เดือน
+			$arr_data['total_month_interest'] = @$share_month_interest+@$deposit_month_interest+@$loan_interest_total;//รวมทั้งสิ้น รายการผ่อนชำระสหกรณ์ปัจจุบัน/เดือน(ดอกเบี้ย)
+			
+			//บุคคลค้ำประกัน
+			$this->db->select(array(
+				't1.*',
+				't3.member_id',
+				't3.firstname_th',
+				't3.lastname_th',
+				't3.mem_group_id',
+				't3.salary',
+				't3.birthday',
+				't3.member_date',
+				't3.share_month',
+				't4.mem_group_name',
+				't5.prename_full'
+			));
+			$this->db->from('coop_loan_guarantee_person as t1');
+			$this->db->join('coop_mem_apply as t3','t1.guarantee_person_id = t3.member_id','inner');
+			$this->db->join("coop_mem_group as t4", "t3.level = t4.id", "left");
+			$this->db->join("coop_prename as t5", "t3.prename_id = t5.prename_id", "left");
+			$this->db->where("t1.loan_id = '{$loan_id}' AND t3.member_status <> '3'");
+			$this->db->order_by("t1.id ASC");
+			$rs_guarantee = $this->db->get()->result_array();
+			foreach($rs_guarantee AS $key=>$row_guarantee){
+				$this->db->from('coop_loan_guarantee_person as t1');
+				$this->db->join('coop_loan as t2','t1.loan_id = t2.id ','inner');
+				$this->db->where("
+					t1.guarantee_person_id = '".@$row_guarantee['guarantee_person_id']."' 
+					AND t2.loan_status IN('1','2')
+				");
+				$rs_count_guarantee = $this->db->get()->result_array();
+				$n=0;
+				foreach($rs_count_guarantee as $key_count => $row_count_guarantee){
+					$n++;
+				}
+				@$rs_guarantee[$key]['count_guarantee'] = @$n;
+
+				$share = $this->db->select("share_period, share_collect_value")->from("coop_mem_share")->where("share_date <= '".$row_loan["createdatetime"]."' AND member_id = '".$row_guarantee['guarantee_person_id']."' AND share_status IN (1,5,6)")->order_by("share_date DESC")->get()->row();
+				$rs_guarantee[$key]['share_balance'] = $share->share_collect_value;
+				$rs_guarantee[$key]['share_period'] = $share->share_period;
+
+				//ข้อมูลค้ำประกันเงินกู้
+				$guarantors_raw = $this->db->select("t3.member_id, t2.contract_number, t3.firstname_th, t3.lastname_th, t4.prename_full, t1.loan_id")
+							->from("coop_loan_guarantee_person as t1")
+							->join("coop_loan as t2", "t1.loan_id = t2.id", "INNER")
+							->join("coop_mem_apply as t3", "t2.member_id = t3.member_id", "LEFT")
+							->join("coop_prename as t4", "t3.prename_id = t4.prename_id", "LEFT")
+							->where("t1.guarantee_person_id = '".$row_guarantee['guarantee_person_id']."'")
+							->get()->result_array();
+				$guarantors = array();
+				foreach($guarantors_raw as $data) {
+					$transaction = $this->db->select("*")->from("coop_loan_transaction")->where("loan_id = '".$data["loan_id"]."' AND transaction_datetime <= '".$row_loan["createdatetime"]."'")->order_by("transaction_datetime DESC")->get()->row();
+					if($transaction->loan_amount_balance > 0) {
+						$guarantors[] = $data;
+					}
+				}
+
+				$rs_guarantee[$key]["guarantors"] = $guarantors;
+
+                //หุ้นค้ำประกัน
+                $res_guarantee =  $this->db->get_where('coop_loan_guarantee', array('loan_id' => $loan_id))->row_array();
+                $arr_data['g_share_amt'] = $res_guarantee['amount'];
+
+
+                $loans = array();
+				$loan_raw = $this->db->select("t1.id as loan_id, t1.approve_date, t1.contract_number, t1.date_last_interest, t1.loan_amount, t1.money_per_period, t1.period_amount, t1.period_now")
+							->from("coop_loan as t1")
+							->where("t1.member_id = '".$row_guarantee['guarantee_person_id']."' AND t1.loan_status IN (1,4,6,7,8) AND t1.id != '".$_GET["loan_id"]."'")
+							->get()->result_array();
+				foreach($loan_raw as $loan) {
+					$transaction = $this->db->select("*")->from("coop_loan_transaction")->where("loan_id = '".$loan["loan_id"]."' AND transaction_datetime <= '".$row_loan["createdatetime"]."'")->order_by("transaction_datetime DESC")->get()->row();
+					if($transaction->loan_amount_balance > 0) {
+						$loan["balance"] = $transaction->loan_amount_balance;
+						$loans[] = $loan;
+					}
+				}
+				$rs_guarantee[$key]["loans"] = $loans;
+
+			}	
+			$arr_data['row_guarantee'] = @$rs_guarantee;	
+			
+			//รายการซื้อ	
+			$this->db->select(array('*'));
+			$this->db->from('coop_loan_deduct_list');
+			$this->db->where("loan_deduct_list_code != 'deduct_pay_prev_loan' AND loan_deduct_status = 1");
+			$this->db->order_by('run_id ASC');
+			$row = $this->db->get()->result_array();
+			$arr_data['loan_deduct_list'] = $row;	
+			
+			$this->db->select(array(
+				'loan_deduct_list_code',
+				'loan_deduct_amount'
+			));
+			$this->db->from('coop_loan_deduct');
+			$this->db->where("loan_id = '".$loan_id."'");
+			$row = $this->db->get()->result_array();
+			$loan_deduct = array();
+			foreach($row as $key => $value){
+				$loan_deduct[$value['loan_deduct_list_code']] = $value['loan_deduct_amount'];
+			}
+			$arr_data['loan_deduct'] = $loan_deduct;
+			
+			//ค่าใช้จ่าย
+			//			$this->db->from('coop_loan_cost');
+			//			$this->db->where("loan_id = '".$loan_id."' AND member_id = '".$member_id."'");
+			//			$this->db->limit(1);
+			//			$rs_cost = $this->db->get()->result_array();
+			//			$row_cost = @$rs_cost[0];
+			//			$arr_data['school_benefits'] = $row_cost['school_benefits'];
+			//			$arr_data['saving'] = @$row_cost['saving'];
+			//			$arr_data['ch_p_k'] = @$row_cost['ch_p_k'];
+			//			$arr_data['pension'] = @$row_cost['pension'];
+			//			$arr_data['k_b_k'] = @$row_cost['k_b_k'];
+			//			$arr_data['other'] = @$row_cost['other'];
+
+            //รายได้
+            $sql = "SELECT
+				*, 
+				IFNULL((select coop_income_loan_detail.income_value from coop_income_loan_detail where coop_income_loan_detail.loan_id = '".$loan_id."' and coop_income_loan_detail.income_id = coop_income.id), 0) as income_value
+			FROM
+				`coop_income`
+			ORDER BY
+				`seq` ASC";
+
+            if($_GET['sql'] == 'show'){
+                echo $sql; exit;
+            }
+            $arr_data['income'] = $this->db->query($sql)->result_array();
+
+            //ค่าใช้จ่าย
+            $arr_data['loan_cost_code'] = array();
+            $this->db->select('outgoing_code, outgoing_name, loan_cost_amount');
+            $this->db->from("coop_outgoing");
+            $this->db->join("coop_loan_cost_mod", "coop_outgoing.outgoing_code=coop_loan_cost_mod.loan_cost_code", "inner");
+            $this->db->where("loan_id = '".$loan_id."' AND member_id = '".$member_id."'");
+            $rs_cost = $this->db->get()->result_array();
+            $arr_data['loan_cost_code'] = $rs_cost;
+			//            foreach ($rs_cost as $key => $val){
+			//                $arr_data['loan_cost_code'] = $val['loan_cost_amount'];
+			//            }
+
+			//อสังหาทรัพย์ค้ำประกัน
+			$this->db->select(array('t1.*',
+									't2.province_name',
+									't3.amphur_name',
+									't4.district_name'
+								));
+			$this->db->from("coop_loan_guarantee_real_estate t1");
+			$this->db->join("coop_province t2","t1.province_id = t2.province_id","left");
+			$this->db->join("coop_amphur t3","t1.amphur_id = t3.amphur_id","left");
+			$this->db->join("coop_district t4","t1.district_id = t4.district_id","left");
+			$this->db->where("t1.loan_id = '".$loan_id."'");
+			$rs_real_estate = $this->db->get()->result_array();
+			$arr_data['row_real_estate'] = @$rs_real_estate[0];
+			
+			//$member_id = @$_GET['member_id'];
+			//$loan_id = @$_GET['loan_id'];
+			//@start ข้อมูลประกันชีวิต
+			$rs_cremation_type = $this->db->select('import_cremation_type,import_amount_balance')
+			->from('coop_life_insurance_cremation')
+			->where("member_id = '".$member_id."' AND loan_id = '".$loan_id."'")
+			->get()->result_array();
+			$cremation_type_1 = 0;
+			$cremation_type_2 = 0;
+			foreach($rs_cremation_type AS $key=>$row_cremation_type){
+				//ชสอ
+				if($row_cremation_type['import_cremation_type'] == '1'){
+					$cremation_type_1 = @$row_cremation_type['import_amount_balance'];
+				}
+				
+				//สสอค
+				if($row_cremation_type['import_cremation_type'] == '2'){
+					$cremation_type_2 = @$row_cremation_type['import_amount_balance'];
+				}
+			}
+			$arr_data['cremation_type_1'] = @$cremation_type_1;
+			$arr_data['cremation_type_2'] = @$cremation_type_2;			
+				
+			$row_life_insurance = $this->db->select('insurance_year,insurance_date,insurance_amount,insurance_premium,insurance_new,insurance_old')
+			->from('coop_life_insurance')
+			->where("member_id = '".$member_id."' AND loan_id = '".$loan_id."'")
+			->limit(1)
+			->get()->result_array();
+			
+			$arr_data['life_insurance_4'] = @$row_life_insurance[0]['insurance_old'];
+			$arr_data['life_insurance_5'] = @$row_life_insurance[0]['insurance_new'];	
+			$arr_data['life_insurance_6'] = @$row_life_insurance[0]['insurance_amount'];	
+			//@end ข้อมูลประกันชีวิต
+
+			//ข้อมูลค้ำประกันเงินกู้
+			$guarantors_raw = $this->db->select("t3.member_id, t2.contract_number, t3.firstname_th, t3.lastname_th, t4.prename_full, t1.loan_id")
+									->from("coop_loan_guarantee_person as t1")
+									->join("coop_loan as t2", "t1.loan_id = t2.id", "INNER")
+									->join("coop_mem_apply as t3", "t2.member_id = t3.member_id", "LEFT")
+									->join("coop_prename as t4", "t3.prename_id = t4.prename_id", "LEFT")
+									->where("t1.guarantee_person_id = '".$member_id."'")
+									->get()->result_array();
+			$guarantors = array();
+			foreach($guarantors_raw as $data) {
+				$transaction = $this->db->select("*")->from("coop_loan_transaction")->where("loan_id = '".$data["loan_id"]."' AND transaction_datetime <= '".$row_loan["createdatetime"]."'")->order_by("transaction_datetime DESC")->get()->row();
+				if($transaction->loan_amount_balance > 0) {
+					$guarantors[] = $data;
+				}
+			}
+
+			$arr_data["guarantors"] = $guarantors;
+
+			$loans = array();
+			$loan_raw = $this->db->select("t1.id as loan_id, t1.approve_date, t1.contract_number, t1.date_last_interest, t1.loan_amount, t1.money_per_period, t1.period_amount, t1.period_now")
+									->from("coop_loan as t1")
+									->where("t1.member_id = '".$member_id."' AND t1.loan_status IN (1,4,6,7,8) AND t1.id != '".$_GET["loan_id"]."'")
+									->get()->result_array();
+			foreach($loan_raw as $loan) {
+				// 2019-12-31 00:00:00
+				$transaction = $this->db->select("*")->from("coop_loan_transaction")->where("loan_id = '".$loan["loan_id"]."' AND transaction_datetime <= '".$row_loan["createdatetime"]."'")->order_by("transaction_datetime DESC")->get()->row();
+				if($transaction->loan_amount_balance > 0) {
+					$loan["balance"] = $transaction->loan_amount_balance;
+					$loans[] = $loan;
+				}
+			}
+			$arr_data["loans"] = $loans;
+
+			$board_raw = $this->db->select("*")->from("coop_loan_board")->get()->result_array();
+			$boards = array();
+			foreach($board_raw as $board) {
+				if($board["level"] != "board") {
+					$boards[$board["level"]] = $board;
+				} else {
+					$boards["boards"][] = $board;
+				}
+			}
+			$arr_data["boards"] = $boards;
+		}
+
+		$arr_data['person_guarantee'] = $this->db->select('person_guarantee')->from('coop_term_of_loan')->where('type_id', $row_loan['loan_type'])->order_by('start_date', 'desc')->limit(1)->get()->row_array()['person_guarantee'];
+        return $arr_data;
+    }
+
+}
\ No newline at end of file
diff --git a/application/models/Setting_model.php b/application/models/Setting_model.php
new file mode 100644
index 0000000..8ed59a4
--- /dev/null
+++ b/application/models/Setting_model.php
@@ -0,0 +1,22 @@
+<?php
+class Setting_model extends CI_Model {
+    
+    public function __construct()
+    {
+        parent::__construct();
+    }
+
+    public function get($setting_name=''){
+        if($setting_name!="") $this->db->where("setting_name", $setting_name);
+        $rs = $this->db->get("coop_setting");
+        $value = ($setting_name!="") ? $rs->row_array()['setting_value'] : $rs->result_array();
+        return $value;
+    }
+
+    public function set($setting_name, $setting_value){
+        $this->db->set("setting_name", $setting_name);
+        $this->db->set("setting_value", $setting_value);
+        $this->db->insert("coop_setting");
+    }
+
+}
\ No newline at end of file
diff --git a/application/views/invest/Invest.php b/application/views/invest/Invest.php
new file mode 100644
index 0000000..4429833
--- /dev/null
+++ b/application/views/invest/Invest.php
@@ -0,0 +1,589 @@
+<?php
+defined('BASEPATH') OR exit('No direct script access allowed');
+
+class Invest extends CI_Controller {
+	function __construct() {
+		parent::__construct();
+		$this->load->model('Invest_libraies', 'invest');
+	}
+	public function index() {
+		$arr_data = array();
+
+		$invest_types = $this->db->select("*")->from("coop_invest_type")->where("status = 1")->order_by("order")->get()->result_array();
+		$invests = $this->db->select("t1.*, t2.end_date")
+							->from("coop_invest as t1")
+							->join("coop_invest_detail as t2", "t1.id = t2.invest_id AND t2.status = 1", "left")
+							->where("t1.status != 3")
+							->order_by("t1.start_date DESC")
+							->get()->result_array();
+		$invest_data = array();
+		foreach($invests as $invest) {
+			$invest_data[$invest['type']][] = $invest;
+		}
+		$arr_data['invest_types'] = $invest_types;
+		$arr_data['invests'] = $invest_data;
+
+		$total_data = $this->invest->get_total_data();
+		$arr_data['total_data'] = $total_data;
+
+		$this->libraries->template('invest/index',$arr_data);
+	}
+
+	public function edit() {
+		$arr_data = array();
+
+		$invest_type = !empty($_POST['invest_type']) ? $_POST['invest_type'] : $_POST['invest_type_sub'];
+
+		if($invest_type == 1) {
+			$sav_c = $_POST['sav_c'];
+			$start_date = !empty($sav_c['start_date']) ? $this->center_function->ConvertToSQLDate($sav_c['start_date']) : NULL;
+			$due_date = !empty($sav_c['due_date']) ? $this->center_function->ConvertToSQLDate($sav_c['due_date']) : NULL;
+			$invest_id = $this->invest->edit_saving_coop($_POST['invest_id'], $sav_c['name'], $sav_c['amount'], $due_date, $sav_c['interest'], $sav_c['period'], $start_date, $sav_c['source'], $_POST['status']);
+		} else if ($invest_type == 2) {
+			$share_c = $_POST['share_c'];
+			$invest_id = $this->invest->edit_share_coop($_POST['invest_id'], $share_c['name'], $share_c['period'], $share_c['source'], $_POST['status']);
+		} else if ($invest_type == 3) {
+			$bond = $_POST['bond'];
+			$start_date = !empty($bond['start_date']) ? $this->center_function->ConvertToSQLDate($bond['start_date']) : NULL;
+			$due_date = !empty($bond['due_date']) ? $this->center_function->ConvertToSQLDate($bond['due_date']) : NULL;
+			$invest_id = $this->invest->edit_bond($_POST['invest_id'], $bond['aver_profit'], $bond['credit_rating'], $start_date, $due_date, $bond['invest_rate_text'], $bond['name'], $bond['department_name'], $bond['payment_method_text'], $bond['unit'], $bond['value_per_unit'], $bond['source'], $_POST['status']);
+		} else if ($invest_type == 4) {
+			$bond = $_POST['bond'];
+			$start_date = !empty($bond['start_date']) ? $this->center_function->ConvertToSQLDate($bond['start_date']) : NULL;
+			$due_date = !empty($bond['due_date']) ? $this->center_function->ConvertToSQLDate($bond['due_date']) : NULL;
+			$invest_id = $this->invest->edit_private_share($_POST['invest_id'], $bond['aver_profit'], $bond['credit_rating'], $start_date, $due_date, $bond['invest_rate_text'], $bond['name'], $bond['department_name'], $bond['payment_method_text'], $bond['unit'], $bond['value_per_unit'], $bond['source'], $_POST['status']);
+		} else if ($invest_type == 5) {
+			$share_c = $_POST['share_s'];
+			$invest_id = $this->invest->edit_set_share($_POST['invest_id'], $share_c['name'], $share_c['period'], $share_c['source'], $_POST['status']);
+		}
+
+		$arr_data['invest_id'] = $invest_id;
+		echo json_encode($arr_data);
+	}
+
+	public function delete() {
+		$result = $this->invest->delete($_POST['id']);
+		echo json_encode($result);
+	}
+
+	public function get_invest_by_id() {
+		$arr_data = array();
+
+		$data = $this->invest->get_invest_data($_GET['id'], NULL, 1, 1, 1);
+		$arr_data['data'] = $data;
+
+		if($data['type'] == 5)  {
+			$arr_data['share_value'] = $this->invest->get_invest_share_value($_GET['id'], NULL);
+		}
+
+		$total_data = $this->invest->get_total_data();
+		$arr_data['total_data'] = $total_data;
+
+		echo json_encode($arr_data);
+	}
+
+	public function add_interest() {
+		$arr_data = array();
+		$date = !empty($_POST['date']) ? $this->center_function->ConvertToSQLDate($_POST['date']) : NULL;
+
+		$data = $this->invest->add_profit_transaction($_POST['id'], $_POST['invest_id'], $date, $_POST['rate'], $_POST['amount'], $_POST['note']);
+		$arr_data['return'] = $data;
+
+		echo json_encode($arr_data);
+	}
+
+	public function get_profit_transaction() {
+		$arr_data = array();
+		$transaction = $this->invest->get_profit_transaction_by_id($_GET['id']);
+		$arr_data['data'] = $transaction;
+		echo json_encode($arr_data);
+	}
+
+	public function add_transaction() {
+		$date = !empty($_POST['date']) ? $this->center_function->ConvertToSQLDate($_POST['date']) : NULL;
+		$data = $this->invest->add_transaction($_POST['id'], $_POST['invest_id'], $date, $_POST['unit'], $_POST['rate'], $_POST['amount'], $_POST['note'], $_POST['tran_type'], $_POST['fee']);
+		$arr_data['return'] = $data;
+		echo json_encode($arr_data);
+	}
+
+	public function get_transaction() {
+		$arr_data = array();
+
+		$data = $this->invest->get_transaction($_GET['id']);
+		$arr_data['data'] = $data;
+		echo json_encode($arr_data);
+	}
+
+	public function add_invest_share_value() {
+		$arr_data = array();
+
+		$invest_id = $_POST['invest_id'];
+		$date = !empty($_POST['date']) ? $this->center_function->ConvertToSQLDate($_POST['date']) : NULL;
+		$value = $_POST['amount'];
+		$data = $this->invest->add_invest_share_value($invest_id, $date, $value);
+
+		echo json_encode($arr_data);
+	}
+
+	public function get_invest_share_value() {
+		$arr_data = array();
+
+		$invest_id = $_GET['id'];
+		$date = !empty($_GET['date']) ? $this->center_function->ConvertToSQLDate($_GET['date']) : NULL;
+		$data = $this->invest->get_invest_share_value($invest_id, $date);
+		$arr_data['share_val'] = $data;
+
+		echo json_encode($arr_data);
+	}
+
+	public function remove_profit() {
+		$arr_data = array();
+
+		$data = $this->invest->remove_profit($_POST['id']);
+		$arr_data['data'] = $data;
+		echo json_encode($arr_data);
+	}
+
+	public function remove_transactrion() {
+		$arr_data = array();
+
+		$data = $this->invest->remove_transactrion($_POST['id']);
+		$arr_data['data'] = $data;
+		echo json_encode($arr_data);
+	}
+
+	public function detail() {
+		$arr_data = array();
+
+		$invest_types = $this->db->select("*")->from("coop_invest_type")->where("status = 1")->order_by("order")->get()->result_array();
+		$arr_data['invest_id'] = $_POST['id'];
+		$arr_data['invest_types'] = $invest_types;
+
+		$this->libraries->template('invest/detail',$arr_data);
+	}
+
+	public function report_invest() {
+		$invest_types = $this->db->select("*")->from("coop_invest_type")->where("status = 1")->order_by("order")->get()->result_array();
+		$arr_data['invest_types'] = $invest_types;
+		$this->libraries->template('invest/report_invest',$arr_data);
+	}
+
+	public function check_report_invest() {
+		$where = "";
+		if(!empty($_POST['type'])) {
+			$where .= " AND type = '".$_POST['type']."'";
+		}
+		$invest = $this->db->select("*")->from("coop_invest")->where("status != 3".$where)->order_by("start_date DESC")->get()->row();
+		if(!empty($invest)) {
+			echo "success";
+		} else {
+			echo "no-data";
+		}
+	}
+
+	public function report_invest_preview() {
+		$where = "";
+		if(!empty($_POST['type'])) {
+			$where .= " AND type = '".$_POST['type']."'";
+		}
+
+		$invests = $this->db->select("t1.*, t2.name as type_name, t3.invest_date, t3.end_date")
+							->from("coop_invest as t1")
+							->join("coop_invest_type as t2" ,"t1.type = t2.id", "INNER")
+							->join("coop_invest_detail as t3", "t1.id = t3.invest_id AND t3.status = 1", "LEFT")
+							->where("t1.status != 3".$where)
+							->order_by("t2.order, t1.name, t1.start_date")
+							->get()->result_array();
+		
+		$arr_data['datas'] = $invest;
+		$arr_data['total_data'] = $total_data;
+		
+		if($_POST['doc_type'] == "html") {
+			$datas = array();
+			$page = 0;
+			$first_page_size = 18;
+			$page_size = 30;
+			$prev_level = "x";
+			$index = 0;
+			$first_page_level = 1;
+			$page_index = 1;
+
+			foreach($invests as $invest) {
+				if($index < $first_page_size) {
+					$page = 1;
+					$page_index = 0;
+				} else {
+					if(($page_index > $first_page_size && $first_page_level == $page)
+						|| ($page_index > $page_size && $first_page_level != $page)) {
+						$page++;
+						$page_index = 0;
+					}
+				}
+				$datas[$page][] = $invest;
+				$index++;
+				$page_index++;
+			}
+
+			$arr_data['datas'] = $datas;
+			$arr_data['page_all'] = $page;
+			$arr_data['max'] = count($invests) - 1;
+            $this->preview_libraries->template_preview('invest/report_invest_preview',$arr_data);
+        } else if ($_POST['doc_type'] == "excel") {
+			$arr_data['datas'] = $invests;
+            $this->load->view('invest/report_invest_excel',$arr_data);
+        }
+	}
+
+	public function reprot_profit_interest() {
+		$invest_types = $this->db->select("*")->from("coop_invest_type")->where("status = 1 AND id IN (1,3,4)")->order_by("order")->get()->result_array();
+		$arr_data['invest_types'] = $invest_types;
+		$this->libraries->template('invest/report_profit_interest',$arr_data);
+	}
+
+	public function check_report_profit_interest() {
+		$result = $this->invest->check_invest_profit($_POST['type'], array(1,3,4));
+		echo $result;
+	}
+
+	public function report_profit_interest_preview() {
+		$where = "";
+		$result = $this->invest->get_profit($_POST['type'], array(1, 3, 4));
+
+		$arr_data['datas'] = $invest;
+		$arr_data['total_data'] = $total_data;
+
+		if($_POST['doc_type'] == "html") {
+			$datas = array();
+			$page = 0;
+			$first_page_size = 18;
+			$page_size = 30;
+			$prev_level = "x";
+			$index = 0;
+			$first_page_level = 1;
+			$page_index = 1;
+
+			$arr_data['datas'] = $result;
+			$arr_data['page_all'] = $page;
+			$arr_data['max'] = count($result) - 1;
+            $this->preview_libraries->template_preview('invest/report_profit_interest_preview',$arr_data);
+        } else if ($_POST['doc_type'] == "excel") {
+			$arr_data['datas'] = $result;
+            $this->load->view('invest/report_profit_interest_excel',$arr_data);
+        }
+	}
+
+	public function reprot_profit_dividend() {
+		$invest_types = $this->db->select("*")->from("coop_invest_type")->where("status = 1 AND id IN (2,5)")->order_by("order")->get()->result_array();
+		$arr_data['invest_types'] = $invest_types;
+		$this->libraries->template('invest/report_profit_dividend',$arr_data);
+	}
+
+	public function check_report_profit_dividend() {
+		$result = $this->invest->check_invest_profit($_POST['type'], array(2,5));
+		echo $result;
+	}
+
+	public function report_profit_dividend_preview() {
+		$where = "";
+
+		$result = $this->invest->get_profit($_POST['type'], array(2,5));
+
+		$arr_data['datas'] = $invest;
+		$arr_data['total_data'] = $total_data;
+
+		if($_POST['doc_type'] == "html") {
+			$datas = array();
+			$page = 0;
+			$first_page_size = 18;
+			$page_size = 30;
+			$prev_level = "x";
+			$index = 0;
+			$first_page_level = 1;
+			$page_index = 1;
+
+			$arr_data['datas'] = $result;
+			$arr_data['page_all'] = $page;
+			$arr_data['max'] = count($result) - 1;
+            $this->preview_libraries->template_preview('invest/report_profit_dividend_preview',$arr_data);
+        } else if ($_POST['doc_type'] == "excel") {
+			$arr_data['datas'] = $result;
+            $this->load->view('invest/report_profit_dividend_excel',$arr_data);
+        }
+	}
+
+	public function report_maturity() {
+		$invest_types = $this->db->select("*")->from("coop_invest_type")->where("status = 1 AND id IN (1,3,4)")->order_by("order")->get()->result_array();
+		$arr_data['invest_types'] = $invest_types;
+		$this->libraries->template('invest/report_maturity',$arr_data);
+	}
+
+	public function check_maturity() {
+		$invest = $this->db->select("t1.id")
+							->from("coop_invest as t1")
+							->join("coop_invest_detail as t3", "t1.id = t3.invest_id AND t3.status = 1 AND DATE(t3.end_date) >= DATE(NOW())", "INNER")
+							->where("t1.status != 3".$where)
+							->get()->row();
+		if(!empty($invest)) {
+			echo "success";
+		} else {
+			echo "not-found-data";
+		}
+	}
+
+	public function report_maturity_preview() {
+		$where = "";
+		if(!empty($_POST['type'])) {
+			$where .= " AND t1.type = '".$_POST['type']."'";
+		} else {
+			$where .= " AND t1.type IN (1,3,4)";
+		}
+
+		$invests = $this->db->select("t1.*, t2.name as type_name, t3.invest_date, t3.end_date")
+							->from("coop_invest as t1")
+							->join("coop_invest_type as t2" ,"t1.type = t2.id", "INNER")
+							->join("coop_invest_detail as t3", "t1.id = t3.invest_id AND t3.status = 1 AND DATE(t3.end_date) >= DATE(NOW())", "INNER")
+							->where("t1.status != 3".$where)
+							->order_by("t3.end_date DESC")
+							->get()->result_array();
+		
+		$arr_data['datas'] = $invest;
+		$arr_data['total_data'] = $total_data;
+		
+		if($_POST['doc_type'] == "html") {
+			$datas = array();
+			$page = 0;
+			$first_page_size = 18;
+			$page_size = 30;
+			$prev_level = "x";
+			$index = 0;
+			$first_page_level = 1;
+			$page_index = 1;
+
+			foreach($invests as $invest) {
+				if($index < $first_page_size) {
+					$page = 1;
+					$page_index = 0;
+				} else {
+					if(($page_index > $first_page_size && $first_page_level == $page)
+						|| ($page_index > $page_size && $first_page_level != $page)) {
+						$page++;
+						$page_index = 0;
+					}
+				}
+				$datas[$page][] = $invest;
+				$index++;
+				$page_index++;
+			}
+
+			$arr_data['datas'] = $datas;
+			$arr_data['page_all'] = $page;
+			$arr_data['max'] = count($invests) - 1;
+            $this->preview_libraries->template_preview('invest/report_maturity_preview',$arr_data);
+        } else if ($_POST['doc_type'] == "excel") {
+			$arr_data['datas'] = $invests;
+            $this->load->view('invest/report_maturity_excel',$arr_data);
+        }
+	}
+
+	public function report_share_transactions() {
+		$invest_types = $this->db->select("*")->from("coop_invest_type")->where("status = 1 AND id IN (2,5)")->order_by("order")->get()->result_array();
+		$arr_data['invest_types'] = $invest_types;
+		$this->libraries->template('invest/report_share_transactions',$arr_data);
+	}
+
+	public function check_share_transactions() {
+		$from_date = $this->center_function->ConvertToSQLDate($_POST["from_date"]);
+		$thru_date = $this->center_function->ConvertToSQLDate($_POST["thru_date"]);
+        $transactions = $this->db->select("t1.id, t1.name, t2.amount, t2.fee, t2.tran_type, t3.name as type_name")
+                                ->from("coop_invest as t1")
+                                ->join("coop_invest_transaction as t2", "t1.id = t2.invest_id AND t2.status = 1 AND DATE(t2.date) >= DATE('".$from_date."') AND DATE(t2.date) <= DATE('".$thru_date."') AND t2.tran_type = 2", "INNER")
+                                ->join("coop_invest_type as t3", "t1.type = t3.id", "INNER")
+                                ->get()
+								->row();
+		if(!empty($transactions)) {
+			echo "success";
+		} else {
+			echo "no-data";
+		}
+	}
+
+	public function report_share_transaction_preview() {
+		$arr_data = array();
+		$from_date = $this->center_function->ConvertToSQLDate($_POST["from_date"]);
+		$thru_date = $this->center_function->ConvertToSQLDate($_POST["thru_date"]);
+		$arr_data['from_date'] = $from_date;
+		$arr_data['thru_date'] = $thru_date;
+
+		$result = $this->invest->get_share_transaction_report_data($from_date, $thru_date);
+		$sell_transactions = $result['invest_sells'];
+		$invest_balances = $result['invest_balances'];
+
+		if($_POST['doc_type'] == "html") {
+			$datas = array();
+			$page = 0;
+			$first_page_size = 18;
+			$page_size = 30;
+			$prev_level = "x";
+			$index = 0;
+			$first_page_level = 1;
+			$page_index = 1;
+
+			foreach($sell_transactions as $invest) {
+				if($index < $first_page_size) {
+					$page = 1;
+					$page_index = 0;
+				} else {
+					if(($page_index > $first_page_size && $first_page_level == $page)
+						|| ($page_index > $page_size && $first_page_level != $page)) {
+						$page++;
+						$page_index = 0;
+					}
+				}
+				$datas[$page][] = $invest;
+				$index++;
+				$page_index++;
+			}
+
+			$arr_data['datas'] = $datas;
+			$arr_data['invest_balances'] = $invest_balances;
+			$arr_data['page_all'] = $page;
+			$arr_data['max'] = count($sell_transactions) - 1;
+            $this->preview_libraries->template_preview('invest/report_share_transaction_preview',$arr_data);
+        } else if ($_POST['doc_type'] == "excel") {
+			$arr_data['datas'] = $sell_transactions;
+			$arr_data['invest_balances'] = $invest_balances;
+            $this->load->view('invest/report_share_transaction_excel',$arr_data);
+        }
+	}
+
+	public function report_invest_balance() {
+		$invest_types = $this->db->select("*")->from("coop_invest_type")->where("status = 1 AND id IN (2,5)")->order_by("order")->get()->result_array();
+		$arr_data['invest_types'] = $invest_types;
+		$this->libraries->template('invest/report_invest_balance',$arr_data);
+	}
+
+	public function check_invest_balance() {
+		$where = "";
+		if(!empty($_POST['type'])) {
+			$where .= " AND type = '".$_POST['type']."'";
+		} else {
+			$where .= " AND type IN (2,5)";
+		}
+		$invest = $this->db->select("*")->from("coop_invest")->where("status != 3".$where)->order_by("start_date DESC")->get()->row();
+		if(!empty($invest)) {
+			echo "success";
+		} else {
+			echo "no-data";
+		}
+	}
+
+	public function report_invest_balance_preview() {
+		$arr_data = array();
+
+		$result = $this->invest->get_invest_balance($_POST['type'], array(2,5));
+
+		if($_POST['doc_type'] == "html") {
+			$datas = array();
+			$page = 0;
+			$first_page_size = 18;
+			$page_size = 30;
+			$prev_level = "x";
+			$index = 0;
+			$first_page_level = 1;
+			$page_index = 1;
+
+			foreach($result as $invest) {
+				if($index < $first_page_size) {
+					$page = 1;
+					$page_index = 0;
+				} else {
+					if(($page_index > $first_page_size && $first_page_level == $page)
+						|| ($page_index > $page_size && $first_page_level != $page)) {
+						$page++;
+						$page_index = 0;
+					}
+				}
+				$datas[$page][] = $invest;
+				$index++;
+				$page_index++;
+			}
+
+			$arr_data['datas'] = $datas;
+			$arr_data['invest_balances'] = $invest_balances;
+			$arr_data['page_all'] = $page;
+			$arr_data['max'] = count($result) - 1;
+            $this->preview_libraries->template_preview('invest/report_invest_balance_preview',$arr_data);
+        } else if ($_POST['doc_type'] == "excel") {
+			$arr_data['datas'] = $result;
+			$arr_data['invest_balances'] = $invest_balances;
+            $this->load->view('invest/report_invest_balance_excel',$arr_data);
+        }
+	}
+
+	
+	public function report_expect_profit() {
+		$invest_types = $this->db->select("*")->from("coop_invest_type")->where("status = 1 AND id IN (1,3,4)")->order_by("order")->get()->result_array();
+		$arr_data['invest_types'] = $invest_types;
+		$this->libraries->template('invest/report_expect_profit',$arr_data);
+	}
+
+	public function check_expect_profit() {
+		$where = "";
+		if(!empty($_POST['type'])) {
+			$where .= " AND t1.type = '".$_POST['type']."'";
+		} else {
+			$where .= " AND t1.type IN (1,3,4)";
+		}
+		$invest = $this->db->select("*")
+							->from("coop_invest as t1")
+							->join("coop_invest_detail as t2", "t1.id = t2.invest_id AND DATE(t2.end_date) >= DATE(NOW()) AND t2.status = 1", "INNER")
+							->where("t1.status != 3".$where)
+							->get()->row();
+		if(!empty($invest)) {
+			echo "success";
+		} else {
+			echo "no-data";
+		}
+	}
+
+	public function report_expect_profit_preview() {
+		$arr_data = array();
+
+		$result = $this->invest->get_expect_profit($_POST['type'], array(1,3,4));
+
+		if($_POST['doc_type'] == "html") {
+			$datas = array();
+			$page = 0;
+			$first_page_size = 18;
+			$page_size = 30;
+			$prev_level = "x";
+			$index = 0;
+			$first_page_level = 1;
+			$page_index = 1;
+
+			foreach($result as $invest) {
+				if($index < $first_page_size) {
+					$page = 1;
+					$page_index = 0;
+				} else {
+					if(($page_index > $first_page_size && $first_page_level == $page)
+						|| ($page_index > $page_size && $first_page_level != $page)) {
+						$page++;
+						$page_index = 0;
+					}
+				}
+				$datas[$page][] = $invest;
+				$index++;
+				$page_index++;
+			}
+
+			$arr_data['datas'] = $datas;
+			$arr_data['page_all'] = $page;
+			$arr_data['max'] = count($result) - 1;
+            $this->preview_libraries->template_preview('invest/report_expect_profit_preview',$arr_data);
+        } else if ($_POST['doc_type'] == "excel") {
+			$arr_data['datas'] = $result;
+            $this->load->view('invest/report_expect_profit_excel',$arr_data);
+        }
+	}
+}
diff --git a/application/views/invest/edit_organization.php b/application/views/invest/edit_organization.php
new file mode 100644
index 0000000..64b8054
--- /dev/null
+++ b/application/views/invest/edit_organization.php
@@ -0,0 +1,272 @@
+<!-- Css color of this screen not belong to main css. -->
+<?php
+unset($_POST);
+$link = array(
+    'href' => PROJECTJSPATH.'assets/css/Chart.min.css',
+    'rel' => 'stylesheet',
+    'type' => 'text/css'
+);
+echo link_tag($link);
+?>
+<style>
+    input[type=number]::-webkit-inner-spin-button,
+    input[type=number]::-webkit-outer-spin-button {
+        -webkit-appearance: none;
+        margin: 0;
+    }
+    th, td {
+        text-align: center;
+    }
+    .modal-dialog-delete {
+        margin:0 auto;
+        width: 350px;
+        margin-top: 8%;
+    }
+    .modal-dialog-account {
+        margin:auto;
+        width: 50%;
+        margin-top:7%;
+    }
+    .control-label {
+        text-align:right;
+        padding-top:5px;
+    }
+    .text_left {
+        text-align:left;
+    }
+    .text_right {
+        text-align:right;
+    }
+    @media (min-width: 768px) {
+        .card_col {
+            width:33.33%;
+        }
+    }
+    @media (max-width: 768px) {
+        .card_col {
+            width:100%;
+        }
+    }
+    .card_col {
+        float: left;
+        padding-left: 5px;
+        padding-right: 5px;
+    }
+    .card_col > .card {
+        padding-top: 15px;
+        padding-bottom: 15px;
+    }
+    .second_bg {
+        background-color : #137de0;
+        color :#FFFFFF;
+    }
+    .second_text {
+        color : #137de0;
+    }
+    .selected_invest {
+        background-color : #137de0 !important;
+        color :#FFFFFF !important;
+    }
+    .card {
+        padding: 15px;
+    }
+    .card_list {
+        padding-top: 0 !important;
+        padding-bottom: 0 !important;
+    }
+    .topic_row {
+        border-top-color: #000 !important;
+    }
+    .topic_row th {
+        color: #4c4b4b;
+        font-size: 20px;
+        padding-top: 2px!important;
+        padding-bottom: 2px!important;
+    }
+    .table_invest_list {
+        border: 0 !important;
+        background-color: #fff !important;
+        margin-top: 20px;
+    }
+    /* .topic_col {
+        border-top: 2px solid #eceff1 !important;
+    } */
+    .table_sub {
+        background-color: transparent !important;
+    }
+    .table_sub td {
+        border-right: 2px solid #fff !important;
+    }
+    .text_right {
+        text-align: right !important;
+    }
+    .table_sub tr:hover {
+        background-color: #c7c3c3 !important;
+    }
+    .card_list .invest-title {
+        margin-top: 10px !important;
+        margin-bottom: 10px !important;
+    }
+    .detail_top {
+        padding-bottom: 20px;
+        border-bottom: 1px solid #eceff1;
+    }
+    .row_detail {
+        border-bottom: 1px solid #eceff1;
+        padding-bottom: 10px;
+    }
+    .col_detail_right {
+        /* border-left: 1px solid #eceff1; */
+    }
+    .col_detail_left {
+        border-right: 1px solid #eceff1;
+    }
+    .helpblock_plus {
+        display: inline;
+        margin-top: 5px;
+        margin-bottom: 10px;
+        /* color: #137de0; */
+    }
+    .helpblock_minus {
+        display: inline;
+        margin-top: 5px;
+        margin-bottom: 10px;
+        color: #d50000;
+    }
+    .helpblock_dark {
+        display: inline;
+        margin-top: 5px;
+        margin-bottom: 10px;
+        color: #000000;
+    }
+    .helpbtn {
+        border-radius: 50px !important;
+        font-size: 12px;
+        padding-top: 2px;
+        padding-bottom: 2px;
+        width: unset;
+        height: unset;
+    }
+    .no_b_space {
+        margin-bottom: 0px;
+    }
+    .no_t_space {
+        margin-top: 0px;
+    }
+    .title_font {
+        font-size: 28px;
+    }
+    .dark_font {
+        color: #000000;
+    }
+    .grey_font {
+        color: #6b6b6b;
+    }
+    .grey_icon {
+        font-size: 12px;
+        color: #b5b5b5;
+    }
+    .no_size_padding {
+        padding-left:0 !important;
+        padding-right:0  !important;
+    }
+    .invest_row td {
+        padding-top: 4px !important;
+        padding-bottom: 4px !important;
+    }
+    .card-footer {
+        border-top: unset;
+    }
+    .table_invest_list .table-bordered {
+        border: unset;
+    }
+    .invest_type_total_row th {
+        padding-bottom: 40px;
+    }
+</style>
+<div class="layout-content">
+    <div class="layout-content-body">
+        <h1 class="title_top">ตั้งค่าองค์กร</h1>
+        <p style="font-family: upbean; font-size: 20px; margin-bottom:5px;"><?php $this->load->view('breadcrumb'); ?></p>
+        <div class="row gutter-xs">
+            <div class="col-xs-12 col-md-12">
+                <div class="panel panel-body">
+                    <div class="card-body card_list">
+                        <div class="col-xs-12 col-md-12 text-right">
+                            <button type="button" id="add_org" class="btn second_bg" data-dismiss="modal"><span class="icon icon-plus"></span> เพิ่มองค์กร</button>
+                        </div>
+                        <div class="col-xs-12 col-md-12 text-center">
+                            <br><br>
+                            <table class="table table-striped table-bordered table-center table_invest_list" style="width:60%; margin: auto;">
+                                <thead>
+                                    <tr style="border-bottom: 3px solid #bdbdbd;">
+                                        <th width="10%">ลำดับ</th>
+                                        <th width="">ชื่อองค์กร</th>
+                                        <th width="15%"></th>
+                                    </tr>
+                                </thead>
+                                <tbody>
+                                    <?php
+                                        foreach($orgs as $org) {
+                                    ?>
+                                    <tr>
+                                        <td class="border_td" width="5%"><?php echo ++$index;?></td>
+                                        <td width="" class="text_left"><?php echo $org['name'];?></td>
+                                        <td width="">
+                                            <a class="edit_btn " style="cursor: pointer;" class="text-default" id="edit_<?php echo $org['id'];?>" data-id="<?php echo $org['id'];?>">แก้ไข</a>
+                                            |
+                                            <a class="del_btn text-danger" style="cursor: pointer;" class="text-default" id="del_<?php echo $org['id'];?>" data-id="<?php echo $org['id'];?>">ลบ</a>
+                                        </td>
+                                    </tr>
+                                    <?php
+                                        }
+                                    ?>
+                                </tbody>
+                            </table>
+                        </div>
+                    </div>
+                </div>
+            </div>
+        </div>
+    </div>
+</div>
+<div id="edit_modal" tabindex="-1" role="dialog" class="modal fade" data-backdrop="static" data-keyboard="false">
+    <div class="modal-dialog modal-dialog-account">
+        <div class="modal-content">
+            <div class="modal-header modal-header-confirmSave">
+                <h2 class="modal-title">เพิ่มการลงทุน</h2>
+            </div>
+            <div class="modal-body">
+                <form action="" method="post" id="add_form">
+                <input id="modal_id" name="id" type="hidden" value="">
+                    <div class="row coop_sav_c_row">
+                        <div class="form-group">
+                            <label class="col-sm-3 control-label">ชื่อองค์กร</label>
+                            <div class="col-sm-6">
+                                <input id="add_name" name="name" class="form-control m-b-1" type="text" value="">
+                            </div>
+                        </div>
+                    </div>
+                    <div class="form-group text-center">
+                        <button type="button" class="btn btn-primary min-width-100" id="submit_add">ตกลง</button>
+                        <button class="btn btn-danger min-width-100" type="button" id="cancel_add">ยกเลิก</button>
+                    </div>
+                </form>
+            </div>
+        </div>
+    </div>
+</div>
+
+<?php
+$v = date('YmdHis');
+$link = array(
+    'src' => PROJECTJSPATH.'assets/js/invest_org.js?v='.$v,
+    'type' => 'text/javascript'
+);
+echo script_tag($link);
+?>
+<script>
+    $(document).ready(function() {
+
+    });
+</script>
\ No newline at end of file
diff --git a/application/views/invest/investmest_summary_preview.php b/application/views/invest/investmest_summary_preview.php
new file mode 100644
index 0000000..7e6a4f9
--- /dev/null
+++ b/application/views/invest/investmest_summary_preview.php
@@ -0,0 +1,217 @@
+<style>
+	.table-view>thead, .table-view>thead>tr>td, .table-view>thead>tr>th {
+		font-size: 14px;
+	}
+	.table-view>tbody>tr>th{
+	    border-top: 1px solid #000 !important;
+		border-bottom: 1px solid #000 !important;
+		font-size: 12px;
+		background-color: #eee;
+	}
+	.table-view-2>tbody>tr>td{
+	    border: 0px !important;
+		/*font-family: upbean;
+		font-size: 16px;*/
+		font-family: Tahoma;
+		font-size: 12px;
+	}	
+	.border-bottom{
+	    border-bottom: 1px solid #000 !important;
+		font-weight: bold;
+	}
+	.table-view-2>tbody>tr>td>span{
+		font-family: Tahoma;
+		font-size: 12px !important;
+	}
+	.foot-border{
+	    border-top: 1px solid #000 !important;
+		border-bottom: double !important;
+		font-weight: bold;
+	}
+	.table {
+		color: #000;
+	}
+	.table>tbody>tr>td, .table>tbody>tr>th, .table>tfoot>tr>td, .table>tfoot>tr>th, .table>thead>tr>td, .table>thead>tr>th {
+		padding:6px;
+	}
+	.title_view {
+		font-size: 32px;
+    	font-weight: bold;
+	}
+	.topic_view {
+		color: #000;
+		font-weight: bold;
+	}
+	@media print { body { -webkit-print-color-adjust: exact; } }
+</style>
+<div style="width: 11.7in;" class="page-break">
+	<div class="panel panel-body" style="padding-top:30px; !important;height: 8.3in;">
+		<table style="width: 100%;">
+			<tr>
+				<td style="width:100px;vertical-align: top;">
+				</td>
+				<td class="text-center">
+					<h3 class="title_view">Investment Summary</h3>
+				</td>
+				<td style="width:100px;vertical-align: top;" class="text-right">
+					<a class="no_print" onclick="window.print();"><button class="btn btn-perview btn-after-input" type="button"><span class="icon icon-print" aria-hidden="true"></span></button></a>
+				</td>
+			</tr>
+		</table>
+		&nbsp;
+		<table style="width: 100%;">
+			<tr>
+				<td style="width:32%;">
+					<h3 class="topic_view">Credit Company</h3>
+				</td>
+				<td>
+					<h3 class="topic_view">Asset Allocation</h3>
+				</td>
+			</tr>
+			<tr>
+				<td>
+					<div class="card" style="display: block; max-width: 100%;  margin: auto;border:0;">
+						<div class="card-chart chart-container"  style="display: block; max-width: 100%; ">
+							<canvas id="summaryChart" style="max-width: 90%; margin-left: auto; margin-right: auto; display: block;" width="90" height="90"></canvas>
+						</div>
+					</div>
+				</td>
+				<td style=" vertical-align:top; padding-top:20px;">
+					<table class="table table-view table-center">
+						<thead>
+							<tr>
+								<th>องค์กร</th>
+								<th>ประเภทการลงทุน</th>
+								<th>การลงทุน</th>
+								<th>เงินลงทุน</th>
+								<th>รวม</th>
+							</tr>
+						</thead>
+						<tbody>
+						<?php
+							$org_prev = 'xx';
+							foreach($orgs as $org_key => $org) {
+								foreach($org['invests'] as $invest) {
+						?>
+							<tr>
+								<?php
+									if($org_prev != $org_key) {
+								?>
+								<td rowspan="<?php echo count($org['invests']);?>" class="text-left">
+									<div style="display:flex;">
+										<div id="color_box_<?php echo $org_key;?>" class="color_box" style="background-color: #cfc; padding: 10px;">
+										</div>
+										&nbsp;
+										<?php echo $org['name'];?>
+									</div>
+								</td>
+								<?php
+									}
+								?>
+								<td class="text-left"><?php echo $invest['type_name'];?></td>
+								<td class="text-left"><?php echo $invest['name'];?></td>
+								<td class="text-right"><?php echo number_format($invest['amount'],2);?></td>
+								<?php
+									if($org_prev != $org_key) {
+								?>
+								<td rowspan="<?php echo count($org['invests']);?>" class="text-right"><?php echo number_format($org['amount'],2)."<br>(".(number_format(($org['amount'] * 100 / $total_invest),2))."%)";?></td>
+								<?php
+									}
+								?>
+							</tr>
+						<?php
+									$org_prev = $org_key;
+								}
+							}
+						?>
+						</tbody>
+					</table>
+				</td>
+			</tr>
+		</table>
+	</div>
+</div>
+<?php
+$v = date('YmdHis');
+$link = array(
+    'src' => PROJECTJSPATH.'assets/js/Chart.min.js?v='.$v,
+    'type' => 'text/javascript'
+);
+echo script_tag($link);
+$link = array(
+    'src' => PROJECTJSPATH.'assets/js/chartjs_plugin/chartjs-plugin-labels.js?v='.$v,
+    'type' => 'text/javascript'
+);
+echo script_tag($link);
+?>
+<script media="screen">
+    $(document).ready(function() {
+
+		//Generate summary chart.
+		var ctx = document.getElementById('summaryChart');
+		color_default_arr = ['#fc7f23','#1f78b4','#d52728','#2e9f2e','#2e9f9a','#9d2e9f','#452e9f'];
+		var randomScalingFactor = function() {
+			return Math.round(Math.random() * 100);
+		};
+
+		var dynamicColors = function() {
+            var r = Math.floor(Math.random() * 255);
+            var g = Math.floor(Math.random() * 255);
+            var b = Math.floor(Math.random() * 255);
+            return "rgb(" + r + "," + g + "," + b + ")";
+         };
+		var ctx = document.getElementById("summaryChart").getContext("2d");
+
+		chart_labels = [];
+		chart_values = [];
+		chart_colors = [];
+		org_index = 0;
+		<?php
+			foreach($orgs as $org_key => $org) {
+		?>
+			chart_labels.push('<?php echo $org['name'];?>');
+			chart_values.push(<?php echo $org['amount'];?>);
+			color_code = color_default_arr[org_index] ? color_default_arr[org_index] : dynamicColors();
+			chart_colors.push(color_code);
+			$("#color_box_<?php echo $org_key;?>").attr('style', ' padding: 10px; background-color: ' + color_code + " !important;");
+			org_index++;
+		<?php
+			}
+		?>
+		var myDoughnut = new Chart(ctx, {
+			type: 'pie',
+			data: {
+				labels: chart_labels,
+				datasets: [{
+					data: chart_values,
+					backgroundColor: chart_colors,
+					borderColor: 'white',
+					borderWidth: 0,
+				}]
+			},
+			showDatapoints: true,
+			options: {
+				tooltips: {
+					enabled: false
+				},
+				pieceLabel: {
+					mode: 'value',
+					render: 'label',
+					fontColor: '#000',
+					position: 'outside',
+				},
+				responsive: true,
+				legend: {
+					display: false,
+				},
+				plugins: {
+      				labels: {
+						outsidePadding: 5,
+						textMargin: 10,
+						position: 'outside'
+					}
+				}
+			}
+		});
+	});
+</script>
\ No newline at end of file
diff --git a/application/views/invest/report_expect_profit.php b/application/views/invest/report_expect_profit.php
new file mode 100644
index 0000000..1dcbb67
--- /dev/null
+++ b/application/views/invest/report_expect_profit.php
@@ -0,0 +1,92 @@
+<div class="layout-content">
+    <div class="layout-content-body">
+		<style>
+			.modal-header-alert {
+				padding:9px 15px;
+				border:1px solid #FF0033;
+				background-color: #FF0033;
+				color: #fff;
+				-webkit-border-top-left-radius: 5px;
+				-webkit-border-top-right-radius: 5px;
+				-moz-border-radius-topleft: 5px;
+				-moz-border-radius-topright: 5px;
+				border-top-left-radius: 5px;
+				border-top-right-radius: 5px;
+			}
+			.center {
+				text-align: center;
+			}
+			.right {
+				text-align: right;
+			}
+			.modal-dialog-account {
+				margin:auto;
+				margin-top:7%;
+			}
+			label{
+				padding-top:7px;
+			}
+		</style>
+		<h1 style="margin-bottom: 0">ระบบการลงทุน</h1>
+		<?php $this->load->view('breadcrumb'); ?>
+		<div class="row gutter-xs">
+			<div class="col-xs-12 col-md-12">
+				<div class="panel panel-body" style="padding-top:0px !important;" id="search-div">
+					<form action="<?php echo base_url(PROJECTPATH.'/invest/report_expect_profit_preview'); ?>" id="search_form" method="POST" target="_blank">
+						<input type="hidden" name="doc_type" id="doc_type" value="html"/>
+						<div class="form-group g24-col-sm-24 text-center">
+                            <h3>รายงานสรุปดอกเบี้ยค้างรับ</h3>
+						</div>
+						<div class="form-group g24-col-sm-24">
+							<label class="g24-col-sm-10 control-label right"> หมวดการลงทุน </label>
+							<div class="g24-col-sm-5">
+								<div class="input-with-icon">
+									<div class="form-group">
+										<select id="type" name="type" class="form-control m-b-1 js-data-example-ajax">
+                                            <option value="">ทั้งหมด</option>
+                                            <?php 
+                                                foreach($invest_types as $key => $type) {
+                                            ?>
+                                            <option value="<?php echo $type['id']; ?>"><?php echo $type['name'];?></option>
+                                            <?php
+                                                }
+                                            ?>
+                                        </select>
+									</div>
+								</div>
+							</div>
+						</div>
+						<div class="form-group g24-col-sm-24 text-center">
+                            <button class="btn btn-primary btn-after-input" type="button" onclick="check_empty(1)"><span> แสดงรายงาน</span></button>
+						</div>
+					</form>
+				</div>
+			</div>
+		</div>
+	</div>
+</div>
+<script>
+function check_empty(type){
+	$.ajax({
+		 url:base_url+"invest/check_expect_profit", 
+		 method:"post",
+		 data:$("#search_form").serialize(),
+		 dataType:"text",
+		 success:function(data){
+			if(data == 'success'){
+				if(type == 1) {
+					$("#doc_type").val('html');
+				} else {
+					$("#doc_type").val('excel');
+				}
+				$("#search_form").submit();
+			} else if (data == "no-data") {
+				swal('ไม่พบข้อมูล', '', 'warning');
+			}else{
+				$('#alertNotFindModal').appendTo("body").modal('show');
+			}
+		 }
+	});
+}
+
+</script>
diff --git a/application/views/invest/report_expect_profit_excel.php b/application/views/invest/report_expect_profit_excel.php
new file mode 100644
index 0000000..baa685f
--- /dev/null
+++ b/application/views/invest/report_expect_profit_excel.php
@@ -0,0 +1,163 @@
+<?php
+$objPHPExcel = new PHPExcel();
+
+$borderRight = array(
+  'borders' => array(
+    'right' => array(
+      'style' => PHPExcel_Style_Border::BORDER_THIN
+    )
+  )
+);
+$borderLeft = array(
+  'borders' => array(
+    'left' => array(
+      'style' => PHPExcel_Style_Border::BORDER_THIN
+    )
+  )
+);
+$borderTop = array(
+  'borders' => array(
+    'top' => array(
+      'style' => PHPExcel_Style_Border::BORDER_THIN
+    )
+  )
+);
+$borderBottom = array(
+  'borders' => array(
+    'bottom' => array(
+      'style' => PHPExcel_Style_Border::BORDER_THIN
+    )
+  )
+);
+$borderBottomDouble = array(
+  'borders' => array(
+    'bottom' => array(
+      'style' => PHPExcel_Style_Border::BORDER_DOUBLE
+    )
+  )
+);
+$styleArray = array(
+  'borders' => array(
+    'allborders' => array(
+      'style' => PHPExcel_Style_Border::BORDER_THIN
+    )
+  ),
+  'font'  => array(
+		'bold'  => false,
+		'size'  => 16,
+		'name'  => 'Cordia New'
+	)
+);
+$textStyleArray = array(
+  'font'  => array(
+		'bold'  => false,
+		'size'  => 16,
+		'name'  => 'Angsana New'
+	)
+);
+$headerStyle = array(
+	'font'  => array(
+		'bold'  => false,
+		'size'  => 16,
+		'name'  => 'Angsana New'
+	)
+);
+$titleStyle = array(
+	'font'  => array(
+		'bold'  => true,
+		'size'  => 18,
+		'name'  => 'TH Sarabun New'
+	)
+);
+$footerStyle = array(
+	'font'  => array(
+		'bold'  => true,
+		'size'  => 14,
+		'name'  => 'AngsanaUPC'
+	)
+);
+$table = array(
+    'borders' => array(
+        'allborders' => array(
+            'style' => PHPExcel_Style_Border::BORDER_THIN
+        )
+    ),
+);
+
+$sheet = 0;
+$i=0;
+$objPHPExcel->createSheet($sheet);
+$objPHPExcel->setActiveSheetIndex($sheet);
+$i+=1;
+$objPHPExcel->getActiveSheet()->mergeCells('A'.$i.':G'.$i);
+$objPHPExcel->getActiveSheet()->SetCellValue('A' . $i , $_SESSION['COOP_NAME']);
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i)->applyFromArray($headerStyle);
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i.':G'.$i)->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
+$i+=1;
+$objPHPExcel->getActiveSheet()->mergeCells('A'.$i.':G'.$i);
+$objPHPExcel->getActiveSheet()->SetCellValue('A' . $i , "รายงานสรุปดอกเบี้ยค้างรับ");
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i)->applyFromArray($headerStyle);
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i.':G'.$i)->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
+$i+=1;
+$objPHPExcel->getActiveSheet()->mergeCells('A'.$i.':G'.$i);
+$objPHPExcel->getActiveSheet()->SetCellValue('A' . $i , $this->center_function->ConvertToThaiDate(@date('Y-m-d'),0,0)) ;
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i)->applyFromArray($headerStyle);
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i.':G'.$i)->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_RIGHT);
+$i+=1;
+$objPHPExcel->getActiveSheet()->mergeCells('A'.$i.':G'.$i);
+$objPHPExcel->getActiveSheet()->SetCellValue('A' . $i , "ผู้ทำรายการ ".$_SESSION['USER_NAME']) ;
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i)->applyFromArray($headerStyle);
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i.':G'.$i)->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_RIGHT);
+$i+=1;
+$i_top = $i;
+$objPHPExcel->getActiveSheet()->SetCellValue('A'.$i, "ลำดับ");
+$objPHPExcel->getActiveSheet()->SetCellValue('B'.$i, "องค์กร");
+$objPHPExcel->getActiveSheet()->SetCellValue('C'.$i, "หมวดการลงทุน");
+$objPHPExcel->getActiveSheet()->SetCellValue('D'.$i, "หัวข้อการลงทุน");
+$objPHPExcel->getActiveSheet()->SetCellValue('E'.$i, "เงินลงทุน");
+$objPHPExcel->getActiveSheet()->SetCellValue('F'.$i, "ดอกเบี้ยค้างรับ");
+$objPHPExcel->getActiveSheet()->SetCellValue('G'.$i, "วันที่ครบกำหนด");
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i.":G".$i)->applyFromArray($table);
+
+$objPHPExcel->getActiveSheet()->getColumnDimension('A')->setWidth(10);
+$objPHPExcel->getActiveSheet()->getColumnDimension('B')->setWidth(30);
+$objPHPExcel->getActiveSheet()->getColumnDimension('C')->setWidth(30);
+$objPHPExcel->getActiveSheet()->getColumnDimension('D')->setWidth(50);
+$objPHPExcel->getActiveSheet()->getColumnDimension('E')->setWidth(15);
+$objPHPExcel->getActiveSheet()->getColumnDimension('F')->setWidth(15);
+$objPHPExcel->getActiveSheet()->getColumnDimension('G')->setWidth(15);
+
+$total = 0;
+$total_balance = 0;
+$index = 0;
+foreach($datas as $data) {
+    $i++;
+    $expect_val = $data['amount'] * $data['rate'] / 100;
+    $objPHPExcel->getActiveSheet()->SetCellValue('A'.$i, ++$index);
+    $objPHPExcel->getActiveSheet()->SetCellValue('B'.$i, $data["org_name"]);
+    $objPHPExcel->getActiveSheet()->SetCellValue('C'.$i, $data["type_name"]);
+    $objPHPExcel->getActiveSheet()->SetCellValue('D'.$i, $data['name']);
+    $objPHPExcel->getActiveSheet()->SetCellValue('E'.$i, number_format($data['amount'], 2));
+    $objPHPExcel->getActiveSheet()->SetCellValue('F'.$i, number_format($expect_val, 2));
+    $objPHPExcel->getActiveSheet()->SetCellValue('G'.$i, $this->center_function->ConvertToThaiDate($data['end_date'], '1', '0'));
+    $objPHPExcel->getActiveSheet()->getStyle('A'.$i.":G".$i)->applyFromArray($table);
+    $total += $data['amount'];
+    $total_balance += $expect_val;
+}
+
+$i++;
+$objPHPExcel->getActiveSheet()->SetCellValue('A'.$i, "รวม");
+$objPHPExcel->getActiveSheet()->mergeCells('A'.$i.':D'.$i);
+$objPHPExcel->getActiveSheet()->SetCellValue('E'.$i, number_format($total,2));
+$objPHPExcel->getActiveSheet()->SetCellValue('F'.$i, number_format($total_balance,2));
+
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i.":G".$i)->applyFromArray($table);
+
+header('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
+header('Content-Disposition: attachment;filename="สรุปดอกเบี้ยค้างรับ.xlsx"');
+header('Cache-Control: max-age=0');
+
+$objWriter = new PHPExcel_Writer_Excel2007($objPHPExcel);
+$objWriter->save('php://output');
+exit;
+?>
\ No newline at end of file
diff --git a/application/views/invest/report_expect_profit_preview.php b/application/views/invest/report_expect_profit_preview.php
new file mode 100644
index 0000000..bbd55e8
--- /dev/null
+++ b/application/views/invest/report_expect_profit_preview.php
@@ -0,0 +1,161 @@
+<style>
+	.table-view>thead, .table-view>thead>tr>td, .table-view>thead>tr>th {
+		font-size: 14px;
+	}
+	.table-view>tbody>tr>th{
+	    border-top: 1px solid #000 !important;
+		border-bottom: 1px solid #000 !important;
+		font-size: 12px;
+		background-color: #eee;
+	}
+	.table-view-2>tbody>tr>td{
+	    border: 0px !important;
+		/*font-family: upbean;
+		font-size: 16px;*/
+		font-family: Tahoma;
+		font-size: 12px;
+	}	
+	.border-bottom{
+	    border-bottom: 1px solid #000 !important;
+		font-weight: bold;
+	}
+	.table-view-2>tbody>tr>td>span{
+		font-family: Tahoma;
+		font-size: 12px !important;
+	}
+	.foot-border{
+	    border-top: 1px solid #000 !important;
+		border-bottom: double !important;
+		font-weight: bold;
+	}
+	.table {
+		color: #000;
+	}
+	.table>tbody>tr>td, .table>tbody>tr>th, .table>tfoot>tr>td, .table>tfoot>tr>th, .table>thead>tr>td, .table>thead>tr>th {
+		padding:6px;
+	}
+</style>
+<?php
+	$runno = 0;
+	$prev_level = "x";
+	$total = 0;
+	$balance_total = 0;
+	foreach($datas AS $page=>$data){
+?>
+<form action="<?php echo base_url(PROJECTPATH.'/invest/report_expect_profit_preview'); ?>" id="search_form" method="POST" target="_blank">
+	<input type="hidden" name="doc_type" id="doc_type" value="excel"/>
+	<input type="hidden" name="type" id="type" value="<?php echo $_POST['type'];?>"/>
+</form>
+<div style="width: 11.7in;" class="page-break">
+	<div class="panel panel-body" style="padding-top:10px !important;height: 8.3in;">
+		<table style="width: 100%;">
+		<?php 
+			if($page == 1) {
+		?>	
+			<tr>
+				<td style="width:100px;vertical-align: top;">
+
+				</td>
+				<td class="text-center">
+					<img src="<?php echo base_url(PROJECTPATH.'/assets/images/coop_profile/'.$_SESSION['COOP_IMG']); ?>" alt="Logo" style="height: 80px;" />
+					<h3 class="title_view"><?php echo @$_SESSION['COOP_NAME'];?></h3>
+					<h3 class="title_view">รายงานสรุปดอกเบี้ยค้างรับ</h3>
+					<h3 class="title_view">
+					</h3>
+				</td>
+				<td style="width:100px;vertical-align: top;" class="text-right">
+					<a class="no_print" onclick="window.print();"><button class="btn btn-perview btn-after-input" type="button"><span class="icon icon-print" aria-hidden="true"></span></button></a>
+					<a class="no_print"  target="_blank" id="excel-submit">
+						<button class="btn btn-perview btn-after-input" type="button"><span class="icon icon icon-file-excel-o" aria-hidden="true"></span></button>
+					</a>
+				</td>
+			</tr>
+		<?php } ?>
+			<tr>
+				<td colspan="3" style="text-align: right;">
+					<span class="title_view">หน้าที่ <?php echo @$page.'/'.@$page_all;?></span><br>
+				</td>
+			</tr> 
+			<tr>
+				<td colspan="3" style="text-align: right;">
+					<span class="title_view">วันที่ <?php echo $this->center_function->ConvertToThaiDate(@date('Y-m-d'),1,0);?></span>
+				</td>
+			</tr> 
+			<tr>
+				<td colspan="3" style="text-align: right;">
+					<span class="title_view">เวลา <?php echo date('H:i:s');?></span>
+				</td>
+			</tr>
+			<tr>
+				<td colspan="3" style="text-align: right;">
+					<span class="title_view">ผู้ทำรายการ <?php echo $_SESSION['USER_NAME'];?></span>
+				</td>
+			</tr>
+		</table>
+
+		<table class="table table-view table-center">
+			<tbody>
+			<?php
+				$first_of_page = 1;
+				$max = count($data)-1;
+				foreach($data as $key => $row){
+          			$expect_val = $row['amount'] * $row['rate'] / 100;
+					if(!empty($first_of_page)) {
+			?>
+				<tr>
+					<th style="width: 5%;vertical-align: middle;">ลำดับ</th>
+					<th style="width: 15%;vertical-align: middle;">องค์กร</th>
+					<th style="width: 15%;vertical-align: middle;">หมวดการลงทุน</th>
+					<th style="vertical-align: middle;">หัวข้อการลงทุน</th>
+					<th style="width: 10%;vertical-align: middle;">เงินลงทุน</th>
+					<th style="width: 10%;vertical-align: middle;">ดอกเบี้ยค้างรับ</th>
+					<th style="width: 10%;vertical-align: middle;">วันที่ครบกำหนด</th>
+				</tr>
+			<?php
+					}
+			?>
+				<tr>
+					<td style="text-align: center;vertical-align: top;"><?php echo ++$runno; ?></td>
+					<td style="text-align: left;vertical-align: top;"><?php echo $row['org_name'];?></td>
+					<td style="text-align: left;vertical-align: top;"><?php echo $row['type_name'];?></td>
+					<td style="text-align: left;vertical-align: top;"><?php echo $row['name'];?></td>
+					<td style="text-align: right;vertical-align: top;"><?php echo number_format($row['amount'], 2);?></td>
+					<td style="text-align: right;vertical-align: top;"><?php echo number_format($expect_val, 2);?></td>
+					<td style="text-align: center;vertical-align: top;"><?php echo $this->center_function->ConvertToThaiDate($row['end_date'], '1', '0');?></td>
+				</tr>
+			<?php
+					$first_of_page = 0;
+					$total += $row['amount'];
+					$balance_total += $expect_val;
+					if($max == $key) {
+			?>
+				<tr>
+					<th colspan="4" class="table_body text-right">
+						รวม&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
+					</th>
+					<th class="text-right">
+						<?php echo number_format($total, 2);?>
+					</th>
+					<th class="text-right">
+						<?php echo number_format($balance_total, 2);?>
+					</th>
+					<th></th>
+				</tr>
+			<?php
+					}
+				}
+			?>
+			</tbody>
+		</table>
+	</div>
+</div>
+<?php
+	}
+?>
+<script>
+	$(document).ready(function() {
+		$("#excel-submit").click(function() {
+			$("#search_form").submit();
+		});
+	});
+</script>
\ No newline at end of file
diff --git a/application/views/invest/report_invest.php b/application/views/invest/report_invest.php
new file mode 100644
index 0000000..9627e1b
--- /dev/null
+++ b/application/views/invest/report_invest.php
@@ -0,0 +1,139 @@
+<div class="layout-content">
+    <div class="layout-content-body">
+		<style>
+			.modal-header-alert {
+				padding:9px 15px;
+				border:1px solid #FF0033;
+				background-color: #FF0033;
+				color: #fff;
+				-webkit-border-top-left-radius: 5px;
+				-webkit-border-top-right-radius: 5px;
+				-moz-border-radius-topleft: 5px;
+				-moz-border-radius-topright: 5px;
+				border-top-left-radius: 5px;
+				border-top-right-radius: 5px;
+			}
+			.center {
+				text-align: center;
+			}
+			.right {
+				text-align: right;
+			}
+			.modal-dialog-account {
+				margin:auto;
+				margin-top:7%;
+			}
+			label{
+				padding-top:7px;
+			}
+		</style>
+		<h1 style="margin-bottom: 0">ระบบการลงทุน</h1>
+		<?php $this->load->view('breadcrumb'); ?>
+		<div class="row gutter-xs">
+			<div class="col-xs-12 col-md-12">
+				<div class="panel panel-body" style="padding-top:0px !important;" id="search-div">
+					<form action="<?php echo base_url(PROJECTPATH.'/invest/report_invest_preview'); ?>" id="search_form" method="POST" target="_blank">
+						<input type="hidden" name="doc_type" id="doc_type" value="html"/>
+						<div class="form-group g24-col-sm-24 text-center">
+                            <h3>รายงานสรุปการลงทุน</h3>
+						</div>
+						<div class="form-group g24-col-sm-24">
+							<label class="g24-col-sm-7 control-label right"> วันที่ </label>
+							<div class="g24-col-sm-4">
+								<div class="input-with-icon">
+									<div class="form-group">
+										<input id="from_date" name="from_date" class="form-control m-b-1 mydate" style="padding-left: 50px;" type="text" value="<?php echo $this->center_function->mydate2date(date('Y-m-d')); ?>" data-date-language="th-th">
+										<span class="icon icon-calendar input-icon m-f-1"></span>
+									</div>
+								</div>
+							</div>
+							<label class="g24-col-sm-2 control-label right"> ถึงวันที่ </label>
+							<div class="g24-col-sm-4">
+								<div class="input-with-icon">
+									<div class="form-group">
+										<input id="thru_date" name="thru_date" class="form-control m-b-1 mydate" style="padding-left: 50px;" type="text" value="<?php echo $this->center_function->mydate2date(date('Y-m-d')); ?>" data-date-language="th-th">
+										<span class="icon icon-calendar input-icon m-f-1"></span>
+									</div>
+								</div>
+							</div>
+						</div>
+						<div class="form-group g24-col-sm-24">
+							<label class="g24-col-sm-7 control-label right"> องค์กร </label>
+							<div class="g24-col-sm-4">
+								<div class="input-with-icon">
+									<div class="form-group">
+										<select id="org" name="org" class="form-control m-b-1 js-data-example-ajax">
+                                            <option value="">ทั้งหมด</option>
+                                            <?php 
+                                                foreach($orgs as $key => $org) {
+                                            ?>
+                                            <option value="<?php echo $org['id']; ?>"><?php echo $org['name'];?></option>
+                                            <?php
+                                                }
+                                            ?>
+                                        </select>
+									</div>
+								</div>
+							</div>
+						</div>
+						<div class="form-group g24-col-sm-24">
+							<label class="g24-col-sm-7 control-label right"> หมวดการลงทุน </label>
+							<div class="g24-col-sm-4">
+								<div class="input-with-icon">
+									<div class="form-group">
+										<select id="type" name="type" class="form-control m-b-1 js-data-example-ajax">
+                                            <option value="">ทั้งหมด</option>
+                                            <?php 
+                                                foreach($invest_types as $key => $type) {
+                                            ?>
+                                            <option value="<?php echo $type['id']; ?>"><?php echo $type['name'];?></option>
+                                            <?php
+                                                }
+                                            ?>
+                                        </select>
+									</div>
+								</div>
+							</div>
+						</div>
+						<div class="form-group g24-col-sm-24 text-center">
+                            <button class="btn btn-primary btn-after-input" type="button" onclick="check_empty(1)"><span> แสดงรายงาน</span></button>
+						</div>
+					</form>
+				</div>
+			</div>
+		</div>
+	</div>
+</div>
+<?php
+$v = date('YmdHis');
+$link = array(
+    'src' => PROJECTJSPATH.'assets/js/invest_report.js?v='.$v,
+    'type' => 'text/javascript'
+);
+echo script_tag($link);
+?>
+<script>
+function check_empty(type){
+	$.ajax({
+		 url:base_url+"invest/check_report_invest", 
+		 method:"post",
+		 data:$("#search_form").serialize(),
+		 dataType:"text",
+		 success:function(data){
+			if(data == 'success'){
+				if(type == 1) {
+					$("#doc_type").val('html');
+				} else {
+					$("#doc_type").val('excel');
+				}
+				$("#search_form").submit();
+			} else if (data == "no-data") {
+				swal('ไม่พบข้อมูล', '', 'warning');
+			}else{
+				$('#alertNotFindModal').appendTo("body").modal('show');
+			}
+		 }
+	});
+}
+
+</script>
diff --git a/application/views/invest/report_invest_balance.php b/application/views/invest/report_invest_balance.php
new file mode 100644
index 0000000..ae381a3
--- /dev/null
+++ b/application/views/invest/report_invest_balance.php
@@ -0,0 +1,92 @@
+<div class="layout-content">
+    <div class="layout-content-body">
+		<style>
+			.modal-header-alert {
+				padding:9px 15px;
+				border:1px solid #FF0033;
+				background-color: #FF0033;
+				color: #fff;
+				-webkit-border-top-left-radius: 5px;
+				-webkit-border-top-right-radius: 5px;
+				-moz-border-radius-topleft: 5px;
+				-moz-border-radius-topright: 5px;
+				border-top-left-radius: 5px;
+				border-top-right-radius: 5px;
+			}
+			.center {
+				text-align: center;
+			}
+			.right {
+				text-align: right;
+			}
+			.modal-dialog-account {
+				margin:auto;
+				margin-top:7%;
+			}
+			label{
+				padding-top:7px;
+			}
+		</style>
+		<h1 style="margin-bottom: 0">ระบบการลงทุน</h1>
+		<?php $this->load->view('breadcrumb'); ?>
+		<div class="row gutter-xs">
+			<div class="col-xs-12 col-md-12">
+				<div class="panel panel-body" style="padding-top:0px !important;" id="search-div">
+					<form action="<?php echo base_url(PROJECTPATH.'/invest/report_invest_balance_preview'); ?>" id="search_form" method="POST" target="_blank">
+						<input type="hidden" name="doc_type" id="doc_type" value="html"/>
+						<div class="form-group g24-col-sm-24 text-center">
+                            <h3>รายงานยอดคงเหลือ</h3>
+						</div>
+						<div class="form-group g24-col-sm-24">
+							<label class="g24-col-sm-10 control-label right"> หมวดการลงทุน </label>
+							<div class="g24-col-sm-5">
+								<div class="input-with-icon">
+									<div class="form-group">
+										<select id="type" name="type" class="form-control m-b-1 js-data-example-ajax">
+                                            <option value="">ทั้งหมด</option>
+                                            <?php 
+                                                foreach($invest_types as $key => $type) {
+                                            ?>
+                                            <option value="<?php echo $type['id']; ?>"><?php echo $type['name'];?></option>
+                                            <?php
+                                                }
+                                            ?>
+                                        </select>
+									</div>
+								</div>
+							</div>
+						</div>
+						<div class="form-group g24-col-sm-24 text-center">
+                            <button class="btn btn-primary btn-after-input" type="button" onclick="check_empty(1)"><span> แสดงรายงาน</span></button>
+						</div>
+					</form>
+				</div>
+			</div>
+		</div>
+	</div>
+</div>
+<script>
+function check_empty(type){
+	$.ajax({
+		 url:base_url+"invest/check_invest_balance", 
+		 method:"post",
+		 data:$("#search_form").serialize(),
+		 dataType:"text",
+		 success:function(data){
+			if(data == 'success'){
+				if(type == 1) {
+					$("#doc_type").val('html');
+				} else {
+					$("#doc_type").val('excel');
+				}
+				$("#search_form").submit();
+			} else if (data == "no-data") {
+				swal('ไม่พบข้อมูล', '', 'warning');
+			}else{
+				$('#alertNotFindModal').appendTo("body").modal('show');
+			}
+		 }
+	});
+}
+
+</script>
diff --git a/application/views/invest/report_invest_balance_excel.php b/application/views/invest/report_invest_balance_excel.php
new file mode 100644
index 0000000..80e696f
--- /dev/null
+++ b/application/views/invest/report_invest_balance_excel.php
@@ -0,0 +1,159 @@
+<?php
+$objPHPExcel = new PHPExcel();
+
+$borderRight = array(
+  'borders' => array(
+    'right' => array(
+      'style' => PHPExcel_Style_Border::BORDER_THIN
+    )
+  )
+);
+$borderLeft = array(
+  'borders' => array(
+    'left' => array(
+      'style' => PHPExcel_Style_Border::BORDER_THIN
+    )
+  )
+);
+$borderTop = array(
+  'borders' => array(
+    'top' => array(
+      'style' => PHPExcel_Style_Border::BORDER_THIN
+    )
+  )
+);
+$borderBottom = array(
+  'borders' => array(
+    'bottom' => array(
+      'style' => PHPExcel_Style_Border::BORDER_THIN
+    )
+  )
+);
+$borderBottomDouble = array(
+  'borders' => array(
+    'bottom' => array(
+      'style' => PHPExcel_Style_Border::BORDER_DOUBLE
+    )
+  )
+);
+$styleArray = array(
+  'borders' => array(
+    'allborders' => array(
+      'style' => PHPExcel_Style_Border::BORDER_THIN
+    )
+  ),
+  'font'  => array(
+		'bold'  => false,
+		'size'  => 16,
+		'name'  => 'Cordia New'
+	)
+);
+$textStyleArray = array(
+  'font'  => array(
+		'bold'  => false,
+		'size'  => 16,
+		'name'  => 'Angsana New'
+	)
+);
+$headerStyle = array(
+	'font'  => array(
+		'bold'  => false,
+		'size'  => 16,
+		'name'  => 'Angsana New'
+	)
+);
+$titleStyle = array(
+	'font'  => array(
+		'bold'  => true,
+		'size'  => 18,
+		'name'  => 'TH Sarabun New'
+	)
+);
+$footerStyle = array(
+	'font'  => array(
+		'bold'  => true,
+		'size'  => 14,
+		'name'  => 'AngsanaUPC'
+	)
+);
+$table = array(
+    'borders' => array(
+        'allborders' => array(
+            'style' => PHPExcel_Style_Border::BORDER_THIN
+        )
+    ),
+);
+
+$sheet = 0;
+$i=0;
+$objPHPExcel->createSheet($sheet);
+$objPHPExcel->setActiveSheetIndex($sheet);
+$i+=1;
+$objPHPExcel->getActiveSheet()->mergeCells('A'.$i.':F'.$i);
+$objPHPExcel->getActiveSheet()->SetCellValue('A' . $i , $_SESSION['COOP_NAME']);
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i)->applyFromArray($headerStyle);
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i.':F'.$i)->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
+$i+=1;
+$objPHPExcel->getActiveSheet()->mergeCells('A'.$i.':F'.$i);
+$objPHPExcel->getActiveSheet()->SetCellValue('A' . $i , "รายงานยอดคงเหลือ");
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i)->applyFromArray($headerStyle);
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i.':F'.$i)->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
+$i+=1;
+$objPHPExcel->getActiveSheet()->mergeCells('A'.$i.':F'.$i);
+$objPHPExcel->getActiveSheet()->SetCellValue('A' . $i , $this->center_function->ConvertToThaiDate(@date('Y-m-d'),0,0)) ;
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i)->applyFromArray($headerStyle);
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i.':F'.$i)->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_RIGHT);
+$i+=1;
+$objPHPExcel->getActiveSheet()->mergeCells('A'.$i.':F'.$i);
+$objPHPExcel->getActiveSheet()->SetCellValue('A' . $i , "ผู้ทำรายการ ".$_SESSION['USER_NAME']) ;
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i)->applyFromArray($headerStyle);
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i.':F'.$i)->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_RIGHT);
+$i+=1;
+$i_top = $i;
+$objPHPExcel->getActiveSheet()->SetCellValue('A'.$i, "ลำดับ");
+$objPHPExcel->getActiveSheet()->SetCellValue('B'.$i, "องค์กร");
+$objPHPExcel->getActiveSheet()->SetCellValue('C'.$i, "หมวดการลงทุน");
+$objPHPExcel->getActiveSheet()->SetCellValue('D'.$i, "หัวข้อการลงทุน");
+$objPHPExcel->getActiveSheet()->SetCellValue('E'.$i, "เงินลงทุน");
+$objPHPExcel->getActiveSheet()->SetCellValue('F'.$i, "เงินคงเหลือ");
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i.":F".$i)->applyFromArray($table);
+
+$objPHPExcel->getActiveSheet()->getColumnDimension('A')->setWidth(10);
+$objPHPExcel->getActiveSheet()->getColumnDimension('B')->setWidth(30);
+$objPHPExcel->getActiveSheet()->getColumnDimension('C')->setWidth(30);
+$objPHPExcel->getActiveSheet()->getColumnDimension('D')->setWidth(50);
+$objPHPExcel->getActiveSheet()->getColumnDimension('E')->setWidth(15);
+$objPHPExcel->getActiveSheet()->getColumnDimension('F')->setWidth(15);
+
+$total = 0;
+$total_balance = 0;
+$index = 0;
+foreach($datas as $data) {
+    $i++;
+    $objPHPExcel->getActiveSheet()->SetCellValue('A'.$i, ++$index);
+    $objPHPExcel->getActiveSheet()->SetCellValue('B'.$i, $data["org_name"]);
+    $objPHPExcel->getActiveSheet()->SetCellValue('C'.$i, $data["type_name"]);
+    $objPHPExcel->getActiveSheet()->SetCellValue('D'.$i, $data['name']);
+    $objPHPExcel->getActiveSheet()->SetCellValue('E'.$i, number_format($data['amount'], 2));
+    $objPHPExcel->getActiveSheet()->SetCellValue('F'.$i, number_format($data['balance'], 2));
+    $objPHPExcel->getActiveSheet()->getStyle('A'.$i.":F".$i)->applyFromArray($table);
+    $total += $data['amount'];
+    $total_balance += $data['balance'];
+}
+
+$i++;
+$objPHPExcel->getActiveSheet()->SetCellValue('A'.$i, "รวม");
+$objPHPExcel->getActiveSheet()->mergeCells('A'.$i.':D'.$i);
+$objPHPExcel->getActiveSheet()->SetCellValue('E'.$i, number_format($total,2));
+$objPHPExcel->getActiveSheet()->SetCellValue('F'.$i, number_format($total_balance,2));
+
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i.":F".$i)->applyFromArray($table);
+
+header('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
+header('Content-Disposition: attachment;filename="ยอดคงเหลือ.xlsx"');
+header('Cache-Control: max-age=0');
+
+$objWriter = new PHPExcel_Writer_Excel2007($objPHPExcel);
+$objWriter->save('php://output');
+exit;
+?>
\ No newline at end of file
diff --git a/application/views/invest/report_invest_balance_preview.php b/application/views/invest/report_invest_balance_preview.php
new file mode 100644
index 0000000..4376167
--- /dev/null
+++ b/application/views/invest/report_invest_balance_preview.php
@@ -0,0 +1,157 @@
+<style>
+	.table-view>thead, .table-view>thead>tr>td, .table-view>thead>tr>th {
+		font-size: 14px;
+	}
+	.table-view>tbody>tr>th{
+	    border-top: 1px solid #000 !important;
+		border-bottom: 1px solid #000 !important;
+		font-size: 12px;
+		background-color: #eee;
+	}
+	.table-view-2>tbody>tr>td{
+	    border: 0px !important;
+		/*font-family: upbean;
+		font-size: 16px;*/
+		font-family: Tahoma;
+		font-size: 12px;
+	}	
+	.border-bottom{
+	    border-bottom: 1px solid #000 !important;
+		font-weight: bold;
+	}
+	.table-view-2>tbody>tr>td>span{
+		font-family: Tahoma;
+		font-size: 12px !important;
+	}
+	.foot-border{
+	    border-top: 1px solid #000 !important;
+		border-bottom: double !important;
+		font-weight: bold;
+	}
+	.table {
+		color: #000;
+	}
+	.table>tbody>tr>td, .table>tbody>tr>th, .table>tfoot>tr>td, .table>tfoot>tr>th, .table>thead>tr>td, .table>thead>tr>th {
+		padding:6px;
+	}
+</style>
+<?php
+	$runno = 0;
+	$prev_level = "x";
+	$total = 0;
+	$balance_total = 0;
+	foreach($datas AS $page=>$data){
+?>
+<form action="<?php echo base_url(PROJECTPATH.'/invest/report_invest_balance_preview'); ?>" id="search_form" method="POST" target="_blank">
+	<input type="hidden" name="doc_type" id="doc_type" value="excel"/>
+	<input type="hidden" name="type" id="type" value="<?php echo $_POST['type'];?>"/>
+</form>
+<div style="width: 11.7in;" class="page-break">
+	<div class="panel panel-body" style="padding-top:10px !important;height: 8.3in;">
+		<table style="width: 100%;">
+		<?php 
+			if($page == 1) {
+		?>	
+			<tr>
+				<td style="width:100px;vertical-align: top;">
+
+				</td>
+				<td class="text-center">
+					<img src="<?php echo base_url(PROJECTPATH.'/assets/images/coop_profile/'.$_SESSION['COOP_IMG']); ?>" alt="Logo" style="height: 80px;" />
+					<h3 class="title_view"><?php echo @$_SESSION['COOP_NAME'];?></h3>
+					<h3 class="title_view">รายงานยอดคงเหลือ</h3>
+					<h3 class="title_view">
+					</h3>
+				</td>
+				<td style="width:100px;vertical-align: top;" class="text-right">
+					<a class="no_print" onclick="window.print();"><button class="btn btn-perview btn-after-input" type="button"><span class="icon icon-print" aria-hidden="true"></span></button></a>
+					<a class="no_print"  target="_blank" id="excel-submit">
+						<button class="btn btn-perview btn-after-input" type="button"><span class="icon icon icon-file-excel-o" aria-hidden="true"></span></button>
+					</a>
+				</td>
+			</tr>
+		<?php } ?>
+			<tr>
+				<td colspan="3" style="text-align: right;">
+					<span class="title_view">หน้าที่ <?php echo @$page.'/'.@$page_all;?></span><br>
+				</td>
+			</tr> 
+			<tr>
+				<td colspan="3" style="text-align: right;">
+					<span class="title_view">วันที่ <?php echo $this->center_function->ConvertToThaiDate(@date('Y-m-d'),1,0);?></span>
+				</td>
+			</tr> 
+			<tr>
+				<td colspan="3" style="text-align: right;">
+					<span class="title_view">เวลา <?php echo date('H:i:s');?></span>
+				</td>
+			</tr>
+			<tr>
+				<td colspan="3" style="text-align: right;">
+					<span class="title_view">ผู้ทำรายการ <?php echo $_SESSION['USER_NAME'];?></span>
+				</td>
+			</tr>
+		</table>
+
+		<table class="table table-view table-center">
+			<tbody>
+			<?php
+				$first_of_page = 1;
+				$max = count($data)-1;
+				foreach($data as $key => $row){
+					if(!empty($first_of_page)) {
+			?>
+				<tr>
+					<th style="width: 5%;vertical-align: middle;">ลำดับ</th>
+					<th style="width: 18%;vertical-align: middle;">องค์กร</th>
+					<th style="width: 18%;vertical-align: middle;">หมวดการลงทุน</th>
+					<th style="vertical-align: middle;">หัวข้อการลงทุน</th>
+					<th style="width: 10%;vertical-align: middle;">เงินลงทุน</th>
+					<th style="width: 10%;vertical-align: middle;">เงินคงเหลือ</th>
+				</tr>
+			<?php
+					}
+			?>
+				<tr>
+					<td style="text-align: center;vertical-align: top;"><?php echo ++$runno; ?></td>
+					<td style="text-align: left;vertical-align: top;"><?php echo $row['org_name'];?></td>
+					<td style="text-align: left;vertical-align: top;"><?php echo $row['type_name'];?></td>
+					<td style="text-align: left;vertical-align: top;"><?php echo $row['name'];?></td>
+					<td style="text-align: right;vertical-align: top;"><?php echo number_format($row['amount'], 2);?></td>
+					<td style="text-align: right;vertical-align: top;"><?php echo number_format($row['balance'], 2);?></td>
+				</tr>
+			<?php
+					$first_of_page = 0;
+					$total += $row['amount'];
+					$balance_total += $row['balance'];
+					if($max == $key) {
+			?>
+				<tr>
+					<th colspan="4" class="table_body text-right">
+						รวม&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
+					</th>
+					<th class="text-right">
+						<?php echo number_format($total, 2);?>
+					</th>
+					<th class="text-right">
+						<?php echo number_format($balance_total, 2);?>
+					</th>
+				</tr>
+			<?php
+					}
+				}
+			?>
+			</tbody>
+		</table>
+	</div>
+</div>
+<?php
+	}
+?>
+<script>
+	$(document).ready(function() {
+		$("#excel-submit").click(function() {
+			$("#search_form").submit();
+		});
+	});
+</script>
\ No newline at end of file
diff --git a/application/views/invest/report_invest_excel.php b/application/views/invest/report_invest_excel.php
new file mode 100644
index 0000000..3fd176c
--- /dev/null
+++ b/application/views/invest/report_invest_excel.php
@@ -0,0 +1,162 @@
+<?php
+$objPHPExcel = new PHPExcel();
+
+$borderRight = array(
+  'borders' => array(
+    'right' => array(
+      'style' => PHPExcel_Style_Border::BORDER_THIN
+    )
+  )
+);
+$borderLeft = array(
+  'borders' => array(
+    'left' => array(
+      'style' => PHPExcel_Style_Border::BORDER_THIN
+    )
+  )
+);
+$borderTop = array(
+  'borders' => array(
+    'top' => array(
+      'style' => PHPExcel_Style_Border::BORDER_THIN
+    )
+  )
+);
+$borderBottom = array(
+  'borders' => array(
+    'bottom' => array(
+      'style' => PHPExcel_Style_Border::BORDER_THIN
+    )
+  )
+);
+$borderBottomDouble = array(
+  'borders' => array(
+    'bottom' => array(
+      'style' => PHPExcel_Style_Border::BORDER_DOUBLE
+    )
+  )
+);
+$styleArray = array(
+  'borders' => array(
+    'allborders' => array(
+      'style' => PHPExcel_Style_Border::BORDER_THIN
+    )
+  ),
+  'font'  => array(
+		'bold'  => false,
+		'size'  => 16,
+		'name'  => 'Cordia New'
+	)
+);
+$textStyleArray = array(
+  'font'  => array(
+		'bold'  => false,
+		'size'  => 16,
+		'name'  => 'Angsana New'
+	)
+);
+$headerStyle = array(
+	'font'  => array(
+		'bold'  => false,
+		'size'  => 16,
+		'name'  => 'Angsana New'
+	)
+);
+$titleStyle = array(
+	'font'  => array(
+		'bold'  => true,
+		'size'  => 18,
+		'name'  => 'TH Sarabun New'
+	)
+);
+$footerStyle = array(
+	'font'  => array(
+		'bold'  => true,
+		'size'  => 14,
+		'name'  => 'AngsanaUPC'
+	)
+);
+$table = array(
+    'borders' => array(
+        'allborders' => array(
+            'style' => PHPExcel_Style_Border::BORDER_THIN
+        )
+    ),
+);
+
+$sheet = 0;
+$i=0;
+$objPHPExcel->createSheet($sheet);
+$objPHPExcel->setActiveSheetIndex($sheet);
+$i+=1;
+$objPHPExcel->getActiveSheet()->mergeCells('A'.$i.':G'.$i);
+$objPHPExcel->getActiveSheet()->SetCellValue('A' . $i , $_SESSION['COOP_NAME']);
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i)->applyFromArray($headerStyle);
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i.':G'.$i)->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
+$i+=1;
+$objPHPExcel->getActiveSheet()->mergeCells('A'.$i.':G'.$i);
+$objPHPExcel->getActiveSheet()->SetCellValue('A' . $i , "รายงานสรุปการลงทุน");
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i)->applyFromArray($headerStyle);
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i.':G'.$i)->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
+$i+=1;
+$objPHPExcel->getActiveSheet()->mergeCells('A'.$i.':G'.$i);
+$objPHPExcel->getActiveSheet()->SetCellValue('A' . $i , $this->center_function->ConvertToThaiDate(@date('Y-m-d'),0,0)) ;
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i)->applyFromArray($headerStyle);
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i.':G'.$i)->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_RIGHT);
+$i+=1;
+$objPHPExcel->getActiveSheet()->mergeCells('A'.$i.':G'.$i);
+$objPHPExcel->getActiveSheet()->SetCellValue('A' . $i , "ผู้ทำรายการ ".$_SESSION['USER_NAME']) ;
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i)->applyFromArray($headerStyle);
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i.':G'.$i)->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_RIGHT);
+$i+=1;
+$i_top = $i;
+$objPHPExcel->getActiveSheet()->SetCellValue('A'.$i, "ลำดับ");
+$objPHPExcel->getActiveSheet()->SetCellValue('B'.$i, "องค์กร");
+$objPHPExcel->getActiveSheet()->SetCellValue('C'.$i, "หมวดการลงทุน");
+$objPHPExcel->getActiveSheet()->SetCellValue('D'.$i, "หัวข้อการลงทุน");
+$objPHPExcel->getActiveSheet()->SetCellValue('E'.$i, "เงินลงทุน");
+$objPHPExcel->getActiveSheet()->SetCellValue('F'.$i, "วันที่ลงทุน");
+$objPHPExcel->getActiveSheet()->SetCellValue('G'.$i, "วันครบกำหนด");
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i.":G".$i)->applyFromArray($table);
+
+$objPHPExcel->getActiveSheet()->getColumnDimension('A')->setWidth(10);
+$objPHPExcel->getActiveSheet()->getColumnDimension('B')->setWidth(30);
+$objPHPExcel->getActiveSheet()->getColumnDimension('C')->setWidth(30);
+$objPHPExcel->getActiveSheet()->getColumnDimension('D')->setWidth(50);
+$objPHPExcel->getActiveSheet()->getColumnDimension('E')->setWidth(15);
+$objPHPExcel->getActiveSheet()->getColumnDimension('F')->setWidth(15);
+$objPHPExcel->getActiveSheet()->getColumnDimension('G')->setWidth(15);
+
+$total = 0;
+$index = 0;
+foreach($datas as $data) {
+    $i++;
+    $objPHPExcel->getActiveSheet()->SetCellValue('A'.$i, ++$index);
+    $objPHPExcel->getActiveSheet()->SetCellValue('B'.$i, $data["org_name"]);
+    $objPHPExcel->getActiveSheet()->SetCellValue('C'.$i, $data["type_name"]);
+    $objPHPExcel->getActiveSheet()->SetCellValue('D'.$i, $data['name']);
+    $objPHPExcel->getActiveSheet()->SetCellValue('E'.$i, number_format($data['amount'], 2));
+    $objPHPExcel->getActiveSheet()->SetCellValue('F'.$i, !empty($data['invest_date']) ? $this->center_function->ConvertToThaiDate($data['invest_date'], '1', '0')
+                                                                                        : $this->center_function->ConvertToThaiDate($data['start_date'], '1', '0'));
+    $objPHPExcel->getActiveSheet()->SetCellValue('G'.$i, !empty($data['end_date']) ? $this->center_function->ConvertToThaiDate($data['end_date'], '1', '0') : "");
+    $objPHPExcel->getActiveSheet()->getStyle('A'.$i.":G".$i)->applyFromArray($table);
+    $total += $data['amount'];
+}
+
+$i++;
+$objPHPExcel->getActiveSheet()->SetCellValue('A'.$i, "รวม");
+$objPHPExcel->getActiveSheet()->mergeCells('A'.$i.':D'.$i);
+$objPHPExcel->getActiveSheet()->SetCellValue('E'.$i, number_format($total,2));
+$objPHPExcel->getActiveSheet()->SetCellValue('F'.$i, "");
+$objPHPExcel->getActiveSheet()->mergeCells('F'.$i.':G'.$i);
+
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i.":G".$i)->applyFromArray($table);
+
+header('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
+header('Content-Disposition: attachment;filename="สรุปการลงทุน.xlsx"');
+header('Cache-Control: max-age=0');
+
+$objWriter = new PHPExcel_Writer_Excel2007($objPHPExcel);
+$objWriter->save('php://output');
+exit;
+?>
\ No newline at end of file
diff --git a/application/views/invest/report_invest_preview.php b/application/views/invest/report_invest_preview.php
new file mode 100644
index 0000000..b1f63fe
--- /dev/null
+++ b/application/views/invest/report_invest_preview.php
@@ -0,0 +1,160 @@
+<style>
+	.table-view>thead, .table-view>thead>tr>td, .table-view>thead>tr>th {
+		font-size: 14px;
+	}
+	.table-view>tbody>tr>th{
+	    border-top: 1px solid #000 !important;
+		border-bottom: 1px solid #000 !important;
+		font-size: 12px;
+		background-color: #eee;
+	}
+	.table-view-2>tbody>tr>td{
+	    border: 0px !important;
+		/*font-family: upbean;
+		font-size: 16px;*/
+		font-family: Tahoma;
+		font-size: 12px;
+	}	
+	.border-bottom{
+	    border-bottom: 1px solid #000 !important;
+		font-weight: bold;
+	}
+	.table-view-2>tbody>tr>td>span{
+		font-family: Tahoma;
+		font-size: 12px !important;
+	}
+	.foot-border{
+	    border-top: 1px solid #000 !important;
+		border-bottom: double !important;
+		font-weight: bold;
+	}
+	.table {
+		color: #000;
+	}
+	.table>tbody>tr>td, .table>tbody>tr>th, .table>tfoot>tr>td, .table>tfoot>tr>th, .table>thead>tr>td, .table>thead>tr>th {
+		padding:6px;
+	}
+</style>
+<?php
+	$runno = 0;
+	$prev_level = "x";
+	$total = 0;
+	foreach($datas AS $page=>$data){
+?>
+<form action="<?php echo base_url(PROJECTPATH.'/invest/report_invest_preview'); ?>" id="search_form" method="POST" target="_blank">
+	<input type="hidden" name="doc_type" id="doc_type" value="excel"/>
+	<input type="hidden" name="type" id="type" value="<?php echo $_POST['type'];?>"/>
+	<input type="hidden" name="from_date" id="from_date" value="<?php echo $_POST['from_date'];?>"/>
+	<input type="hidden" name="thru_date" id="thru_date" value="<?php echo $_POST['thru_date'];?>"/>
+	<input type="hidden" name="org" id="org" value="<?php echo $_POST['org'];?>"/>
+</form>
+<div style="width: 11.7in;" class="page-break">
+	<div class="panel panel-body" style="padding-top:10px !important;height: 8.3in;">
+		<table style="width: 100%;">
+		<?php 
+			if($page == 1) {
+		?>	
+			<tr>
+				<td style="width:100px;vertical-align: top;">
+
+				</td>
+				<td class="text-center">
+					<img src="<?php echo base_url(PROJECTPATH.'/assets/images/coop_profile/'.$_SESSION['COOP_IMG']); ?>" alt="Logo" style="height: 80px;" />
+					<h3 class="title_view"><?php echo @$_SESSION['COOP_NAME'];?></h3>
+					<h3 class="title_view">รายงานสรุปการลงทุน</h3>
+					<h3 class="title_view">
+					</h3>
+				</td>
+				<td style="width:100px;vertical-align: top;" class="text-right">
+					<a class="no_print" onclick="window.print();"><button class="btn btn-perview btn-after-input" type="button"><span class="icon icon-print" aria-hidden="true"></span></button></a>
+					<a class="no_print"  target="_blank" id="excel-submit">
+						<button class="btn btn-perview btn-after-input" type="button"><span class="icon icon icon-file-excel-o" aria-hidden="true"></span></button>
+					</a>
+				</td>
+			</tr>
+		<?php } ?>
+			<tr>
+				<td colspan="3" style="text-align: right;">
+					<span class="title_view">หน้าที่ <?php echo @$page.'/'.@$page_all;?></span><br>
+				</td>
+			</tr> 
+			<tr>
+				<td colspan="3" style="text-align: right;">
+					<span class="title_view">วันที่ <?php echo $this->center_function->ConvertToThaiDate(@date('Y-m-d'),1,0);?></span>
+				</td>
+			</tr> 
+			<tr>
+				<td colspan="3" style="text-align: right;">
+					<span class="title_view">เวลา <?php echo date('H:i:s');?></span>
+				</td>
+			</tr>
+			<tr>
+				<td colspan="3" style="text-align: right;">
+					<span class="title_view">ผู้ทำรายการ <?php echo $_SESSION['USER_NAME'];?></span>
+				</td>
+			</tr>
+		</table>
+
+		<table class="table table-view table-center">
+			<tbody>
+			<?php
+				$first_of_page = 1;
+				$max = count($data)-1;
+				foreach($data as $key => $row){
+					if(!empty($first_of_page)) {
+			?>
+				<tr>
+					<th style="width: 5%;vertical-align: middle;">ลำดับ</th>
+					<th style="width: 15%;vertical-align: middle;">องค์กร</th>
+					<th style="width: 15%;vertical-align: middle;">หมวดการลงทุน</th>
+					<th style="vertical-align: middle;">หัวข้อการลงทุน</th>
+					<th style="width: 10%;vertical-align: middle;">เงินลงทุน</th>
+					<th style="width: 10%;vertical-align: middle;">วันที่ลงทุน</th>
+					<th style="width: 10%;vertical-align: middle;">วันครบกำหนด</th>
+				</tr>
+			<?php
+					}
+			?>
+				<tr>
+					<td style="text-align: center;vertical-align: top;"><?php echo ++$runno; ?></td>
+					<td style="text-align: left;vertical-align: top;"><?php echo $row['org_name'];?></td>
+					<td style="text-align: left;vertical-align: top;"><?php echo $row['type_name'];?></td>
+					<td style="text-align: left;vertical-align: top;"><?php echo $row['name'];?></td>
+					<td style="text-align: right;vertical-align: top;"><?php echo number_format($row['amount'], 2);?></td>
+					<td style="text-align: center;vertical-align: top;"><?php echo !empty($row['invest_date']) ? $this->center_function->ConvertToThaiDate($row['invest_date'], '1', '0')
+																												 : $this->center_function->ConvertToThaiDate($row['start_date'], '1', '0');?></td>
+					<td style="text-align: center;vertical-align: top;"><?php echo !empty($row['end_date']) ? $this->center_function->ConvertToThaiDate($row['end_date'], '1', '0') : "";?></td>
+				</tr>
+			<?php
+					$first_of_page = 0;
+					$total += $row['amount'];
+					if($max == $key) {
+			?>
+				<tr>
+					<th colspan="4" class="table_body text-right">
+						รวม&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
+					</th>
+					<th class="text-right">
+						<?php echo number_format($total, 2);?>
+					</tthd>
+					<th colspan="3">
+					</th>
+				</tr>
+			<?php
+					}
+				}
+			?>
+			</tbody>
+		</table>
+	</div>
+</div>
+<?php
+	}
+?>
+<script>
+	$(document).ready(function() {
+		$("#excel-submit").click(function() {
+			$("#search_form").submit();
+		});
+	});
+</script>
\ No newline at end of file
diff --git a/application/views/invest/report_maturity.php b/application/views/invest/report_maturity.php
new file mode 100644
index 0000000..645c4c4
--- /dev/null
+++ b/application/views/invest/report_maturity.php
@@ -0,0 +1,92 @@
+<div class="layout-content">
+    <div class="layout-content-body">
+		<style>
+			.modal-header-alert {
+				padding:9px 15px;
+				border:1px solid #FF0033;
+				background-color: #FF0033;
+				color: #fff;
+				-webkit-border-top-left-radius: 5px;
+				-webkit-border-top-right-radius: 5px;
+				-moz-border-radius-topleft: 5px;
+				-moz-border-radius-topright: 5px;
+				border-top-left-radius: 5px;
+				border-top-right-radius: 5px;
+			}
+			.center {
+				text-align: center;
+			}
+			.right {
+				text-align: right;
+			}
+			.modal-dialog-account {
+				margin:auto;
+				margin-top:7%;
+			}
+			label{
+				padding-top:7px;
+			}
+		</style>
+		<h1 style="margin-bottom: 0">ระบบการลงทุน</h1>
+		<?php $this->load->view('breadcrumb'); ?>
+		<div class="row gutter-xs">
+			<div class="col-xs-12 col-md-12">
+				<div class="panel panel-body" style="padding-top:0px !important;" id="search-div">
+					<form action="<?php echo base_url(PROJECTPATH.'/invest/report_maturity_preview'); ?>" id="search_form" method="POST" target="_blank">
+						<input type="hidden" name="doc_type" id="doc_type" value="html"/>
+						<div class="form-group g24-col-sm-24 text-center">
+                            <h3>รายงานใกล้ครบกำหนด</h3>
+						</div>
+						<div class="form-group g24-col-sm-24">
+							<label class="g24-col-sm-10 control-label right"> หมวดการลงทุน </label>
+							<div class="g24-col-sm-5">
+								<div class="input-with-icon">
+									<div class="form-group">
+										<select id="type" name="type" class="form-control m-b-1 js-data-example-ajax">
+                                            <option value="">ทั้งหมด</option>
+                                            <?php 
+                                                foreach($invest_types as $key => $type) {
+                                            ?>
+                                            <option value="<?php echo $type['id']; ?>"><?php echo $type['name'];?></option>
+                                            <?php
+                                                }
+                                            ?>
+                                        </select>
+									</div>
+								</div>
+							</div>
+						</div>
+						<div class="form-group g24-col-sm-24 text-center">
+                            <button class="btn btn-primary btn-after-input" type="button" onclick="check_empty(1)"><span> แสดงรายงาน</span></button>
+						</div>
+					</form>
+				</div>
+			</div>
+		</div>
+	</div>
+</div>
+<script>
+function check_empty(type){
+	$.ajax({
+		 url:base_url+"invest/check_maturity", 
+		 method:"post",
+		 data:$("#search_form").serialize(),
+		 dataType:"text",
+		 success:function(data){
+			if(data == 'success'){
+				if(type == 1) {
+					$("#doc_type").val('html');
+				} else {
+					$("#doc_type").val('excel');
+				}
+				$("#search_form").submit();
+			} else if (data == "no-data") {
+				swal('ไม่พบข้อมูล', '', 'warning');
+			}else{
+				$('#alertNotFindModal').appendTo("body").modal('show');
+			}
+		 }
+	});
+}
+
+</script>
diff --git a/application/views/invest/report_maturity_excel.php b/application/views/invest/report_maturity_excel.php
new file mode 100644
index 0000000..4d701d8
--- /dev/null
+++ b/application/views/invest/report_maturity_excel.php
@@ -0,0 +1,157 @@
+<?php
+$objPHPExcel = new PHPExcel();
+
+$borderRight = array(
+  'borders' => array(
+    'right' => array(
+      'style' => PHPExcel_Style_Border::BORDER_THIN
+    )
+  )
+);
+$borderLeft = array(
+  'borders' => array(
+    'left' => array(
+      'style' => PHPExcel_Style_Border::BORDER_THIN
+    )
+  )
+);
+$borderTop = array(
+  'borders' => array(
+    'top' => array(
+      'style' => PHPExcel_Style_Border::BORDER_THIN
+    )
+  )
+);
+$borderBottom = array(
+  'borders' => array(
+    'bottom' => array(
+      'style' => PHPExcel_Style_Border::BORDER_THIN
+    )
+  )
+);
+$borderBottomDouble = array(
+  'borders' => array(
+    'bottom' => array(
+      'style' => PHPExcel_Style_Border::BORDER_DOUBLE
+    )
+  )
+);
+$styleArray = array(
+  'borders' => array(
+    'allborders' => array(
+      'style' => PHPExcel_Style_Border::BORDER_THIN
+    )
+  ),
+  'font'  => array(
+		'bold'  => false,
+		'size'  => 16,
+		'name'  => 'Cordia New'
+	)
+);
+$textStyleArray = array(
+  'font'  => array(
+		'bold'  => false,
+		'size'  => 16,
+		'name'  => 'Angsana New'
+	)
+);
+$headerStyle = array(
+	'font'  => array(
+		'bold'  => false,
+		'size'  => 16,
+		'name'  => 'Angsana New'
+	)
+);
+$titleStyle = array(
+	'font'  => array(
+		'bold'  => true,
+		'size'  => 18,
+		'name'  => 'TH Sarabun New'
+	)
+);
+$footerStyle = array(
+	'font'  => array(
+		'bold'  => true,
+		'size'  => 14,
+		'name'  => 'AngsanaUPC'
+	)
+);
+$table = array(
+    'borders' => array(
+        'allborders' => array(
+            'style' => PHPExcel_Style_Border::BORDER_THIN
+        )
+    ),
+);
+
+$sheet = 0;
+$i=0;
+$objPHPExcel->createSheet($sheet);
+$objPHPExcel->setActiveSheetIndex($sheet);
+$i+=1;
+$objPHPExcel->getActiveSheet()->mergeCells('A'.$i.':F'.$i);
+$objPHPExcel->getActiveSheet()->SetCellValue('A' . $i , $_SESSION['COOP_NAME']);
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i)->applyFromArray($headerStyle);
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i.':F'.$i)->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
+$i+=1;
+$objPHPExcel->getActiveSheet()->mergeCells('A'.$i.':F'.$i);
+$objPHPExcel->getActiveSheet()->SetCellValue('A' . $i , "รายงานใกล้ครบกำหนด");
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i)->applyFromArray($headerStyle);
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i.':F'.$i)->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
+$i+=1;
+$objPHPExcel->getActiveSheet()->mergeCells('A'.$i.':F'.$i);
+$objPHPExcel->getActiveSheet()->SetCellValue('A' . $i , $this->center_function->ConvertToThaiDate(@date('Y-m-d'),0,0)) ;
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i)->applyFromArray($headerStyle);
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i.':F'.$i)->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_RIGHT);
+$i+=1;
+$objPHPExcel->getActiveSheet()->mergeCells('A'.$i.':F'.$i);
+$objPHPExcel->getActiveSheet()->SetCellValue('A' . $i , "ผู้ทำรายการ ".$_SESSION['USER_NAME']) ;
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i)->applyFromArray($headerStyle);
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i.':F'.$i)->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_RIGHT);
+$i+=1;
+$i_top = $i;
+$objPHPExcel->getActiveSheet()->SetCellValue('A'.$i, "ลำดับ");
+$objPHPExcel->getActiveSheet()->SetCellValue('B'.$i, "องค์กร");
+$objPHPExcel->getActiveSheet()->SetCellValue('C'.$i, "หมวดการลงทุน");
+$objPHPExcel->getActiveSheet()->SetCellValue('D'.$i, "หัวข้อการลงทุน");
+$objPHPExcel->getActiveSheet()->SetCellValue('E'.$i, "เงินลงทุน");
+$objPHPExcel->getActiveSheet()->SetCellValue('F'.$i, "วันครบกำหนด");
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i.":F".$i)->applyFromArray($table);
+
+$objPHPExcel->getActiveSheet()->getColumnDimension('A')->setWidth(10);
+$objPHPExcel->getActiveSheet()->getColumnDimension('B')->setWidth(30);
+$objPHPExcel->getActiveSheet()->getColumnDimension('C')->setWidth(30);
+$objPHPExcel->getActiveSheet()->getColumnDimension('D')->setWidth(50);
+$objPHPExcel->getActiveSheet()->getColumnDimension('E')->setWidth(15);
+$objPHPExcel->getActiveSheet()->getColumnDimension('F')->setWidth(15);
+
+$total = 0;
+$index = 0;
+foreach($datas as $data) {
+    $i++;
+    $objPHPExcel->getActiveSheet()->SetCellValue('A'.$i, ++$index);
+    $objPHPExcel->getActiveSheet()->SetCellValue('B'.$i, $data["org_name"]);
+    $objPHPExcel->getActiveSheet()->SetCellValue('C'.$i, $data["type_name"]);
+    $objPHPExcel->getActiveSheet()->SetCellValue('D'.$i, $data['name']);
+    $objPHPExcel->getActiveSheet()->SetCellValue('E'.$i, number_format($data['amount'], 2));
+    $objPHPExcel->getActiveSheet()->SetCellValue('F'.$i, !empty($data['end_date']) ? $this->center_function->ConvertToThaiDate($data['end_date'], '1', '0') : "");
+    $objPHPExcel->getActiveSheet()->getStyle('A'.$i.":F".$i)->applyFromArray($table);
+    $total += $data['amount'];
+}
+
+$i++;
+$objPHPExcel->getActiveSheet()->SetCellValue('A'.$i, "รวม");
+$objPHPExcel->getActiveSheet()->mergeCells('A'.$i.':D'.$i);
+$objPHPExcel->getActiveSheet()->SetCellValue('E'.$i, number_format($total,2));
+$objPHPExcel->getActiveSheet()->SetCellValue('F'.$i, "");
+
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i.":F".$i)->applyFromArray($table);
+
+header('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
+header('Content-Disposition: attachment;filename="ใกล้ครบกำหนด.xlsx"');
+header('Cache-Control: max-age=0');
+
+$objWriter = new PHPExcel_Writer_Excel2007($objPHPExcel);
+$objWriter->save('php://output');
+exit;
+?>
\ No newline at end of file
diff --git a/application/views/invest/report_maturity_preview.php b/application/views/invest/report_maturity_preview.php
new file mode 100644
index 0000000..3faa227
--- /dev/null
+++ b/application/views/invest/report_maturity_preview.php
@@ -0,0 +1,154 @@
+<style>
+	.table-view>thead, .table-view>thead>tr>td, .table-view>thead>tr>th {
+		font-size: 14px;
+	}
+	.table-view>tbody>tr>th{
+	    border-top: 1px solid #000 !important;
+		border-bottom: 1px solid #000 !important;
+		font-size: 12px;
+		background-color: #eee;
+	}
+	.table-view-2>tbody>tr>td{
+	    border: 0px !important;
+		/*font-family: upbean;
+		font-size: 16px;*/
+		font-family: Tahoma;
+		font-size: 12px;
+	}	
+	.border-bottom{
+	    border-bottom: 1px solid #000 !important;
+		font-weight: bold;
+	}
+	.table-view-2>tbody>tr>td>span{
+		font-family: Tahoma;
+		font-size: 12px !important;
+	}
+	.foot-border{
+	    border-top: 1px solid #000 !important;
+		border-bottom: double !important;
+		font-weight: bold;
+	}
+	.table {
+		color: #000;
+	}
+	.table>tbody>tr>td, .table>tbody>tr>th, .table>tfoot>tr>td, .table>tfoot>tr>th, .table>thead>tr>td, .table>thead>tr>th {
+		padding:6px;
+	}
+</style>
+<?php
+	$runno = 0;
+	$prev_level = "x";
+	$total = 0;
+	foreach($datas AS $page=>$data){
+?>
+<form action="<?php echo base_url(PROJECTPATH.'/invest/report_maturity_preview'); ?>" id="search_form" method="POST" target="_blank">
+	<input type="hidden" name="doc_type" id="doc_type" value="excel"/>
+	<input type="hidden" name="type" id="type" value="<?php echo $_POST['type'];?>"/>
+</form>
+<div style="width: 11.7in;" class="page-break">
+	<div class="panel panel-body" style="padding-top:10px !important;height: 8.3in;">
+		<table style="width: 100%;">
+		<?php 
+			if($page == 1) {
+		?>	
+			<tr>
+				<td style="width:100px;vertical-align: top;">
+
+				</td>
+				<td class="text-center">
+					<img src="<?php echo base_url(PROJECTPATH.'/assets/images/coop_profile/'.$_SESSION['COOP_IMG']); ?>" alt="Logo" style="height: 80px;" />
+					<h3 class="title_view"><?php echo @$_SESSION['COOP_NAME'];?></h3>
+					<h3 class="title_view">รายงานใกล้ครบกำหนด</h3>
+					<h3 class="title_view">
+					</h3>
+				</td>
+				<td style="width:100px;vertical-align: top;" class="text-right">
+					<a class="no_print" onclick="window.print();"><button class="btn btn-perview btn-after-input" type="button"><span class="icon icon-print" aria-hidden="true"></span></button></a>
+					<a class="no_print"  target="_blank" id="excel-submit">
+						<button class="btn btn-perview btn-after-input" type="button"><span class="icon icon icon-file-excel-o" aria-hidden="true"></span></button>
+					</a>
+				</td>
+			</tr>
+		<?php } ?>
+			<tr>
+				<td colspan="3" style="text-align: right;">
+					<span class="title_view">หน้าที่ <?php echo @$page.'/'.@$page_all;?></span><br>
+				</td>
+			</tr> 
+			<tr>
+				<td colspan="3" style="text-align: right;">
+					<span class="title_view">วันที่ <?php echo $this->center_function->ConvertToThaiDate(@date('Y-m-d'),1,0);?></span>
+				</td>
+			</tr> 
+			<tr>
+				<td colspan="3" style="text-align: right;">
+					<span class="title_view">เวลา <?php echo date('H:i:s');?></span>
+				</td>
+			</tr>
+			<tr>
+				<td colspan="3" style="text-align: right;">
+					<span class="title_view">ผู้ทำรายการ <?php echo $_SESSION['USER_NAME'];?></span>
+				</td>
+			</tr>
+		</table>
+
+		<table class="table table-view table-center">
+			<tbody>
+			<?php
+				$first_of_page = 1;
+				$max = count($data)-1;
+				foreach($data as $key => $row){
+					if(!empty($first_of_page)) {
+			?>
+				<tr>
+					<th style="width: 5%;vertical-align: middle;">ลำดับ</th>
+					<th style="width: 18%;vertical-align: middle;">องค์กร</th>
+					<th style="width: 18%;vertical-align: middle;">หมวดการลงทุน</th>
+					<th style="vertical-align: middle;">หัวข้อการลงทุน</th>
+					<th style="width: 10%;vertical-align: middle;">เงินลงทุน</th>
+					<th style="width: 10%;vertical-align: middle;">วันครบกำหนด</th>
+				</tr>
+			<?php
+					}
+			?>
+				<tr>
+					<td style="text-align: center;vertical-align: top;"><?php echo ++$runno; ?></td>
+					<td style="text-align: left;vertical-align: top;"><?php echo $row['org_name'];?></td>
+					<td style="text-align: left;vertical-align: top;"><?php echo $row['type_name'];?></td>
+					<td style="text-align: left;vertical-align: top;"><?php echo $row['name'];?></td>
+					<td style="text-align: right;vertical-align: top;"><?php echo number_format($row['amount'], 2);?></td>
+					<td style="text-align: center;vertical-align: top;"><?php echo !empty($row['end_date']) ? $this->center_function->ConvertToThaiDate($row['end_date'], '1', '0') : "";?></td>
+				</tr>
+			<?php
+					$first_of_page = 0;
+					$total += $row['amount'];
+					if($max == $key) {
+			?>
+				<tr>
+					<th colspan="3" class="table_body text-right">
+						รวม&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
+					</th>
+					<th class="text-right">
+						<?php echo number_format($total, 2);?>
+					</tthd>
+					<th colspan="2">
+					</th>
+				</tr>
+			<?php
+					}
+				}
+			?>
+			</tbody>
+		</table>
+	</div>
+</div>
+<?php
+	}
+?>
+<script>
+	$(document).ready(function() {
+		$("#excel-submit").click(function() {
+			$("#search_form").submit();
+		});
+	});
+</script>
\ No newline at end of file
diff --git a/application/views/invest/report_profit_dividend.php b/application/views/invest/report_profit_dividend.php
new file mode 100644
index 0000000..c8bdced
--- /dev/null
+++ b/application/views/invest/report_profit_dividend.php
@@ -0,0 +1,139 @@
+<div class="layout-content">
+    <div class="layout-content-body">
+		<style>
+			.modal-header-alert {
+				padding:9px 15px;
+				border:1px solid #FF0033;
+				background-color: #FF0033;
+				color: #fff;
+				-webkit-border-top-left-radius: 5px;
+				-webkit-border-top-right-radius: 5px;
+				-moz-border-radius-topleft: 5px;
+				-moz-border-radius-topright: 5px;
+				border-top-left-radius: 5px;
+				border-top-right-radius: 5px;
+			}
+			.center {
+				text-align: center;
+			}
+			.right {
+				text-align: right;
+			}
+			.modal-dialog-account {
+				margin:auto;
+				margin-top:7%;
+			}
+			label{
+				padding-top:7px;
+			}
+		</style>
+		<h1 style="margin-bottom: 0">ระบบการลงทุน</h1>
+		<?php $this->load->view('breadcrumb'); ?>
+		<div class="row gutter-xs">
+			<div class="col-xs-12 col-md-12">
+				<div class="panel panel-body" style="padding-top:0px !important;" id="search-div">
+					<form action="<?php echo base_url(PROJECTPATH.'/invest/report_profit_dividend_preview'); ?>" id="search_form" method="POST" target="_blank">
+						<input type="hidden" name="doc_type" id="doc_type" value="html"/>
+						<div class="form-group g24-col-sm-24 text-center">
+                            <h3>รายงานสรุปปันผล</h3>
+						</div>
+						<div class="form-group g24-col-sm-24">
+							<label class="g24-col-sm-7 control-label right"> วันที่ </label>
+							<div class="g24-col-sm-4">
+								<div class="input-with-icon">
+									<div class="form-group">
+										<input id="from_date" name="from_date" class="form-control m-b-1 mydate" style="padding-left: 50px;" type="text" value="<?php echo $this->center_function->mydate2date(date('Y-m-d')); ?>" data-date-language="th-th">
+										<span class="icon icon-calendar input-icon m-f-1"></span>
+									</div>
+								</div>
+							</div>
+							<label class="g24-col-sm-2 control-label right"> ถึงวันที่ </label>
+							<div class="g24-col-sm-4">
+								<div class="input-with-icon">
+									<div class="form-group">
+										<input id="thru_date" name="thru_date" class="form-control m-b-1 mydate" style="padding-left: 50px;" type="text" value="<?php echo $this->center_function->mydate2date(date('Y-m-d')); ?>" data-date-language="th-th">
+										<span class="icon icon-calendar input-icon m-f-1"></span>
+									</div>
+								</div>
+							</div>
+						</div>
+						<div class="form-group g24-col-sm-24">
+							<label class="g24-col-sm-7 control-label right"> องค์กร </label>
+							<div class="g24-col-sm-4">
+								<div class="input-with-icon">
+									<div class="form-group">
+										<select id="org" name="org" class="form-control m-b-1 js-data-example-ajax">
+                                            <option value="">ทั้งหมด</option>
+                                            <?php 
+                                                foreach($orgs as $key => $org) {
+                                            ?>
+                                            <option value="<?php echo $org['id']; ?>"><?php echo $org['name'];?></option>
+                                            <?php
+                                                }
+                                            ?>
+                                        </select>
+									</div>
+								</div>
+							</div>
+						</div>
+						<div class="form-group g24-col-sm-24">
+							<label class="g24-col-sm-7 control-label right"> หมวดการลงทุน </label>
+							<div class="g24-col-sm-4">
+								<div class="input-with-icon">
+									<div class="form-group">
+										<select id="type" name="type" class="form-control m-b-1 js-data-example-ajax">
+                                            <option value="">ทั้งหมด</option>
+                                            <?php 
+                                                foreach($invest_types as $key => $type) {
+                                            ?>
+                                            <option value="<?php echo $type['id']; ?>"><?php echo $type['name'];?></option>
+                                            <?php
+                                                }
+                                            ?>
+                                        </select>
+									</div>
+								</div>
+							</div>
+						</div>
+						<div class="form-group g24-col-sm-24 text-center">
+                            <button class="btn btn-primary btn-after-input" type="button" onclick="check_empty(1)"><span> แสดงรายงาน</span></button>
+						</div>
+					</form>
+				</div>
+			</div>
+		</div>
+	</div>
+</div>
+<?php
+	$v = date('YmdHis');
+	$link = array(
+		'src' => PROJECTJSPATH.'assets/js/invest_report.js?v='.$v,
+		'type' => 'text/javascript'
+	);
+	echo script_tag($link);
+?>
+<script>
+function check_empty(type){
+	$.ajax({
+		 url:base_url+"invest/check_report_profit_dividend", 
+		 method:"post",
+		 data:$("#search_form").serialize(),
+		 dataType:"text",
+		 success:function(data){
+			if(data == 'success'){
+				if(type == 1) {
+					$("#doc_type").val('html');
+				} else {
+					$("#doc_type").val('excel');
+				}
+				$("#search_form").submit();
+			} else if (data == "no-data") {
+				swal('ไม่พบข้อมูล', '', 'warning');
+			}else{
+				$('#alertNotFindModal').appendTo("body").modal('show');
+			}
+		 }
+	});
+}
+
+</script>
diff --git a/application/views/invest/report_profit_dividend_excel.php b/application/views/invest/report_profit_dividend_excel.php
new file mode 100644
index 0000000..267c8e2
--- /dev/null
+++ b/application/views/invest/report_profit_dividend_excel.php
@@ -0,0 +1,188 @@
+<?php
+$objPHPExcel = new PHPExcel();
+
+$borderRight = array(
+  'borders' => array(
+    'right' => array(
+      'style' => PHPExcel_Style_Border::BORDER_THIN
+    )
+  )
+);
+$borderLeft = array(
+  'borders' => array(
+    'left' => array(
+      'style' => PHPExcel_Style_Border::BORDER_THIN
+    )
+  )
+);
+$borderTop = array(
+  'borders' => array(
+    'top' => array(
+      'style' => PHPExcel_Style_Border::BORDER_THIN
+    )
+  )
+);
+$borderBottom = array(
+  'borders' => array(
+    'bottom' => array(
+      'style' => PHPExcel_Style_Border::BORDER_THIN
+    )
+  )
+);
+$borderBottomDouble = array(
+  'borders' => array(
+    'bottom' => array(
+      'style' => PHPExcel_Style_Border::BORDER_DOUBLE
+    )
+  )
+);
+$styleArray = array(
+  'borders' => array(
+    'allborders' => array(
+      'style' => PHPExcel_Style_Border::BORDER_THIN
+    )
+  ),
+  'font'  => array(
+		'bold'  => false,
+		'size'  => 16,
+		'name'  => 'Cordia New'
+	)
+);
+$textStyleArray = array(
+  'font'  => array(
+		'bold'  => false,
+		'size'  => 16,
+		'name'  => 'Angsana New'
+	)
+);
+$headerStyle = array(
+	'font'  => array(
+		'bold'  => false,
+		'size'  => 16,
+		'name'  => 'Angsana New'
+	)
+);
+$titleStyle = array(
+	'font'  => array(
+		'bold'  => true,
+		'size'  => 18,
+		'name'  => 'TH Sarabun New'
+	)
+);
+$footerStyle = array(
+	'font'  => array(
+		'bold'  => true,
+		'size'  => 14,
+		'name'  => 'AngsanaUPC'
+	)
+);
+$table = array(
+    'borders' => array(
+        'allborders' => array(
+            'style' => PHPExcel_Style_Border::BORDER_THIN
+        )
+    ),
+);
+
+$sheet = 0;
+$i=0;
+$objPHPExcel->createSheet($sheet);
+$objPHPExcel->setActiveSheetIndex($sheet);
+$i+=1;
+$objPHPExcel->getActiveSheet()->mergeCells('A'.$i.':E'.$i);
+$objPHPExcel->getActiveSheet()->SetCellValue('A' . $i , $_SESSION['COOP_NAME']);
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i)->applyFromArray($headerStyle);
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i.':E'.$i)->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
+$i+=1;
+$objPHPExcel->getActiveSheet()->mergeCells('A'.$i.':E'.$i);
+$objPHPExcel->getActiveSheet()->SetCellValue('A' . $i , "รายงานสรุปปันผล");
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i)->applyFromArray($headerStyle);
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i.':E'.$i)->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
+$i+=1;
+$objPHPExcel->getActiveSheet()->mergeCells('A'.$i.':E'.$i);
+$objPHPExcel->getActiveSheet()->SetCellValue('A' . $i , $this->center_function->ConvertToThaiDate(@date('Y-m-d'),0,0)) ;
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i)->applyFromArray($headerStyle);
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i.':E'.$i)->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_RIGHT);
+$i+=1;
+$objPHPExcel->getActiveSheet()->mergeCells('A'.$i.':E'.$i);
+$objPHPExcel->getActiveSheet()->SetCellValue('A' . $i , "ผู้ทำรายการ ".$_SESSION['USER_NAME']) ;
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i)->applyFromArray($headerStyle);
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i.':E'.$i)->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_RIGHT);
+$i+=1;
+
+$objPHPExcel->getActiveSheet()->getColumnDimension('A')->setWidth(8);
+$objPHPExcel->getActiveSheet()->getColumnDimension('B')->setWidth(30);
+$objPHPExcel->getActiveSheet()->getColumnDimension('C')->setWidth(50);
+$objPHPExcel->getActiveSheet()->getColumnDimension('D')->setWidth(15);
+$objPHPExcel->getActiveSheet()->getColumnDimension('E')->setWidth(15);
+
+$total = 0;
+$prev_id = "x";
+foreach($datas as $index => $data) {
+    if($prev_id != $data['id']) {
+		$total_id = 0;
+		$run_no = 0;
+		$prev_id = $data['id'];
+		$i+=2;
+		$objPHPExcel->getActiveSheet()->mergeCells('A'.$i.':E'.$i);
+		$objPHPExcel->getActiveSheet()->SetCellValue('A' . $i ,$data['type_name']." : ".$data['name']);
+		$objPHPExcel->getActiveSheet()->getStyle('A'.$i.":E".$i)->applyFromArray($headerStyle);
+
+		$i++;
+		$objPHPExcel->getActiveSheet()->SetCellValue('B'.$i, "จำนวนเงิน : ".number_format($data['amount'],2));
+		$objPHPExcel->getActiveSheet()->SetCellValue('C'.$i, "วันที่ลงทุน : ".$this->center_function->ConvertToThaiDate($data['start_date'], '1', '0'));
+		$objPHPExcel->getActiveSheet()->getStyle('A'.$i.":E".$i)->applyFromArray($headerStyle);
+
+		$i++;
+		$objPHPExcel->getActiveSheet()->SetCellValue('B'.$i, "รอบบัญชี : ".$data['period']);
+		$objPHPExcel->getActiveSheet()->SetCellValue('C'.$i, "องค์กร : ".$data['org_name']);
+		$objPHPExcel->getActiveSheet()->getStyle('A'.$i.":E".$i)->applyFromArray($headerStyle);
+
+		$i++;
+		$objPHPExcel->getActiveSheet()->SetCellValue('B'.$i, "สถานะ : ".($data['status'] == 1 && strtotime($data['end_date']) >= strtotime(date("Y-m-d")) ? "ปกติ" : "ไม่เปิดใช้งาน"));
+		$objPHPExcel->getActiveSheet()->getStyle('A'.$i.":E".$i)->applyFromArray($headerStyle);
+
+		$i++;
+		$objPHPExcel->getActiveSheet()->SetCellValue('A'.$i, "ลำดับ");
+		$objPHPExcel->getActiveSheet()->SetCellValue('B'.$i, "วันที่ได้รับปันผล");
+		$objPHPExcel->getActiveSheet()->SetCellValue('C'.$i, "ปันผล");
+		$objPHPExcel->getActiveSheet()->SetCellValue('D'.$i, "จำนวนเงิน");
+		$objPHPExcel->getActiveSheet()->SetCellValue('E'.$i, "หมายเหตุ");
+		$objPHPExcel->getActiveSheet()->getStyle('A'.$i.":E".$i)->applyFromArray($table);
+	}
+    $i++;
+    $objPHPExcel->getActiveSheet()->SetCellValue('A'.$i, ++$run_no);
+    $objPHPExcel->getActiveSheet()->SetCellValue('B'.$i, $this->center_function->ConvertToThaiDate($data['interest_date'], '1', '0'));
+    $objPHPExcel->getActiveSheet()->SetCellValue('C'.$i, $data['rate']."%");
+    $objPHPExcel->getActiveSheet()->SetCellValue('D'.$i, number_format($data['interest_amount'], 2));
+    $objPHPExcel->getActiveSheet()->SetCellValue('E'.$i, $data['note']);
+    $objPHPExcel->getActiveSheet()->getStyle('A'.$i.":E".$i)->applyFromArray($table);
+	$total += $data['interest_amount'];
+	$total_id += $data['interest_amount'];
+	if(empty($datas[($index + 1)]) || $datas[($index + 1)]['id'] != $data['id']) {
+		$objPHPExcel->getActiveSheet()->SetCellValue('A'.$i, "");
+		$objPHPExcel->getActiveSheet()->SetCellValue('B'.$i, "");
+		$objPHPExcel->getActiveSheet()->SetCellValue('C'.$i, "รวม");
+		$objPHPExcel->getActiveSheet()->SetCellValue('D'.$i, number_format($total_id, 2));
+		$objPHPExcel->getActiveSheet()->SetCellValue('E'.$i, "");
+		$objPHPExcel->getActiveSheet()->getStyle('A'.$i.":E".$i)->applyFromArray($table);
+	}
+}
+
+$i++;
+$objPHPExcel->getActiveSheet()->SetCellValue('C'.$i, "รวมทั้งหมด");
+// $objPHPExcel->getActiveSheet()->mergeCells('A'.$i.':C'.$i);
+$objPHPExcel->getActiveSheet()->SetCellValue('D'.$i, number_format($total,2));
+$objPHPExcel->getActiveSheet()->SetCellValue('E'.$i, "");
+$objPHPExcel->getActiveSheet()->mergeCells('E'.$i.':F'.$i);
+
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i.":E".$i)->applyFromArray($headerStyle);
+
+header('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
+header('Content-Disposition: attachment;filename="สรุปปันผล.xlsx"');
+header('Cache-Control: max-age=0');
+
+$objWriter = new PHPExcel_Writer_Excel2007($objPHPExcel);
+$objWriter->save('php://output');
+exit;
+?>
\ No newline at end of file
diff --git a/application/views/invest/report_profit_dividend_preview.php b/application/views/invest/report_profit_dividend_preview.php
new file mode 100644
index 0000000..95d5e4a
--- /dev/null
+++ b/application/views/invest/report_profit_dividend_preview.php
@@ -0,0 +1,240 @@
+<style>
+	.table-view>thead, .table-view>thead>tr>td, .table-view>thead>tr>th {
+		font-size: 14px;
+	}
+	.table-view>tbody>tr>th{
+	    border-top: 1px solid #000 !important;
+		border-bottom: 1px solid #000 !important;
+		font-size: 12px;
+		background-color: #eee;
+	}
+	.table-view-2>tbody>tr>td{
+	    border: 0px !important;
+		/*font-family: upbean;
+		font-size: 16px;*/
+		font-family: Tahoma;
+		font-size: 12px;
+	}	
+	.border-bottom{
+	    border-bottom: 1px solid #000 !important;
+		font-weight: bold;
+	}
+	.table-view-2>tbody>tr>td>span{
+		font-family: Tahoma;
+		font-size: 12px !important;
+	}
+	.foot-border{
+	    border-top: 1px solid #000 !important;
+		border-bottom: double !important;
+		font-weight: bold;
+	}
+	.table {
+		color: #000;
+	}
+	.table>tbody>tr>td, .table>tbody>tr>th, .table>tfoot>tr>td, .table>tfoot>tr>th, .table>thead>tr>td, .table>thead>tr>th {
+		padding:6px;
+	}
+</style>
+<form action="<?php echo base_url(PROJECTPATH.'/invest/report_profit_dividend_preview'); ?>" id="search_form" method="POST" target="_blank">
+	<input type="hidden" name="doc_type" id="doc_type" value="excel"/>
+	<input type="hidden" name="type" id="type" value="<?php echo $_POST['type'];?>"/>
+	<input type="hidden" name="from_date" id="from_date" value="<?php echo $_POST['from_date'];?>"/>
+	<input type="hidden" name="thru_date" id="thru_date" value="<?php echo $_POST['thru_date'];?>"/>
+	<input type="hidden" name="org" id="org" value="<?php echo $_POST['org'];?>"/>
+</form>
+<?php
+	$runno = 0;
+	$total = 0;
+	$id_total = 0;//total for each id.
+	// $index = 0;
+	$line_count = 0;
+	$prev_id = "x";
+	$page = 1;
+	foreach($datas AS $index => $data){
+?>
+<?php
+	if($index == 0) {
+?>	
+<div style="width: 8.3in;" class="page-break">
+	<div class="panel panel-body" style="padding-top:10px !important;height: 11.7in;">
+		<table style="width: 100%;">
+			<tr>
+				<td style="width:100px;vertical-align: top;">
+
+				</td>
+				<td class="text-center">
+					<img src="<?php echo base_url(PROJECTPATH.'/assets/images/coop_profile/'.$_SESSION['COOP_IMG']); ?>" alt="Logo" style="height: 80px;" />
+					<h3 class="title_view"><?php echo @$_SESSION['COOP_NAME'];?></h3>
+					<h3 class="title_view">รายงานสรุปปันผล</h3>
+					<h3 class="title_view">
+					</h3>
+				</td>
+				<td style="width:100px;vertical-align: top;" class="text-right">
+					<a class="no_print" onclick="window.print();"><button class="btn btn-perview btn-after-input" type="button"><span class="icon icon-print" aria-hidden="true"></span></button></a>
+					<a class="no_print"  target="_blank" id="excel-submit">
+						<button class="btn btn-perview btn-after-input" type="button"><span class="icon icon icon-file-excel-o" aria-hidden="true"></span></button>
+					</a>
+				</td>
+			</tr>
+	<?php
+			$line_count += 150;
+		}
+		if($index == 0 || $line_count > 900 || ($line_count > 800  && $prev_id != $data['id'])) {
+			if($index != 0) {
+				$line_count = 0;
+	?>
+<div style="width: 8.3in;" class="page-break">
+	<div class="panel panel-body" style="padding-top:10px !important;height: 11.7in;">
+		<table style="width: 100%;">
+	<?php
+			}
+	?>
+			<tr>
+				<td colspan="3" style="text-align: right;">
+					<span class="title_view">หน้าที่ <?php echo @$page++;?></span><br>
+				</td>
+			</tr> 
+			<tr>
+				<td colspan="3" style="text-align: right;">
+					<span class="title_view">วันที่ <?php echo $this->center_function->ConvertToThaiDate(@date('Y-m-d'),1,0);?></span>
+				</td>
+			</tr> 
+			<tr>
+				<td colspan="3" style="text-align: right;">
+					<span class="title_view">เวลา <?php echo date('H:i:s');?></span>
+				</td>
+			</tr>
+			<tr>
+				<td colspan="3" style="text-align: right;">
+					<span class="title_view">ผู้ทำรายการ <?php echo $_SESSION['USER_NAME'];?></span>
+				</td>
+			</tr>
+		</table>
+	<?php
+			$line_count += 80;
+			$str_f = 1;
+		} else {
+			$str_f = 0;
+		}
+
+		if($prev_id != $data['id']) {
+			$prev_id = $data['id'];
+			$runno = 0;
+			
+	?>
+		<table class="table" style="<?php echo $index != 0 && $str_f == 0 ? 'margin-top: 80px;' : '';?> width:90%; margin-bottom: 10px;">
+			<tbody>
+				<tr>
+					<th colspan="4" style="border: unset;" class="text-left">
+					<?php echo $data['type_name']." : ".$data['name']?>
+					</th>
+				</tr>
+				<tr>
+					<th style="border: unset;width: 50%;" class="text-left">
+						จำนวนเงิน : <?php echo number_format($data['amount'],2);?>
+					</th>
+					<th style="border: unset;width: 50%;" class="text-left">
+						วันที่ลงทุน : <?php echo $this->center_function->ConvertToThaiDate($data['start_date'], '1', '0');?>
+					</th>
+				</tr>
+				<tr>
+					<th style="border: unset;" class="text-left">
+						รอบบัญชี : <?php echo $data['period'];?>
+					</th>
+					<th style="border: unset;" class="text-left">
+						องค์กร : <?php echo $data['org_name'];?>
+					</th>
+				</tr>
+				<tr>
+					<th style="border: unset;" class="text-left">
+						สถานะ : <?php echo $data['status'] == 1 ? "ปกติ" : "ไม่เปิดใช้งาน";?>
+					</th>
+					<th style="border: unset;" class="text-left">
+					</th>
+				</tr>
+			</tbody>
+		</table>
+	<?php
+			$str_f = 1;
+			$line_count += 190;
+		}
+
+		if($str_f == 1) {
+	?>
+
+		<table class="table table-view table-center" style="width:80%">
+			<tbody>
+				<tr>
+					<th style="width: 11%;vertical-align: middle;">ลำดับ</th>
+					<th style="width: 20%;vertical-align: middle;">วันที่ได้รับปันผล</th>
+					<th style="width: 12%;vertical-align: middle;">ปันผล</th>
+					<th style="width: 15%;vertical-align: middle;">จำนวนเงิน</th>
+					<th style="vertical-align: middle;">หมายเหตุ</th>
+				</tr>
+	<?php
+			$line_count += 20;
+		}
+	?>
+				<tr>
+					<td style="text-align: center;vertical-align: top;"><?php echo ++$runno; ?></td>
+					<td style="text-align: center;vertical-align: top;"><?php echo $this->center_function->ConvertToThaiDate($data['interest_date'], '1', '0');?></td>
+					<td style="text-align: right;vertical-align: top;"><?php echo $data['rate']."%";?></td>
+					<td style="text-align: right;vertical-align: top;"><?php echo number_format($data['interest_amount'], 2);?></td>
+					<td style="text-align: left;vertical-align: top;"><?php echo $data['note'];?></td>
+				</tr>
+			<?php
+					$line_count += 20;
+					$first_of_page = 0;
+					$total += $data['interest_amount'];
+					$id_total += $data['interest_amount'];
+					if(empty($datas[($index+1)]) || $datas[($index+1)]['id'] != $data['id']) {
+			?>
+				<tr>
+					<th colspan="3" class="table_body text-right">
+						รวม&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
+					</th>
+					<th class="text-right">
+						<?php echo number_format($id_total, 2);?>
+					</tthd>
+					<th colspan="1">
+					</th>
+				</tr>
+			<?php
+						$id_total = 0;
+					}
+	if($line_count > 900 || $index == $max || ($line_count > 800  && $datas[($index+1)]['id'] != $data['id'])) {
+?>
+			</tbody>
+		</table>
+<?php
+		if($index == $max) {
+?>
+		<table class="table" style="width:80%; margin-top: 10px;">
+			<tbody>
+				<tr>
+					<th style="width: 11%;vertical-align: middle;"></th>
+					<th style="width: 20%;vertical-align: middle;"></th>
+					<th style="width: 12%;vertical-align: middle;" class="text-right">รวมทั้งสิ้น</th>
+					<th style="width: 15%;vertical-align: middle;" class="text-right"><?php echo number_format($total, 2);?></th>
+					<th style="vertical-align: middle;"></th>
+				</tr>
+			</tbody>
+		</table>
+<?php
+		}
+?>
+	</div>
+</div>
+<?php
+	} 
+?>
+<?php
+	}
+?>
+<script>
+	$(document).ready(function() {
+		$("#excel-submit").click(function() {
+			$("#search_form").submit();
+		});
+	});
+</script>
\ No newline at end of file
diff --git a/application/views/invest/report_profit_interest.php b/application/views/invest/report_profit_interest.php
new file mode 100644
index 0000000..7d5547a
--- /dev/null
+++ b/application/views/invest/report_profit_interest.php
@@ -0,0 +1,138 @@
+<div class="layout-content">
+    <div class="layout-content-body">
+		<style>
+			.modal-header-alert {
+				padding:9px 15px;
+				border:1px solid #FF0033;
+				background-color: #FF0033;
+				color: #fff;
+				-webkit-border-top-left-radius: 5px;
+				-webkit-border-top-right-radius: 5px;
+				-moz-border-radius-topleft: 5px;
+				-moz-border-radius-topright: 5px;
+				border-top-left-radius: 5px;
+				border-top-right-radius: 5px;
+			}
+			.center {
+				text-align: center;
+			}
+			.right {
+				text-align: right;
+			}
+			.modal-dialog-account {
+				margin:auto;
+				margin-top:7%;
+			}
+			label{
+				padding-top:7px;
+			}
+		</style>
+		<h1 style="margin-bottom: 0">ระบบการลงทุน</h1>
+		<?php $this->load->view('breadcrumb'); ?>
+		<div class="row gutter-xs">
+			<div class="col-xs-12 col-md-12">
+				<div class="panel panel-body" style="padding-top:0px !important;" id="search-div">
+					<form action="<?php echo base_url(PROJECTPATH.'/invest/report_profit_interest_preview'); ?>" id="search_form" method="POST" target="_blank">
+						<input type="hidden" name="doc_type" id="doc_type" value="html"/>
+						<div class="form-group g24-col-sm-24 text-center">
+                            <h3>รายงานสรุปดอกเบี้ย</h3>
+						</div>
+						<div class="form-group g24-col-sm-24">
+							<label class="g24-col-sm-7 control-label right"> วันที่ </label>
+							<div class="g24-col-sm-4">
+								<div class="input-with-icon">
+									<div class="form-group">
+										<input id="from_date" name="from_date" class="form-control m-b-1 mydate" style="padding-left: 50px;" type="text" value="<?php echo $this->center_function->mydate2date(date('Y-m-d')); ?>" data-date-language="th-th">
+										<span class="icon icon-calendar input-icon m-f-1"></span>
+									</div>
+								</div>
+							</div>
+							<label class="g24-col-sm-2 control-label right"> ถึงวันที่ </label>
+							<div class="g24-col-sm-4">
+								<div class="input-with-icon">
+									<div class="form-group">
+										<input id="thru_date" name="thru_date" class="form-control m-b-1 mydate" style="padding-left: 50px;" type="text" value="<?php echo $this->center_function->mydate2date(date('Y-m-d')); ?>" data-date-language="th-th">
+										<span class="icon icon-calendar input-icon m-f-1"></span>
+									</div>
+								</div>
+							</div>
+						</div>
+						<div class="form-group g24-col-sm-24">
+							<label class="g24-col-sm-7 control-label right"> องค์กร </label>
+							<div class="g24-col-sm-4">
+								<div class="input-with-icon">
+									<div class="form-group">
+										<select id="org" name="org" class="form-control m-b-1 js-data-example-ajax">
+                                            <option value="">ทั้งหมด</option>
+                                            <?php 
+                                                foreach($orgs as $key => $org) {
+                                            ?>
+                                            <option value="<?php echo $org['id']; ?>"><?php echo $org['name'];?></option>
+                                            <?php
+                                                }
+                                            ?>
+                                        </select>
+									</div>
+								</div>
+							</div>
+						</div>
+						<div class="form-group g24-col-sm-24">
+							<label class="g24-col-sm-7 control-label right"> หมวดการลงทุน </label>
+							<div class="g24-col-sm-4">
+								<div class="input-with-icon">
+									<div class="form-group">
+										<select id="type" name="type" class="form-control m-b-1 js-data-example-ajax">
+                                            <option value="">ทั้งหมด</option>
+                                            <?php 
+                                                foreach($invest_types as $key => $type) {
+                                            ?>
+                                            <option value="<?php echo $type['id']; ?>"><?php echo $type['name'];?></option>
+                                            <?php
+                                                }
+                                            ?>
+                                        </select>
+									</div>
+								</div>
+							</div>
+						</div>
+						<div class="form-group g24-col-sm-24 text-center">
+                            <button class="btn btn-primary btn-after-input" type="button" onclick="check_empty(1)"><span> แสดงรายงาน</span></button>
+						</div>
+					</form>
+				</div>
+			</div>
+		</div>
+	</div>
+</div>
+<?php
+	$v = date('YmdHis');
+	$link = array(
+		'src' => PROJECTJSPATH.'assets/js/invest_report.js?v='.$v,
+		'type' => 'text/javascript'
+	);
+	echo script_tag($link);
+?>
+<script>
+	function check_empty(type){
+		$.ajax({
+			url:base_url+"invest/check_report_profit_interest", 
+			method:"post",
+			data:$("#search_form").serialize(),
+			dataType:"text",
+			success:function(data){
+				if(data == 'success'){
+					if(type == 1) {
+						$("#doc_type").val('html');
+					} else {
+						$("#doc_type").val('excel');
+					}
+					$("#search_form").submit();
+				} else if (data == "no-data") {
+					swal('ไม่พบข้อมูล', '', 'warning');
+				}else{
+					$('#alertNotFindModal').appendTo("body").modal('show');
+				}
+			}
+		});
+	}
+</script>
diff --git a/application/views/invest/report_profit_interest_excel.php b/application/views/invest/report_profit_interest_excel.php
new file mode 100644
index 0000000..5ece466
--- /dev/null
+++ b/application/views/invest/report_profit_interest_excel.php
@@ -0,0 +1,188 @@
+<?php
+$objPHPExcel = new PHPExcel();
+
+$borderRight = array(
+  'borders' => array(
+    'right' => array(
+      'style' => PHPExcel_Style_Border::BORDER_THIN
+    )
+  )
+);
+$borderLeft = array(
+  'borders' => array(
+    'left' => array(
+      'style' => PHPExcel_Style_Border::BORDER_THIN
+    )
+  )
+);
+$borderTop = array(
+  'borders' => array(
+    'top' => array(
+      'style' => PHPExcel_Style_Border::BORDER_THIN
+    )
+  )
+);
+$borderBottom = array(
+  'borders' => array(
+    'bottom' => array(
+      'style' => PHPExcel_Style_Border::BORDER_THIN
+    )
+  )
+);
+$borderBottomDouble = array(
+  'borders' => array(
+    'bottom' => array(
+      'style' => PHPExcel_Style_Border::BORDER_DOUBLE
+    )
+  )
+);
+$styleArray = array(
+  'borders' => array(
+    'allborders' => array(
+      'style' => PHPExcel_Style_Border::BORDER_THIN
+    )
+  ),
+  'font'  => array(
+		'bold'  => false,
+		'size'  => 16,
+		'name'  => 'Cordia New'
+	)
+);
+$textStyleArray = array(
+  'font'  => array(
+		'bold'  => false,
+		'size'  => 16,
+		'name'  => 'Angsana New'
+	)
+);
+$headerStyle = array(
+	'font'  => array(
+		'bold'  => false,
+		'size'  => 16,
+		'name'  => 'Angsana New'
+	)
+);
+$titleStyle = array(
+	'font'  => array(
+		'bold'  => true,
+		'size'  => 18,
+		'name'  => 'TH Sarabun New'
+	)
+);
+$footerStyle = array(
+	'font'  => array(
+		'bold'  => true,
+		'size'  => 14,
+		'name'  => 'AngsanaUPC'
+	)
+);
+$table = array(
+    'borders' => array(
+        'allborders' => array(
+            'style' => PHPExcel_Style_Border::BORDER_THIN
+        )
+    ),
+);
+
+$sheet = 0;
+$i=0;
+$objPHPExcel->createSheet($sheet);
+$objPHPExcel->setActiveSheetIndex($sheet);
+$i+=1;
+$objPHPExcel->getActiveSheet()->mergeCells('A'.$i.':E'.$i);
+$objPHPExcel->getActiveSheet()->SetCellValue('A' . $i , $_SESSION['COOP_NAME']);
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i)->applyFromArray($headerStyle);
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i.':E'.$i)->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
+$i+=1;
+$objPHPExcel->getActiveSheet()->mergeCells('A'.$i.':E'.$i);
+$objPHPExcel->getActiveSheet()->SetCellValue('A' . $i , "รายงานสรุปดอกเบี้ย");
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i)->applyFromArray($headerStyle);
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i.':E'.$i)->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
+$i+=1;
+$objPHPExcel->getActiveSheet()->mergeCells('A'.$i.':E'.$i);
+$objPHPExcel->getActiveSheet()->SetCellValue('A' . $i , $this->center_function->ConvertToThaiDate(@date('Y-m-d'),0,0)) ;
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i)->applyFromArray($headerStyle);
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i.':E'.$i)->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_RIGHT);
+$i+=1;
+$objPHPExcel->getActiveSheet()->mergeCells('A'.$i.':E'.$i);
+$objPHPExcel->getActiveSheet()->SetCellValue('A' . $i , "ผู้ทำรายการ ".$_SESSION['USER_NAME']) ;
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i)->applyFromArray($headerStyle);
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i.':E'.$i)->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_RIGHT);
+$i+=1;
+
+$objPHPExcel->getActiveSheet()->getColumnDimension('A')->setWidth(8);
+$objPHPExcel->getActiveSheet()->getColumnDimension('B')->setWidth(30);
+$objPHPExcel->getActiveSheet()->getColumnDimension('C')->setWidth(50);
+$objPHPExcel->getActiveSheet()->getColumnDimension('D')->setWidth(15);
+$objPHPExcel->getActiveSheet()->getColumnDimension('E')->setWidth(15);
+
+$total = 0;
+$prev_id = "x";
+foreach($datas as $index => $data) {
+    if($prev_id != $data['id']) {
+		$total_id = 0;
+		$run_no = 0;
+		$prev_id = $data['id'];
+		$i+=2;
+		$objPHPExcel->getActiveSheet()->mergeCells('A'.$i.':E'.$i);
+		$objPHPExcel->getActiveSheet()->SetCellValue('A' . $i ,$data['type_name']." : ".$data['name']);
+		$objPHPExcel->getActiveSheet()->getStyle('A'.$i.":E".$i)->applyFromArray($headerStyle);
+
+		$i++;
+		$objPHPExcel->getActiveSheet()->SetCellValue('B'.$i, "จำนวนเงิน : ".number_format($data['amount'],2));
+		$objPHPExcel->getActiveSheet()->SetCellValue('C'.$i, "อัตราดอกเลี้ย : ".$data['invest_rate_text']);
+		$objPHPExcel->getActiveSheet()->SetCellValue('D'.$i, "วันที่ลงทุน : ".$this->center_function->ConvertToThaiDate($data['invest_date'], '1', '0'));
+		$objPHPExcel->getActiveSheet()->SetCellValue('E'.$i, "วันที่ครบกำหนด : ".$this->center_function->ConvertToThaiDate($data['end_date'], '1', '0'));
+		$objPHPExcel->getActiveSheet()->getStyle('A'.$i.":E".$i)->applyFromArray($headerStyle);
+
+		$i++;
+		$objPHPExcel->getActiveSheet()->SetCellValue('B'.$i, "รอบการจ่ายเงิน : ".$data['period']);
+		$objPHPExcel->getActiveSheet()->SetCellValue('C'.$i, "สถานะ : ".($data['status'] == 1 && strtotime($data['end_date']) >= strtotime(date("Y-m-d")) ? "ปกติ"
+																			: (strtotime($data['end_date']) < strtotime(date("Y-m-d")) ? "ครบกำหนด" : "ไม่เปิดใช้งาน")));
+		$objPHPExcel->getActiveSheet()->SetCellValue('D'.$i, "องค์กร : ".$data['org_name']);
+		$objPHPExcel->getActiveSheet()->getStyle('A'.$i.":D".$i)->applyFromArray($headerStyle);
+
+		$i++;
+		$objPHPExcel->getActiveSheet()->SetCellValue('A'.$i, "ลำดับ");
+		$objPHPExcel->getActiveSheet()->SetCellValue('B'.$i, "วันที่ได้รับดอกเบี้ย");
+		$objPHPExcel->getActiveSheet()->SetCellValue('C'.$i, "อัตราดอกเบี้ย");
+		$objPHPExcel->getActiveSheet()->SetCellValue('D'.$i, "ดอกเบี้ย");
+		$objPHPExcel->getActiveSheet()->SetCellValue('E'.$i, "หมายเหตุ");
+		$objPHPExcel->getActiveSheet()->getStyle('A'.$i.":E".$i)->applyFromArray($table);
+	}
+    $i++;
+    $objPHPExcel->getActiveSheet()->SetCellValue('A'.$i, ++$run_no);
+    $objPHPExcel->getActiveSheet()->SetCellValue('B'.$i, $this->center_function->ConvertToThaiDate($data['interest_date'], '1', '0'));
+    $objPHPExcel->getActiveSheet()->SetCellValue('C'.$i, $data['rate']."%");
+    $objPHPExcel->getActiveSheet()->SetCellValue('D'.$i, number_format($data['interest_amount'], 2));
+    $objPHPExcel->getActiveSheet()->SetCellValue('E'.$i, $data['note']);
+    $objPHPExcel->getActiveSheet()->getStyle('A'.$i.":E".$i)->applyFromArray($table);
+	$total += $data['interest_amount'];
+	$total_id += $data['interest_amount'];
+	if(empty($datas[($index + 1)]) || $datas[($index + 1)]['id'] != $data['id']) {
+		$objPHPExcel->getActiveSheet()->SetCellValue('A'.$i, "");
+		$objPHPExcel->getActiveSheet()->SetCellValue('B'.$i, "");
+		$objPHPExcel->getActiveSheet()->SetCellValue('C'.$i, "รวม");
+		$objPHPExcel->getActiveSheet()->SetCellValue('D'.$i, number_format($total_id, 2));
+		$objPHPExcel->getActiveSheet()->SetCellValue('E'.$i, "");
+		$objPHPExcel->getActiveSheet()->getStyle('A'.$i.":E".$i)->applyFromArray($table);
+	}
+}
+
+$i++;
+$objPHPExcel->getActiveSheet()->SetCellValue('C'.$i, "รวมทั้งหมด");
+// $objPHPExcel->getActiveSheet()->mergeCells('A'.$i.':C'.$i);
+$objPHPExcel->getActiveSheet()->SetCellValue('D'.$i, number_format($total,2));
+$objPHPExcel->getActiveSheet()->SetCellValue('E'.$i, "");
+$objPHPExcel->getActiveSheet()->mergeCells('E'.$i.':F'.$i);
+
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i.":E".$i)->applyFromArray($headerStyle);
+
+header('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
+header('Content-Disposition: attachment;filename="สรุปดอกเบี้ย.xlsx"');
+header('Cache-Control: max-age=0');
+
+$objWriter = new PHPExcel_Writer_Excel2007($objPHPExcel);
+$objWriter->save('php://output');
+exit;
+?>
\ No newline at end of file
diff --git a/application/views/invest/report_profit_interest_preview.php b/application/views/invest/report_profit_interest_preview.php
new file mode 100644
index 0000000..584b378
--- /dev/null
+++ b/application/views/invest/report_profit_interest_preview.php
@@ -0,0 +1,245 @@
+<style>
+	.table-view>thead, .table-view>thead>tr>td, .table-view>thead>tr>th {
+		font-size: 14px;
+	}
+	.table-view>tbody>tr>th{
+	    border-top: 1px solid #000 !important;
+		border-bottom: 1px solid #000 !important;
+		font-size: 12px;
+		background-color: #eee;
+	}
+	.table-view-2>tbody>tr>td{
+	    border: 0px !important;
+		/*font-family: upbean;
+		font-size: 16px;*/
+		font-family: Tahoma;
+		font-size: 12px;
+	}	
+	.border-bottom{
+	    border-bottom: 1px solid #000 !important;
+		font-weight: bold;
+	}
+	.table-view-2>tbody>tr>td>span{
+		font-family: Tahoma;
+		font-size: 12px !important;
+	}
+	.foot-border{
+	    border-top: 1px solid #000 !important;
+		border-bottom: double !important;
+		font-weight: bold;
+	}
+	.table {
+		color: #000;
+	}
+	.table>tbody>tr>td, .table>tbody>tr>th, .table>tfoot>tr>td, .table>tfoot>tr>th, .table>thead>tr>td, .table>thead>tr>th {
+		padding:6px;
+	}
+</style>
+<form action="<?php echo base_url(PROJECTPATH.'/invest/report_profit_interest_preview'); ?>" id="search_form" method="POST" target="_blank">
+	<input type="hidden" name="doc_type" id="doc_type" value="excel"/>
+	<input type="hidden" name="type" id="type" value="<?php echo $_POST['type'];?>"/>
+	<input type="hidden" name="from_date" id="from_date" value="<?php echo $_POST['from_date'];?>"/>
+	<input type="hidden" name="thru_date" id="thru_date" value="<?php echo $_POST['thru_date'];?>"/>
+	<input type="hidden" name="org" id="org" value="<?php echo $_POST['org'];?>"/>
+</form>
+<?php
+	$runno = 0;
+	$total = 0;
+	$id_total = 0;//total for each id.
+	// $index = 0;
+	$line_count = 0;
+	$prev_id = "x";
+	$page = 1;
+	foreach($datas AS $index => $data){
+?>
+<?php 
+	if($index == 0) {
+?>	
+<div style="width: 8.3in;" class="page-break">
+	<div class="panel panel-body" style="padding-top:10px !important;height: 11.7in;">
+		<table style="width: 100%;">
+			<tr>
+				<td style="width:100px;vertical-align: top;">
+
+				</td>
+				<td class="text-center">
+					<img src="<?php echo base_url(PROJECTPATH.'/assets/images/coop_profile/'.$_SESSION['COOP_IMG']); ?>" alt="Logo" style="height: 80px;" />
+					<h3 class="title_view"><?php echo @$_SESSION['COOP_NAME'];?></h3>
+					<h3 class="title_view">รายงานสรุปดอกเบี้ย</h3>
+					<h3 class="title_view">
+					</h3>
+				</td>
+				<td style="width:100px;vertical-align: top;" class="text-right">
+					<a class="no_print" onclick="window.print();"><button class="btn btn-perview btn-after-input" type="button"><span class="icon icon-print" aria-hidden="true"></span></button></a>
+					<a class="no_print"  target="_blank" id="excel-submit">
+						<button class="btn btn-perview btn-after-input" type="button"><span class="icon icon icon-file-excel-o" aria-hidden="true"></span></button>
+					</a>
+				</td>
+			</tr>
+	<?php
+			$line_count += 150;
+		}
+		if($index == 0 || $line_count > 900 || ($line_count > 800  && $prev_id != $data['id'])) {
+			if($index != 0) {
+				$line_count = 0;
+	?>
+<div style="width: 8.3in;" class="page-break">
+	<div class="panel panel-body" style="padding-top:10px !important;height: 11.7in;">
+		<table style="width: 100%;">
+	<?php
+			}
+	?>
+			<tr>
+				<td colspan="3" style="text-align: right;">
+					<span class="title_view">หน้าที่ <?php echo @$page++;?></span><br>
+				</td>
+			</tr> 
+			<tr>
+				<td colspan="3" style="text-align: right;">
+					<span class="title_view">วันที่ <?php echo $this->center_function->ConvertToThaiDate(@date('Y-m-d'),1,0);?></span>
+				</td>
+			</tr> 
+			<tr>
+				<td colspan="3" style="text-align: right;">
+					<span class="title_view">เวลา <?php echo date('H:i:s');?></span>
+				</td>
+			</tr>
+			<tr>
+				<td colspan="3" style="text-align: right;">
+					<span class="title_view">ผู้ทำรายการ <?php echo $_SESSION['USER_NAME'];?></span>
+				</td>
+			</tr>
+		</table>
+	<?php
+			$line_count += 80;
+			$str_f = 1;
+		} else {
+			$str_f = 0;
+		}
+
+		if($prev_id != $data['id']) {
+			$prev_id = $data['id'];
+			$runno = 0;
+			
+	?>
+		<table class="table" style="<?php echo $index != 0 && $str_f == 0 ? 'margin-top: 100px;' : '';?> width:90%; margin-bottom: 10px;">
+			<tbody>
+				<tr>
+					<th colspan="4" style="border: unset;" class="text-left">
+					<?php echo $data['type_name']." : ".$data['name']?>
+					</th>
+				</tr>
+				<tr>
+					<th style="border: unset;width: 25%;" class="text-left">
+						จำนวนเงิน : <?php echo number_format($data['amount'],2);?>
+					</th>
+					<th style="border: unset;width: 20%;" class="text-left">
+						อัตราดอกเบี้ย : <?php echo $data['invest_rate_text'];?>
+					</th>
+					<th style="border: unset;width: 25%;" class="text-left">
+						วันที่ลงทุน : <?php echo $this->center_function->ConvertToThaiDate($data['invest_date'], '1', '0');?>
+					</th>
+					<th style="border: unset;width: 30%;" class="text-left">
+						วันที่ครบกำหนด : <?php echo $this->center_function->ConvertToThaiDate($data['end_date'], '1', '0');?>
+					</th>
+				</tr>
+				<tr>
+					<th style="border: unset;" class="text-left">
+						รอบการจ่ายเงิน : <?php echo $data['period'];?>
+					</th>
+					<th style="border: unset;" class="text-left">
+						สถานะ : <?php echo $data['status'] == 1 && strtotime($data['end_date']) >= strtotime(date("Y-m-d")) ? "ปกติ"
+											: (strtotime($data['end_date']) < strtotime(date("Y-m-d")) ? "ครบกำหนด" : "ไม่เปิดใช้งาน");?>
+					</th>
+					<th style="border: unset;" class="text-left">
+						องค์กร : <?php echo $data['org_name'];?>
+					</th>
+					<th style="border: unset;" class="text-left">
+					</th>
+				</tr>
+			</tbody>
+		</table>
+	<?php
+			$str_f = 1;
+			$line_count += 180;
+		}
+
+		if($str_f == 1) {
+	?>
+
+		<table class="table table-view table-center" style="width:80%">
+			<tbody>
+				<tr>
+					<th style="width: 11%;vertical-align: middle;">ลำดับ</th>
+					<th style="width: 20%;vertical-align: middle;">วันที่ได้รับดอกเบี้ย</th>
+					<th style="width: 12%;vertical-align: middle;">อัตราดอกเบี้ย</th>
+					<th style="width: 15%;vertical-align: middle;">ดอกเบี้ย</th>
+					<th style="vertical-align: middle;">หมายเหตุ</th>
+				</tr>
+	<?php
+			$line_count += 20;
+		}
+	?>
+				<tr>
+					<td style="text-align: center;vertical-align: top;"><?php echo ++$runno; ?></td>
+					<td style="text-align: center;vertical-align: top;"><?php echo $this->center_function->ConvertToThaiDate($data['interest_date'], '1', '0');?></td>
+					<td style="text-align: right;vertical-align: top;"><?php echo $data['rate']."%";?></td>
+					<td style="text-align: right;vertical-align: top;"><?php echo number_format($data['interest_amount'], 2);?></td>
+					<td style="text-align: left;vertical-align: top;"><?php echo $data['note'];?></td>
+				</tr>
+			<?php
+					$line_count += 20;
+					$first_of_page = 0;
+					$total += $data['interest_amount'];
+					$id_total += $data['interest_amount'];
+					if(empty($datas[($index+1)]) || $datas[($index+1)]['id'] != $data['id']) {
+			?>
+				<tr>
+					<th colspan="3" class="table_body text-right">
+						รวม&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
+					</th>
+					<th class="text-right">
+						<?php echo number_format($id_total, 2);?>
+					</tthd>
+					<th colspan="1">
+					</th>
+				</tr>
+			<?php
+						$id_total = 0;
+					}
+	if($line_count > 900 || $index == $max || ($line_count > 800  && $datas[($index+1)]['id'] != $data['id'])) {
+?>
+			</tbody>
+		</table>
+<?php
+		if($index == $max) {
+?>
+		<table class="table" style="width:80%; margin-top: 10px;">
+			<tbody>
+				<tr>
+					<th style="width: 11%;vertical-align: middle;"></th>
+					<th style="width: 20%;vertical-align: middle;"></th>
+					<th style="width: 12%;vertical-align: middle;" class="text-right">รวมทั้งสิ้น</th>
+					<th style="width: 15%;vertical-align: middle;" class="text-right"><?php echo number_format($total, 2);?></th>
+					<th style="vertical-align: middle;"></th>
+				</tr>
+			</tbody>
+		</table>
+<?php
+		}
+?>
+	</div>
+</div>
+<?php
+	} 
+?>
+<?php
+	}
+?>
+<script>
+	$(document).ready(function() {
+		$("#excel-submit").click(function() {
+			$("#search_form").submit();
+		});
+	});
+</script>
\ No newline at end of file
diff --git a/application/views/invest/report_share_transaction_excel.php b/application/views/invest/report_share_transaction_excel.php
new file mode 100644
index 0000000..cc5d858
--- /dev/null
+++ b/application/views/invest/report_share_transaction_excel.php
@@ -0,0 +1,166 @@
+<?php
+$objPHPExcel = new PHPExcel();
+
+$borderRight = array(
+  'borders' => array(
+    'right' => array(
+      'style' => PHPExcel_Style_Border::BORDER_THIN
+    )
+  )
+);
+$borderLeft = array(
+  'borders' => array(
+    'left' => array(
+      'style' => PHPExcel_Style_Border::BORDER_THIN
+    )
+  )
+);
+$borderTop = array(
+  'borders' => array(
+    'top' => array(
+      'style' => PHPExcel_Style_Border::BORDER_THIN
+    )
+  )
+);
+$borderBottom = array(
+  'borders' => array(
+    'bottom' => array(
+      'style' => PHPExcel_Style_Border::BORDER_THIN
+    )
+  )
+);
+$borderBottomDouble = array(
+  'borders' => array(
+    'bottom' => array(
+      'style' => PHPExcel_Style_Border::BORDER_DOUBLE
+    )
+  )
+);
+$styleArray = array(
+  'borders' => array(
+    'allborders' => array(
+      'style' => PHPExcel_Style_Border::BORDER_THIN
+    )
+  ),
+  'font'  => array(
+		'bold'  => false,
+		'size'  => 16,
+		'name'  => 'Cordia New'
+	)
+);
+$textStyleArray = array(
+  'font'  => array(
+		'bold'  => false,
+		'size'  => 16,
+		'name'  => 'Angsana New'
+	)
+);
+$headerStyle = array(
+	'font'  => array(
+		'bold'  => false,
+		'size'  => 16,
+		'name'  => 'Angsana New'
+	)
+);
+$titleStyle = array(
+	'font'  => array(
+		'bold'  => true,
+		'size'  => 18,
+		'name'  => 'TH Sarabun New'
+	)
+);
+$footerStyle = array(
+	'font'  => array(
+		'bold'  => true,
+		'size'  => 14,
+		'name'  => 'AngsanaUPC'
+	)
+);
+$table = array(
+    'borders' => array(
+        'allborders' => array(
+            'style' => PHPExcel_Style_Border::BORDER_THIN
+        )
+    ),
+);
+
+$sheet = 0;
+$i=0;
+$objPHPExcel->createSheet($sheet);
+$objPHPExcel->setActiveSheetIndex($sheet);
+$i+=1;
+$objPHPExcel->getActiveSheet()->mergeCells('A'.$i.':F'.$i);
+$objPHPExcel->getActiveSheet()->SetCellValue('A' . $i , $_SESSION['COOP_NAME']);
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i)->applyFromArray($headerStyle);
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i.':F'.$i)->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
+$i+=1;
+$objPHPExcel->getActiveSheet()->mergeCells('A'.$i.':F'.$i);
+$objPHPExcel->getActiveSheet()->SetCellValue('A' . $i , "รายงานจ่ายคืน/ไถ่ถอน");
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i)->applyFromArray($headerStyle);
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i.':F'.$i)->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
+$i+=1;
+$date_title = "วันที่ ".$this->center_function->ConvertToThaiDate($from_date);
+$date_title .= ($from_date == $thru_date) ? "" :"  ถึงวันที่  ".$this->center_function->ConvertToThaiDate($thru_date);
+$objPHPExcel->getActiveSheet()->mergeCells('A'.$i.':F'.$i);
+$objPHPExcel->getActiveSheet()->SetCellValue('A' . $i , $date_title);
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i)->applyFromArray($headerStyle);
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i.':F'.$i)->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
+$i+=1;
+$objPHPExcel->getActiveSheet()->mergeCells('A'.$i.':F'.$i);
+$objPHPExcel->getActiveSheet()->SetCellValue('A' . $i , $this->center_function->ConvertToThaiDate(@date('Y-m-d'),0,0)) ;
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i)->applyFromArray($headerStyle);
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i.':F'.$i)->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_RIGHT);
+$i+=1;
+$objPHPExcel->getActiveSheet()->mergeCells('A'.$i.':F'.$i);
+$objPHPExcel->getActiveSheet()->SetCellValue('A' . $i , "ผู้ทำรายการ ".$_SESSION['USER_NAME']) ;
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i)->applyFromArray($headerStyle);
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i.':F'.$i)->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_RIGHT);
+$i+=1;
+$i_top = $i;
+$objPHPExcel->getActiveSheet()->SetCellValue('A'.$i, "ลำดับ");
+$objPHPExcel->getActiveSheet()->SetCellValue('B'.$i, "หน่วยงาน");
+$objPHPExcel->getActiveSheet()->SetCellValue('C'.$i, "หมวดการลงทุน");
+$objPHPExcel->getActiveSheet()->SetCellValue('D'.$i, "หัวข้อการลงทุน");
+$objPHPExcel->getActiveSheet()->SetCellValue('E'.$i, "เงินลงทุน");
+$objPHPExcel->getActiveSheet()->SetCellValue('F'.$i, "จ่ายคืน/ไถ่ถอน");
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i.":F".$i)->applyFromArray($table);
+
+$objPHPExcel->getActiveSheet()->getColumnDimension('A')->setWidth(10);
+$objPHPExcel->getActiveSheet()->getColumnDimension('B')->setWidth(30);
+$objPHPExcel->getActiveSheet()->getColumnDimension('C')->setWidth(30);
+$objPHPExcel->getActiveSheet()->getColumnDimension('D')->setWidth(50);
+$objPHPExcel->getActiveSheet()->getColumnDimension('E')->setWidth(15);
+$objPHPExcel->getActiveSheet()->getColumnDimension('F')->setWidth(15);
+
+$total = 0;
+$balance_total = 0;
+$index = 0;
+foreach($datas as $data) {
+    $i++;
+    $objPHPExcel->getActiveSheet()->SetCellValue('A'.$i, ++$index);
+    $objPHPExcel->getActiveSheet()->SetCellValue('B'.$i, $data["org_name"]);
+    $objPHPExcel->getActiveSheet()->SetCellValue('C'.$i, $data["type_name"]);
+    $objPHPExcel->getActiveSheet()->SetCellValue('D'.$i, $data['name']);
+    $objPHPExcel->getActiveSheet()->SetCellValue('E'.$i, !empty($invest_balances[$data['id']]) ? number_format($invest_balances[$data['id']], 2) : "0.00");
+    $objPHPExcel->getActiveSheet()->SetCellValue('F'.$i, number_format($data['amount'], 2));
+    $objPHPExcel->getActiveSheet()->getStyle('A'.$i.":F".$i)->applyFromArray($table);
+    $total += $data['amount'];
+    if(!empty($invest_balances[$data['id']])) $balance_total += $invest_balances[$data['id']];
+}
+
+$i++;
+$objPHPExcel->getActiveSheet()->SetCellValue('A'.$i, "รวม");
+$objPHPExcel->getActiveSheet()->mergeCells('A'.$i.':D'.$i);
+$objPHPExcel->getActiveSheet()->SetCellValue('E'.$i, number_format($total,2));
+$objPHPExcel->getActiveSheet()->SetCellValue('F'.$i, number_format($balance_total,2));
+
+$objPHPExcel->getActiveSheet()->getStyle('A'.$i.":F".$i)->applyFromArray($table);
+
+header('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
+header('Content-Disposition: attachment;filename="จ่ายคืน/ไถ่ถอน.xlsx"');
+header('Cache-Control: max-age=0');
+
+$objWriter = new PHPExcel_Writer_Excel2007($objPHPExcel);
+$objWriter->save('php://output');
+exit;
+?>
\ No newline at end of file
diff --git a/application/views/invest/report_share_transaction_preview.php b/application/views/invest/report_share_transaction_preview.php
new file mode 100644
index 0000000..4ae529c
--- /dev/null
+++ b/application/views/invest/report_share_transaction_preview.php
@@ -0,0 +1,162 @@
+<style>
+	.table-view>thead, .table-view>thead>tr>td, .table-view>thead>tr>th {
+		font-size: 14px;
+	}
+	.table-view>tbody>tr>th{
+	    border-top: 1px solid #000 !important;
+		border-bottom: 1px solid #000 !important;
+		font-size: 12px;
+		background-color: #eee;
+	}
+	.table-view-2>tbody>tr>td{
+	    border: 0px !important;
+		/*font-family: upbean;
+		font-size: 16px;*/
+		font-family: Tahoma;
+		font-size: 12px;
+	}	
+	.border-bottom{
+	    border-bottom: 1px solid #000 !important;
+		font-weight: bold;
+	}
+	.table-view-2>tbody>tr>td>span{
+		font-family: Tahoma;
+		font-size: 12px !important;
+	}
+	.foot-border{
+	    border-top: 1px solid #000 !important;
+		border-bottom: double !important;
+		font-weight: bold;
+	}
+	.table {
+		color: #000;
+	}
+	.table>tbody>tr>td, .table>tbody>tr>th, .table>tfoot>tr>td, .table>tfoot>tr>th, .table>thead>tr>td, .table>thead>tr>th {
+		padding:6px;
+	}
+</style>
+<?php
+	$runno = 0;
+	$prev_level = "x";
+	$total = 0;
+	$balance_total = 0;
+	foreach($datas AS $page=>$data){
+?>
+<form action="<?php echo base_url(PROJECTPATH.'/invest/report_share_transaction_preview'); ?>" id="search_form" method="POST" target="_blank">
+	<input type="hidden" name="from_date" id="from_date" value="<?php echo $_POST['from_date']?>"/>
+	<input type="hidden" name="thru_date" id="thru_date" value="<?php echo $_POST['thru_date']?>"/>
+	<input type="hidden" name="doc_type" id="doc_type" value="excel"/>
+</form>
+<div style="width: 11.7in;" class="page-break">
+	<div class="panel panel-body" style="padding-top:10px !important;height: 8.3in;">
+		<table style="width: 100%;">
+		<?php
+			if($page == 1) {
+		?>	
+			<tr>
+				<td style="width:100px;vertical-align: top;">
+
+				</td>
+				<td class="text-center">
+					<img src="<?php echo base_url(PROJECTPATH.'/assets/images/coop_profile/'.$_SESSION['COOP_IMG']); ?>" alt="Logo" style="height: 80px;" />
+					<h3 class="title_view"><?php echo @$_SESSION['COOP_NAME'];?></h3>
+					<h3 class="title_view">รายงานจ่ายคืน/ไถ่ถอน</h3>
+					<h3 class="title_view">
+					<?php 
+						echo "วันที่ ".$this->center_function->ConvertToThaiDate($from_date);
+						echo ($from_date == $thru_date)?"":"  ถึงวันที่  ".$this->center_function->ConvertToThaiDate($thru_date);
+					?>
+					</h3>
+				</td>
+				<td style="width:100px;vertical-align: top;" class="text-right">
+					<a class="no_print" onclick="window.print();"><button class="btn btn-perview btn-after-input" type="button"><span class="icon icon-print" aria-hidden="true"></span></button></a>
+					<a class="no_print"  target="_blank" id="excel-submit">
+						<button class="btn btn-perview btn-after-input" type="button"><span class="icon icon icon-file-excel-o" aria-hidden="true"></span></button>
+					</a>
+				</td>
+			</tr>
+		<?php } ?>
+			<tr>
+				<td colspan="3" style="text-align: right;">
+					<span class="title_view">หน้าที่ <?php echo @$page.'/'.@$page_all;?></span><br>
+				</td>
+			</tr> 
+			<tr>
+				<td colspan="3" style="text-align: right;">
+					<span class="title_view">วันที่ <?php echo $this->center_function->ConvertToThaiDate(@date('Y-m-d'),1,0);?></span>
+				</td>
+			</tr> 
+			<tr>
+				<td colspan="3" style="text-align: right;">
+					<span class="title_view">เวลา <?php echo date('H:i:s');?></span>
+				</td>
+			</tr>
+			<tr>
+				<td colspan="3" style="text-align: right;">
+					<span class="title_view">ผู้ทำรายการ <?php echo $_SESSION['USER_NAME'];?></span>
+				</td>
+			</tr>
+		</table>
+
+		<table class="table table-view table-center">
+			<tbody>
+			<?php
+				$first_of_page = 1;
+				$max = count($data)-1;
+				foreach($data as $key => $row){
+					if(!empty($first_of_page)) {
+			?>
+				<tr>
+					<th style="width: 5%;vertical-align: middle;">ลำดับ</th>
+					<th style="width: 15%;vertical-align: middle;">หน่วยงาน</th>
+					<th style="width: 15%;vertical-align: middle;">หมวดการลงทุน</th>
+					<th style="vertical-align: middle;">หัวข้อการลงทุน</th>
+					<th style="width: 10%;vertical-align: middle;">เงินลงทุน</th>
+					<th style="width: 10%;vertical-align: middle;">จ่ายคืน/ไถ่ถอน</th>
+				</tr>
+			<?php
+					}
+			?>
+				<tr>
+					<td style="text-align: center;vertical-align: top;"><?php echo ++$runno; ?></td>
+					<td style="text-align: left;vertical-align: top;"><?php echo $row['org_name'];?></td>
+					<td style="text-align: left;vertical-align: top;"><?php echo $row['type_name'];?></td>
+					<td style="text-align: left;vertical-align: top;"><?php echo $row['name'];?></td>
+					<td style="text-align: right;vertical-align: top;"><?php echo !empty($invest_balances[$row['id']]) ? number_format($invest_balances[$row['id']], 2) : "0.00";?></td>
+					<td style="text-align: right;vertical-align: top;"><?php echo number_format($row['amount'], 2);?></td>
+				</tr>
+			<?php
+					$first_of_page = 0;
+					if(!empty($invest_balances[$row['id']])) $balance_total += $invest_balances[$row['id']];
+					$total += $row['amount'];
+					if($max == $key) {
+			?>
+				<tr>
+					<th colspan="4" class="table_body text-right">
+						รวม&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
+					</th>
+					<th class="text-right">
+						<?php echo number_format($balance_total, 2);?>
+					</tthd>
+					<th class="text-right">
+						<?php echo number_format($total, 2);?>
+					</th>
+				</tr>
+			<?php
+					}
+				}
+			?>
+			</tbody>
+		</table>
+	</div>
+</div>
+<?php
+	}
+?>
+<script>
+	$(document).ready(function() {
+		$("#excel-submit").click(function() {
+			$("#search_form").submit();
+		});
+	});
+</script>
\ No newline at end of file
diff --git a/application/views/invest/report_share_transactions.php b/application/views/invest/report_share_transactions.php
new file mode 100644
index 0000000..c40db2b
--- /dev/null
+++ b/application/views/invest/report_share_transactions.php
@@ -0,0 +1,111 @@
+<div class="layout-content">
+    <div class="layout-content-body">
+		<style>
+			.modal-header-alert {
+				padding:9px 15px;
+				border:1px solid #FF0033;
+				background-color: #FF0033;
+				color: #fff;
+				-webkit-border-top-left-radius: 5px;
+				-webkit-border-top-right-radius: 5px;
+				-moz-border-radius-topleft: 5px;
+				-moz-border-radius-topright: 5px;
+				border-top-left-radius: 5px;
+				border-top-right-radius: 5px;
+			}
+			.center {
+				text-align: center;
+			}
+			.right {
+				text-align: right;
+			}
+			.modal-dialog-account {
+				margin:auto;
+				margin-top:7%;
+			}
+			label{
+				padding-top:7px;
+			}
+		</style>
+		<h1 style="margin-bottom: 0">ระบบการลงทุน</h1>
+		<?php $this->load->view('breadcrumb'); ?>
+		<div class="row gutter-xs">
+			<div class="col-xs-12 col-md-12">
+				<div class="panel panel-body" style="padding-top:0px !important;" id="search-div">
+					<form action="<?php echo base_url(PROJECTPATH.'/invest/report_share_transaction_preview'); ?>" id="search_form" method="POST" target="_blank">
+						<input type="hidden" name="doc_type" id="doc_type" value="html"/>
+						<div class="form-group g24-col-sm-24 text-center">
+                            <h3>รายงานจ่ายคืน/ไถ่ถอน</h3>
+						</div>
+						<div class="form-group g24-col-sm-24 text-center">
+							<label class="g24-col-sm-8 control-label right"> วันที่ </label>
+							<div class="g24-col-sm-4">
+								<div class="input-with-icon">
+									<div class="form-group">
+										<input id="from_date" name="from_date" class="form-control m-b-1 mydate" style="padding-left: 50px;" type="text" value="<?php echo $this->center_function->mydate2date(date('Y-m-d')); ?>" data-date-language="th-th">
+										<span class="icon icon-calendar input-icon m-f-1"></span>
+									</div>
+								</div>
+							</div>
+							<label class="g24-col-sm-1 control-label right"> ถึง วันที่ </label>
+							<div class="g24-col-sm-4">
+								<div class="input-with-icon">
+									<div class="form-group">
+										<input id="thru_date" name="thru_date" class="form-control m-b-1 mydate" style="padding-left: 50px;" type="text" value="<?php echo $this->center_function->mydate2date(date('Y-m-d')); ?>" data-date-language="th-th">
+										<span class="icon icon-calendar input-icon m-f-1"></span>
+									</div>
+								</div>
+							</div>
+						</div>
+						<div class="form-group g24-col-sm-24 text-center">
+                            <button class="btn btn-primary btn-after-input" type="button" onclick="check_empty(1)"><span> แสดงรายงาน</span></button>
+						</div>
+					</form>
+				</div>
+			</div>
+		</div>
+	</div>
+</div>
+<script>
+$( document ).ready(function() {
+	$(".mydate").datepicker({
+		prevText : "ก่อนหน้า",
+		nextText: "ถัดไป",
+		currentText: "Today",
+		changeMonth: true,
+		changeYear: true,
+		isBuddhist: true,
+		monthNamesShort: ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.', 'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'],
+		dayNamesMin: ['อา', 'จ', 'อ', 'พ', 'พฤ', 'ศ', 'ส'],
+		constrainInput: true,
+		dateFormat: "dd/mm/yy",
+		yearRange: "c-50:c+10",
+		autoclose: true,
+	});
+});
+
+function check_empty(type){
+	$.ajax({
+		 url:base_url+"invest/check_share_transactions", 
+		 method:"post",
+		 data:$("#search_form").serialize(),
+		 dataType:"text",
+		 success:function(data){
+			if(data == 'success'){
+				if(type == 1) {
+					$("#doc_type").val('html');
+				} else {
+					$("#doc_type").val('excel');
+				}
+				$("#search_form").submit();
+			} else if (data == "no-data") {
+				swal('ไม่พบข้อมูล', '', 'warning');
+			}else{
+				$('#alertNotFindModal').appendTo("body").modal('show');
+			}
+		 }
+	});
+
+}
+
+</script>
diff --git a/application/views/loan_contract/contract.php b/application/views/loan_contract/contract.php
index 9544230..00eeb00 100644
--- a/application/views/loan_contract/contract.php
+++ b/application/views/loan_contract/contract.php
@@ -13,6 +13,7 @@
             <th>ยอดเงินกู้</th>
             <th>หักกลบ</th>
             <th>จำนวนที่ได้รับ</th>
+            <th>ดอกเบี้ย</th>
             <th>ผู้ทำรายการ</th>
         </tr>
         </thead>
@@ -33,6 +34,7 @@
                         </div>
                     </td>
                     <td class="text-right"><?php echo number_format($val['loan_amount_balance'], 2) ?></td>
+                    <td class="text-right" id="contract_interest_<?=$val['id']?>"><?php echo number_format(0, 2) ?></td>
                     <td class="text-center"><?php echo $val['admin_id'] == "" ? 'N/A' : $val['admin_id'] ?></td>
                 </tr>
             <?php } ?>
diff --git a/application/views/loan_contract/index.php b/application/views/loan_contract/index.php
index a145b80..afbea21 100644
--- a/application/views/loan_contract/index.php
+++ b/application/views/loan_contract/index.php
@@ -220,12 +220,12 @@
                             <div class="g24-col-sm-14">
                                 <div class="radio-inline">
                                     <label>
-                                        <input type="radio"  name="data[coop_loan][pay_type]" value="1" onclick="calcPeriod();">คงต้น
+                                        <input type="radio"  name="data[coop_loan][pay_type]" value="1" onclick="calcPeriod();" <?php echo ($this->Setting_model->get("data[coop_loan][pay_type]")==1) ? "checked" : "" ?>>คงต้น
                                     </label>
                                 </div>
                                 <div class="radio-inline">
                                     <label>
-                                        <input type="radio"  name="data[coop_loan][pay_type]" value="2" onclick="calcPeriod();" checked> คงยอด
+                                        <input type="radio"  name="data[coop_loan][pay_type]" value="2" onclick="calcPeriod();" <?php echo ($this->Setting_model->get("data[coop_loan][pay_type]")==2) ? "checked" : "" ?>> คงยอด
                                     </label>
                                 </div>
                             </div>
diff --git a/application/views/loan_contract/payment.php b/application/views/loan_contract/payment.php
index 56363e4..4cd2bda 100644
--- a/application/views/loan_contract/payment.php
+++ b/application/views/loan_contract/payment.php
@@ -14,36 +14,33 @@
         <div class="form-group g24-col-sm-12">
             <label class="g24-col-sm-8 control-label">รูปแบบการจ่ายเงิน</label>
             <div class="g24-col-sm-14">
-                <select class="form-control" id="transfer_type">
-                    <option value="1">เงินสด</option>
-                    <option value="2">โอนเงินบัญชีสหกรณ์</option>
-                    <option value="3">โอนเงินบัญชีธนาคาร</option>
-                    <option value="4">เช็ค</option>
+                <select class="form-control" name="data[coop_loan][transfer_type]" id="transfer_type">
+                    <option value="0">เงินสด</option>
+                    <option value="1">โอนเงินบัญชีสหกรณ์</option>
+                    <option value="2">โอนเงินบัญชีธนาคาร</option>
+                    <option value="3">เช็ค</option>
                 </select>
             </div>
         </div>
     </div>
     <div class="g24-col-sm-24 content-bank">
         <div class="form-group g24-col-sm-12">
-            <label class="g24-col-sm-8 control-label" for="bank">ธนาคาร</label>
+            <label class="g24-col-sm-8 control-label" for="transfer_bank_id">ธนาคาร</label>
             <div class="g24-col-sm-14">
-                <input type="text" id="bank" class="form-control" value="">
+                <select name="data[coop_loan][transfer_bank_id]" id="transfer_bank_id" class="form-control">
+						<option value="">เลือกธนาคาร</option>
+						<?php foreach($rs_bank as $key => $value){ ?>
+						<option value="<?php echo $value['bank_id']; ?>" <?php echo $content_bank['dividend_bank_id']==$value['bank_id'] ? "selected" : "" ?>><?php echo $value['bank_name']; ?></option>
+					<?php } ?>
+			    </select>	
             </div>
         </div>
     </div>
     <div class="g24-col-sm-24 content-bank">
         <div class="form-group g24-col-sm-12">
-            <label class="g24-col-sm-8 control-label" for="bank_branch">สาขา</label>
+            <label class="g24-col-sm-8 control-label" for="transfer_bank_account_id">เลขที่บัญชี</label>
             <div class="g24-col-sm-14">
-                <input type="text" id="bank_branch" class="form-control" value="">
-            </div>
-        </div>
-    </div>
-    <div class="g24-col-sm-24 content-bank">
-        <div class="form-group g24-col-sm-12">
-            <label class="g24-col-sm-8 control-label" for="ิbank_account">เลขที่บัญชี</label>
-            <div class="g24-col-sm-14">
-                <input type="text" id="bank_account" class="form-control" value="">
+                <input type="text" name="data[coop_loan][transfer_bank_account_id]" id="transfer_bank_account_id" class="form-control" value="<?=@$content_bank['dividend_acc_num']?>">
             </div>
         </div>
     </div>
diff --git a/application/views/report_loan_data/coop_report_loan_detail_preview_1.php b/application/views/report_loan_data/coop_report_loan_detail_preview_1.php
new file mode 100644
index 0000000..1b42eb0
--- /dev/null
+++ b/application/views/report_loan_data/coop_report_loan_detail_preview_1.php
@@ -0,0 +1,1599 @@
+<style>
+	.table-view>thead, .table-view>thead>tr>td, .table-view>thead>tr>th {
+		font-size: 15px;
+	}	
+
+	.box-radius{
+		border-radius: 4px;border: 1px solid #333333;padding: 5px;
+	}	
+	
+	.group-box{
+		text-align: left;display: -webkit-inline-box;
+	}
+	
+	.border-bottom-dotted{border-bottom: 1px dotted #75758a;color: #000000;}
+	.border-bottom-dotted-red{border-bottom: 1px dotted red;}
+	
+	
+	table {
+		border-collapse: initial;
+		border-spacing: 0;
+	}
+
+	.text-center {
+		text-align: center !important;
+	}
+
+	.bordered {
+		border: solid #333333 1px;
+		-moz-border-radius: 6px;
+		-webkit-border-radius: 6px;
+		border-radius: 6px;    
+		width: 100%;
+		font-family: Tahoma;
+		font-size: 14px;
+		color: #000000;
+	}   
+		
+	.bordered th {
+		border-left: 1px solid #333333;
+		border-top: 1px solid #333333;
+		border-bottom: 1px solid #333333;
+		padding: 0px 2px 0px 2px;
+		text-align: left;  
+		-webkit-box-shadow: 0 1px 0 rgba(255,255,255,.8) inset; 
+		-moz-box-shadow:0 1px 0 rgba(255,255,255,.8) inset;  
+		box-shadow: 0 1px 0 rgba(255,255,255,.8) inset;        
+		border-top: none;
+		text-shadow: 0 1px 0 rgba(255,255,255,.5); 
+		text-align: center;
+	} 
+	
+	.bordered td{
+		border-left: 1px solid #333333;
+		padding: 0px 2px 0px 2px;
+		text-align: left;
+		vertical-align: top;		
+	}
+	
+	.bordered tfoot td{
+		border-top: 1px solid #333333;
+		padding: 0px 2px 0px 2px;
+		text-align: left; 
+		background-color: #ffffff;
+		font-weight: bold;
+	}	
+
+	.bordered td:first-child, .bordered th:first-child {
+		border-left: none;
+	}
+
+	.bordered th:first-child {
+		-moz-border-radius: 6px 0 0 0;
+		-webkit-border-radius: 6px 0 0 0;
+		border-radius: 6px 0 0 0;
+	}
+	
+	.bordered th:last-child {
+		-moz-border-radius: 0 6px 0 0;
+		-webkit-border-radius: 0 6px 0 0;
+		border-radius: 0 6px 0 0;
+	}
+
+	.bordered th:only-child{
+		-moz-border-radius: 6px 6px 0 0;
+		-webkit-border-radius: 6px 6px 0 0;
+		border-radius: 6px 6px 0 0;
+	}
+
+	.bordered tr:last-child td:first-child {
+		-moz-border-radius: 0 0 0 6px;
+		-webkit-border-radius: 0 0 0 6px;
+		border-radius: 0 0 0 6px;
+	} 
+
+	.bordered tr:last-child td:last-child {
+		-moz-border-radius: 0 0 6px 0;
+		-webkit-border-radius: 0 0 6px 0;
+		border-radius: 0 0 6px 0;
+	}
+	
+	.border-left{
+		border-left: 1px solid #333333 !important;
+		border-radius: 0 !important;
+	}
+	
+	.border-top{
+		border-top: 1px solid #333333 !important;
+	}
+	
+	.font-bold{	
+		font-weight: bold;
+	}
+	
+	.text-title{    
+		font-size: 15px;
+		font-weight: bold;
+		margin-top: 5px;
+	}
+	
+	.text-red{color:red;}
+	
+	@media print {	
+		.text-red{color:red !important;}
+	}
+	
+	div{font-family: Tahoma;font-size: 14px;}
+	
+	.no-border{
+		font-family: Tahoma;
+		font-size: 14px;
+	}
+	.no-border td{
+		border-left: 0px;
+		padding: 0px 2px 0px 2px;
+		text-align: left;
+		vertical-align: top;		
+	}
+	
+	span{font-family: Tahoma;font-size: 14px;color: #000000;}
+	
+	.signature_part {
+		width: 100%;
+		font-family: Tahoma;
+		font-size: 14px;
+		color: #000000;
+	}
+	.no-border-b{
+		font-family: Tahoma;
+		font-size: 14px;
+		color: #000000;
+	}
+</style>		
+		<?php
+			$year = @$_GET['year'];	
+			$petition_number = (empty($row_loan['contract_number']))?@$row_loan['petition_number']:@$row_loan['petition_number'].'/'.@$row_loan['contract_number'];
+
+			//echo '<pre>'; print_r($row_loan); echo '</pre>';		
+		?>
+		
+		<div style="width: 1000px;" class="page-break">
+			<div class="panel panel-body" style="padding-top:10px !important;height: 1400px;">
+				<table style="width: 100%;">
+					<tr>						
+						<td style="vertical-align: top;" class="text-right">
+							<a class="no_print" onclick="window.print();"><button class="btn btn-perview btn-after-input" type="button"><span class="icon icon-print" aria-hidden="true"></span></button></a>
+						</td>
+					</tr> 
+				</table>
+				<table style="width: 100%;">
+					<tr>
+						<td style="width:100px;vertical-align: top;">
+							<img src="<?php echo base_url(PROJECTPATH.'/assets/images/coop_profile/'.$_SESSION['COOP_IMG']); ?>" alt="Logo" style="height: 80px;" />
+						</td>
+						<td>
+							 <h3 class="title_view"><?php echo @$_SESSION['COOP_NAME'];?></h3>
+							 <h3 class="title_view">รายละเอียดการขอกู้เงิน <?php echo @$row_loan['loan_type_detail'];?></h3>
+							<p>&nbsp;</p>	
+						 </td>
+						 <td style="width:250px;vertical-align: top;" class="text-right">
+							<div class="group-box">
+								<span>เลขที่คำขอ</span>	
+								<div class="border-bottom-dotted" style="width: 156px;text-align: center;">&nbsp;<?php echo @$petition_number;?></div>	
+							</div>		
+							<div class="group-box">
+								<span>วันที่</span>	
+								<div class="border-bottom-dotted" style="width: 181px;text-align: center;">&nbsp;<?php echo $this->center_function->ConvertToThaiDate(@$row_loan['createdatetime'],0,0);?></div>	
+							</div>	
+						 </td>
+					</tr> 
+					<tr>
+						<td colspan="3">
+							<h3 class="title_view">
+							</h3>
+						</td>
+					</tr> 
+				</table>
+				<table>
+					<tr>
+						<td style="vertical-align: top;">
+							<div class="box-radius" style="width:520px;">
+								<div class="group-box">
+									<span>รหัสสมาชิก</span>	
+									<div class="border-bottom-dotted" style="width: 110px;text-align: center;">&nbsp;<?php echo @$row_member['member_id'];?></div>	
+									<span>ชื่อ - นามสกุล</span>	
+									<div class="border-bottom-dotted" style="width: 252px;text-align: center;">&nbsp;<?php echo @$row_member['firstname_th'].'  '.@$row_member['lastname_th'];?></div>	
+								</div>
+								<div class="group-box">
+									<span>สังกัด</span>	
+									<div class="border-bottom-dotted" style="width: 476px;text-align: center;">&nbsp;<?php echo (empty($row_member['department_name']))?"-":@$row_member['department_name'];?></div>	
+								</div>								
+								<div class="group-box">
+									<span>หน่วยงาน</span>	
+									<div class="border-bottom-dotted" style="width: 453px;text-align: center;">&nbsp;<?php echo (empty($row_member['faction_name']))?"-":@$row_member['faction_name'];?></div>	
+								</div>								
+								<div class="group-box">
+									<span>กลุ่ม</span>
+									<div class="border-bottom-dotted" style="width: 207px;text-align: center;">&nbsp;<?php echo (empty($row_member['level_name']))?"-":@$row_member['level_name'];?></div>	
+									<span>รูปแบบสมาชิก</span>	
+									<div class="border-bottom-dotted" style="width: 194px;text-align: center;">&nbsp;<?php echo (empty($row_member['mem_type_name']))?"-":@$row_member['mem_type_name'];?></div>
+								</div>								
+								<div class="group-box">
+									<span>ว/ด/ป เกิด</span>	
+									<div class="border-bottom-dotted" style="width: 181px;text-align: center;">&nbsp;<?php echo $this->center_function->ConvertToThaiDate(@$row_member['birthday'],0,0);?></div>	
+									<span>อายุ</span>
+									<div class="border-bottom-dotted" style="width: 70px;text-align: center;">&nbsp;<?php echo $this->center_function->diff_birthday(@$row_member['birthday']);?></div>
+									<span>ปี</span>
+								</div>
+								<!--<div class="group-box">
+									<span>มีการกำหนดกรณีไม่ผ่านเกณฑ์</span>	
+									<div class="border-bottom-dotted" style="width: 384px;text-align: center;">&nbsp;<?php echo (@$deduct_person_guarantee == 0)?"-":number_format(@$deduct_person_guarantee,2)." บาท";?></div>
+								</div>
+								<div class="group-box">
+									<span>ค่าธรรมเนียม</span>	
+									<div class="border-bottom-dotted" style="width: 452px;text-align: center;">&nbsp;<?php echo (@$deduct_loan_fee == 0)?"-":number_format(@$deduct_loan_fee,2)." บาท";?></div>	
+								</div>
+								-->
+								<div class="group-box" style="width: 100%;">
+									<span>&nbsp;</span>	
+									<div style="border-bottom: 1px dotted #ffffff;">&nbsp;</div>	
+								</div>
+								<div class="group-box" style="width: 100%;">
+									<span>&nbsp;</span>	
+									<div style="border-bottom: 1px dotted #ffffff;">&nbsp;</div>		
+								</div>
+								<div class="group-box">
+									<span>&nbsp;</span>	
+									<div>&nbsp;</div>	
+								</div>	
+							</div>
+						</td>
+						<td style="padding-left: 5px;vertical-align: top;">
+							<div class="box-radius" style="width:430px; min-height: 188px;">
+								<div class="group-box">
+									<span>รูปแบบดอกเบี้ย</span>
+									<div class="border-bottom-dotted" style="width: 190px;text-align: center;">&nbsp;<?php echo @$pay_type;?></div>
+									<span>อัตราดอกเบี้ย</span>	
+									<div class="border-bottom-dotted" style="width: 60px;text-align: center;">&nbsp;<?php echo  (@$row_loan['interest_per_year'] == 0)?"-":number_format(@$row_loan['interest_per_year'],2)." %";?></div>	
+								</div>	
+								<div class="group-box">
+									<span>วงเงินที่ขออนุมัติ</span>	
+									<div class="border-bottom-dotted" style="width: 130px;text-align: right;"><?php echo (@$row_loan['loan_amount'] == 0)?"-":number_format(@$row_loan['loan_amount'],2);?>&nbsp;</div>
+									<span>บาท&nbsp;&nbsp;&nbsp;</span>										
+									<span>จำนวนงวด</span>	
+									<div class="border-bottom-dotted" style="width: 65px;text-align: center;">&nbsp;<?php echo (@$row_loan['period_amount'] == '')?"-":@$row_loan['period_amount'];?></div>
+									<span>งวด</span>	
+								</div>
+								<div class="group-box">
+									<span>ผ่อนต่อเดือน</span>	
+									<div class="border-bottom-dotted" style="width: 152px;text-align: right;"><?php echo (@$total_paid_per_month == 0)?"-":number_format(@$total_paid_per_month,2);?>&nbsp;</div>
+									<span>บาท</span>	
+								</div>	
+								<div class="group-box">
+									<span>หักเงินกู้เดิม</span>	
+									<div class="border-bottom-dotted" style="width: 156px;text-align: right;"><?php echo (@$existing_loan == 0)?"-":number_format(@$existing_loan,2);?>&nbsp;</div>
+									<span>บาท</span>	
+								</div>	
+<!--								<div class="group-box">-->
+<!--									<span>ภาระเงินต้น</span>	-->
+<!--									<div class="border-bottom-dotted" style="width: 158px;text-align: right;">--><?php //echo (@$principal_load == 0)?"-":number_format(@$principal_load,2);?><!--&nbsp;</div>-->
+<!--									<span>บาท</span>	-->
+<!--								</div>	-->
+<!--								<div class="group-box">-->
+<!--									<span>ภาระดอกเบี้ย</span>	-->
+<!--									<div class="border-bottom-dotted" style="width: 149px;text-align: right;">--><?php //echo (@$interest_burden == 0)?"-":number_format(@$interest_burden,2);?><!--&nbsp;</div>-->
+<!--									<span>บาท</span>	-->
+<!--								</div>	-->
+								<div class="group-box">
+									<span>รายการหัก</span>
+									<div class="border-bottom-dotted" style="width: 164px;text-align: right;"><?php echo (@$deductible == 0)?"-":number_format($deductible,2);?>&nbsp;</div>
+									<span>บาท</span>	
+								</div>									
+								<div class="group-box">
+									<span>ค่าเช็ค</span>	
+									<div class="border-bottom-dotted" style="width: 186px;text-align: right;"><?php echo (@$deduct_cheque == 0)?"-":number_format($deduct_cheque,2);?>&nbsp;</div>
+									<span>บาท</span>	
+								</div>
+								<div class="group-box text-red">
+									<span class="text-red">ยอดรับสุทธิ</span>	
+									<div class="border-bottom-dotted-red" style="width: 159px;text-align: right;"><?php echo (@$total_amount == 0)?"-":number_format(@$total_amount,2);?>&nbsp;</div>
+									<span class="text-red">บาท</span>	
+								</div>		
+							</div>
+						</td>
+					</tr>
+				</table>
+				
+				<table style="margin: 5px;">
+					<tr>
+						<td style="vertical-align: top;width:330px;">
+							<span class="text-title">รายได้/ค่าใช้จ่าย</span>
+							<?php
+								$salary = (!empty($row_report_detail))?@$row_report_detail['salary']:@$row_member['salary'];
+								$other_income = (!empty($row_report_detail))?@$row_report_detail['other_income']:@$row_member['other_income'];
+								$total_income =  @$salary+@$other_income;
+								
+								$rules_share = (!empty($row_report_detail))?@$row_report_detail['rules_share']:@$rules_share;
+								$cal_share = (!empty($row_report_detail))?@$row_report_detail['now_share']:@$cal_share;
+								$account_blue_deposit = (!empty($row_report_detail))?@$row_report_detail['account_blue_deposit']:@$account_blue_deposit;
+								
+
+                                if(!isset($loan_cost_code) && count($loan_cost_code) == 0) {
+                                    $total_expenses = 0;
+                                }else{
+                                    $total_expenses = array_sum(array_map( function($item){ return $item['loan_cost_amount']; }, $loan_cost_code));
+                                }
+								$income_costs_balance = $total_income - $total_expenses;
+								
+							?>
+                            <input type="hidden" name="debug" value="<?php print_r($coop_loan_cost)?>">
+							<table class="bordered">
+								<tr>
+									<th>รายการ</th>        
+									<th style="width:100px;">จำนวนเงิน (บาท)</th>
+								</tr>
+								<tr>
+									<td>รายได้</td>        
+									<td style="text-align:right;"></td>
+								</tr>
+								<tr>
+									<td>- เงินเดือน</td>        
+									<td style="text-align:right;"><?php echo (@$salary == 0)?"-":number_format(@$salary,2);?></td>
+								</tr>
+                                <?php
+                                foreach(@$income as $key => $value){
+                                    $token = sha1(md5($_GET['loan_id']));
+                                    $total_income += @$value['income_value'];
+                                    ?>
+                                    <tr>
+                                        <td>- <?=$value['income_name']?></td>
+                                        <td class="inline_income" style="text-align:right;">
+                                            <span class="inline_income" data-text="<?=$value['id']?>"><?php echo (@$value['income_value'] == 0)?"-":number_format(@$value['income_value'],2);?></span>
+                                        </td>
+                                    </tr>
+                                    <?php
+                                }
+                                $income_costs_balance = $total_income - $total_expenses;
+                                ?>
+								<tr>      
+									<td class="font-bold">รวมรายได้</td>
+									<td class="font-bold" style="text-align:right;"><?php echo (@$total_income == 0)?"-":number_format(@$total_income,2);?></td>
+								</tr>
+                                <?php if(isset($loan_cost_code)){ ?>
+                                <tr>
+                                    <td>ค่าใช้จ่าย</td>
+                                    <td style="text-align:right;"></td>
+                                </tr>
+                                <?php foreach ($loan_cost_code as $key => $item) { ?>
+                                <tr>
+                                    <td>- <?php echo $item['outgoing_name'];?></td>
+                                    <td style="text-align:right;"><?php echo (@$item['loan_cost_amount'] == 0)?"-":number_format(@$item['loan_cost_amount'],2);?></td>
+                                </tr>
+                                <?php }
+                                } ?>
+								<tr>      
+									<td class="font-bold">รวมค่าใช้จ่าย</td>
+									<td class="font-bold" style="text-align:right;"><?php echo (@$total_expenses == 0)?"-":number_format(@$total_expenses,2);?></td>
+								</tr> 
+								<tr>      
+									<td class="font-bold border-top" style="text-align:center;">คงเหลือ</td>
+									<td class="font-bold border-top" style="text-align:right;"><?php echo number_format(@$income_costs_balance,2);?></td>
+								</tr>   
+							</table>
+							<?php if(isset($loan_deduct_list) && count($loan_deduct_list) >= 1){ ?>
+							<span class="text-title">ประกันชีวิต</span>
+							<?php
+								$life_insurance_1 = 0;
+								$life_insurance_2 = (@$cremation_type_2 > 0)?@$cremation_type_2:0;
+								$life_insurance_3 = (@$cremation_type_1 > 0)?@$cremation_type_1:0;
+								$life_insurance_4 = (@$life_insurance_4 > 0)?@$life_insurance_4:0;
+								$life_insurance_5 = (@$life_insurance_5 > 0)?@$life_insurance_5:0;
+								$life_insurance_6 = (@$life_insurance_6 > 0)?@$life_insurance_6:0;
+								foreach($loan_deduct_list as $key => $value){
+									if(@$loan_deduct['buy_s_s_o_k'] > 0 ){
+										$life_insurance_2 = 600000;
+									}
+
+									if(@$loan_deduct['buy_ch_s_o'] > 0){
+										$life_insurance_3 = 600000;
+									}
+								}	
+							?>
+							<table class="bordered">
+								<tr>
+									<th>รายการ</th>        
+									<th style="width:100px;">จำนวนเงิน (บาท)</th>
+								</tr>
+								<tr>
+									<td>หุ้น</td>        
+									<td style="text-align:right;"><?php echo (@$cal_share > @$rules_share)?number_format(@$cal_share,2):number_format(@$rules_share,2);?></td>
+								</tr>
+								<tr>
+									<td>สสอค. </td>        
+									<td style="text-align:right;"><?php echo (@$life_insurance_2 == 0)?"-":number_format(@$life_insurance_2,2);?></td>
+								</tr>
+								<tr>
+									<td>ชสอ. </td>        
+									<td style="text-align:right;"><?php echo (@$life_insurance_3 == 0)?"-":number_format(@$life_insurance_3,2);?></td>
+								</tr> 
+								<!--<tr>      
+									<td>ทุนประกันสังคม</td>
+									<td style="text-align:right;"><?php echo (@$life_insurance_3 == 0)?"-":number_format(@$life_insurance_3,2);?></td>
+								</tr>-->
+								<tr>      
+									<td class="font-bold border-top">ทุนประกันเดิม</td>
+									<td class="font-bold border-top" style="text-align:right;"><?php echo (@$life_insurance_4 == 0)?"-":number_format(@$life_insurance_4,2);?></td>
+								</tr> 
+								<!--<tr>      
+									<td class="font-bold">ทุนประกันใหม่</td>
+									<td class="font-bold" style="text-align:right;"><?php echo (@$life_insurance_5 == 0)?"-":number_format(@$life_insurance_5,2);?></td>
+								</tr>-->
+								<tr>      
+									<td class="font-bold">ทุนประกันเพิ่ม</td>
+									<td class="font-bold" style="text-align:right;"><?php echo (@$life_insurance_6 == 0)?"-":number_format(@$life_insurance_6,2);?></td>
+								</tr>  
+								<tr>      
+									<td class="font-bold">เบี้ยประกัน</td>
+									<td class="font-bold" style="text-align:right;"><?php echo (@$deduct_insurance == 0)?"-":number_format(@$deduct_insurance,2);?></td>
+								</tr>  
+							</table>
+							<?php } ?>
+							<span class="text-title">หุ้น</span>
+							<table class="bordered">
+								<tr>
+									<th>รายการ</th>        
+									<th style="width:100px;">จำนวนเงิน (บาท)</th>
+								</tr>
+								<tr>
+									<td>หุ้นที่ใช้ค้ำประกัน</td>
+									<td style="text-align:right;"><?php echo (@$g_share_amt == 0)?"-":number_format(@$g_share_amt,2);?></td>
+								</tr>
+								<tr>
+									<td>หุ้นที่มี</td>        
+									<td style="text-align:right;"><?php echo (@$cal_share == 0)?"-":number_format(@$cal_share,2); ?></td>
+								</tr> 
+								<tr>      
+									<td>เงินฝาก</td>
+									<td style="text-align:right;"><?php echo number_format(@$account_blue_deposit,2);?></td>
+								</tr>
+								<!--<tr>
+									<td>เดิม</td>        
+									<td style="text-align:right;"><?php echo number_format(@$old_share,2);?></td>
+								</tr> 
+								<tr>      
+									<td>เข้าบัญชีเงินฝาก</td>
+									<td style="text-align:right;"><?php echo number_format(@$deposit_account_in,2);?></td>
+								</tr> -->
+							</table>
+						</td>
+						<td style="padding-left: 5px;vertical-align: top;width:330px;">
+							<span class="text-title">รายการผ่อนชำระสหกรณ์ปัจจุบัน/เดือน</span>
+							<table class="bordered">								
+								<tr>
+									<th rowspan="2">รายการ</th>        
+									<th colspan="2">จำนวนเงิน (บาท)</th>
+								</tr>
+								<tr>
+									<th class="border-left" style="width: 65px;">เงินต้น</th>        
+									<th class="border-left" style="width: 65px;">ดอกเบี้ย</th>
+								</tr>
+							
+								<tr>
+									<td>หุ้นหักรายเดือน</td>        
+									<td style="text-align:right;"><?php echo (@$share_month == 0)?"-":number_format(@$share_month,2);?></td>
+									<td style="text-align:right;"><?php echo (@$share_month_interest == 0)?"-":number_format(@$share_month_interest,2);?></td>
+								</tr>
+								<tr>
+									<td>เงินฝากหักรายเดือน</td>        
+									<td style="text-align:right;"><?php echo (@$deposit_month == 0)?"-":number_format(@$deposit_month,2);?></td>
+									<td style="text-align:right;"><?php echo (@$deposit_month_interest == 0)?"-":number_format(@$deposit_month_interest,2);?></td>
+								</tr> 
+								<?php								 
+								if(!empty($arr_list_loan)){
+									foreach($arr_list_loan AS $key=>$value){
+								?>
+								<tr>
+									<td><?php echo @$value['contract_number'];?></td>
+									<td style="text-align:right;"><?php echo (@$value['loan_principle'] == 0)?"-":number_format(@$value['loan_principle'],2);?></td>
+									<td style="text-align:right;"><?php echo (@$value['loan_interest'] == 0)?"-":number_format(@$value['loan_interest'],2);?></td>
+								</tr> 
+								<?php
+									}
+								 }
+								?>
+								<tr>
+									<td>สัญญาเงินกู้ (ใหม่)</td>
+									<td style="text-align:right;"><?php echo (@$total_paid_per_month == 0)?"-":number_format(@$total_paid_per_month,2);?></td>
+									<td style="text-align:right;"><?php echo (@$interest_30_day == 0)?"-":number_format(@$interest_30_day,2);?></td>
+								</tr>
+								<tr>      
+									<td class="font-bold border-top" style="text-align:center;">รวมทั้งสิ้น</td>
+									<td class="font-bold border-top" style="text-align:right;"><?php echo (@$total_month == 0)?"-":number_format(@$total_month,2);?></td>
+									<td class="font-bold border-top" style="text-align:right;"><?php echo (@$total_month_interest == 0)?"-":number_format(@$total_month_interest,2);?></td>
+								</tr> 
+							</table>
+							
+							<span class="text-title">รายการรับเงิน</span>
+							<table class="bordered">
+								<tr>
+									<th>รายการ</th>        
+									<th style="width:100px;">จำนวนเงิน (บาท)</th>
+								</tr>
+								<?php 
+									if(!empty($receiving_money)){
+										foreach($receiving_money AS $key=>$row_receiving_money){
+											if($key==sizeof($receiving_money)-1)
+												$row_receiving_money['total_received'] += @$extra_debt['total_princical'];
+								?>
+								<tr>
+									<td style="vertical-align: top;vertical-align: top;"><?php echo @$row_receiving_money['transfer_type'];?></td>        
+									<td style="text-align:right;vertical-align: top;"><?php echo (@$row_receiving_money['total_received'] == 0)?"-":number_format(@$row_receiving_money['total_received'],2);?></td>
+								</tr>
+								<?php 
+										}
+									}
+								?>
+							</table>
+							
+							<span class="text-title">เงินฝาก</span>
+							<table class="bordered">
+								<tr>
+									<th>รายการ</th>        
+									<th style="width:100px;">จำนวนเงิน (บาท)</th>
+								</tr>
+								<!--
+								<?php
+								if(!empty($account_list)){
+									foreach($account_list AS $key => $value){
+								?>
+								<tr>
+									<td><?php echo @$value['account_id'].':'.@$value['account_name'];?></td>        
+									<td style="text-align:right;"><?php echo (@$value['account_balance'] == 0)?"-":number_format(@$value['account_balance'],2);?></td>
+								</tr> 
+								
+								<?php	}
+								}
+								?>
+								-->
+							</table>
+						</td>
+						<td style="padding-left: 5px;vertical-align: top;width:330px;">
+							<?php
+								$broken = 0; //ยอดหัก
+								$total_installment = $income_costs_balance-$broken-$total_month-$total_paid_per_month; //คงเป็นยอดผ่อนชำระได้
+							?>
+							<!--<span class="text-title">คำนวณสิทธิ์</span>
+							<table class="bordered">
+								<tr>
+									<th>รายการ</th>        
+									<th style="width:100px;">จำนวนเงิน (บาท)</th>
+								</tr>
+								<tr>
+									<td>เงินเหลือรายเดือน</td>        
+									<td style="text-align:right;"><?php echo (@$income_costs_balance == 0)?"-":number_format(@$income_costs_balance,2);?></td>
+								</tr> 
+								<tr>
+									<td>ยอดหัก <?php echo number_format(10,2);?></td>        
+									<td style="text-align:right;"><?php echo (@$broken == 0)?"-":number_format(@$broken,2);?></td>
+								</tr> 
+								<tr>
+									<td>รวมหักรายเดือน</td>        
+									<td style="text-align:right;"><?php echo (@$total_month == 0)?"-":number_format(@$total_month,2);?></td>
+								</tr> 
+								<tr>
+									<td>รวมหักรายเดือน(ใหม่)</td>        
+									<td style="text-align:right;"><?php echo (@$total_paid_per_month == 0)?"-":number_format(@$total_paid_per_month,2);?></td>
+								</tr>
+								<tr>
+									<td class="font-bold">คงเป็นยอดผ่อนชำระได้</td>        
+									<td class="font-bold" style="text-align:right;"><?php echo (@$total_installment == 0)?"-":number_format(@$total_installment,2);?></td>
+								</tr>  
+							</table>
+							-->
+							
+							<span class="text-title">ปิดสัญญาเดิม</span>
+							<table class="bordered">
+								<tr>
+									<th rowspan="2">เลขที่สัญญา</th>        
+									<th colspan="4">จำนวนเงิน (บาท)</th>
+								</tr>
+								<tr>
+									<th class="border-left" style="width:50px;">เงินต้น</th>        
+									<th class="border-left" style="width:50px;">ดอกเบี้ย</th>
+									<th class="border-left" style="width:50px;">ดอกเบี้ยค้างชำระ</th>
+									<th class="border-left" style="width:50px;">ค่าธรรมเนียม</th>
+								</tr>
+								<?php
+								$total_loan_balance = 0;
+								$total_loan_interest = 0;
+								$total_loan_outstanding = 0;
+								$total_loan_fee = 0;
+								if(!empty($list_old_loan)){
+									foreach($list_old_loan AS $key => $value){
+										$loan_balance = @$value['loan_amount_balance'];
+										$loan_interest = @$value['loan_interest_amount'];
+										$loan_outstanding = 0;
+										$loan_fee = 0;		
+
+										$total_loan_balance += @$loan_balance;
+										$total_loan_interest += @$loan_interest;
+										$total_loan_outstanding += @$loan_outstanding;
+										$total_loan_fee += @$loan_fee;
+								?>
+								<tr>
+									<td><?php echo @$value['contract_number'];?></td>
+									<td style="text-align:right;"><?php echo (@$loan_balance == 0)?"-":number_format(@$loan_balance,2);?></td>
+									<td style="text-align:right;"><?php echo (@$loan_interest == 0)?"-":number_format(@$loan_interest,2);?></td>
+									<td style="text-align:right;"><?php echo (@$loan_outstanding == 0)?"-":number_format(@$loan_outstanding,2);?></td>
+									<td style="text-align:right;"><?php echo (@$loan_fee == 0)?"-":number_format(@$loan_fee,2);?></td>
+								</tr> 
+								
+								<?php	}
+								}
+								?>
+								
+								<tr>      
+									<td class="font-bold border-top" style="text-align:center;">รวมทั้งสิ้น</td>
+									<td class="font-bold border-top" style="text-align:right;"><?php echo (@$total_loan_balance == 0)?"-":number_format(@$total_loan_balance,2);?></td>
+									<td class="font-bold border-top" style="text-align:right;"><?php echo (@$total_loan_interest == 0)?"-":number_format(@$total_loan_interest,2);?></td>
+									<td class="font-bold border-top" style="text-align:right;"><?php echo (@$total_loan_outstanding == 0)?"-":number_format(@$total_loan_outstanding,2);?></td>
+									<td class="font-bold border-top" style="text-align:right;"><?php echo (@$total_loan_fee == 0)?"-":number_format(@$total_loan_fee,2);?></td>
+								</tr> 
+							</table>
+							<?php if(isset($loan_deduct_list) && count($loan_deduct_list) >= 1){ ?>
+							<span class="text-title">รายการซื้อ</span>
+							<table class="bordered">
+								<tr>
+									<th>รายการ</th>        
+									<th style="width:100px;">จำนวนเงิน (บาท)</th>
+								</tr>
+								<?php
+								$total_buy = 0;
+								$total_deduct = 0;
+								foreach($loan_deduct_list as $key => $value){
+									$total_deduct += @$loan_deduct[$value['loan_deduct_list_code']];
+								?>								
+								<tr>
+									<td><?php echo @$value['loan_deduct_list'];?></td>        
+									<td style="text-align:right;vertical-align: top;"><?php echo @$loan_deduct[$value['loan_deduct_list_code']]!=''?number_format($loan_deduct[$value['loan_deduct_list_code']],2):'-';?></td>
+								</tr> 
+								<?php
+									
+								}
+								$total_buy = @$total_deduct;								
+								?>
+								
+								<tr>      
+									<td class="font-bold border-top" style="text-align:center;">รวมทั้งสิ้น</td>
+									<td class="font-bold border-top" style="text-align:right;"><?php echo (@$total_buy == 0)?"-":number_format(@$total_buy,2);?></td>
+								</tr>  
+							</table>
+							<?php } ?>
+							<span class="text-title">&nbsp;</span>
+							<?php 
+								$total_pay_external = @$total_expenses;
+								//จากเงินกู้ ATM
+								if(@$check_type_loan == 'loan_atm'){
+									$total_pay_in = @$total_month+$total_month_interest+(@$total_paid_per_month+@$interest_30_day);
+									//$total_pay_in = @$total_month+(@$total_paid_per_month+@$interest_30_day);
+									//echo @$total_month.'+'.$total_month_interest.'+('.@$total_paid_per_month.'+'.@$interest_30_day.')<hr>';
+								}else{								
+									//ถ้าเขาหักกลบก็เอารายเดือนยอดใหม่เลย แต่ถ้าไม่หักกลบก็ต้องเอายอดที่ต้องผ่อนหนี้เก่ามาด้วย
+									if(!empty($list_old_loan)){
+										$type_offset = 1; //0=ไม่หักกลบ,1=หักลบ  
+									}else{
+										$type_offset = 0; //0=ไม่หักกลบ,1=หักลบ  
+									}		
+									
+									if($type_offset == 0){
+										//$total_pay_in = @$total_month+@$total_paid_per_month;
+										//ค่าหุ้น600+งวดสามัญ ต้น10779+งวดสามัญ ดอก12221 และเงินงวดฉุกเฉินที่กู้ใหม่คือ 600+66 เป็นค่าใช้จ่ายภายในสหกรณ์
+										$total_pay_in = @$total_month+@$total_month_interest;
+										if(@$_GET['dev'] == 'dev'){
+											echo @$pay_type_id.'<br>';
+											echo @$pay_type.'<hr>';
+											$total_pay_in_a = @$total_month+@$total_month_interest+@$total_paid_per_month+@$interest_30_day;
+											echo @$total_month.'+'.@$total_month_interest.'+'.@$total_paid_per_month.'+'.@$interest_30_day.'<br>';
+											echo $total_pay_in_a.'<br>';
+
+										}
+					
+									}else if($type_offset == 1){
+										$loan_list_loan = 0;
+										$loan_list_loan_interest = 0;
+										foreach($list_old_loan AS $key_old=>$value_old){
+										    if(sizeof($arr_list_loan)) {
+                                                foreach ($arr_list_loan AS $key_list => $value_list) {
+                                                    //echo '<pre>'; print_r($value_list); echo '</pre>';
+                                                    if ($value_old['loan_id'] == $value_list['loan_id']) {
+                                                        $loan_list_loan += @$value_list['loan_principle'];
+                                                        $loan_list_loan_interest += @$value_list['loan_interest'];
+                                                    }
+                                                }
+                                            }
+										}
+										//ตัวอย่างการคิดยอดหักภายในสหกรณ์( สามัญต้น 5000+ดอก 7228+หุ้น1000+ฉฉที่กู้ใหม่ 4600+520
+										if($this->Setting_model->get("display_deduct_in_coop_report_loan_detail_preview")==1){
+											$total_pay_in = (@$total_month + $total_month_interest - @$loan_list_loan - @$loan_list_loan_interest);
+										}else{
+											$total_pay_in = (@$total_month + $total_month_interest - @$loan_list_loan - @$loan_list_loan_interest)+@$total_paid_per_month+@$interest_30_day;
+										}
+										/*
+											2019_02_15 แก้ไข เงื่อนไข การณีชำระแบบคงต้น
+											ค่าใช้จ่ายภายในสหกรณ์
+											1.เงินกู้ใหม่ เงินต้น 4,700 บาท
+											2.เงินกู้ใหม่ ดอกเบี้ย 6,837 บาท
+											3.หุ้นรายเดือน 600 บาท
+											รวมเป็น 12,137 บาท
+										*/
+										if(@$_GET['dev'] == 'dev'){
+											echo @$pay_type_id.'<br>';
+											echo @$pay_type.'<hr>';
+											$total_pay_in_a = (@$total_month + $total_month_interest - @$loan_list_loan - @$loan_list_loan_interest)+@$total_paid_per_month+@$interest_30_day;
+											echo '('.@$total_month.' + '.$total_month_interest.' - '.@$loan_list_loan.' - '.@$loan_list_loan_interest.')+'.@$total_paid_per_month.'+'.@$interest_30_day.'<br>';
+											echo $total_pay_in_a.'<br>';
+
+										}
+
+										//$total_pay_in = (@$total_month - @$loan_list_loan)+@$total_paid_per_month+@$interest_30_day;
+										//echo $total_pay_in.'<hr>';
+										//echo '('.@$total_month.' + '.$total_month_interest.' - '.@$loan_list_loan.' - '.@$loan_list_loan_interest.')+'.@$total_paid_per_month.'+'.@$interest_30_day.'<br>'; 
+									}	
+								}
+								
+								$total_pay_all = @$total_pay_external+@$total_pay_in;
+								$total_amount_all = @$total_income-@$total_pay_all;
+								$percent_amount_all = @(@$total_amount_all*100/@$total_income);
+							?>
+							<table class="bordered">
+									<tr>
+										<th>รายการ</th>        
+										<th style="width:100px;">จำนวนเงิน (บาท)</th>
+									</tr>
+									<tr>
+										<td>รวมค่าใช้จ่ายภายนอก</td>        
+										<td style="text-align:right;"><?php echo (@$total_pay_external == 0)?"-":number_format(@$total_pay_external,2);?></td>
+									</tr> 
+									<tr>
+										<td>รวมค่าใช้จ่ายภายในสหกรณ์</td>        
+										<td style="text-align:right;"><?php echo (@$total_pay_in == 0)?"-":number_format(@$total_pay_in,2);?></td>
+									</tr> 
+									<tr>
+										<td class="font-bold">รวมค่าใช้จ่ายทั้งสิน</td>        
+										<td class="font-bold" style="text-align:right;"><?php echo (@$total_pay_all == 0)?"-":number_format(@$total_pay_all,2);?></td>
+									</tr>  
+									<tr>
+										<td class="font-bold">คงเหลือ <?php echo number_format(@$total_income,2);?> - <?php echo number_format(@$total_pay_all,2);?></td>        
+										<td class="font-bold" style="text-align:right;"><?php echo (@$total_amount_all == 0)?"-":number_format(@$total_amount_all,2);?></td>
+									</tr> 
+									<tr>      
+										<td class="font-bold border-top" style="text-align:center;">คิดเป็น</td>
+										<td class="font-bold border-top" style="text-align:right;"><?php echo (@$percent_amount_all <= 0)?"-":number_format(@$percent_amount_all,2).'  %';?></td>
+									</tr> 
+							</table>
+						</td>
+					</tr>
+				</table>
+                <?php if(@$person_guarantee == '1' && false){ ?>
+				<table style="margin: 5px;">
+					<tr>
+						<td style="width:50%">
+							<table class="signature_part">
+								<tr><td>&nbsp;</td></tr>
+								<tr><td>&nbsp;</td></tr>
+								<tr><td>ลงชื่อ......................................จนท.ฝ่ายสินเชื่อฯ</td></tr>
+								<tr><td>&nbsp;</td></tr>
+								<tr><td>&nbsp;</td></tr>
+								<tr><td>ลงชื่อ......................................ผู้ช่วยผู้จัดการฝ่ายคอมฯ</td></tr>
+								<tr><td>&nbsp;</td></tr>
+								<tr><td>&nbsp;</td></tr>
+								<tr><td>จึงเรียน คณะกรรมการเงินกู้เพื่อโปรดพิจารณาอนุมัติ ให้แก้สมาชิกต่อไป</td></tr>
+								<tr><td>&nbsp;</td></tr>
+								<tr><td>&nbsp;</td></tr>
+								<tr><td class="text-center">ขอแสดงความนับถือ</td></tr>
+								<tr><td>&nbsp;</td></tr>
+								<tr><td>&nbsp;</td></tr>
+								<tr><td class="text-center">(<?php echo $boards["vice_manager"]["name"]?>)</td></tr>
+								<tr><td class="text-center">รองผู้จัดการ</td></tr>
+								<tr><td class="text-center">ปฏิบัติหน้าที่แทน ผจก.</td></tr>
+							</table>
+						</td>
+                        <?php if(isset($boards['boards']) && sizeof($boards["boards"]) >= 1){ ?>
+						<td style="width:50%;">
+							<table class="signature_part" style="margin-left:50px;">
+								<?php
+									$i = 1;
+									foreach($boards["boards"] as $board) {
+								?>
+									<tr><td>&nbsp;</td></tr>
+									<tr><td><?php echo $i++;?>. ลงชื่อ......................................(<?php echo $board["name"];?>)</td></tr>
+									<tr><td>&nbsp;</td></tr>
+								<?php
+									}
+								?>
+
+							</table>
+						</td>
+                        <?php } ?>
+					<tr>
+				</table>
+                <?php } ?>
+			</div>
+		</div>
+		<!--page 2-->
+		<div style="width: 1000px;">
+			<div class="panel panel-body" style="padding-top:10px !important;height: 1400px;">
+				<table style="width: 100%;">
+					<tr>
+						<td style="width:100px;vertical-align: top;">
+							<img src="<?php echo base_url(PROJECTPATH.'/assets/images/coop_profile/'.$_SESSION['COOP_IMG']); ?>" alt="Logo" style="height: 80px;" />
+						</td>
+						<td>
+							 <h3 class="title_view"><?php echo @$_SESSION['COOP_NAME'];?></h3>
+							 <h3 class="title_view">รายละเอียดการขอกู้เงิน <?php echo @$type_loan;?></h3>
+							<p>&nbsp;</p>	
+						 </td>
+						 <td style="width:250px;vertical-align: top;" class="text-right">
+							<div class="group-box">
+								<span>เลขที่คำขอ</span>	
+								<div class="border-bottom-dotted" style="width: 156px;text-align: center;">&nbsp;<?php echo @$petition_number;?></div>	
+							</div>		
+							<div class="group-box">
+								<span>วันที่</span>	
+								<div class="border-bottom-dotted" style="width: 181px;text-align: center;">&nbsp;<?php echo $this->center_function->ConvertToThaiDate(@$row_loan['createdatetime'],0,0);?></div>	
+							</div>	
+						 </td>
+					</tr> 
+					<tr>
+						<td colspan="3">
+							<h3 class="title_view">
+							</h3>
+						</td>
+					</tr> 
+				</table>
+				<table>
+					<tr>
+						<td style="vertical-align: top;">
+							<div class="box-radius" style="width:520px;">
+								<div class="group-box">
+									<span>รหัสสมาชิก</span>	
+									<div class="border-bottom-dotted" style="width: 110px;text-align: center;">&nbsp;<?php echo @$row_member['member_id'];?></div>	
+									<span>ชื่อ - นามสกุล</span>	
+									<div class="border-bottom-dotted" style="width: 252px;text-align: center;">&nbsp;<?php echo @$row_member['firstname_th'].'  '.@$row_member['lastname_th'];?></div>	
+								</div>
+								<div class="group-box">
+									<span>สังกัด</span>	
+									<div class="border-bottom-dotted" style="width: 476px;text-align: center;">&nbsp;<?php echo (empty($row_member['department_name']))?"-":@$row_member['department_name'];?></div>	
+								</div>								
+								<div class="group-box">
+									<span>หน่วยงาน</span>	
+									<div class="border-bottom-dotted" style="width: 453px;text-align: center;">&nbsp;<?php echo (empty($row_member['faction_name']))?"-":@$row_member['faction_name'];?></div>	
+								</div>								
+								<div class="group-box">
+									<span>กลุ่ม</span>
+									<div class="border-bottom-dotted" style="width: 207px;text-align: center;">&nbsp;<?php echo (empty($row_member['level_name']))?"-":@$row_member['level_name'];?></div>	
+									<span>รูปแบบสมาชิก</span>	
+									<div class="border-bottom-dotted" style="width: 194px;text-align: center;">&nbsp;<?php echo (empty($row_member['mem_type_name']))?"-":@$row_member['mem_type_name'];?></div>
+								</div>								
+								<div class="group-box">
+									<span>ว/ด/ป เกิด</span>	
+									<div class="border-bottom-dotted" style="width: 181px;text-align: center;">&nbsp;<?php echo $this->center_function->ConvertToThaiDate(@$row_member['birthday'],0,0);?></div>	
+									<span>อายุ</span>
+									<div class="border-bottom-dotted" style="width: 70px;text-align: center;">&nbsp;<?php echo $this->center_function->diff_birthday(@$row_member['birthday']);?></div>
+									<span>ปี</span>
+								</div>
+								<!--<div class="group-box">
+									<span>มีการกำหนดกรณีไม่ผ่านเกณฑ์</span>	
+									<div class="border-bottom-dotted" style="width: 384px;text-align: center;">&nbsp;<?php echo (@$deduct_person_guarantee == 0)?"-":number_format(@$deduct_person_guarantee,2)." บาท";?></div>
+								</div>
+								<div class="group-box">
+									<span>ค่าธรรมเนียม</span>	
+									<div class="border-bottom-dotted" style="width: 452px;text-align: center;">&nbsp;<?php echo (@$deduct_loan_fee == 0)?"-":number_format(@$deduct_loan_fee,2)." บาท";?></div>	
+								</div>-->
+								<div class="group-box" style="width: 100%;">
+									<span>&nbsp;</span>	
+									<div style="border-bottom: 1px dotted #ffffff;">&nbsp;</div>	
+								</div>
+								<div class="group-box" style="width: 100%;">
+									<span>&nbsp;</span>	
+									<div style="border-bottom: 1px dotted #ffffff;">&nbsp;</div>	
+								</div>
+								<div class="group-box">
+									<span>&nbsp;</span>	
+									<div>&nbsp;</div>	
+								</div>	
+							</div>
+						</td>
+						<td style="padding-left: 5px;vertical-align: top;">
+							<div class="box-radius" style="width:430px; min-height: 188px;">
+								<div class="group-box">
+									<span>รูปแบบดอกเบี้ย</span>	
+									<div class="border-bottom-dotted" style="width: 190px;text-align: center;">&nbsp;<?php echo @$pay_type;?></div>
+									<span>อัตราดอกเบี้ย</span>	
+									<div class="border-bottom-dotted" style="width: 60px;text-align: center;">&nbsp;<?php echo  (@$row_loan['interest_per_year'] == 0)?"-":number_format(@$row_loan['interest_per_year'],2)." %";?></div>	
+								</div>	
+								<div class="group-box">
+									<span>วงเงินที่ขออนุมัติ</span>	
+									<div class="border-bottom-dotted" style="width: 130px;text-align: right;"><?php echo (@$row_loan['loan_amount'] == 0)?"-":number_format(@$row_loan['loan_amount'],2);?>&nbsp;</div>
+									<span>บาท&nbsp;&nbsp;&nbsp;</span>										
+									<span>จำนวนงวด</span>	
+									<div class="border-bottom-dotted" style="width: 65px;text-align: center;">&nbsp;<?php echo (@$row_loan['period_amount'] == '')?"-":@$row_loan['period_amount'];?></div>
+									<span>งวด</span>	
+								</div>
+								<div class="group-box">
+									<span>ผ่อนต่อเดือน</span>	
+									<div class="border-bottom-dotted" style="width: 152px;text-align: right;"><?php echo (@$total_paid_per_month == 0)?"-":number_format(@$total_paid_per_month,2);?>&nbsp;</div>
+									<span>บาท</span>	
+								</div>	
+								<div class="group-box">
+									<span>หักเงินกู้เดิม</span>	
+									<div class="border-bottom-dotted" style="width: 156px;text-align: right;"><?php echo (@$existing_loan == 0)?"-":number_format(@$existing_loan,2);?>&nbsp;</div>
+									<span>บาท</span>	
+								</div>	
+<!--								<div class="group-box">-->
+<!--									<span>ภาระเงินต้น</span>	-->
+<!--									<div class="border-bottom-dotted" style="width: 158px;text-align: right;">--><?php //echo (@$principal_load == 0)?"-":number_format(@$principal_load,2);?><!--&nbsp;</div>-->
+<!--									<span>บาท</span>	-->
+<!--								</div>	-->
+<!--								<div class="group-box">-->
+<!--									<span>ภาระดอกเบี้ย</span>	-->
+<!--									<div class="border-bottom-dotted" style="width: 149px;text-align: right;">--><?php //echo (@$interest_burden == 0)?"-":number_format(@$interest_burden,2);?><!--&nbsp;</div>-->
+<!--									<span>บาท</span>	-->
+<!--								</div>	-->
+								<div class="group-box">
+									<span>ดอกเบี้ย</span>
+									<div class="border-bottom-dotted" style="width: 177px;text-align: right;"><?php echo (@$deductible == 0)?"-":number_format($deductible,2);?>&nbsp;</div>
+									<span>บาท</span>	
+								</div>									
+								<div class="group-box text-red">
+									<span class="text-red">ยอดรับสุทธิ</span>	
+									<div class="border-bottom-dotted-red" style="width: 159px;text-align: right;"><?php echo (@$total_amount == 0)?"-":number_format(@$total_amount,2);?>&nbsp;</div>
+									<span class="text-red">บาท</span>	
+								</div>	
+							</div>
+						</td>
+					</tr>
+				</table>
+				
+				
+				<!-- <div style="text-align: left;width: 955px;">
+					<span class="text-title">บุคคลค้ำประกัน</span>
+				</div>	
+				<table class="bordered" style="width: 955px;">
+					<tr>
+						<td style="width: 150px;">&nbsp;</td>
+						<td style="height: 150px;border-left: 0px;padding-top: 10px;padding-bottom: 10px;">
+								<table  class="no-border">
+								<?php
+								//echo '<pre>'; print_r(@$row_guarantee); echo '</pre>';
+								$guarantee_no = 0;
+								foreach(@$row_guarantee AS $key=>$guarantee){
+									$guarantee_no++;
+								?>
+									<tr>
+										<td>
+											ผู้ค้ำลำดับที่ <?php echo @$guarantee_no;?>
+										</td>
+										<td>
+											<?php echo @$guarantee['guarantee_person_id'];?>
+										</td>
+										<td>
+											ชื่อ-สกุล
+										</td>
+										<td>
+											<?php echo @$guarantee['firstname_th']." ".@$guarantee['lastname_th'];?>									
+										</td>
+										<td>
+											สังกัด
+										</td>
+										<td>
+											<?php echo @$guarantee['mem_group_name'];?>
+										</td>
+									</tr>
+									<tr>
+										<td>
+											ภาระค้ำประกัน
+										</td>
+										<td>
+											<?php echo (@$guarantee['guarantee_person_amount'] == 0)?"-":number_format(@$guarantee['guarantee_person_amount'],2);?>
+										</td>
+										<td colspan="3"> -->
+											<!--ค้ำแล้ว
+											<?php echo @$guarantee['count_guarantee'];?>	
+											สัญญา
+											-->
+										<!-- </td>
+									</tr>
+								<?php	
+								}
+								?>	
+								</table>							
+						</td> 
+						<td style="border-left: 0px;">&nbsp;</td>
+					</tr>								  
+				</table> -->
+				
+				<!-- <div style="text-align: left;width: 955px;">
+					<span class="text-title">อสังหาทรัพย์ค้ำประกัน</span>
+				</div>	
+				<table class="bordered" style="width: 955px;">
+					<tr>
+						<td style="width: 150px;">&nbsp;</td>
+						<td style="height: 150px;border-left: 0px;padding-top: 10px;padding-bottom: 10px;">
+								<?php if(!empty($row_real_estate)){?>
+								<table  class="no-border">
+									<tr>
+										<td colspan="3" class="font-bold">										
+											ตำแหน่งที่ดิน
+										</td>
+									</tr>	
+									<tr>
+										<td>
+											ระวาง 
+											
+											<?php echo @$row_real_estate['real_estate_position_1'];?>										
+											|||
+											<?php echo @$row_real_estate['real_estate_position_2'];?>
+										</td>
+										<td>เลขที่ดิน <?php echo @$row_real_estate['land_number'];?></td>
+										<td>หน้าสำรวจ <?php echo @$row_real_estate['survey_page'];?></td>
+									</tr>	
+									<tr>
+										<td>จังหวัด <?php echo @$row_real_estate['province_name'];?></td>
+										<td>อำเภอ <?php echo @$row_real_estate['amphur_name'];?></td>
+										<td>ตำบล <?php echo @$row_real_estate['district_name'];?></td>
+									</tr>	
+									<tr>
+										<td colspan="3" class="font-bold">โฉนดที่ดิน</td>
+									</tr>	
+									<tr>
+										<td>เลขที่ <?php echo @$row_real_estate['deed_number'];?></td>
+										<td>เล่ม <?php echo @$row_real_estate['deed_book'];?></td>
+										<td>หน้า <?php echo @$row_real_estate['deed_page'];?></td>
+									</tr>	
+									<tr>
+										<td>จำนวนที่ดิน <?php echo @$row_real_estate['rai'];?>  ไร่</td>
+										<td><?php echo @$row_real_estate['ngan'];?> งาน</td>
+										<td><?php echo @$row_real_estate['tarangwah'];?> ตารางวา</td>
+									</tr>
+								</table>
+							<?php }?>		
+						</td> 
+						<td style="border-left: 0px;">&nbsp;</td>
+					</tr>								  
+				</table>
+				
+				<div class="text-title">&nbsp;</div>
+				<div class="text-title">&nbsp;</div>
+				<table style="width: 955px;">
+					<tr>
+						<td>
+							<div class="box-radius" style="width:475px;height: 300px;vertical-align: top;padding-left:10px;">
+								<div>&nbsp;</div>
+								<div class="group-box">
+									<span>ลงชื่อ</span>	
+									<div class="border-bottom-dotted" style="width: 350px;">&nbsp;</div>
+									<span>ผู้ทำรายการ</span>	
+								</div>	
+								<div style="text-align: center;"><span><?php echo @$row_loan['admin_name'];?></span></div>
+							</div>	
+						</td>
+						<td style="padding-left: 5px;">	
+							<div class="box-radius" style="width:475px;height: 300px;vertical-align: top;padding-left:10px;">
+								<div>&nbsp;</div>
+								<div class="group-box">
+									<span>ลงชื่อ</span>	
+									<div class="border-bottom-dotted" style="width: 410px;">&nbsp;</div>
+								</div>
+																
+								<div class="group-box" style="margin-left: 20px;">											
+									<span>(</span>	
+									<div class="border-bottom-dotted" style="width: 410px;">&nbsp;</div>
+									<span>)</span>
+								</div>
+								<div style="text-align: center;"><span>หัวหน้าฝ่ายสินเชื่อ</span></div>	
+					
+								<div>&nbsp;</div>
+								<div class="group-box">
+									<span>ลงชื่อ</span>	
+									<div class="border-bottom-dotted" style="width: 410px;">&nbsp;</div>
+								</div>
+																
+								<div class="group-box" style="margin-left: 20px;">											
+									<span>(</span>	
+									<div class="border-bottom-dotted" style="width: 410px;">&nbsp;</div>
+									<span>)</span>
+								</div>
+								<div style="text-align: center;"><span>รองผู้จัดการฝ่ายบริหาร</span></div>	
+							
+								<div>&nbsp;</div>
+								<div class="group-box">
+									<span>ลงชื่อ</span>	
+									<div class="border-bottom-dotted" style="width: 410px;">&nbsp;</div>
+								</div>
+												
+								<div class="group-box" style="margin-left: 20px;">											
+									<span>(</span>	
+									<div class="border-bottom-dotted" style="width: 410px;">&nbsp;</div>
+									<span>)</span>
+								</div>
+								<div style="text-align: center;"><span>ผู้จัดการ</span></div>								
+							</div>
+						</td> 	
+					</tr>								  
+				</table>			
+				
+				<span class="text-title">&nbsp;</span>
+				<table class="bordered"  style="width: 955px;">
+					<tr>
+						<td style="width:320px;"></td>
+						<td style="border-left: 0px;">
+							<div>&nbsp;</div>
+							<table>
+								<tr>
+									<td>
+										<div class="group-box">											
+											<span>อนุมัติให้กู้ได้</span>	
+											<div class="border-bottom-dotted" style="width: 363px;text-align:center;">&nbsp;<?php echo (@$row_loan['loan_amount'] == 0)?"-":number_format(@$row_loan['loan_amount'],2);?></div>
+											<span>บาท</span>	
+										</div>	
+									</td> 
+								</tr>
+								<tr>
+									<td>
+										<div>&nbsp;</div>
+										<div class="group-box">
+											<span>ลงชื่อ</span>	
+											<div class="border-bottom-dotted" style="width: 405px;">&nbsp;</div>
+										</div>
+									</td> 
+								</tr>
+								<tr>
+									<td>											
+										<div class="group-box" style="margin-left: 28px;">											
+											<span>(</span>	
+											<div class="border-bottom-dotted" style="width: 405px;">&nbsp;</div>
+											<span>)</span>
+										</div>
+									</td> 
+								</tr>
+								<tr>
+									<td style="text-align: center;">										
+										<div class="group-box">
+											<span>ประธานฝ่ายการเงินและสินเชื่อ</span>	
+										</div>	
+									</td> 
+								</tr>
+							</table>
+							<div>&nbsp;</div>
+						</td>
+						<td style="width:320px;border-left: 0px;"></td>
+					</tr>								
+				</table> -->
+				
+			</div>
+		</div>
+
+		<!-- loanee info -->
+		<div style="width: 1000px;">
+			<div class="panel panel-body" style="padding-top:10px !important;height: 1400px;">
+				<table style="width: 100%;">
+					<tr>
+						<td style="width:100px;vertical-align: top;">
+							<img src="<?php echo base_url(PROJECTPATH.'/assets/images/coop_profile/'.$_SESSION['COOP_IMG']); ?>" alt="Logo" style="height: 80px;" />
+						</td>
+						<td>
+							 <h3 class="title_view"><?php echo @$_SESSION['COOP_NAME'];?></h3>
+							 <h3 class="title_view">รายการแจ้งหุ้นหนี้สมาชิก ประจำวันที่ <?php echo $this->center_function->ConvertToThaiDate(@$row_loan['createdatetime'],0,0);?></h3>
+							<p>&nbsp;</p>	
+						 </td>
+					</tr> 
+					<tr>
+						<td colspan="3">
+							<h3 class="title_view">
+							</h3>
+						</td>
+					</tr> 
+				</table>
+				<div>&nbsp;</div>
+				<table style="width: 100%;" class="no-border-b">
+					<tr>
+						<td style="width:10%;" class="text-center">
+							ชื่อสมาชิก
+						</td>
+						<td>
+							<?php echo $row_member["prename_full"].$row_member["firstname_th"]." ".$row_member["lastname_th"];?>
+						</td>
+						<td style="width:10%;" class="text-center">
+							เลขที่สมาชิก
+						</td>
+						<td style="width:10%;" class="text-center">
+							<?php echo $row_member["member_id"];?>
+						</td>
+					<tr>
+					<tr>
+						<td style="width:10%;" class="text-center">
+							สังกัด
+						</td>
+						<td>
+							<?php echo $row_member["level_name"];?>
+						</td>
+						<td style="width:10%;" class="text-center">
+						</td>
+						<td style="width:10%;" class="text-center">
+						</td>
+					<tr>
+				</table>
+				<div>&nbsp;</div>
+				<div>&nbsp;</div>
+				<table style="width: 100%;"  class="bordered">
+					<tr>
+						<th>เงินเดือน</th>
+						<th>ระยะเวลาเป็นสมาชิก</th>
+						<th>หุ้นงวดที่</th>
+						<th>หุ้นชำระต่อเดือน</th>
+						<th>ทุนเรือนหุ้น</th>
+					</tr>
+					<tr>
+						<td class="text-right"><?php echo number_format($row_member["salary"],2);?></td>
+						<td class="text-center"><?php
+							echo $this->center_function->cal_age(@$row_member["member_date"], 'y')." ปี ";
+							echo !empty($this->center_function->cal_age(@$row_member["member_date"], 'm')) ? $this->center_function->cal_age(@$row_member["member_date"], 'm')." เดือน" : "";
+						?></td>
+						<td class="text-right"><?php echo number_format($share_period,2);?></td>
+						<td class="text-right"><?php echo number_format($share_month,2);?></td>
+						<td class="text-right"><?php echo number_format($cal_share,2);?></td>
+					</tr>
+				</table>
+				<div>&nbsp;</div>
+				<div>&nbsp;</div>
+				<?php
+					if(!empty($guarantors)) {
+				?>
+				<table style="width: 100%;" class="no-border-b">
+					<tr>
+						<th class="text-left text-title" colspan="4">
+							รายการค้ำประกัน
+						</th>
+					<tr>
+				</table>
+				<table style="width: 100%;" class="bordered">
+					<tr>
+						<th style="width:20%;" class="text-center text-title">
+							เลขที่สมาชิก
+						</th>
+						<th style="width:20%;" class="text-center text-title">
+							เลขที่สัญญา
+						</th>
+						<th class="text-center text-title">
+							ชื่อสมาชิก
+						</th>
+					<tr>
+					<?php
+						foreach($guarantors as $guarantor) {
+					?>
+					<tr>
+						<td class="text-center">
+							<?php echo $guarantor["member_id"];?>
+						</td>
+						<td class="text-center">
+							<?php echo $guarantor["contract_number"];?>
+						</td>
+						<td class="text-left" style="padding-left: 100px;">
+							<?php echo $guarantor["prename_full"].$guarantor["firstname_th"]." ".$guarantor["lastname_th"];?>
+						</td>
+					<tr>
+					<?php
+						}
+					?>
+				</table>
+				<?php
+					}
+				?>
+				<div>&nbsp;</div>
+				<div>&nbsp;</div>
+				<?php
+					if(!empty($loans)) {
+				?>
+				<table style="width: 100%;" class="no-border-b">
+					<tr>
+						<th class="text-left" colspan="9">
+							รายการสัญญาเงินกู้
+						</th>
+					<tr>
+				</table>
+				<table style="width: 100%;" class="bordered">
+					<tr>
+						<th class="text-center text-title">
+							เลขที่สัญญา
+						</th>
+						<th class="text-center text-title">
+							วันที่ทำสัญญา
+						</th>
+						<th class="text-center text-title">
+							ชำระล่าสุด
+						</th>
+						<th class="text-center text-title">
+							จำนวนเงินกู้
+						</th>
+						<th class="text-center text-title">
+							เงินชำระต่องวด
+						</th>
+						<th class="text-center text-title">
+							จำนวนงวด
+						</th>
+						<th class="text-center text-title">
+							งวดที่ชำระ
+						</th>
+						<th class="text-center text-title">
+							เงินกู้ชำระแล้ว
+						</th>
+						<th class="text-center text-title">
+							เงินกู้คงเหลือ
+						</th>
+					<tr>
+					<?php
+						foreach($loans as $loan) {
+					?>
+					<tr>
+						<td class="text-center">
+							<?php echo $loan["contract_number"];?>
+						</td>
+						<td class="text-center">
+							<?php echo $this->center_function->ConvertToThaiDate(@$row_loan['approve_date'],0,0);?>
+						</td>
+						<td class="text-center">
+							<?php echo $this->center_function->ConvertToThaiDate(@$row_loan['date_last_interest'],0,0);?>
+						</td>
+						<td class="text-center">
+							<?php echo number_format($loan["loan_amount"],2);?>
+						</td>
+						<td class="text-center">
+							<?php echo $loan["money_per_period"]?>
+						</td>
+						<td class="text-center">
+							<?php echo $loan["period_amount"]?>
+						</td>
+						<td class="text-center">
+							<?php echo $loan["period_now"];?>
+						</td>
+						<td class="text-center">
+							<?php echo number_format($loan["loan_amount"] - $loan["balance"],2);?>
+						</td>
+						<td class="text-center">
+							<?php echo number_format($loan["balance"],2);?>
+						</td>
+					<tr>
+					<?php
+						}
+					?>
+				</table>	
+				<?php
+					}
+				?>
+				<div>&nbsp;</div>
+				<div>&nbsp;</div>
+				<table style="width: 100%;" class="no-border-b">
+					<tr>
+						<th class="text-right" colspan="9">
+							สมาชิกผู้กู้
+						</th>
+					<tr>
+				</table>
+			</div>
+		</div>
+
+		<!-- guarantor info -->
+		<?php
+			foreach($row_guarantee as $guarantee) {
+		?>
+		<div style="width: 1000px;">
+			<div class="panel panel-body" style="padding-top:10px !important;height: 1400px;">
+				<table style="width: 100%;">
+					<tr>
+						<td style="width:100px;vertical-align: top;">
+							<img src="<?php echo base_url(PROJECTPATH.'/assets/images/coop_profile/'.$_SESSION['COOP_IMG']); ?>" alt="Logo" style="height: 80px;" />
+						</td>
+						<td>
+							 <h3 class="title_view"><?php echo @$_SESSION['COOP_NAME'];?></h3>
+							 <h3 class="title_view">รายการแจ้งหุ้นหนี้สมาชิก ประจำวันที่ <?php echo $this->center_function->ConvertToThaiDate(@$row_loan['createdatetime'],0,0);?></h3>
+							<p>&nbsp;</p>	
+						 </td>
+					</tr> 
+					<tr>
+						<td colspan="3">
+							<h3 class="title_view">
+							</h3>
+						</td>
+					</tr> 
+				</table>
+				<div>&nbsp;</div>
+				<table style="width: 100%;" class="no-border-b">
+					<tr>
+						<td style="width:10%;" class="text-center">
+							ชื่อสมาชิก
+						</td>
+						<td>
+							<?php echo $guarantee["prename_full"].$guarantee["firstname_th"]." ".$guarantee["lastname_th"];?>
+						</td>
+						<td style="width:10%;" class="text-center">
+							เลขที่สมาชิก
+						</td>
+						<td style="width:10%;" class="text-center">
+							<?php echo $guarantee["member_id"];?>
+						</td>
+					<tr>
+					<tr>
+						<td style="width:10%;" class="text-center">
+							สังกัด
+						</td>
+						<td>
+							<?php echo $guarantee["mem_group_name"];?>
+						</td>
+						<td style="width:10%;" class="text-center">
+						</td>
+						<td style="width:10%;" class="text-center">
+						</td>
+					<tr>
+				</table>
+				<div>&nbsp;</div>
+				<div>&nbsp;</div>
+				<table style="width: 100%;"  class="bordered">
+					<tr>
+						<th>เงินเดือน</th>
+						<th>ระยะเวลาเป็นสมาชิก</th>
+						<th>หุ้นงวดที่</th>
+						<th>หุ้นชำระต่อเดือน</th>
+						<th>ทุนเรือนหุ้น</th>
+					</tr>
+					<tr>
+						<td class="text-right"><?php echo number_format($guarantee["salary"],2);?></td>
+						<td class="text-center"><?php
+							echo $this->center_function->cal_age(@$guarantee["member_date"], 'y')." ปี ";
+							echo !empty($this->center_function->cal_age(@$guarantee["member_date"], 'm')) ? $this->center_function->cal_age(@$guarantee["member_date"], 'm')." เดือน" : "";
+						?></td>
+						<td class="text-right"><?php echo number_format($guarantee['share_period'],2);?></td>
+						<td class="text-right"><?php echo number_format($guarantee['share_month'],2);?></td>
+						<td class="text-right"><?php echo number_format($guarantee['share_balance'],2);?></td>
+					</tr>
+				</table>
+				<div>&nbsp;</div>
+				<div>&nbsp;</div>
+				<?php
+					if(!empty($guarantee['guarantors'])) {
+				?>
+				<table style="width: 100%;" class="no-border-b">
+					<tr>
+						<th class="text-left text-title" colspan="4">
+							รายการค้ำประกัน
+						</th>
+					<tr>
+				</table>
+				<table style="width: 100%;" class="bordered">
+					<tr>
+						<th style="width:20%;" class="text-center text-title">
+							เลขที่สมาชิก
+						</th>
+						<th style="width:20%;" class="text-center text-title">
+							เลขที่สัญญา
+						</th>
+						<th class="text-center text-title">
+							ชื่อสมาชิก
+						</th>
+					<tr>
+					<?php
+						foreach($guarantee['guarantors'] as $guarantor) {
+					?>
+					<tr>
+						<td class="text-center">
+							<?php echo $guarantor["member_id"];?>
+						</td>
+						<td class="text-center">
+							<?php echo $guarantor["contract_number"];?>
+						</td>
+						<td class="text-left" style="padding-left: 100px;">
+							<?php echo $guarantor["prename_full"].$guarantor["firstname_th"]." ".$guarantor["lastname_th"];?>
+						</td>
+					<tr>
+					<?php
+						}
+					?>
+				</table>
+				<?php
+					}
+				?>
+				<div>&nbsp;</div>
+				<div>&nbsp;</div>
+				<?php
+					if(!empty($guarantee['loans'])) {
+				?>
+				<table style="width: 100%;" class="no-border-b">
+					<tr>
+						<th class="text-left" colspan="9">
+							รายการสัญญาเงินกู้
+						</th>
+					<tr>
+				</table>
+				<table style="width: 100%;" class="bordered">
+					<tr>
+						<th class="text-center text-title">
+							เลขที่สัญญา
+						</th>
+						<th class="text-center text-title">
+							วันที่ทำสัญญา
+						</th>
+						<th class="text-center text-title">
+							ชำระล่าสุด
+						</th>
+						<th class="text-center text-title">
+							จำนวนเงินกู้
+						</th>
+						<th class="text-center text-title">
+							เงินชำระต่องวด
+						</th>
+						<th class="text-center text-title">
+							จำนวนงวด
+						</th>
+						<th class="text-center text-title">
+							งวดที่ชำระ
+						</th>
+						<th class="text-center text-title">
+							เงินกู้ชำระแล้ว
+						</th>
+						<th class="text-center text-title">
+							เงินกู้คงเหลือ
+						</th>
+					<tr>
+					<?php
+						foreach($guarantee['loans'] as $loan) {
+					?>
+					<tr>
+						<td class="text-center">
+							<?php echo $loan["contract_number"];?>
+						</td>
+						<td class="text-center">
+							<?php echo $this->center_function->ConvertToThaiDate(@$row_loan['approve_date'],0,0);?>
+						</td>
+						<td class="text-center">
+							<?php echo $this->center_function->ConvertToThaiDate(@$row_loan['date_last_interest'],0,0);?>
+						</td>
+						<td class="text-center">
+							<?php echo number_format($loan["loan_amount"],2);?>
+						</td>
+						<td class="text-center">
+							<?php echo $loan["money_per_period"]?>
+						</td>
+						<td class="text-center">
+							<?php echo $loan["period_amount"]?>
+						</td>
+						<td class="text-center">
+							<?php echo $loan["period_now"];?>
+						</td>
+						<td class="text-center">
+							<?php echo number_format($loan["loan_amount"] - $loan["balance"],2);?>
+						</td>
+						<td class="text-center">
+							<?php echo number_format($loan["balance"],2);?>
+						</td>
+					<tr>
+					<?php
+						}
+					?>
+				</table>	
+				<?php
+					}
+				?>
+				<div>&nbsp;</div>
+				<div>&nbsp;</div>
+				<table style="width: 100%;" class="no-border-b">
+					<tr>
+						<th class="text-right" colspan="9">
+							สมาชิกผู้ค้ำประกันเงินกู้
+						</th>
+					<tr>
+				</table>
+			</div>
+		</div>
+		<?php
+			}
+		?>
diff --git a/application/views/report_share_data/coop_report_share_loan_balance_level_preview.php b/application/views/report_share_data/coop_report_share_loan_balance_level_preview.php
index bda6d2f..725faab 100644
--- a/application/views/report_share_data/coop_report_share_loan_balance_level_preview.php
+++ b/application/views/report_share_data/coop_report_share_loan_balance_level_preview.php
@@ -16,7 +16,7 @@
 	    /*color: #000;	*/
 	}
 	.title_view_small{
-		font-size: 10px;Report_share_data
+		font-size: 10px;
 		font-family: THSarabunNew;	
 	    /*color: #000;*/
 	}	
diff --git a/application/views/report_share_data/coop_report_share_loan_balance_person_excel.php b/application/views/report_share_data/coop_report_share_loan_balance_person_excel.php
index e6cc488..878d898 100644
--- a/application/views/report_share_data/coop_report_share_loan_balance_person_excel.php
+++ b/application/views/report_share_data/coop_report_share_loan_balance_person_excel.php
@@ -145,6 +145,7 @@ $last_runno = 0;
 							<th class="table_header_top" rowspan="2" style="width: 70px;vertical-align: middle;">รหัสสังกัด</th>
 							<th class="table_header_top" rowspan="2" style="vertical-align: middle;">หน่วยงานหลัก::หน่วยงานรอง</th> 
 							<th class="table_header_top" rowspan="2" style="width: 150px;vertical-align: middle;">หน่วยงานย่อย</th> 
+							<th class="table_header_top" rowspan="2" style="width: 40px;vertical-align: middle;">ตำแหน่ง</th> 
 							<th class="table_header_top" rowspan="2" style="width: 40px;vertical-align: middle;">ลำดับ</th> 
 							<th class="table_header_top" rowspan="2" style="width: 40px;vertical-align: middle;">งวดหุ้น</th> 
 							<th class="table_header_top" rowspan="2" style="width: 90px;vertical-align: middle;">ทุนเรือนหุ้น</th> 
@@ -181,6 +182,13 @@ $last_runno = 0;
 						$all_total_loan_balance = 0;
 						$all_share_balance_subdivision = 0;
 						$all_loan_balance_subdivision = 0;
+                        $tmp['mem_group_id'] = array();
+                        $tmp['member_id'] = array();
+                        $member_count = 0;
+                        $sum_share = 0;
+                        $sum_emergent = 0;
+                        $sum_normal = 0;
+                        $sum_special = 0;
 						$member_id_past = "xx";
 						if(!empty($data)){
 							foreach(@$data as $da) {
@@ -190,6 +198,37 @@ $last_runno = 0;
 											$runno = 0;
 										}
 										$runno++;
+
+                            if(!empty($tmp['mem_group_id']) && $tmp['mem_group_id'] <> $row['mem_group_id'] ) {
+                                ?>
+                                <tr style='border-bottom: 2px double black;'>
+                                    <td class="table_body" style='text-align: center;vertical-align: top;mso-number-format:"\@";' colspan='5'>รวม</td>
+                                    <td class="table_body" colspan='2' style='text-align: right'><?php echo number_format($member_count); ?></td>
+                                    <td class="table_body" style='text-align: right'><?php echo number_format($sum_share,2); ?></td>
+                                    <td class="table_body" style='text-align: center;vertical-align: top;mso-number-format:"\@";' colspan='2'>รวม</td>
+                                    <td class="table_body" style='text-align: right'><?php echo number_format($sum_emergent, 2); ?></td>
+                                    <td class="table_body" style='text-align: center;vertical-align: top;mso-number-format:"\@";' colspan='2'>รวม</td>
+                                    <td class="table_body"  style='text-align: right'><?php echo number_format($sum_normal, 2); ?></td>
+                                    <td class="table_body" style='text-align: center;vertical-align: top;mso-number-format:"\@";' colspan='2'>รวม</td>
+                                    <td class="table_body" style='text-align: right'><?php echo number_format($sum_special, 2); ?></td>
+                                </tr>
+                    <?php
+                                $sum_share = 0;
+                                $sum_emergent = 0;
+                                $sum_normal = 0;
+                                $sum_special = 0;
+                                $member_count = 0;
+                                $index++;
+                            }
+                        $tmp['mem_group_id'] = $row['mem_group_id'];
+                        if(empty($tmp['member_id']) || $tmp['member_id'] <> $row['member_id']){
+                            $member_count += 1;
+                        }
+                        $sum_share += (int)$row['share_collect'];
+                        $sum_emergent += (int)$row['loan_emergent_balance'];
+                        $sum_normal += (int)$row['loan_normal_balance'];
+                        $sum_special += (int)$row['loan_special_balance'];
+                        $tmp['member_id'] = $row['member_id'];
 					?>					
 							
 							<tr> 
@@ -197,7 +236,8 @@ $last_runno = 0;
 							  <td class="table_body" style="text-align: left;vertical-align: top;"><?php echo @$row['prename_full'].@$row['firstname_th']."  ".@$row['lastname_th'];?></td>			 
 							  <td class="table_body" style='text-align: center;vertical-align: top;mso-number-format:"\@";'><?php echo @$row['mem_group_id'];?></td>				 
 							  <td class="table_body" style="text-align: left;vertical-align: top;"><?php echo (@$row['mem_group_name_main'] != '')?@$row['mem_group_name_main'].' :: '.@$row['mem_group_name_sub']:'';?></td>				 
-							  <td class="table_body" style="text-align: left;vertical-align: top;"><?php echo @$row['mem_group_name_level'];?></td>				 
+							  <td class="table_body" style="text-align: left;vertical-align: top;"><?php echo @$row['mem_group_name_level'];?></td>			
+							  <td class="table_body" style="text-align: right;vertical-align: top;"><?php echo @$row['position']; ?></td> 	 
 							  <td class="table_body" style="text-align: right;vertical-align: top;"><?php echo @$runno; ?></td> 		
 							  <?php
 							  	if($runno == '1') {
diff --git a/application/views/report_share_data/coop_report_share_loan_balance_person_preview.php b/application/views/report_share_data/coop_report_share_loan_balance_person_preview.php
index 989080f..f87c755 100644
--- a/application/views/report_share_data/coop_report_share_loan_balance_person_preview.php
+++ b/application/views/report_share_data/coop_report_share_loan_balance_person_preview.php
@@ -1,9 +1,3 @@
-<?php
- echo "<pre>";
- print_r($data);
- exit;
-?>
-
 <style>
 	.table {
 		font-size: 10px;
@@ -158,6 +152,7 @@
 							<th rowspan="2" style="width: 70px;vertical-align: middle;">รหัสสังกัด</th>
 							<th rowspan="2" style="vertical-align: middle;">หน่วยงานหลัก::หน่วยงานรอง</th> 
 							<th rowspan="2" style="width: 150px;vertical-align: middle;">หน่วยงานย่อย</th> 
+							<th rowspan="2" style="width: 150px;vertical-align: middle;">ตำแหน่ง</th> 
 							<th rowspan="2" style="width: 40px;vertical-align: middle;">ลำดับ</th> 
 							<th rowspan="2" style="width: 40px;vertical-align: middle;">งวดหุ้น</th> 
 							<th rowspan="2" style="width: 90px;vertical-align: middle;">ทุนเรือนหุ้น</th> 
@@ -204,7 +199,8 @@
 							  <td style="text-align: left;vertical-align: top;"><?php echo @$row['prename_full'].@$row['firstname_th']."  ".@$row['lastname_th'];?></td>			 
 							  <td style="text-align: center;vertical-align: top;"><?php echo @$row['mem_group_id'];?></td>				 
 							  <td style="text-align: left;vertical-align: top;"><?php echo (@$row['mem_group_name_main'] != '')?@$row['mem_group_name_main'].' :: '.@$row['mem_group_name_sub']:'';?></td>				 
-							  <td style="text-align: left;vertical-align: top;"><?php echo @$row['mem_group_name_level'];?></td>				 
+							  <td style="text-align: left;vertical-align: top;"><?php echo @$row['mem_group_name_level'];?></td>	
+							  <td style="text-align: right;vertical-align: top;"><?php echo @$row['position']; ?></td>			 
 							  <td style="text-align: right;vertical-align: top;"><?php echo @$runno; ?></td> 					 
 							  <?php
 							  	if($runno == '1') {
diff --git a/application/views/template/template_footer.php b/application/views/template/template_footer.php
index 4d32761..7af2519 100644
--- a/application/views/template/template_footer.php
+++ b/application/views/template/template_footer.php
@@ -220,7 +220,13 @@
 			'src' => PROJECTJSPATH.'assets/js/jquery.number_format.js',
 			'type' => 'text/javascript'
 		);
-		echo script_tag($link);
+        echo script_tag($link);
+        $link = array(
+            'src' => PROJECTJSPATH.'assets/js/coop_setting.js',
+            'language' => 'javascript',
+            'type' => 'text/javascript'
+        );
+        echo script_tag($link);
 ?>
     <div class="layout-footer" style="z-index:-1 !important;">
         <div class="layout-footer-body">
diff --git a/assets/js/coop_setting.js b/assets/js/coop_setting.js
new file mode 100644
index 0000000..1a805a2
--- /dev/null
+++ b/assets/js/coop_setting.js
@@ -0,0 +1,45 @@
+var _global_decimalPlaces, _global_places;
+
+function _load(){
+    new Promise(resolve => {
+        $.post(base_url+'coop_setting/get_setting', {}, function(res){
+            resolve(res);
+        })
+    }).then((res) => {
+        _global_places = res.setting.rounding_calc_period_interest;
+        _global_decimalPlaces = res.setting.round_interest;
+        console.log(this._global_decimalPlaces);
+    });
+}
+_load();
+
+function round(number, decimalPlaces){
+    decimalPlaces = decimalPlaces === undefined ? _global_decimalPlaces : decimalPlaces;
+    const factorOfTen = Math.pow(10, decimalPlaces);
+    if(factorOfTen==0){
+        return Math.round(number);
+    }
+    return Math.round(number * factorOfTen) / factorOfTen;
+}
+
+function ceil(number, decimalPlaces){
+    decimalPlaces = decimalPlaces === undefined ? _global_decimalPlaces : decimalPlaces;
+    return Math.ceil(number);
+}
+
+function floor(number, decimalPlaces){
+    decimalPlaces = decimalPlaces === undefined ? _global_decimalPlaces : decimalPlaces;
+    // const factorOfTen = Math.pow(10, decimalPlaces);
+    return Math.floor(number);
+}
+
+//ปัดหลัก
+function round_nearest(number, places){
+    places = places === undefined ? _global_places : places;
+    const factorOfTen = Math.pow(10, places);
+    if(factorOfTen==0){
+        return factorOfTen;
+    }
+    return Math.ceil(number/factorOfTen)*factorOfTen;
+}
+
diff --git a/assets/js/invest_org.js b/assets/js/invest_org.js
new file mode 100644
index 0000000..455a225
--- /dev/null
+++ b/assets/js/invest_org.js
@@ -0,0 +1,91 @@
+$(document).ready(function() {
+    $("#add_org").click(function() {
+        $("#modal_id").val("");
+        $("#add_name").val("");
+        $("#edit_modal").modal("show");
+    });
+    $(".edit_btn").click(function() {
+        $.blockUI({
+            message: 'กรุณารอสักครู่...',
+            css: {
+                border: 'none',
+                padding: '15px',
+                backgroundColor: '#000',
+                '-webkit-border-radius': '10px',
+                '-moz-border-radius': '10px',
+                opacity: .5,
+                color: '#fff'
+            },
+            baseZ: 6000,
+            bindEvents: false
+        });
+        id = $(this).attr("data-id");
+        $.post(base_url+"invest/get_organization_ajax",
+        {id:id},
+        function(result) {
+            data = JSON.parse(result);
+            $("#modal_id").val(data.data.id);
+            $("#add_name").val(data.data.name);
+            $("#edit_modal").modal("show");
+            $.unblockUI();
+        });
+    });
+    $(".del_btn").click(function() {
+        $.blockUI({
+            message: 'กรุณารอสักครู่...',
+            css: {
+                border: 'none',
+                padding: '15px',
+                backgroundColor: '#000',
+                '-webkit-border-radius': '10px',
+                '-moz-border-radius': '10px',
+                opacity: .5,
+                color: '#fff'
+            },
+            baseZ: 6000,
+            bindEvents: false
+        });
+        id = $(this).attr("data-id");
+        $.post(base_url+"invest/edit_organization_ajax",
+        {id:id,
+        status:3},
+        function(result) {
+            window.location.href = 'organization';
+            $.unblockUI();
+        });
+    });
+    $("#submit_add").click(function() {
+        text_alert = '';
+        if($('#add_name').val() == ''){
+            text_alert += '-ชื่อองค์กร\n';
+        }
+
+        if(text_alert != ''){
+            swal("กรุณากรอกข้อมูล", text_alert, "warning")
+        }else{
+            $.blockUI({
+                message: 'กรุณารอสักครู่...',
+                css: {
+                    border: 'none',
+                    padding: '15px',
+                    backgroundColor: '#000',
+                    '-webkit-border-radius': '10px',
+                    '-moz-border-radius': '10px',
+                    opacity: .5,
+                    color: '#fff'
+                },
+                baseZ: 6000,
+                bindEvents: false
+            });
+            $.post(base_url+"invest/edit_organization_ajax",
+            $("#add_form").serialize(),
+            function(result) {
+                window.location.href = 'organization';
+                $.unblockUI();
+            });
+        }
+    });
+    $("#cancel_add").click(function() {
+        $("#edit_modal").modal("hide");
+    });
+});
diff --git a/assets/js/invest_report.js b/assets/js/invest_report.js
new file mode 100644
index 0000000..ef1b0dd
--- /dev/null
+++ b/assets/js/invest_report.js
@@ -0,0 +1,16 @@
+$(document).ready(function() {
+    $(".mydate").datepicker({
+		prevText : "ก่อนหน้า",
+		nextText: "ถัดไป",
+		currentText: "Today",
+		changeMonth: true,
+		changeYear: true,
+		isBuddhist: true,
+		monthNamesShort: ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.', 'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'],
+		dayNamesMin: ['อา', 'จ', 'อ', 'พ', 'พฤ', 'ศ', 'ส'],
+		constrainInput: true,
+		dateFormat: "dd/mm/yy",
+		yearRange: "c-50:c+10",
+		autoclose: true,
+	});
+});
\ No newline at end of file
diff --git a/assets/js/loan_contract.js b/assets/js/loan_contract.js
index 05b2d8d..0b19748 100644
--- a/assets/js/loan_contract.js
+++ b/assets/js/loan_contract.js
@@ -398,7 +398,7 @@ function calcPeriod() {
 }
 
 function flatRate() {
-    return  Math.ceil((loanAmount/periodAmt)/100)*100;
+    return  round_nearest((loanAmount/periodAmt));
 }
 
 function effectiveRate() {
@@ -411,7 +411,7 @@ function calcDeduct() {
 
 function calcEstimateReceive() {
     if(!firstSet) return;
-    estimate = Math.round((loanAmount - deduct)/0.01)*0.01;
+    estimate = round((loanAmount - deduct));
     $('#deduct_pay_prev_loan').val(deduct);
     $('#estimate_money').val(addCommas(estimate));
 }
@@ -422,7 +422,7 @@ function cal_estimate_money(){
         //console.log($(this).attr('name').substring(18).substring(-1,$(this).attr('name').length-(18+1)), removeCommas($(this).val()));
         total += removeCommas($(this).val());
     });
-    estimate =loanAmount - total;
+    estimate = round(loanAmount - total);
     $('#estimate_money').val(addCommas(estimate));
 }
 
@@ -1026,6 +1026,7 @@ function prevDeduct() {
                         let prevLoan = removeCommas(item.prev_loan_total);
                         let interest = removeCommas(item.interest);
                         let result = parseFloat(prevLoan + interest);
+                        $("#contract_interest_"+item.ref_id).html(addCommas(interest));
                         deduct += result;
                         addDeductInput(idx, item, dataType);
                         num++;
@@ -1256,16 +1257,16 @@ function updateEstimateGuaranteePerson(person) {
  *  Transfer Type
  */
 $(document).on('change', '#transfer_type', function () {
-    if ($(this).val() === '1') {
+    if ($(this).val() === '0') {
         $('.content-deposit').hide();
         $('.content-bank').hide();
-    } else if ($(this).val() === '2') {
+    } else if ($(this).val() === '1') {
         $('.content-deposit').show();
         $('.content-bank').hide();
-    } else if ($(this).val() === '3') {
+    } else if ($(this).val() === '2') {
         $('.content-deposit').hide();
         $('.content-bank').show();
-    } else if ($(this).val() === '4') {
+    } else if ($(this).val() === '3') {
         $('.content-deposit').hide();
         $('.content-bank').hide();
     } else {
@@ -1334,7 +1335,10 @@ function setContractDetail(obj) {
     $('#period_amount').val(obj.period_amount);
     $('#interest').val(obj.interest_per_year);
     $('#createdatetime').val(obj.createdatetime);
-
+    $('#transfer_type').val(obj.transfer_type);
+    $('#transfer_bank_id').val(obj.transfer_bank_id);
+    $('#transfer_bank_account_id').val(obj.transfer_bank_account_id);
+    $('#transfer_type').trigger("change");
     setPeriodAMT(obj.period_amount);
     setPayType(obj.pay_type);
     setLoanAmount(obj.loan_amount);
